<div class="contraindications-container">
  @if (loading) {
    <div class="loading-state">
      <p>{{ 'contraindications.checking' | transloco }}</p>
    </div>
  } @else if (error) {
    <div class="error-state">
      <p class="error-message">{{ error }}</p>
      <button class="retry-button" (click)="refreshContraindications()">{{ 'common.retry' | transloco }}</button>
    </div>
  } @else {
    <div class="contraindications-content">
      <!-- Refresh button (top right, next to general note) -->
      <button class="refresh-tool-button" (click)="refreshContraindications()" [title]="'tooltips.refresh' | transloco">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <!-- General note button (top right) -->
      <button class="add-note-button general-note floating-top-right" (click)="openGeneralNotesModal()" [title]="'tooltips.add_general_note' | transloco">
        +
      </button>

      <!-- Type 1: Contraindication Matches (Patient Conditions vs Medications) -->
      <div class="contraindications-section">
        <div class="section-header">
          <h2>{{ 'tools.patient_contraindications' | transloco }}</h2>
          <span class="count-badge">{{ getFilteredMatches().length }}</span>
        </div>
        <p class="section-description">{{ 'tools.contraindications_based_on_conditions' | transloco }}</p>

        @if (getFilteredMatches().length === 0) {
          <div class="no-contraindications">
            <p>✓ {{ 'contraindications.no_contraindications_found' | transloco }}</p>
          </div>
        } @else {
          <!-- Table Header -->
          <div class="contraindications-header">
            <div class="header-cell medication-header">{{ 'interactions.header_medication' | transloco }}</div>
            <div class="header-cell condition-header">{{ 'interactions.header_condition' | transloco }}</div>
            <div class="header-cell severity-header">{{ 'interactions.header_type' | transloco }}</div>
            <div class="header-cell description-header">{{ 'interactions.header_details' | transloco }}</div>
            <div class="header-cell notes-header">{{ 'interactions.header_notes' | transloco }}</div>
          </div>

          <div class="contraindications-list">
            @for (contraindication of getFilteredMatches(); track getUniqueKey(contraindication, $index)) {
              <div class="contraindication-row-wrapper">
                <div 
                  class="contraindication-card" 
                  [class.expanded]="expandedContraindication === getUniqueKey(contraindication, $index)"
                >
                  <div class="contraindication-row" (click)="toggleContraindication(getUniqueKey(contraindication, $index))">
                    <div class="cell medication-cell">
                      <span class="medication-name">{{ contraindication.medication || ('fallbacks.no_medication_name' | transloco) }}</span>
                      <span class="cnk-code">CNK: {{ contraindication.medicationCnk || 'NO CNK' }}</span>
                    </div>
                    <div class="cell condition-cell">
                      <span class="condition-name">{{ contraindication.condition || ('fallbacks.no_condition' | transloco) }}</span>
                      <span class="condition-code">{{ contraindication.conditionCode || 'NO CODE' }}</span>
                    </div>
                    <div class="cell severity-cell">
                      <span class="severity-badge" [class]="getSeverityClass(contraindication.appreciationCode)">
                        {{ contraindication.appreciation }}
                      </span>
                    </div>
                    <div class="cell description-cell">
                      <span class="count-badge">{{ contraindication.contraindications.length }} {{ 'common.reasons' | transloco }}</span>
                      <svg class="expand-icon" [class.rotated]="expandedContraindication === getUniqueKey(contraindication, $index)" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="cell notes-cell" (click)="$event.stopPropagation()">
                      <button class="add-note-button" (click)="openNotesModal(contraindication, 'match')" [title]="'tooltips.add_note' | transloco">
                        +
                      </button>
                    </div>
                  </div>
                  
                  @if (expandedContraindication === getUniqueKey(contraindication, $index)) {
                    <div class="contraindication-details" (click)="$event.stopPropagation()">
                      <div class="details-header">
                        <h4>{{ 'contraindications_component.contraindication_details' | transloco }}</h4>
                      </div>
                      <div class="details-list">
                        @for (detail of contraindication.contraindications; track detail.code) {
                          <div class="detail-item">
                            <span class="detail-code">[{{ detail.code }}]</span>
                            <span class="detail-description" [innerHTML]="formatText(detail.description)"></span>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>

      <!-- Type 2: Product Contraindications (All contraindications per medication) -->
      <div class="contraindications-section">
        <div class="section-header">
          <h2>{{ 'tools.additional_contraindications' | transloco }}</h2>
          @if (productContraindicationsLoaded) {
            <span class="count-badge">{{ getFilteredProductContraindications().length }}</span>
          }
        </div>
        <p class="section-description">{{ 'tools.other_contraindications' | transloco }}</p>

        @if (!productContraindicationsLoaded && !loadingProductContraindications) {
          <div class="load-button-container">
            <button class="load-button" (click)="loadAdditionalContraindications()">
              {{ 'contraindications.load_additional' | transloco }}
            </button>
          </div>
        } @else if (loadingProductContraindications) {
          <div class="loading-state">
            <p>{{ 'contraindications.loading_additional' | transloco }}</p>
          </div>
        } @else if (getFilteredProductContraindications().length === 0) {
          <div class="no-contraindications">
            <p>✓ {{ 'contraindications_component.no_additional_found' | transloco }}</p>
          </div>
        } @else {
          <!-- Table Header -->
          <div class="contraindications-header">
            <div class="header-cell medication-header">{{ 'interactions.header_medication' | transloco }}</div>
            <div class="header-cell condition-header">{{ 'interactions.header_condition' | transloco }}</div>
            <div class="header-cell severity-header">{{ 'interactions.header_type' | transloco }}</div>
            <div class="header-cell description-header">{{ 'interactions.header_details' | transloco }}</div>
            <div class="header-cell notes-header">{{ 'interactions.header_notes' | transloco }}</div>
          </div>

          <div class="contraindications-list">
            @for (contraindication of getFilteredProductContraindications(); track getUniqueKey(contraindication, $index)) {
              <div class="contraindication-row-wrapper">
                <div 
                  class="contraindication-card" 
                  [class.expanded]="expandedContraindication === getUniqueKey(contraindication, $index)"
                >
                  <div class="contraindication-row" (click)="toggleContraindication(getUniqueKey(contraindication, $index))">
                    <div class="cell medication-cell">
                      <span class="medication-name">{{ contraindication.medicationName || ('fallbacks.no_medication_name' | transloco) }}</span>
                      <span class="cnk-code">CNK: {{ contraindication.cnk || 'NO CNK' }}</span>
                    </div>
                    <div class="cell condition-cell">
                      <span class="condition-name">{{ contraindication.condition || ('fallbacks.no_condition' | transloco) }}</span>
                      <span class="condition-code">{{ contraindication.conditionCode || 'NO CODE' }}</span>
                    </div>
                    <div class="cell severity-cell">
                      <span class="severity-badge" [class]="getSeverityClass(contraindication.appreciationCode)">
                        {{ contraindication.appreciation }}
                      </span>
                    </div>
                    <div class="cell description-cell">
                      <span class="count-badge">{{ contraindication.contraindications.length }} {{ 'common.reasons' | transloco }}</span>
                      <svg class="expand-icon" [class.rotated]="expandedContraindication === getUniqueKey(contraindication, $index)" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="cell notes-cell" (click)="$event.stopPropagation()">
                      <button class="add-note-button" (click)="openNotesModal(contraindication, 'product')" [title]="'tooltips.add_note' | transloco">
                        +
                      </button>
                    </div>
                  </div>
                  
                  @if (expandedContraindication === getUniqueKey(contraindication, $index)) {
                    <div class="contraindication-details" (click)="$event.stopPropagation()">
                      <div class="details-header">
                        <h4>{{ 'contraindications_component.contraindication_details' | transloco }}</h4>
                      </div>
                      <div class="details-list">
                        @for (detail of contraindication.contraindications; track detail.code) {
                          <div class="detail-item">
                            <span class="detail-code">[{{ detail.code }}]</span>
                            <span class="detail-description" [innerHTML]="formatText(detail.description)"></span>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>
