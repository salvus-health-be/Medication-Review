<div class="medication-item" [ngClass]="{ 'is-new': isNew }" [attr.data-cnk]="medication.cnk ?? ''" [attr.data-vmp]="medication.vmp ?? ''" [attr.data-package-size]="medication.packageSize ?? ''">
  <div class="medication-header" (click)="toggleExpand()">
    <div class="header-content">
      <div class="medication-name">{{ medication.name }}</div>
      @if (!medication.asNeeded && !notDaily) {
        <div class="header-frequency">{{ dosesPerDay }}x{{ 'medication.per_day' | transloco }}</div>
      }
      @if (!medication.asNeeded && notDaily && medication.specialFrequency && medication.specialDescription) {
        <div class="header-frequency">{{ medication.specialFrequency }}x {{ getLocalizedPeriod() }}</div>
      }
      <div class="medication-codes"><!-- metadata --></div>

      @if (medication.asNeeded) {
        <div class="as-needed-badge">{{ 'ui.as_needed_with_translation' | transloco }}</div>
      }

      @if (medication.indication) {
        <div class="medication-indication" title="{{ medication.indication }}">{{ medication.indication }}</div>
      }
    </div>

    <div class="action-buttons">
      <button class="action-button edit-button" (click)="editMedication($event)" [title]="'actions.edit_medication' | transloco">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M11.333 2.00004C11.5081 1.82494 11.716 1.68605 11.9447 1.59129C12.1735 1.49653 12.4187 1.44775 12.6663 1.44775C12.914 1.44775 13.1592 1.49653 13.3879 1.59129C13.6167 1.68605 13.8246 1.82494 13.9997 2.00004C14.1748 2.17513 14.3137 2.383 14.4084 2.61178C14.5032 2.84055 14.552 3.08575 14.552 3.33337C14.552 3.58099 14.5032 3.82619 14.4084 4.05497C14.3137 4.28374 14.1748 4.49161 13.9997 4.66671L5.33301 13.3334L1.33301 14.6667L2.66634 10.6667L11.333 2.00004Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <button class="action-button delete-button" (click)="deleteMedication($event)" [title]="'actions.delete_medication' | transloco">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    @if (expandable) {
      <div class="expand-icon" [class.expanded]="isExpanded">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    }
  </div>

  @if (isExpanded) {
    <div class="medication-body">
      <div class="indication-section">
        <label for="indication-{{ medication.medicationId }}">{{ 'ui.indication_label' | transloco }}</label>
        <input
          type="text"
          id="indication-{{ medication.medicationId }}"
          [(ngModel)]="medication.indication"
          (ngModelChange)="onValueChange()"
          [placeholder]="'medication.indication' | transloco"
          class="indication-input"
        />
      </div>

      <div class="as-needed-section">
        <label class="checkbox-label">
          <input
            type="checkbox"
            [(ngModel)]="medication.asNeeded"
            (ngModelChange)="onValueChange()"
          />
          <span>{{ 'ui.as_needed_with_translation' | transloco }}</span>
        </label>
        
        <label class="checkbox-label">
          <input
            type="checkbox"
            [(ngModel)]="notDaily"
            (ngModelChange)="onNotDailyChange()"
          />
          <span>{{ 'medication.not_daily' | transloco }}</span>
        </label>
      </div>

      @if (notDaily && !medication.asNeeded) {
        <div class="special-frequency-section">
          <div class="field-group">
            <label for="special-frequency-{{ medication.medicationId }}">{{ 'medication.frequency' | transloco }}</label>
            <input
              type="number"
              id="special-frequency-{{ medication.medicationId }}"
              [(ngModel)]="medication.specialFrequency"
              (ngModelChange)="onValueChange()"
              min="1"
              step="1"
              placeholder="1"
              class="frequency-input"
            />
          </div>
          <div class="field-group">
            <label for="special-description-{{ medication.medicationId }}">{{ 'medication.period' | transloco }}</label>
            <select
              id="special-description-{{ medication.medicationId }}"
              [(ngModel)]="medication.specialDescription"
              (ngModelChange)="onValueChange()"
              class="period-select"
            >
              <option value="">{{ 'medication.select_period' | transloco }}</option>
              <option value="weekly">{{ 'medication.period_weekly' | transloco }}</option>
              <option value="biweekly">{{ 'medication.period_biweekly' | transloco }}</option>
              <option value="monthly">{{ 'medication.period_monthly' | transloco }}</option>
              <option value="quarterly">{{ 'medication.period_quarterly' | transloco }}</option>
              <option value="yearly">{{ 'medication.period_yearly' | transloco }}</option>
            </select>
          </div>
        </div>
      }

      @if (!medication.asNeeded && !notDaily) {
        <table class="intake-schedule">
          <thead>
            <tr>
              <th class="time-column">Time</th>
              <th class="before-column">{{ 'medication.before' | transloco }}</th>
              <th class="during-column">{{ 'medication.during' | transloco }}</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="time-label">{{ 'medication.breakfast' | transloco }}</td>
              <td>
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsBeforeBreakfast"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                />
              </td>
              <td>
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsDuringBreakfast"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                />
              </td>
            </tr>
            <tr>
              <td class="time-label">{{ 'medication.lunch' | transloco }}</td>
              <td>
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsBeforeLunch"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                />
              </td>
              <td>
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsDuringLunch"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                />
              </td>
            </tr>
            <tr>
              <td class="time-label">{{ 'medication.dinner' | transloco }}</td>
              <td>
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsBeforeDinner"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                />
              </td>
              <td>
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsDuringDinner"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                />
              </td>
            </tr>
            <tr>
              <td class="time-label">{{ 'medication.at_bedtime' | transloco }}</td>
              <td colspan="2">
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsAtBedtime"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                  class="night-input"
                />
              </td>
            </tr>
          </tbody>
        </table>
      }
    </div>
  }
</div>

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirmation) {
  <app-confirmation-modal
    [title]="'actions.delete_medication' | transloco"
    [message]="'messages.confirm_delete_medication' | transloco:{ name: medication.name }"
    [confirmText]="'common.delete' | transloco"
    [cancelText]="'common.cancel' | transloco"
    (confirm)="onDeleteConfirm()"
    (cancel)="onDeleteCancel()">
  </app-confirmation-modal>
}
