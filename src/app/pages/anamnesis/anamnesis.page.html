<div class="anamnesis-page">
  <!-- Part Selector Tabs -->
  <div class="part-tabs">
    <button class="part-tab" [class.active]="currentPart === 'part1'" (click)="switchPart('part1')">
      <span class="tab-number">1</span>
      <span class="tab-label">{{ 'anamnesis.general_questions' | transloco }}</span>
      <span class="tab-percentage">{{ getPartProgress('part1') }}%</span>
    </button>
    <button class="part-tab" [class.active]="currentPart === 'part2'" (click)="switchPart('part2')">
      <span class="tab-number">2</span>
      <span class="tab-label">{{ 'anamnesis.therapy_adherence' | transloco }}</span>
      <span class="tab-percentage">{{ getPartProgress('part2') }}%</span>
    </button>
    <button class="part-tab" [class.active]="currentPart === 'part3'" (click)="switchPart('part3')">
      <span class="tab-number">3</span>
      <span class="tab-label">{{ 'anamnesis.effectiveness_side_effects' | transloco }}</span>
      <span class="tab-percentage">{{ getPartProgress('part3') }}%</span>
    </button>
    <div class="header-actions">
      <button class="btn-secondary btn-download" (click)="downloadPdf()" [title]="'pdf.download' | transloco">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-printer"
          viewBox="0 0 16 16">
          <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1" />
          <path
            d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1" />
        </svg>
        {{ 'pdf.download' | transloco }}
      </button>
      <button class="btn-primary" (click)="goToDocumentation()" [title]="'documentation.open' | transloco">{{
        'documentation.open' | transloco }}</button>
    </div>
  </div>

  <div class="content-container">
    <!-- Left Panel: Question Boxes (40%) -->
    <div class="question-boxes-panel">
      <div class="panel-header">
        <span>{{ 'anamnesis.question_categories' | transloco }}</span>
      </div>
      <div class="question-boxes-list">
        @for (box of questionBoxes; track box.id) {
        <div class="question-box" [class.selected]="selectedBox?.id === box.id" (click)="selectBox(box)">
          <div class="box-title">{{ box.title }}</div>
          <div class="box-count">{{ 'anamnesis.questions_progress' | transloco:{ answered: getAnsweredQuestionCount(box), total: getVisibleQuestionCount(box) } }}
            [{{ getQuestionProgress(box) }}%]</div>
          <div class="box-share-counters">
            <span class="share-counter patient-counter">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              {{ getShareWithPatientCount(box) }}
            </span>
            <span class="share-counter doctor-counter">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="1"></circle>
                <path d="M12 1v6m0 6v6"></path>
                <path d="M4.22 4.22l4.24 4.24m5.08 0l4.24-4.24M4.22 19.78l4.24-4.24m5.08 0l4.24 4.24"></path>
              </svg>
              {{ getShareWithDoctorCount(box) }}
            </span>
            @if (getNoteCount(box) > 0) {
            <span class="share-counter note-counter">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              {{ getNoteCount(box) }} {{ (getNoteCount(box) === 1 ? 'notes.note' : 'notes.notes') | transloco }}
            </span>
            }
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getQuestionProgress(box)"></div>
          </div>
        </div>
        }
      </div>
    </div>

    <!-- Right Panel: Question Details (60%) -->
    <div class="question-details-panel">
      @if (selectedBox) {
      <div class="panel-header">{{ selectedBox.title }}</div>

      <div class="questions-container">
        <!-- Existing Notes (if any) -->
        @for (note of getNotesForSelectedBox(); track note.rowKey) {
        <div class="question-item">
          <div class="existing-note-header">
            <span class="note-category-badge">{{ note.category }}</span>
            <span class="note-timestamp">{{ note.timestamp | date:'short' }}</span>
          </div>
          <div class="existing-note-text">{{ note.text }}</div>
          <label class="question-label">{{ 'anamnesis_dynamic.pharmacist_action' | transloco }}</label>
          <textarea class="question-textarea pharmacist-action" [value]="getNoteComment(note.rowKey)"
            (input)="onNoteCommentChange(note.rowKey, $event)"
            [placeholder]="'anamnesis_dynamic.pharmacist_action_placeholder' | transloco" rows="2"></textarea>
          <div class="pharmacist-note-sharing">
            <label class="share-checkbox">
              <input type="checkbox" [checked]="getNoteShareWithPatient(note.rowKey)"
                (change)="onNoteShareChange(note.rowKey, 'patient', $event)">
              <span>{{ 'anamnesis_dynamic.share_with_patient' | transloco }}</span>
            </label>
            <label class="share-checkbox">
              <input type="checkbox" [checked]="getNoteShareWithDoctor(note.rowKey)"
                (change)="onNoteShareChange(note.rowKey, 'doctor', $event)">
              <span>{{ 'anamnesis_dynamic.share_with_doctor' | transloco }}</span>
            </label>
          </div>
        </div>
        }

        <!-- Regular Questions -->
        @for (question of selectedBox.questions; track question.name) {
        @if (!question.hidden) {
        <div class="question-item">
          <label class="question-label">{{ question.text }}</label>

          @switch (question.type) {
          @case ('text') {
          <input type="text" class="question-input" [(ngModel)]="question.value"
            (ngModelChange)="onQuestionChange(question.name, $event)" placeholder="Enter your answer">
          }
          @case ('textarea') {
          <textarea
            [class]="(question.name.includes('_action') || question.name.includes('Action') || (question.name.includes('_notes') && currentPart === 'part2')) ? 'question-textarea pharmacist-action' : 'question-textarea'"
            [(ngModel)]="question.value" (ngModelChange)="onQuestionChange(question.name, $event)"
            [placeholder]="(question.name.includes('_action') || question.name.includes('Action') || (question.name.includes('_notes') && currentPart === 'part2')) ? ('anamnesis_dynamic.pharmacist_action_placeholder' | transloco) : 'Enter your answer'"
            rows="3"></textarea>
          @if (question.name.includes('_action') || question.name.includes('Action') ||
          (question.name.includes('_notes') && currentPart === 'part2')) {
          <div class="pharmacist-note-sharing">
            <label class="share-checkbox">
              <input type="checkbox" [(ngModel)]="question.shareWithPatient"
                (ngModelChange)="onShareCheckboxChange(question.name)">
              <span>{{ 'anamnesis_dynamic.share_with_patient' | transloco }}</span>
            </label>
            <label class="share-checkbox">
              <input type="checkbox" [(ngModel)]="question.shareWithDoctor"
                (ngModelChange)="onShareCheckboxChange(question.name)">
              <span>{{ 'anamnesis_dynamic.share_with_doctor' | transloco }}</span>
            </label>
          </div>
          }
          }
          @case ('checkbox') {
          <div class="question-checkbox">
            <input type="checkbox" [id]="question.name" [(ngModel)]="question.value"
              (ngModelChange)="onQuestionChange(question.name, $event)">
            <label [for]="question.name">Yes</label>
          </div>
          }
          @case ('radio') {
          <div class="question-radio-group">
            @for (option of question.options; track option) {
            <label class="question-radio">
              <input type="radio" [name]="question.name" [value]="option" [(ngModel)]="question.value"
                (ngModelChange)="onQuestionChange(question.name, $event)">
              <span>{{ option === true ? ('common.yes' | transloco) : (option === false ? ('common.no' | transloco) :
                (option === 'Yes' ? ('anamnesis_dynamic.yes' | transloco) : (option === 'No' ? ('anamnesis_dynamic.no' |
                transloco) : option))) }}</span>
            </label>
            }
          </div>
          }
          @case ('number') {
          <input type="number" class="question-input" [(ngModel)]="question.value"
            (ngModelChange)="onQuestionChange(question.name, $event)" min="0" placeholder="0">
          }
          @case ('date') {
          <input type="date" class="question-input" [(ngModel)]="question.value"
            (ngModelChange)="onQuestionChange(question.name, $event)">
          }
          }
        </div>
        }
        }
      </div>
      } @else {
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="12" y1="18" x2="12" y2="12"></line>
          <line x1="9" y1="15" x2="15" y2="15"></line>
        </svg>
        <p>Select a question category from the left to begin</p>
      </div>
      }
    </div>
  </div>

  <!-- Clear All Button -->
  <button class="clear-all-button" (click)="clearAllAnswers()" [title]="'anamnesis.clear_all_answers' | transloco">
    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="3 6 5 6 21 6"></polyline>
      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      <line x1="10" y1="11" x2="10" y2="17"></line>
      <line x1="14" y1="11" x2="14" y2="17"></line>
    </svg>
    {{ 'anamnesis.clear_all_answers' | transloco }}
  </button>
</div>