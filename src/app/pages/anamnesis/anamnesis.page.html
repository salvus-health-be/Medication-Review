<div class="anamnesis-page">
  <div class="page-header">
  <h1>Actions</h1>
  <button class="btn-primary" (click)="goToDocumentation()" [title]="'documentation.open' | transloco">{{ 'documentation.open' | transloco }}</button>
  </div>

  <!-- Part Selector Tabs -->
  <div class="part-tabs">
    <button 
      class="part-tab" 
      [class.active]="currentPart === 'part1'"
      (click)="switchPart('part1')">
      <span class="tab-number">1</span>
      <span class="tab-label">{{ 'anamnesis.general_questions' | transloco }}</span>
    </button>
    <button 
      class="part-tab" 
      [class.active]="currentPart === 'part2'"
      (click)="switchPart('part2')">
      <span class="tab-number">2</span>
      <span class="tab-label">{{ 'anamnesis.therapy_adherence' | transloco }}</span>
    </button>
    <button 
      class="part-tab" 
      [class.active]="currentPart === 'part3'"
      (click)="switchPart('part3')">
      <span class="tab-number">3</span>
      <span class="tab-label">{{ 'anamnesis.effectiveness_side_effects' | transloco }}</span>
    </button>
  </div>

  <div class="content-container">
    <!-- Left Panel: Question Boxes (40%) -->
    <div class="question-boxes-panel">
      <div class="panel-header">
        <span>{{ 'anamnesis.question_categories' | transloco }}</span>
        <button class="btn-icon btn-print" [title]="'pdf.preview' | transloco" (click)="previewPdf()" aria-label="Preview PDF">
          <!-- bootstrap-style printer icon provided by user -->
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer" viewBox="0 0 16 16" aria-hidden="true">
            <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
            <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1"/>
          </svg>
        </button>
      </div>
      <div class="question-boxes-list">
        @for (box of questionBoxes; track box.id) {
          <div 
            class="question-box" 
            [class.selected]="selectedBox?.id === box.id"
            (click)="selectBox(box)">
            <div class="box-title">{{ box.title }}</div>
            <div class="box-description">{{ box.description }}</div>
            <div class="box-count">{{ getVisibleQuestionCount(box) }} questions</div>
          </div>
        }
      </div>
    </div>

    <!-- Right Panel: Question Details (60%) -->
    <div class="question-details-panel">
      @if (selectedBox) {
        <div class="panel-header">{{ selectedBox.title }}</div>

        <div class="questions-container">
          <!-- Existing Notes (if any) -->
          @for (note of getNotesForSelectedBox(); track note.rowKey) {
            <div class="question-item">
              <div class="existing-note-header">
                <span class="note-category-badge">{{ note.category }}</span>
                <span class="note-timestamp">{{ note.timestamp | date:'short' }}</span>
              </div>
              <div class="existing-note-text">{{ note.text }}</div>
              <label class="question-label">{{ 'anamnesis_dynamic.pharmacist_action' | transloco }}</label>
              <textarea 
                class="question-textarea"
                [value]="getNoteComment(note.rowKey)"
                (input)="onNoteCommentChange(note.rowKey, $event)"
                [placeholder]="'anamnesis_dynamic.pharmacist_action_placeholder' | transloco"
                rows="2"></textarea>
            </div>
          }

          <!-- Regular Questions -->
          @for (question of selectedBox.questions; track question.name) {
            @if (!question.hidden) {
              <div class="question-item">
                <label class="question-label">{{ question.text }}</label>
                
                @switch (question.type) {
                  @case ('text') {
                    <input 
                      type="text" 
                      class="question-input"
                      [(ngModel)]="question.value"
                      (ngModelChange)="onQuestionChange(question.name, $event)"
                      placeholder="Enter your answer">
                  }
                  @case ('textarea') {
                    <textarea 
                      [class]="(question.name.includes('_action') || question.name.includes('Action') || (question.name.includes('_notes') && currentPart === 'part2')) ? 'question-textarea pharmacist-action' : 'question-textarea'"
                      [(ngModel)]="question.value"
                      (ngModelChange)="onQuestionChange(question.name, $event)"
                      [placeholder]="(question.name.includes('_action') || question.name.includes('Action') || (question.name.includes('_notes') && currentPart === 'part2')) ? ('anamnesis_dynamic.pharmacist_action_placeholder' | transloco) : 'Enter your answer'"
                      rows="3"></textarea>
                    @if (question.name.includes('_action') || question.name.includes('Action') || (question.name.includes('_notes') && currentPart === 'part2')) {
                      <div class="pharmacist-note-sharing">
                        <label class="share-checkbox">
                          <input 
                            type="checkbox"
                            [(ngModel)]="question.shareWithPatient"
                            (ngModelChange)="onShareCheckboxChange(question.name)">
                          <span>{{ 'anamnesis_dynamic.share_with_patient' | transloco }}</span>
                        </label>
                        <label class="share-checkbox">
                          <input 
                            type="checkbox"
                            [(ngModel)]="question.shareWithDoctor"
                            (ngModelChange)="onShareCheckboxChange(question.name)">
                          <span>{{ 'anamnesis_dynamic.share_with_doctor' | transloco }}</span>
                        </label>
                      </div>
                    }
                  }
                  @case ('checkbox') {
                    <div class="question-checkbox">
                      <input 
                        type="checkbox" 
                        [id]="question.name"
                        [(ngModel)]="question.value"
                        (ngModelChange)="onQuestionChange(question.name, $event)">
                      <label [for]="question.name">Yes</label>
                    </div>
                  }
                  @case ('radio') {
                    <div class="question-radio-group">
                      @for (option of question.options; track option) {
                        <label class="question-radio">
                          <input 
                            type="radio" 
                            [name]="question.name"
                            [value]="option"
                            [(ngModel)]="question.value"
                            (ngModelChange)="onQuestionChange(question.name, $event)">
                          <span>{{ option === 'Yes' ? ('anamnesis_dynamic.yes' | transloco) : (option === 'No' ? ('anamnesis_dynamic.no' | transloco) : option) }}</span>
                        </label>
                      }
                    </div>
                  }
                  @case ('number') {
                    <input 
                      type="number" 
                      class="question-input"
                      [(ngModel)]="question.value"
                      (ngModelChange)="onQuestionChange(question.name, $event)"
                      min="0"
                      placeholder="0">
                  }
                  @case ('date') {
                    <input 
                      type="date" 
                      class="question-input"
                      [(ngModel)]="question.value"
                      (ngModelChange)="onQuestionChange(question.name, $event)">
                  }
                }
              </div>
            }
          }
        </div>
      } @else {
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="18" x2="12" y2="12"></line>
            <line x1="9" y1="15" x2="15" y2="15"></line>
          </svg>
          <p>Select a question category from the left to begin</p>
        </div>
      }
    </div>
  </div>
</div>
