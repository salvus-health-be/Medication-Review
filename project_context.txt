### PROJECT STRUCTURE ###

MVP-5/
    .editorconfig
    .gitignore
    angular.json
    angular_to_prompt.py
    package.json
    proxy.conf.json
    README.md
    transloco.config.ts
    tsconfig.app.json
    tsconfig.json
    tsconfig.spec.json
    .github/
        instructions/
            general_instructions.instructions.md
        workflows/
            main_mvp-medication-review.yml
    public/
        i18n/
            en.json
            fr.json
            nl.json
        images/
    src/
        index.html
        main.ts
        styles.scss
        web.config
        app/
            app.config.ts
            app.html
            app.routes.ts
            app.scss
            app.spec.ts
            app.ts
            transloco-loader.ts
            components/
                add-lab-value-modal/
                    add-lab-value-modal.component.html
                    add-lab-value-modal.component.scss
                    add-lab-value-modal.component.ts
                analysis-medication-item/
                    analysis-medication-item.component.html
                    analysis-medication-item.component.scss
                    analysis-medication-item.component.ts
                analysis-toolbar/
                    analysis-toolbar.component.html
                    analysis-toolbar.component.scss
                    analysis-toolbar.component.ts
                cnk-selection-modal/
                    cnk-selection-modal.component.html
                    cnk-selection-modal.component.scss
                    cnk-selection-modal.component.ts
                confirmation-modal/
                    confirmation-modal.component.html
                    confirmation-modal.component.scss
                    confirmation-modal.component.ts
                contra-indications/
                    contra-indications.component.html
                    contra-indications.component.scss
                    contra-indications.component.ts
                contraindication-modal/
                    contraindication-modal.component.html
                    contraindication-modal.component.scss
                    contraindication-modal.component.ts
                contraindications/
                    contraindications.component.html
                    contraindications.component.scss
                    contraindications.component.ts
                gheops/
                    gheops.component.html
                    gheops.component.scss
                    gheops.component.ts
                header/
                    header.component.html
                    header.component.scss
                    header.component.ts
                interaction-notes-modal/
                    interaction-notes-modal.component.html
                    interaction-notes-modal.component.scss
                    interaction-notes-modal.component.ts
                interactions/
                    interactions.component.html
                    interactions.component.scss
                    interactions.component.ts
                lab-value-item/
                    lab-value-item.component.html
                    lab-value-item.component.scss
                    lab-value-item.component.ts
                lab-values/
                    lab-values.component.html
                    lab-values.component.scss
                    lab-values.component.ts
                lab-values-list/
                    lab-values-list.component.html
                    lab-values-list.component.scss
                    lab-values-list.component.ts
                manage-moments-modal/
                    manage-moments-modal.component.html
                    manage-moments-modal.component.scss
                    manage-moments-modal.component.ts
                manual-dispensing-modal/
                    manual-dispensing-modal.component.html
                    manual-dispensing-modal.component.scss
                    manual-dispensing-modal.component.ts
                medication-item/
                    medication-item.component.html
                    medication-item.component.scss
                    medication-item.component.ts
                medication-list/
                    medication-list.component.html
                    medication-list.component.scss
                    medication-list.component.ts
                medication-notes-modal/
                    medication-notes-modal.component.html
                    medication-notes-modal.component.scss
                    medication-notes-modal.component.ts
                medication-search-modal/
                    medication-search-modal.component.html
                    medication-search-modal.component.scss
                    medication-search-modal.component.ts
                note-overview-modal/
                    note-overview-modal.component.html
                    note-overview-modal.component.scss
                    note-overview-modal.component.ts
                patient-details/
                    patient-details.component.html
                    patient-details.component.scss
                    patient-details.component.ts
                posology/
                    posology.component.html
                    posology.component.scss
                    posology.component.ts
                questionnaire/
                    questionnaire.component.html
                    questionnaire.component.scss
                    questionnaire.component.ts
                renadaptor/
                    renadaptor.component.html
                    renadaptor.component.scss
                    renadaptor.component.ts
                start-stop/
                    start-stop.component.html
                    start-stop.component.scss
                    start-stop.component.ts
                therapy-adherence/
                    therapy-adherence.component.html
                    therapy-adherence.component.scss
                    therapy-adherence.component.ts
            images/
            models/
                api.models.ts
            pages/
                analysis/
                    analysis.page.html
                    analysis.page.scss
                    analysis.page.ts
                anamnesis/
                    anamnesis.page.html
                    anamnesis.page.scss
                    anamnesis.page.ts
                anamnesis-preparation/
                    anamnesis-preparation.page.html
                input/
                    input.page.html
                    input.page.scss
                    input.page.ts
                login/
                    login.page.html
                    login.page.scss
                    login.page.ts
                note-overview/
                    note-overview.page.html
                    note-overview.page.scss
                    note-overview.page.ts
                pdf-preview/
                    pdf-preview.page.html
                    pdf-preview.page.scss
                    pdf-preview.page.ts
                report-generation/
                    report-generation.page.html
                    report-generation.page.scss
                    report-generation.page.ts
            services/
                anamnesis-pdf.service.ts
                api.service.ts
                pdf-generation.service.ts
                review-notes.service.ts
                state.service.ts
        assets/
            prompt_templates/
        environments/
            environment.prod.ts
            environment.ts
        styles/
            _add-note-buttons.scss
            _colors.scss
            _fonts.scss


### FILE CONTENTS ###

--- START OF FILE: .editorconfig ---
```typescript
# Editor configuration, see https://editorconfig.org
root = true

[*]
charset = utf-8
indent_style = space
indent_size = 2
insert_final_newline = true
trim_trailing_whitespace = true

[*.ts]
quote_type = single
ij_typescript_use_double_quotes = false

[*.md]
max_line_length = off
trim_trailing_whitespace = false

```
--- END OF FILE: .editorconfig ---

--- START OF FILE: .gitignore ---
```typescript
# See https://docs.github.com/get-started/getting-started-with-git/ignoring-files for more about ignoring files.

# Compiled output
/dist
/tmp
/out-tsc
/bazel-out

# Node
/node_modules
npm-debug.log
yarn-error.log

# IDEs and editors
.idea/
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace

# Visual Studio Code
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
.history/*

# Miscellaneous
/.angular/cache
.sass-cache/
/connect.lock
/coverage
/libpeerconnection.log
testem.log
/typings
__screenshots__/

# System files
.DS_Store
Thumbs.db

```
--- END OF FILE: .gitignore ---

--- START OF FILE: angular.json ---
```typescript
{
  "$schema": "./node_modules/@angular/cli/lib/config/schema.json",
  "version": 1,
  "newProjectRoot": "projects",
  "projects": {
    "MVP-5": {
      "projectType": "application",
      "schematics": {
        "@schematics/angular:component": {
          "style": "scss"
        }
      },
      "root": "",
      "sourceRoot": "src",
      "prefix": "app",
      "architect": {
        "build": {
          "builder": "@angular/build:application",
          "options": {
            "browser": "src/main.ts",
            "polyfills": [
              "zone.js"
            ],
            "tsConfig": "tsconfig.app.json",
            "inlineStyleLanguage": "scss",
            "assets": [
              {
                "glob": "**/*",
                "input": "public"
              },
              {
                "glob": "web.config",
                "input": "src",
                "output": "."
              }
            ],
            "styles": [
              "src/styles.scss"
            ]
          },
          "configurations": {
            "production": {
              "fileReplacements": [
                {
                  "replace": "src/environments/environment.ts",
                  "with": "src/environments/environment.prod.ts"
                }
              ],
              "budgets": [
                {
                  "type": "initial",
                  "maximumWarning": "5MB",
                  "maximumError": "10MB"
                },
                {
                  "type": "anyComponentStyle",
                  "maximumWarning": "4kB",
                  "maximumError": "50kB"
                }
              ],
              "outputHashing": "all"
            },
            "development": {
              "optimization": false,
              "extractLicenses": false,
              "sourceMap": true
            }
          },
          "defaultConfiguration": "production"
        },
        "serve": {
          "builder": "@angular/build:dev-server",
          "configurations": {
            "production": {
              "buildTarget": "MVP-5:build:production"
            },
            "development": {
              "buildTarget": "MVP-5:build:development",
              "proxyConfig": "proxy.conf.json"
            }
          },
          "defaultConfiguration": "development"
        },
        "extract-i18n": {
          "builder": "@angular/build:extract-i18n"
        },
        "test": {
          "builder": "@angular/build:karma",
          "options": {
            "polyfills": [
              "zone.js",
              "zone.js/testing"
            ],
            "tsConfig": "tsconfig.spec.json",
            "inlineStyleLanguage": "scss",
            "assets": [
              {
                "glob": "**/*",
                "input": "public"
              }
            ],
            "styles": [
              "src/styles.scss"
            ]
          }
        }
      }
    }
  }
}

```
--- END OF FILE: angular.json ---

--- START OF FILE: angular_to_prompt.py ---
```typescript
import os
import argparse

# --- CONFIGURATION ---
# Directories to ignore
IGNORE_DIRS = {
    'node_modules', 'dist', '.git', '.angular', '.vscode', '.idea', 'coverage'
}

# Files to ignore (exact matches)
IGNORE_FILES = {
    'package-lock.json', 'yarn.lock', '.DS_Store', 'favicon.ico'
}

# File extensions to ignore (binary files, images, etc.)
IGNORE_EXTENSIONS = {
    '.png', '.jpg', '.jpeg', '.gif', '.svg', '.ico', 
    '.ttf', '.woff', '.woff2', '.eot', '.mp4', '.pdf', 
    '.exe', '.dll', '.so', '.dylib', '.class', '.jar'
}

def generate_tree(startpath):
    """Generates a visual tree structure of the project."""
    tree_str = "### PROJECT STRUCTURE ###\n\n"
    for root, dirs, files in os.walk(startpath):
        # Filter directories in-place
        dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
        
        level = root.replace(startpath, '').count(os.sep)
        indent = ' ' * 4 * (level)
        tree_str += f"{indent}{os.path.basename(root)}/\n"
        subindent = ' ' * 4 * (level + 1)
        for f in files:
            if f not in IGNORE_FILES and os.path.splitext(f)[1] not in IGNORE_EXTENSIONS:
                tree_str += f"{subindent}{f}\n"
    return tree_str + "\n"

def generate_prompt(startpath):
    """Reads files and formats them into a prompt."""
    output = []
    
    # 1. Add the Project Tree
    output.append(generate_tree(startpath))
    
    output.append("### FILE CONTENTS ###\n")

    # 2. Walk through files and add content
    for root, dirs, files in os.walk(startpath):
        # Filter directories
        dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]

        for file in files:
            file_path = os.path.join(root, file)
            ext = os.path.splitext(file)[1]

            if file in IGNORE_FILES or ext in IGNORE_EXTENSIONS:
                continue

            # Relative path for readability
            rel_path = os.path.relpath(file_path, startpath)

            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                    
                # Format: Name of file, then code block
                output.append(f"--- START OF FILE: {rel_path} ---")
                output.append(f"```typescript") # Defaulting to ts syntax highlighting for readability
                output.append(content)
                output.append(f"```")
                output.append(f"--- END OF FILE: {rel_path} ---\n")
                
            except Exception as e:
                print(f"Skipping file {rel_path} due to read error: {e}")

    return "\n".join(output)

def main():
    parser = argparse.ArgumentParser(description="Convert Angular project to LLM Prompt")
    parser.add_argument("path", nargs="?", default=".", help="Path to the Angular project (default: current folder)")
    parser.add_argument("-o", "--output", default="project_context.txt", help="Output file name (default: project_context.txt)")
    
    args = parser.parse_args()
    
    project_path = os.path.abspath(args.path)
    
    if not os.path.exists(project_path):
        print(f"Error: Path '{project_path}' does not exist.")
        return

    print(f"Scanning project at: {project_path}")
    print("Generating prompt...")
    
    full_prompt = generate_prompt(project_path)
    
    with open(args.output, "w", encoding="utf-8") as f:
        f.write(full_prompt)
        
    print(f"‚úÖ Success! Prompt saved to: {args.output}")
    print(f"üìä Approximate Token Count: {len(full_prompt) // 4}")

if __name__ == "__main__":
    main()
```
--- END OF FILE: angular_to_prompt.py ---

--- START OF FILE: package.json ---
```typescript
{
  "name": "mvp-5",
  "version": "0.0.0",
  "scripts": {
    "ng": "ng",
    "start": "ng serve",
    "build": "ng build",
    "watch": "ng build --watch --configuration development",
    "test": "ng test"
  },
  "prettier": {
    "printWidth": 100,
    "singleQuote": true,
    "overrides": [
      {
        "files": "*.html",
        "options": {
          "parser": "angular"
        }
      }
    ]
  },
  "private": true,
  "dependencies": {
    "@angular/common": "^20.3.0",
    "@angular/compiler": "^20.3.0",
    "@angular/core": "^20.3.0",
    "@angular/forms": "^20.3.0",
    "@angular/platform-browser": "^20.3.0",
    "@angular/router": "^20.3.0",
    "@jsverse/transloco": "^8.1.0",
    "chart.js": "^4.5.1",
    "chartjs-adapter-date-fns": "^3.0.0",
    "date-fns": "^4.1.0",
    "jspdf": "^3.0.3",
    "jspdf-autotable": "^5.0.2",
    "pdfmake": "^0.2.20",
    "rxjs": "~7.8.0",
    "tslib": "^2.3.0",
    "zone.js": "~0.15.0"
  },
  "devDependencies": {
    "@angular/build": "^20.3.8",
    "@angular/cli": "^20.3.8",
    "@angular/compiler-cli": "^20.3.0",
    "@types/jasmine": "~5.1.0",
    "@types/pdfmake": "^0.2.12",
    "jasmine-core": "~5.9.0",
    "karma": "~6.4.0",
    "karma-chrome-launcher": "~3.2.0",
    "karma-coverage": "~2.2.0",
    "karma-jasmine": "~5.1.0",
    "karma-jasmine-html-reporter": "~2.1.0",
    "typescript": "~5.9.2"
  }
}

```
--- END OF FILE: package.json ---

--- START OF FILE: proxy.conf.json ---
```typescript
{
  "/api": {
    "target": "http://localhost:7071",
    "secure": false,
    "changeOrigin": true,
    "logLevel": "debug"
  }
}

```
--- END OF FILE: proxy.conf.json ---

--- START OF FILE: README.md ---
```typescript
# MVP5

This project was generated using [Angular CLI](https://github.com/angular/angular-cli) version 20.3.8.

## Development server

To start a local development server, run:

```bash
ng serve
```

Once the server is running, open your browser and navigate to `http://localhost:4200/`. The application will automatically reload whenever you modify any of the source files.

## Code scaffolding

Angular CLI includes powerful code scaffolding tools. To generate a new component, run:

```bash
ng generate component component-name
```

For a complete list of available schematics (such as `components`, `directives`, or `pipes`), run:

```bash
ng generate --help
```

## Building

To build the project run:

```bash
ng build
```

This will compile your project and store the build artifacts in the `dist/` directory. By default, the production build optimizes your application for performance and speed.

## Running unit tests

To execute unit tests with the [Karma](https://karma-runner.github.io) test runner, use the following command:

```bash
ng test
```

## Running end-to-end tests

For end-to-end (e2e) testing, run:

```bash
ng e2e
```

Angular CLI does not come with an end-to-end testing framework by default. You can choose one that suits your needs.

## Additional Resources

For more information on using the Angular CLI, including detailed command references, visit the [Angular CLI Overview and Command Reference](https://angular.dev/tools/cli) page.

```
--- END OF FILE: README.md ---

--- START OF FILE: transloco.config.ts ---
```typescript
import {TranslocoGlobalConfig} from '@jsverse/transloco-utils';
    
const config: TranslocoGlobalConfig = {
  rootTranslationsPath: 'public/i18n/',
  langs: [ 'en', 'nl', 'fr' ],
  keysManager: {}
};
    
export default config;
```
--- END OF FILE: transloco.config.ts ---

--- START OF FILE: tsconfig.app.json ---
```typescript
/* To learn more about Typescript configuration file: https://www.typescriptlang.org/docs/handbook/tsconfig-json.html. */
/* To learn more about Angular compiler options: https://angular.dev/reference/configs/angular-compiler-options. */
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": "./out-tsc/app",
    "types": []
  },
  "include": [
    "src/**/*.ts"
  ],
  "exclude": [
    "src/**/*.spec.ts"
  ]
}

```
--- END OF FILE: tsconfig.app.json ---

--- START OF FILE: tsconfig.json ---
```typescript
/* To learn more about Typescript configuration file: https://www.typescriptlang.org/docs/handbook/tsconfig-json.html. */
/* To learn more about Angular compiler options: https://angular.dev/reference/configs/angular-compiler-options. */
{
  "compileOnSave": false,
  "compilerOptions": {
    "strict": true,
    "noImplicitOverride": true,
    "noPropertyAccessFromIndexSignature": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "skipLibCheck": true,
    "isolatedModules": true,
    "experimentalDecorators": true,
    "importHelpers": true,
    "target": "ES2022",
    "module": "preserve"
  },
  "angularCompilerOptions": {
    "enableI18nLegacyMessageIdFormat": false,
    "strictInjectionParameters": true,
    "strictInputAccessModifiers": true,
    "typeCheckHostBindings": true,
    "strictTemplates": true
  },
  "files": [],
  "references": [
    {
      "path": "./tsconfig.app.json"
    },
    {
      "path": "./tsconfig.spec.json"
    }
  ]
}

```
--- END OF FILE: tsconfig.json ---

--- START OF FILE: tsconfig.spec.json ---
```typescript
/* To learn more about Typescript configuration file: https://www.typescriptlang.org/docs/handbook/tsconfig-json.html. */
/* To learn more about Angular compiler options: https://angular.dev/reference/configs/angular-compiler-options. */
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": "./out-tsc/spec",
    "types": [
      "jasmine"
    ]
  },
  "include": [
    "src/**/*.ts"
  ]
}

```
--- END OF FILE: tsconfig.spec.json ---

--- START OF FILE: .github\instructions\general_instructions.instructions.md ---
```typescript
---
applyTo: '**'
---
Provide project context and coding guidelines that AI should follow when generating code, answering questions, or reviewing changes.

# General Instructions
This is the Angular project. We also have a backend service in a separate repository. The frontend and backend communicate via REST APIs. Please ensure that any changes made in the frontend are compatible with the backend APIs. You can call the backend service at "http://localhost:7071/api" but this only applies to local development so please make it so we only need to change this URL in one place when deploying to production.
```
--- END OF FILE: .github\instructions\general_instructions.instructions.md ---

--- START OF FILE: .github\workflows\main_mvp-medication-review.yml ---
```typescript
# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Node.js app to Azure Web App - mvp-medication-review

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: '22.x'

      - name: npm install, build, and test
        run: |
          npm install
          npm run build --if-present
      
      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: './dist/MVP-5/browser'

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_A35C636BAF424BED8DCC4557BC64A755 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_6523DCEC1E9048BB873D2AE05D3420B7 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_054C008FF06F4183989FB7007D0CADE4 }}

      - name: 'Deploy to Azure Web App'
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        with:
          app-name: 'mvp-medication-review'
          slot-name: 'Production'
          package: .

          




```
--- END OF FILE: .github\workflows\main_mvp-medication-review.yml ---

--- START OF FILE: public\i18n\en.json ---
```typescript
{
  "common": {
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete",
    "edit": "Edit",
    "add": "Add",
    "close": "Close",
    "confirm": "Confirm",
    "back": "Back",
    "next": "Next",
    "loading": "Loading...",
    "error": "Error",
    "success": "Success",
    "warning": "Warning",
    "info": "Info",
    "yes": "Yes",
    "no": "No",
    "search": "Search",
    "filter": "Filter",
    "clear": "Clear",
    "refresh": "Refresh",
    "print": "Print",
    "export": "Export",
    "import": "Import",
    "download": "Download",
    "upload": "Upload",
    "or": "or",
    "home": "Home",
    "settings": "Settings",
    "help": "Help",
    "logout": "Logout",
    "profile": "Profile"
    ,
    "retry": "Retry"
  },
  "header": {
    "step_1": "Input",
    "step_2": "Analysis",
    "step_3": "Actions",
    "step_4": "Documentation",
    "save_progress": "Save Progress",
    "notes_overview": "Notes Overview",
    "contraindications": "Contra-indications",
    "add_contraindication": "Add Contra-indication"
  },
  "login": {
    "title": "Login",
    "username": "Username",
    "password": "Password",
    "login_button": "Login",
    "forgot_password": "Forgot Password?",
    "remember_me": "Remember Me"
    ,
    "apb_number": "APB Number",
    "enter_apb": "Enter APB number",
    "medication_review_id": "Medication Review ID",
    "optional": "optional",
    "leave_empty": "Leave empty to create new",
    "login_failed": "Login failed. Please try again."
  },
  "patient": {
    "name": "Name",
    "age": "Age",
    "sex": "Sex",
    "male": "Male",
    "female": "Female",
    "other": "Other",
    "birth_date": "Birth Date",
    "patient_id": "Patient ID",
    "patient_info": "Patient Information",
    "patient_details": "Patient Details",
    "renal_function": "Renal Function (eGFR)",
    "renal_function_placeholder": "Enter eGFR in mL/min"
  },
  "actions": {
    "edit_medication": "Edit Medication",
    "delete_medication": "Delete Medication",
    "delete_lab_values": "Delete Lab Values"
  },
  "ui": {
    "as_needed_with_translation": "As needed",
    "as_needed_short": "As needed",
    "indication_label": "Indication",
    "plus_add": "+ Add"
  },
  "input": {
    "start_preparation": "Start Preparation"
  },
  "medication": {
    "medication_schema": "Medication Schema",
    "medication_list": "Medication List",
    "add_medication": "Add Medication",
    "search_medication": "Search Medication",
    "medication_name": "Medication Name",
    "dosage": "Dosage",
    "frequency": "Frequency",
    "indication": "Indication",
    "as_needed": "As Needed",
    "as_needed_short": "As needed",
    "as_needed_medication": "As needed medication",
    "package_size": "Package Size",
    "cnk": "CNK",
    "vmp": "VMP",
    "breakfast": "Breakfast",
    "lunch": "Lunch",
    "dinner": "Dinner",
    "bedtime": "Bedtime",
    "before": "Before",
    "during": "During",
    "at_bedtime": "At Bedtime",
    "units": "Units",
    "times_per_day": "{{count}}x/day",
    "per_day": "/day",
    "one_per_day": "1x/day",
    "two_per_day": "2x/day",
    "three_per_day": "3x/day",
    "four_per_day": "4x/day",
    "no_medications": "No medications added yet",
    "medication_details": "Medication Details",
    "dosing_instructions": "Dosing Instructions",
    "replace_medication": "Replace Medication",
    "search_placeholder": "Type to search medications...",
    "no_results": "No medications found for \"{{term}}\"",
    "search_hint": "Start typing to search medications (minimum 2 characters)",
    "not_daily": "Not Daily",
    "period": "Period",
    "select_period": "Select period",
    "period_weekly": "weekly",
    "period_biweekly": "every 2 weeks",
    "period_monthly": "monthly",
    "period_quarterly": "quarterly",
    "period_yearly": "yearly"
    ,"delete_all": "Delete all",
    "select_cnk": "Select Medication CNK",
    "select_cnk_instruction": "Multiple medications match this name. Please select the correct one:",
    "skip_medication": "Skip This Medication",
    "matching_cnk": "Matching medication to CNK...",
    "cnk_match_failed": "Could not automatically match medication to CNK"
  },
  "modals": {
    "add_contraindications": "Add Contraindications",
    "loading_contraindications": "Loading contraindications from APB...",
    "search_contraindications_placeholder": "Search contraindications...",
    "filter_all": "All",
    "filter_hypersensitivities": "Hypersensitivities",
    "filter_pathologies": "Pathologies",
    "filter_physiological_conditions": "Physiological Conditions",
    "no_contraindications_found": "No contraindications found matching your search.",
    "selected": "selected",
    "add_selected": "Add Selected"
  },
  "tools": {
    "medication_schema": "Medication Schema",
    "questionnaire": "Questionnaire",
    "therapy_adherence": "Therapy Adherence",
    "interactions": "APB Interactions",
    "contraindications": "APB Contra-indications",
    "lab_values": "Lab Values",
    "posology": "APB Posology",
    "renadaptor": "Renadaptor",
    "gheops": "GheOPS",
    "gheops_description": "Ghent Older People's Prescriptions - Community Pharmacy Screening Tool",
    "gheops_help": "This tool helps optimize medication prescriptions for elderly patients. Use it to identify potentially inappropriate medications and dosing recommendations.",
    "questionnaire_upload": "Upload Questionnaire",
    "questionnaire_drag_drop": "Drag & Drop PDF Questionnaire",
    "questionnaire_drop_here": "Drop PDF here",
    "questionnaire_browse": "Browse Files",
    "questionnaire_file_hint": "Maximum file size: 50MB",
    "questionnaire_invalid_pdf": "Please select a PDF file",
    "questionnaire_file_too_large": "File size must be less than 50MB",
    "questionnaire_remove": "Remove PDF",
    "questionnaire_description": "Upload a PDF questionnaire to display and review it here. Use the note button to add observations saved to Part 1: General Questions.",
    "start_stop": "START-STOP",
    "start_stop_description": "Screening Tool to Alert to Right Treatment - Screening Tool of Older Persons' Prescriptions",
    "start_stop_help": "This tool provides criteria for potentially inappropriate prescribing in older adults. START criteria identify medications that should be considered, while STOPP criteria identify medications that should be avoided.",
    "general_notes": "General Notes",
    "add_note": "Add Note",
    "add": "+ Add",
    "open_in_new_tab": "Open in New Tab",
    "start_preparation": "Start Preparation",
    "no_data": "No data available",
    "no_dispensing_data": "No dispensing data available for this medication",
    "maximum_dosages": "Maximum Dosages",
    "patient_contraindications": "Patient Contraindications",
    "additional_contraindications": "Additional Contraindications",
    "contraindications_based_on_conditions": "Contraindications based on patient's conditions",
    "other_contraindications": "Other contraindications not in patient's condition list"
  },
  "documentation": {
    "open": "Open Documentation",
    "back_to_actions": "Back to Actions"
  },
  "anamnesis": {
    "title": "Anamnesis",
    "part_1": "Part 1: General Questions",
    "part_2": "Part 2: Therapy Adherence",
    "part_3": "Part 3: Effectiveness & Side Effects",
    "general_questions": "General Questions",
    "therapy_adherence": "Therapy Adherence",
    "effectiveness_side_effects": "Effectiveness & Side Effects",
    "question_categories": "Question Categories",
    "general_notes": "General Notes",
    "select_category": "Select a category to view questions",
    "categories": {
      "concerns": "Concerns/Experiences",
      "medication_help": "Medication Intake Assistance",
      "practical_problems": "Practical Problems",
      "incidents": "Incidents",
      "follow_up": "Follow-up/Monitoring",
      "understanding": "Understanding of Medications",
      "adherence_barriers": "Adherence Barriers",
      "adherence_assessment": "Adherence Assessment",
      "symptom_control": "Symptom Control",
      "common_side_effects": "Common Side Effects",
      "side_effect_severity": "Severity of Side Effects",
      "overall_effectiveness": "Overall Effectiveness"
    },
    "questions": {
      "anxiety": "Does the patient have concerns or anxiety about their medications?",
      "medication_purpose": "Does the patient understand the purpose of each medication?",
      "correct_dosing": "Does the patient know the correct dosing?",
      "swallowing_difficulty": "Difficulty swallowing",
      "movement_limitation": "Movement limitation",
      "vision_problems": "Vision problems",
      "hearing_problems": "Hearing problems",
      "cognitive_impairment": "Cognitive impairment",
      "dexterity_issues": "Dexterity issues",
      "falls": "Number of falls in past 6 months",
      "hospitalizations": "Number of hospitalizations in past year",
      "care_providers": "Who helps with medication management?",
      "parameter_monitoring": "What parameters are monitored?",
      "forgetfulness": "Forgets to take medications",
      "side_effects": "Experiences side effects",
      "regimen_complexity": "Regimen too complex",
      "cost_concerns": "Cost concerns",
      "adherence_rating": "Overall adherence rating (1-10)",
      "adherence_notes": "Additional adherence notes",
      "prescribed_intake": "Is the medication taken as prescribed?",
      "frequency_forgotten": "How often is it forgotten?",
      "intake_problems": "What problems does the patient have?",
      "additional_comments": "Additional comments",
      "symptom_control_rating": "How well are symptoms controlled? (1-10)",
      "nausea": "Nausea",
      "dizziness": "Dizziness",
      "fatigue": "Fatigue",
      "headache": "Headache",
      "gi_issues": "GI issues",
      "severity_rating": "Severity rating (1-10)",
      "qol_impact": "Impact on quality of life",
      "effectiveness_rating": "Overall effectiveness rating (1-10)",
      "benefit_risk": "Does benefit outweigh risks?",
      "effectiveness_notes": "Additional effectiveness notes",
      "is_effective": "Is the medication effective?",
      "experienced_side_effects": "What side effects are experienced?",
      "severity": "Severity (1-10)",
      "qol_impact_question": "Impact on quality of life?"
    }
  },
  "notes": {
    "notes_overview": "Notes Overview",
    "add_note": "Add Note",
    "edit_note": "Edit Note",
    "delete_note": "Delete Note",
    "note_text": "Note Text",
    "note_placeholder": "Enter your note here...",
    "note_category": "Category",
    "for_patient": "For Patient",
    "for_gp": "For GP",
    "add_to_patient_conversation": "Add to patient conversation",
    "add_to_gp_report": "Add to GP report",
    "add_to_anamnesis": "Add to anamnesis",
    "general_note": "General",
    "no_notes": "No notes available",
    "pharmacist_comment": "Pharmacist Comment",
    "add_comment": "Add your comment about this note...",
    "existing_notes": "Existing Notes",
    "medication_note": "Medication Note",
    "save_note": "Save Note",
    "cancel_note": "Cancel",
    "start_conversation": "Start Conversation",
    "preset_reduce_intake": "Reduce intake moments",
    "preset_move_intake": "Move intake moment",
    "preset_too_few_units": "Patient had too few units",
    "preset_too_many_units": "Patient had too many units",
    "preset_advice_alternative": "Advice alternative",
    "preset_inform_patient": "Inform patient",
    "preset_dose_too_high": "Dose is too high",
    "preset_dose_too_low": "Dose is too low",
    "preset_dosing_adjustment": "Dosing needs adjustments",
    "preset_renal_followup": "Renal function follow-up"
  },
  "frequency": {
    "daily": "daily",
    "twice_weekly": "twice weekly",
    "three_times_weekly": "three times weekly",
    "weekly": "weekly",
    "every_2_weeks": "every 2 weeks",
    "every_3_weeks": "every 3 weeks",
    "every_4_weeks": "every 4 weeks",
    "monthly": "monthly",
    "every_2_months": "every 2 months",
    "quarterly": "quarterly",
    "annually": "annually"
  },
  "pdf": {
    "preview": "PDF Preview",
    "download": "Download PDF",
    "print": "Print",
    "generating": "Generating PDF...",
    "part_1_title": "Part 1: General Questions",
    "part_2_title": "Medication Scheme",
    "part_3_title": "Part 2: Therapy Adherence",
    "part_4_title": "Part 3: Effectiveness & Side Effects",
    "part_1": "Part 1: General Information",
    "part_2": "Part 2: Therapy Adherence",
    "part_3": "Part 3: Effectiveness & Side Effects",
    "patient_summary": "Patient Summary",
    "doctor_summary": "Doctor Summary",
    "pharmacy_summary": "Pharmacy Summary",
    "patient_information": "Patient Information",
    "current_medications": "Current Medications",
    "medication": "Medication",
    "dosage": "Dosage",
    "frequency_per_day": "Frequency/Day",
    "indication": "Indication",
    "pharmacist_notes": "Pharmacist Notes",
    "complete_notes": "Complete Notes",
    "patient_concerns": "Patient Concerns",
    "medication_assistance": "Medication Assistance",
    "practical_problems": "Practical Problems",
    "incidents": "Incidents",
    "follow_up_monitoring": "Follow-up/Monitoring",
    "medication_adherence": "Medication Adherence",
    "effectiveness_side_effects": "Effectiveness & Side Effects",
    "as_needed": "As needed",
    "x_daily": "{{count}}x daily",
    "units_x_daily": "{{units}} units, {{count}}x daily",
    "no_medication": "No medication",
    "no_notes": "No notes",
    "patient_concern_tooMany": "Does the patient feel they take too many medications?",
    "patient_concern_financialBurden": "Does the patient experience financial burden from medications?",
    "patient_concern_anxiety": "Does the patient have concerns or anxiety about medications?",
    "patient_concern_untreatedComplaints": "Does the patient have untreated complaints?",
    "patient_concern_other": "Other concerns?",
    "medication_help_hasAssistance": "Does the patient have assistance taking medications?",
    "medication_help_additionalNeeded": "Is additional help desirable?",
    "practical_problem_swallowing": "Swallowing difficulties?",
    "practical_problem_movement": "Movement limitations?",
    "practical_problem_vision": "Vision problems?",
    "practical_problem_hearing": "Hearing problems?",
    "practical_problem_cognitive": "Cognitive impairment?",
    "practical_problem_dexterity": "Dexterity issues?",
    "practical_problem_other": "Other practical problems?",
    "incidents_falls": "Number of falls (past 6 months)",
    "incidents_hospitalizations": "Number of hospitalizations (past year)",
    "incidents_actionNeeded": "Is action needed?",
    "followup_careProviders": "Who assists with medication management?",
    "followup_parameterMonitoring": "Which parameters are being monitored?",
    "followup_actionNeeded": "Is action needed?",
    "adherence_takes_as_prescribed": "Takes as prescribed?",
    "adherence_frequency_forgotten": "How often forgotten?",
    "adherence_problems": "What problems?",
    "effectiveness_is_effective": "Is effective?",
    "effectiveness_has_side_effects": "Side effects?"
  },
  "reports": {
    "patient_summary": "Patient Summary",
    "doctor_summary": "Doctor Summary",
    "pharmacy_summary": "Pharmacy Summary",
    "select_tool": "Select a tool from the left to generate a report"
  },
  "validation": {
    "required": "This field is required",
    "invalid_email": "Invalid email address",
    "invalid_phone": "Invalid phone number",
    "min_length": "Minimum length is {{min}} characters",
    "max_length": "Maximum length is {{max}} characters",
    "min_value": "Minimum value is {{min}}",
    "max_value": "Maximum value is {{max}}"
  },
  "messages": {
    "save_success": "Successfully saved",
    "save_error": "Error saving data",
    "delete_success": "Successfully deleted",
    "delete_error": "Error deleting data",
    "load_error": "Error loading data",
    "network_error": "Network error occurred",
    "session_expired": "Session expired. Returning to login.",
    "confirm_delete": "Are you sure you want to delete this item?",
    "confirm_delete_medication": "Are you sure you want to delete \"{{name}}\"? This action cannot be undone.",
    "confirm_delete_lab_value": "Are you sure you want to delete this lab value?",
    "delete_lab_value_error": "Failed to delete lab value. Please try again.",
    "unsaved_changes": "You have unsaved changes. Are you sure you want to leave?",
    "confirm_delete_note": "Are you sure you want to delete this note? This action cannot be undone.",
    "delete_note_title": "Delete Note"
  },
  "lab_values": {
    "add_lab_value": "Add Lab Value",
    "name": "Name",
    "value": "Value",
    "unit": "Unit",
    "unnamed": "Unnamed",
    "name_placeholder": "e.g., Glucose, Cholesterol, HbA1c",
    "value_placeholder": "e.g., 95, 5.6",
    "unit_placeholder": "e.g., mg/dL, mmol/L, %",
    "no_lab_values": "No lab values added yet"
  },
  "anamnesis_dynamic": {
    "medication_help_title": "Medication Intake Assistance",
    "takes_as_prescribed": "Does the patient take this medication as prescribed?",
    "how_often_forgotten": "How often does the patient forget this medication?",
    "what_problems": "What problems does the patient have with this medication?",
    "is_effective": "Is this medication effective for the patient?",
    "which_side_effects": "What side effects does the patient experience?",
  "additional_notes": "Additional remarks",
    "pharmacist_notes": "Pharmacist notes",
    "pharmacist_action": "Pharmacist action",
    "share_with_patient": "Share with patient",
    "share_with_doctor": "Share with doctor",
    "pharmacist_action_placeholder": "Describe the action you will take...",
    "medication_effective_question": "Is this medication effective for the patient?",
    "side_effects_question": "Does the patient experience any side effects?",
    "yes": "Yes",
    "no": "No",
    "action_if_not_effective": "Action if not effective",
    "action_for_side_effects": "Action for side effects"
  },
  "therapy_adherence": {
    "loading_history": "Loading dispensing history...",
    "uploading": "Uploading...",
    "retry": "Retry",
    "choose_csv": "Choose CSV File",
    "upload_dispensing_history": "Please upload dispensing history",
    "upload_new_file": "Upload New File",
    "add_manual_moments": "Add Manual Moments",
    "view_all_moments": "View All Moments"
  },
  "manage_moments": {
    "title": "Manage Dispensing Moments",
    "loading": "Loading dispensing moments...",
    "no_data": "No dispensing history available. Please upload a CSV file or add manual moments first.",
    "select_medication": "Select Medication",
    "no_manual_moments": "No manual dispensing moments found for this medication. Only manually added moments can be deleted.",
    "date": "Date",
    "amount": "Amount",
    "actions": "Actions",
    "delete": "Delete",
    "total": "Total",
    "medication": "Medication"
  },
  "manual_dispensing": {
    "title": "Add Manual Dispensing Moments",
    "loading_medications": "Loading medications...",
    "add_moment": "Add Dispensing Moment",
    "select_medication": "Select Medication",
    "select_medication_placeholder": "Choose a medication...",
    "cnk": "CNK Code",
    "description": "Description",
    "description_placeholder": "e.g., Paracetamol 500mg tablets",
    "date": "Date",
    "amount": "Amount (packages)",
    "add_to_list": "Add to List",
    "moments_to_add": "Moments to Add",
    "remove": "Remove",
    "submit_all": "Submit All",
    "submitting": "Submitting...",
    "success_message": "Successfully added {{count}} dispensing moment(s)"
  },
  "posology": {
    "loading_info": "Loading dosage information...",
    "retry": "Retry"
  },
  "renadaptor": {
    "loading": "Loading Renadaptor...",
    "try_again": "Try Again"
  },
  "pdf_errors": {
    "failed_to_generate": "Failed to generate PDF"
  },
  "interaction_types": {
    "drug_drug": "Drug-Drug",
    "drug_food": "Drug-Food"
  },
  "interactions": {
    "loading_details": "Loading details...",
    "checking": "Checking for interactions...",
    "drug_drug_title": "Drug-Drug Interactions",
	"drug_food_title": "Drug-Food Interactions",
    "header_left": "Left",
    "header_right": "Right",
    "header_severity": "Severity",
    "header_number": "Number",
    "header_details": "Details",
    "header_notes": "Notes",
	"header_medication": "Medication",
	"header_condition": "Condition",
	"header_type": "Type",
	"header_food": "Food",
	"no_drug_drug": "No drug-drug interactions found!",
	"no_drug_food": "No drug-food interactions found!"
  },
  "note_modal": {
    "save_changes": "Save changes",
    "cancel_editing": "Cancel editing",
    "edit_note": "Edit note",
    "delete_note": "Delete note",
    "save": "Save",
    "cancel": "Cancel"
  },
  "contraindications": {
    "checking": "Checking contraindications...",
    "no_contraindications_found": "No contraindications found for patient conditions"
  },
  "fallbacks": {
    "not_applicable": "N/A",
    "no_medication_name": "NO MEDICATION NAME",
    "no_condition": "NO CONDITION",
    "no_direction": "No direction"
  }
}
```
--- END OF FILE: public\i18n\en.json ---

--- START OF FILE: public\i18n\fr.json ---
```typescript
{
  "common": {
    "save": "Enregistrer",
    "cancel": "Annuler",
    "delete": "Supprimer",
    "edit": "Modifier",
    "add": "Ajouter",
    "close": "Fermer",
    "confirm": "Confirmer",
    "back": "Retour",
    "next": "Suivant",
    "loading": "Chargement...",
    "error": "Erreur",
    "success": "Succ√®s",
    "warning": "Avertissement",
    "info": "Info",
    "yes": "Oui",
    "no": "Non",
    "search": "Rechercher",
    "filter": "Filtrer",
    "clear": "Effacer",
    "refresh": "Actualiser",
    "print": "Imprimer",
    "export": "Exporter",
    "import": "Importer",
    "download": "T√©l√©charger",
    "upload": "T√©l√©verser",
    "home": "Accueil",
    "settings": "Param√®tres",
    "help": "Aide",
    "logout": "D√©connexion",
    "profile": "Profil"
    ,
    "retry": "R√©essayer"
  },
  "header": {
    "step_1": "Saisie",
    "step_2": "Analyse",
    "step_3": "Actions",
    "step_4": "Documentation",
    "save_progress": "Sauvegarder la progression",
    "notes_overview": "Aper√ßu des notes",
    "contraindications": "Contre-indications",
    "add_contraindication": "Ajouter une contre-indication"
  },
  "login": {
    "title": "Connexion",
    "username": "Nom d'utilisateur",
    "password": "Mot de passe",
    "login_button": "Se connecter",
    "forgot_password": "Mot de passe oubli√© ?",
    "remember_me": "Se souvenir de moi"
    ,
    "apb_number": "Num√©ro APB",
    "enter_apb": "Entrez le num√©ro APB",
    "medication_review_id": "ID de revue des m√©dicaments",
    "optional": "optionnel",
    "leave_empty": "Laisser vide pour cr√©er un nouveau",
    "login_failed": "√âchec de la connexion. Veuillez r√©essayer."
  },
  "patient": {
    "name": "Nom",
    "age": "√Çge",
    "sex": "Sexe",
    "male": "Homme",
    "female": "Femme",
    "other": "Autre",
    "birth_date": "Date de naissance",
    "patient_id": "ID du patient",
    "patient_info": "Informations sur le patient",
    "patient_details": "D√©tails du patient",
    "renal_function": "Fonction r√©nale (DFG)",
    "renal_function_placeholder": "Entrez le DFG en mL/min"
  },
  "actions": {
    "edit_medication": "Modifier le m√©dicament",
    "delete_medication": "Supprimer le m√©dicament",
    "delete_lab_values": "Supprimer les valeurs de laboratoire"
  },
  "ui": {
    "as_needed_with_translation": "Si n√©cessaire",
    "as_needed_short": "Si besoin",
    "indication_label": "Indication",
    "plus_add": "+ Ajouter"
  },
  "medication": {
    "medication_schema": "Sch√©ma de m√©dication",
    "add_medication": "Ajouter un m√©dicament",
    "search_medication": "Rechercher un m√©dicament",
    "medication_name": "Nom du m√©dicament",
    "dosage": "Posologie",
    "frequency": "Fr√©quence",
    "indication": "Indication",
    "as_needed": "Si n√©cessaire",
    "as_needed_short": "Si besoin",
    "as_needed_medication": "M√©dicament si besoin",
    "package_size": "Taille de l'emballage",
    "cnk": "CNK",
    "vmp": "VMP",
    "delete_all": "Supprimer tout",
    "breakfast": "Petit-d√©jeuner",
    "lunch": "D√©jeuner",
    "dinner": "D√Æner",
    "bedtime": "Au coucher",
    "before": "Avant",
    "during": "Pendant",
    "at_bedtime": "Au coucher",
    "units": "Unit√©s",
    "times_per_day": "{{count}}x/jour",
    "per_day": "/jour",
    "no_medications": "Aucun m√©dicament ajout√© pour le moment",
    "medication_details": "D√©tails du m√©dicament",
    "dosing_instructions": "Instructions de dosage",
    "replace_medication": "Remplacer le m√©dicament",
    "search_placeholder": "Tapez pour rechercher des m√©dicaments...",
    "no_results": "Aucun m√©dicament trouv√© pour \"{{term}}\"",
    "search_hint": "Commencez √† taper pour rechercher des m√©dicaments (minimum 2 caract√®res)",
    "not_daily": "Pas quotidien",
    "period": "P√©riode",
    "select_period": "S√©lectionner la p√©riode",
    "period_weekly": "hebdomadaire",
    "period_biweekly": "toutes les 2 semaines",
    "period_monthly": "mensuel",
    "period_quarterly": "trimestriel",
    "period_yearly": "annuel"
  },
  "modals": {
    "add_contraindications": "Ajouter des contre-indications",
    "loading_contraindications": "Chargement des contre-indications depuis l'APB...",
    "search_contraindications_placeholder": "Rechercher des contre-indications...",
    "filter_all": "Tous",
    "filter_hypersensitivities": "Hypersensibilit√©s",
    "filter_pathologies": "Pathologies",
    "filter_physiological_conditions": "Conditions physiologiques",
    "no_contraindications_found": "Aucune contre-indication trouv√©e pour votre recherche.",
    "selected": "s√©lectionn√©",
    "add_selected": "Ajouter la s√©lection"
  },
  "med_search": {
    "replace_medication": "Remplacer le m√©dicament",
    "search_placeholder": "Tapez pour rechercher des m√©dicaments...",
    "no_results": "Aucun m√©dicament trouv√© pour \"{{term}}\"",
    "search_hint": "Commencez √† taper pour rechercher des m√©dicaments (minimum 2 caract√®res)"
  },
  "interactions": {
    "loading_details": "Chargement des d√©tails...",
    "checking": "V√©rification des interactions...",
    "drug_drug_title": "Interactions m√©dicamenteuses",
    "drug_food_title": "Interactions m√©dicament-aliment",
    "header_left": "Gauche",
    "header_right": "Droite",
    "header_severity": "Gravit√©",
    "header_number": "Num√©ro",
    "header_details": "D√©tails",
    "header_notes": "Notes",
    "header_medication": "M√©dicament",
    "header_condition": "Affection",
    "header_type": "Type",
    "header_food": "Aliment",
    "no_drug_drug": "Aucune interaction m√©dicamenteuse trouv√©e !",
    "no_drug_food": "Aucune interaction m√©dicament-aliment trouv√©e !"
  },
  "tools": {
    "therapy_adherence": "Adh√©sion au traitement",
    "interactions": "APB Interactions",
    "contraindications": "APB Contre-indications",
    "posology": "APB Posologie",
    "renadaptor": "Renadaptor",
    "gheops": "GheOPS",
    "start_stop": "START-STOP",
    "general_notes": "Notes g√©n√©rales",
    "add_note": "Ajouter une note",
    "no_data": "Aucune donn√©e disponible",
    "no_dispensing_data": "Aucune donn√©e de d√©livrance disponible pour ce m√©dicament"
  },
  "documentation": {
    "open": "Ouvrir la documentation",
    "back_to_actions": "Retour aux actions"
  },
  "input": {
    "start_preparation": "D√©marrer la pr√©paration"
  },
  "anamnesis": {
    "title": "Anamn√®se",
    "part_1": "Partie 1 : Questions g√©n√©rales",
    "part_2": "Partie 2 : Adh√©sion au traitement",
    "part_3": "Partie 3 : Efficacit√© et effets secondaires",
    "question_categories": "Cat√©gories de questions",
    "general_notes": "Notes g√©n√©rales",
    "select_category": "S√©lectionnez une cat√©gorie pour voir les questions",
    "categories": {
      "concerns": "Pr√©occupations/Exp√©riences",
      "medication_help": "Aide √† la prise de m√©dicaments",
      "practical_problems": "Probl√®mes pratiques",
      "incidents": "Incidents",
      "follow_up": "Suivi/Surveillance",
      "understanding": "Compr√©hension des m√©dicaments",
      "adherence_barriers": "Obstacles √† l'adh√©sion",
      "adherence_assessment": "√âvaluation de l'adh√©sion",
      "symptom_control": "Contr√¥le des sympt√¥mes",
      "common_side_effects": "Effets secondaires courants",
      "side_effect_severity": "Gravit√© des effets secondaires",
      "overall_effectiveness": "Efficacit√© globale"
    },
    "questions": {
      "anxiety": "Le patient a-t-il des pr√©occupations ou de l'anxi√©t√© concernant ses m√©dicaments ?",
      "medication_purpose": "Le patient comprend-il le but de chaque m√©dicament ?",
      "correct_dosing": "Le patient conna√Æt-il la posologie correcte ?",
      "swallowing_difficulty": "Difficult√© √† avaler",
      "movement_limitation": "Limitation des mouvements",
      "vision_problems": "Probl√®mes de vision",
      "hearing_problems": "Probl√®mes d'audition",
      "cognitive_impairment": "Troubles cognitifs",
      "dexterity_issues": "Probl√®mes de dext√©rit√©",
      "falls": "Nombre de chutes au cours des 6 derniers mois",
      "hospitalizations": "Nombre d'hospitalisations au cours de la derni√®re ann√©e",
      "care_providers": "Qui aide √† la gestion des m√©dicaments ?",
      "parameter_monitoring": "Quels param√®tres sont surveill√©s ?",
      "forgetfulness": "Oublie de prendre ses m√©dicaments",
      "side_effects": "√âprouve des effets secondaires",
      "regimen_complexity": "Sch√©ma th√©rapeutique trop complexe",
      "cost_concerns": "Pr√©occupations li√©es au co√ªt",
      "adherence_rating": "√âvaluation globale de l'adh√©sion (1-10)",
      "adherence_notes": "Notes suppl√©mentaires sur l'adh√©sion",
      "prescribed_intake": "Le m√©dicament est-il pris tel que prescrit ?",
      "frequency_forgotten": "√Ä quelle fr√©quence est-il oubli√© ?",
      "intake_problems": "Quels probl√®mes le patient rencontre-t-il ?",
      "additional_comments": "Commentaires suppl√©mentaires",
      "symptom_control_rating": "Dans quelle mesure les sympt√¥mes sont-ils contr√¥l√©s ? (1-10)",
      "nausea": "Naus√©es",
      "dizziness": "Vertiges",
      "fatigue": "Fatigue",
      "headache": "Maux de t√™te",
      "gi_issues": "Probl√®mes gastro-intestinaux",
      "severity_rating": "√âvaluation de la gravit√© (1-10)",
      "qol_impact": "Impact sur la qualit√© de vie",
      "effectiveness_rating": "√âvaluation de l'efficacit√© globale (1-10)",
      "benefit_risk": "Le b√©n√©fice l'emporte-t-il sur les risques ?",
      "effectiveness_notes": "Notes suppl√©mentaires sur l'efficacit√©",
      "is_effective": "Le m√©dicament est-il efficace ?",
      "experienced_side_effects": "Quels effets secondaires sont ressentis ?",
      "severity": "Gravit√© (1-10)",
      "qol_impact_question": "Impact sur la qualit√© de vie ?"
    }
  },
  "notes": {
    "notes_overview": "Aper√ßu des notes",
    "add_note": "Ajouter une note",
    "edit_note": "Modifier la note",
    "delete_note": "Supprimer la note",
    "note_text": "Texte de la note",
    "note_placeholder": "Saisissez votre note ici...",
    "note_category": "Cat√©gorie",
    "for_patient": "Pour le patient",
    "for_gp": "Pour le m√©decin traitant",
    "add_to_patient_conversation": "Ajouter √† la conversation avec le patient",
    "add_to_gp_report": "Ajouter au rapport du m√©decin",
    "add_to_anamnesis": "Ajouter √† l'anamn√®se",
    "general_note": "G√©n√©ral",
    "no_notes": "Aucune note disponible",
    "pharmacist_comment": "Commentaire du pharmacien",
    "add_comment": "Ajoutez votre commentaire √† propos de cette note...",
    "existing_notes": "Notes existantes",
    "medication_note": "Note sur le m√©dicament",
    "save_note": "Enregistrer la note",
    "cancel_note": "Annuler",
    "start_conversation": "D√©marrer la Conversation",
    "preset_reduce_intake": "R√©duire les moments de prise",
    "preset_move_intake": "D√©placer le moment de prise",
    "preset_too_few_units": "Le patient avait trop peu d'unit√©s",
    "preset_too_many_units": "Le patient avait trop d'unit√©s",
    "preset_advice_alternative": "Conseiller une alternative",
    "preset_inform_patient": "Informer le patient",
    "preset_dose_too_high": "La dose est trop √©lev√©e",
    "preset_dose_too_low": "La dose est trop faible",
    "preset_dosing_adjustment": "Ajustements de dosage n√©cessaires",
    "preset_renal_followup": "Suivi de la fonction r√©nale"
  },
  "frequency": {
    "daily": "quotidien",
    "twice_weekly": "deux fois par semaine",
    "three_times_weekly": "trois fois par semaine",
    "weekly": "hebdomadaire",
    "every_2_weeks": "toutes les 2 semaines",
    "every_3_weeks": "toutes les 3 semaines",
    "every_4_weeks": "toutes les 4 semaines",
    "monthly": "mensuel",
    "every_2_months": "tous les 2 mois",
    "quarterly": "trimestriel",
    "annually": "annuel"
  },
  "pdf": {
    "preview": "Aper√ßu PDF",
    "download": "T√©l√©charger le PDF",
    "print": "Imprimer",
    "generating": "G√©n√©ration du PDF en cours...",
    "part_1_title": "Partie 1 : Questions g√©n√©rales",
    "part_2_title": "Sch√©ma de M√©dication",
    "part_3_title": "Partie 2 : Adh√©sion au traitement",
    "part_4_title": "Partie 3 : Efficacit√© et effets secondaires",
    "part_1": "Partie 1 : Informations g√©n√©rales",
    "part_2": "Partie 2 : Adh√©sion au traitement",
    "part_3": "Partie 3 : Efficacit√© et effets secondaires",
    "patient_summary": "R√©sum√© pour le patient",
    "doctor_summary": "R√©sum√© pour le m√©decin",
    "pharmacy_summary": "R√©sum√© pour la pharmacie",
    "patient_information": "Informations sur le patient",
    "current_medications": "M√©dicaments actuels",
    "medication": "M√©dicament",
    "dosage": "Posologie",
    "frequency_per_day": "Fr√©quence/Jour",
    "indication": "Indication",
    "pharmacist_notes": "Notes du pharmacien",
    "complete_notes": "Notes compl√®tes",
    "patient_concerns": "Pr√©occupations du patient",
    "medication_assistance": "Aide √† la prise de m√©dicaments",
    "practical_problems": "Probl√®mes pratiques",
    "incidents": "Incidents",
    "follow_up_monitoring": "Suivi/Surveillance",
    "medication_adherence": "Adh√©sion au traitement",
    "effectiveness_side_effects": "Efficacit√© et effets secondaires",
    "as_needed": "Si n√©cessaire",
    "x_daily": "{{count}}x par jour",
    "units_x_daily": "{{units}} unit√©s, {{count}}x par jour",
    "no_medication": "Aucun m√©dicament",
    "no_notes": "Aucune note",
    "patient_concern_tooMany": "Le patient estime-t-il prendre trop de m√©dicaments ?",
    "patient_concern_financialBurden": "Le patient subit-il une charge financi√®re due aux m√©dicaments ?",
    "patient_concern_anxiety": "Le patient a-t-il des inqui√©tudes concernant les m√©dicaments ?",
    "patient_concern_untreatedComplaints": "Le patient a-t-il des plaintes non trait√©es ?",
    "patient_concern_other": "Autres pr√©occupations ?",
    "medication_help_hasAssistance": "Le patient b√©n√©ficie-t-il d'une aide pour prendre ses m√©dicaments ?",
    "medication_help_additionalNeeded": "Une aide suppl√©mentaire est-elle souhaitable ?",
    "practical_problem_swallowing": "Difficult√©s de d√©glutition ?",
    "practical_problem_movement": "Limitations de mouvement ?",
    "practical_problem_vision": "Probl√®mes de vision ?",
    "practical_problem_hearing": "Probl√®mes d'audition ?",
    "practical_problem_cognitive": "D√©ficience cognitive ?",
    "practical_problem_dexterity": "Probl√®mes de dext√©rit√© ?",
    "practical_problem_other": "Autres probl√®mes pratiques ?",
    "incidents_falls": "Nombre de chutes (6 derniers mois)",
    "incidents_hospitalizations": "Nombre d'hospitalisations (ann√©e pass√©e)",
    "incidents_actionNeeded": "Une action est-elle n√©cessaire ?",
    "followup_careProviders": "Qui aide √† la gestion des m√©dicaments ?",
    "followup_parameterMonitoring": "Quels param√®tres sont surveill√©s ?",
    "followup_actionNeeded": "Une action est-elle n√©cessaire ?",
    "adherence_takes_as_prescribed": "Prend comme prescrit ?",
    "adherence_frequency_forgotten": "Combien de fois oubli√© ?",
    "adherence_problems": "Quels probl√®mes ?",
    "effectiveness_is_effective": "Est efficace ?",
    "effectiveness_has_side_effects": "Effets secondaires ?"
  },
  "reports": {
    "patient_summary": "R√©sum√© pour le patient",
    "doctor_summary": "R√©sum√© pour le m√©decin",
    "pharmacy_summary": "R√©sum√© pour la pharmacie",
    "select_tool": "S√©lectionnez un outil √† gauche pour g√©n√©rer un rapport"
  },
  "validation": {
    "required": "Ce champ est obligatoire",
    "invalid_email": "Adresse e-mail invalide",
    "invalid_phone": "Num√©ro de t√©l√©phone invalide",
    "min_length": "La longueur minimale est de {{min}} caract√®res",
    "max_length": "La longueur maximale est de {{max}} caract√®res",
    "min_value": "La valeur minimale est {{min}}",
    "max_value": "La valeur maximale est {{max}}"
  },
  "messages": {
    "save_success": "Enregistr√© avec succ√®s",
    "save_error": "Erreur lors de l'enregistrement des donn√©es",
    "delete_success": "Supprim√© avec succ√®s",
    "delete_error": "Erreur lors de la suppression des donn√©es",
    "load_error": "Erreur lors du chargement des donn√©es",
    "network_error": "Une erreur r√©seau s'est produite",
    "session_expired": "Session expir√©e. Retour √† la page de connexion.",
    "confirm_delete": "√ätes-vous s√ªr de vouloir supprimer cet √©l√©ment ?",
    "confirm_delete_medication": "√ätes-vous s√ªr de vouloir supprimer \"{{name}}\" ? Cette action est irreversible.",
    "confirm_delete_lab_value": "√ätes-vous s√ªr de vouloir supprimer cette valeur de laboratoire ?",
    "delete_lab_value_error": "Impossible de supprimer la valeur de laboratoire. Veuillez r√©essayer.",
    "unsaved_changes": "Vous avez des modifications non enregistr√©es. √ätes-vous s√ªr de vouloir quitter ?",
    "confirm_delete_note": "√ätes-vous s√ªr de vouloir supprimer cette note ? Cette action ne peut pas √™tre annul√©e.",
    "delete_note_title": "Supprimer la note"
  },
  "lab_values": {
    "add_lab_value": "Ajouter une valeur de laboratoire",
    "name": "Nom",
    "value": "Valeur",
    "unit": "Unit√©",
    "unnamed": "Sans nom",
    "name_placeholder": "par ex., Glucose, Cholest√©rol, HbA1c",
    "value_placeholder": "par ex., 95, 5.6",
    "unit_placeholder": "par ex., mg/dL, mmol/L, %",
    "no_lab_values": "Aucune valeur de laboratoire ajout√©e pour le moment"
  },
  "anamnesis_dynamic": {
    "medication_help_title": "Aide √† la prise de m√©dicaments",
    "takes_as_prescribed": "Le patient prend-il ce m√©dicament comme prescrit ?",
    "how_often_forgotten": "√Ä quelle fr√©quence le patient oublie-t-il ce m√©dicament ?",
    "what_problems": "Quels probl√®mes le patient rencontre-t-il avec ce m√©dicament ?",
    "is_effective": "Ce m√©dicament est-il efficace pour le patient ?",
    "which_side_effects": "Quels effets secondaires le patient ressent-il ?",
  "additional_notes": "Remarques suppl√©mentaires",
    "pharmacist_notes": "Notes du pharmacien",
    "pharmacist_action": "Action du pharmacien",
    "share_with_patient": "Partager avec le patient",
    "share_with_doctor": "Partager avec le m√©decin",
    "pharmacist_action_placeholder": "D√©crivez l'action que vous allez entreprendre...",
    "medication_effective_question": "Ce m√©dicament est-il efficace pour le patient ?",
    "side_effects_question": "Le patient ressent-il des effets secondaires ?",
    "yes": "Oui",
    "no": "Non",
    "action_if_not_effective": "Action si non efficace",
    "action_for_side_effects": "Action pour les effets secondaires"
  },
  "therapy_adherence": {
    "loading_history": "Chargement de l'historique de distribution...",
    "uploading": "T√©l√©chargement en cours...",
    "retry": "R√©essayer",
    "choose_csv": "Choisir un fichier CSV",
    "upload_dispensing_history": "Veuillez t√©l√©charger l'historique de distribution",
    "upload_new_file": "T√©l√©charger un Nouveau Fichier",
    "add_manual_moments": "Ajouter des Moments Manuels",
    "view_all_moments": "Voir Tous les Moments"
  },
  "manage_moments": {
    "title": "G√©rer les Moments de D√©livrance",
    "loading": "Chargement des moments de d√©livrance...",
    "no_data": "Aucun historique de distribution disponible. Veuillez t√©l√©charger un fichier CSV ou ajouter des moments manuels d'abord.",
    "select_medication": "S√©lectionner un M√©dicament",
    "no_manual_moments": "Aucun moment de d√©livrance manuel trouv√© pour ce m√©dicament. Seuls les moments ajout√©s manuellement peuvent √™tre supprim√©s.",
    "date": "Date",
    "amount": "Quantit√©",
    "actions": "Actions",
    "delete": "Supprimer",
    "total": "Total",
    "medication": "M√©dicament"
  },
  "manual_dispensing": {
    "title": "Ajouter des Moments de D√©livrance Manuels",
    "loading_medications": "Chargement des m√©dicaments...",
    "add_moment": "Ajouter un Moment de D√©livrance",
    "select_medication": "S√©lectionner un M√©dicament",
    "select_medication_placeholder": "Choisissez un m√©dicament...",
    "cnk": "Code CNK",
    "description": "Description",
    "description_placeholder": "ex. Parac√©tamol 500mg comprim√©s",
    "date": "Date",
    "amount": "Quantit√© (emballages)",
    "add_to_list": "Ajouter √† la Liste",
    "moments_to_add": "Moments √† Ajouter",
    "remove": "Supprimer",
    "submit_all": "Soumettre Tout",
    "submitting": "Soumission...",
    "success_message": "{{count}} moment(s) de d√©livrance ajout√©(s) avec succ√®s"
  },
  "posology": {
    "loading_info": "Chargement des informations posologiques...",
    "retry": "R√©essayer"
  },
  "renadaptor": {
    "loading": "Chargement de Renadaptor...",
    "try_again": "R√©essayer"
  },
  "pdf_errors": {
    "failed_to_generate": "√âchec de la g√©n√©ration du PDF"
  },
  "interaction_types": {
    "drug_drug": "M√©dicament-M√©dicament",
    "drug_food": "M√©dicament-Aliment"
  },
  "note_modal": {
    "save_changes": "Enregistrer les modifications",
    "cancel_editing": "Annuler la modification",
    "edit_note": "Modifier la note",
    "delete_note": "Supprimer la note",
    "save": "Enregistrer",
    "cancel": "Annuler"
  },
  "contraindications": {
    "checking": "V√©rification des contre-indications...",
    "no_contraindications_found": "Aucune contre-indication trouv√©e pour les conditions du patient"
  },
  "fallbacks": {
    "not_applicable": "N/A",
    "no_medication_name": "PAS DE NOM DE M√âDICAMENT",
    "no_condition": "PAS DE CONDITION",
    "no_direction": "Pas de direction"
  }
}
```
--- END OF FILE: public\i18n\fr.json ---

--- START OF FILE: public\i18n\nl.json ---
```typescript
{
  "common": {
    "save": "Opslaan",
    "cancel": "Annuleren",
    "delete": "Verwijderen",
    "edit": "Bewerken",
    "add": "Toevoegen",
    "close": "Sluiten",
    "confirm": "Bevestigen",
    "back": "Terug",
    "next": "Volgende",
    "loading": "Laden...",
    "error": "Fout",
    "success": "Geslaagd",
    "warning": "Waarschuwing",
    "info": "Info",
    "yes": "Ja",
    "no": "Nee",
    "search": "Zoeken",
    "filter": "Filter",
    "clear": "Wissen",
    "refresh": "Vernieuwen",
    "print": "Afdrukken",
    "export": "Exporteren",
    "import": "Importeren",
    "download": "Downloaden",
    "upload": "Uploaden",
    "or": "of",
    "home": "Home",
    "settings": "Instellingen",
    "help": "Help",
    "logout": "Uitloggen",
    "profile": "Profiel"
    ,
    "retry": "Opnieuw proberen"
  },
  "header": {
    "step_1": "Input",
    "step_2": "Analyse",
    "step_3": "Acties",
    "step_4": "Documentatie",
    "save_progress": "Voortgang opslaan",
    "notes_overview": "Notitieoverzicht",
    "contraindications": "Contra-indicaties",
    "add_contraindication": "Contra-indicatie toevoegen"
  },
  "login": {
    "title": "Inloggen",
    "username": "Gebruikersnaam",
    "password": "Wachtwoord",
    "login_button": "Inloggen",
    "forgot_password": "Wachtwoord vergeten?",
    "remember_me": "Onthoud mij"
    ,
    "apb_number": "APB-nummer",
    "enter_apb": "Voer APB-nummer in",
    "medication_review_id": "Medicatierapport ID",
    "optional": "optioneel",
    "leave_empty": "Leeg laten om nieuw aan te maken",
    "login_failed": "Inloggen mislukt. Probeer het opnieuw."
  },
  "patient": {
    "name": "Naam",
    "age": "Leeftijd",
    "sex": "Geslacht",
    "male": "Man",
    "female": "Vrouw",
    "other": "Anders",
    "birth_date": "Geboortedatum",
    "patient_id": "Pati√´ntnummer",
    "patient_info": "Pati√´ntinformatie",
    "patient_details": "Pati√´ntgegevens",
    "renal_function": "Nierfunctie (eGFR)",
    "renal_function_placeholder": "Voer eGFR in mL/min in"
  },
  "actions": {
    "edit_medication": "Medicatie bewerken",
    "delete_medication": "Medicatie verwijderen",
    "delete_lab_values": "Labowaarden verwijderen"
  },
  "ui": {
    "as_needed_with_translation": "Zo nodig",
    "as_needed_short": "Zo nodig",
    "indication_label": "Indicatie",
    "plus_add": "+ Toevoegen"
  },
  "input": {
    "start_preparation": "Voorbereiding starten"
  },
  "medication": {
    "medication_schema": "Medicatieschema",
    "medication_list": "Medicatielijst",
    "add_medication": "Medicatie toevoegen",
    "search_medication": "Zoek medicatie",
    "medication_name": "Naam medicatie",
    "dosage": "Dosering",
    "frequency": "Frequentie",
    "indication": "Indicatie",
    "as_needed": "Zo nodig",
    "as_needed_short": "Zo nodig",
    "as_needed_medication": "Zo nodig medicatie",
    "package_size": "Verpakkingsgrootte",
    "cnk": "CNK",
    "vmp": "VMP",
    "breakfast": "Ontbijt",
    "lunch": "Middageten",
    "dinner": "Avondeten",
    "bedtime": "Slapengaan",
    "before": "Voor",
    "during": "Tijdens",
    "at_bedtime": "Bij het slapengaan",
    "units": "Eenheden",
    "times_per_day": "{{count}}x/dag",
    "per_day": "/dag",
    "one_per_day": "1x/dag",
    "two_per_day": "2x/dag",
    "three_per_day": "3x/dag",
    "four_per_day": "4x/dag",
    "no_medications": "Nog geen medicatie toegevoegd",
    "medication_details": "Medicatiegegevens",
    "dosing_instructions": "Doseringsinstructies",
    "replace_medication": "Medicatie vervangen",
    "search_placeholder": "Typ om medicatie te zoeken...",
    "no_results": "Geen medicatie gevonden voor \"{{term}}\"",
    "search_hint": "Begin met typen om medicatie te zoeken (minimaal 2 tekens)",
    "not_daily": "Niet dagelijks",
    "period": "Periode",
    "select_period": "Selecteer periode",
    "period_weekly": "wekelijks",
    "period_biweekly": "om de 2 weken",
    "period_monthly": "maandelijks",
    "period_quarterly": "driemaandelijks",
    "period_yearly": "jaarlijks"
    ,"delete_all": "Verwijder alles",
    "select_cnk": "Selecteer Medicatie CNK",
    "select_cnk_instruction": "Meerdere medicijnen komen overeen met deze naam. Selecteer de juiste:",
    "skip_medication": "Deze Medicatie Overslaan",
    "matching_cnk": "Medicatie koppelen aan CNK...",
    "cnk_match_failed": "Kon medicatie niet automatisch koppelen aan CNK"
  },
  "modals": {
    "add_contraindications": "Contra-indicaties toevoegen",
    "loading_contraindications": "Contra-indicaties laden van APB...",
    "search_contraindications_placeholder": "Zoek contra-indicaties...",
    "filter_all": "Alles",
    "filter_hypersensitivities": "Overgevoeligheden",
    "filter_pathologies": "Pathologie√´n",
    "filter_physiological_conditions": "Fysiologische aandoeningen",
    "no_contraindications_found": "Geen contra-indicaties gevonden die overeenkomen met uw zoekopdracht.",
    "selected": "geselecteerd",
    "add_selected": "Geselecteerde toevoegen"
  },
  "tools": {
    "medication_schema": "Medicatieschema",
    "questionnaire": "Vragenlijst",
    "therapy_adherence": "Therapietrouw",
    "interactions": "APB Interacties",
    "contraindications": "APB Contra-indicaties",
    "lab_values": "Labowaarden",
    "posology": "APB Posologie",
    "renadaptor": "Renadaptor",
    "gheops": "GheOPS",
    "gheops_description": "Ghent Older People's Prescriptions - Community Pharmacy Screening Tool",
    "gheops_help": "Deze tool helpt bij het optimaliseren van medicatievoorschriften voor oudere pati√´nten. Gebruik het om potentieel ongeschikte medicatie en doseringsaanbevelingen te identificeren.",
    "questionnaire_upload": "Upload Vragenlijst",
    "questionnaire_drag_drop": "Sleep & Plaats PDF Vragenlijst",
    "questionnaire_drop_here": "Plaats PDF hier",
    "questionnaire_browse": "Bestanden Bladeren",
    "questionnaire_file_hint": "Maximale bestandsgrootte: 50MB",
    "questionnaire_invalid_pdf": "Selecteer een PDF-bestand",
    "questionnaire_file_too_large": "Bestandsgrootte moet kleiner zijn dan 50MB",
    "questionnaire_remove": "Verwijder PDF",
    "questionnaire_description": "Upload een PDF-vragenlijst om deze hier weer te geven en te beoordelen. Gebruik de notitieknop om observaties toe te voegen die worden opgeslagen in Deel 1: Algemene vragen.",
    "start_stop": "START-STOP",
    "start_stop_description": "Screening Tool to Alert to Right Treatment - Screening Tool of Older Persons' Prescriptions",
    "start_stop_help": "Deze tool biedt criteria voor potentieel onjuist voorschrijven bij ouderen. START-criteria identificeren medicijnen die overwogen moeten worden, terwijl STOPP-criteria medicijnen identificeren die vermeden moeten worden.",
    "general_notes": "Algemene notities",
    "add_note": "Notitie toevoegen",
    "add": "+ Toevoegen",
    "open_in_new_tab": "Openen in nieuw tabblad",
    "start_preparation": "Voorbereiding starten",
    "no_data": "Geen gegevens beschikbaar",
    "no_dispensing_data": "Geen aflevergegevens beschikbaar voor deze medicatie",
    "maximum_dosages": "Maximale doseringen",
    "patient_contraindications": "Contra-indicaties van de pati√´nt",
    "additional_contraindications": "Aanvullende contra-indicaties",
    "contraindications_based_on_conditions": "Contra-indicaties op basis van de aandoeningen van de pati√´nt",
    "other_contraindications": "Andere contra-indicaties die niet in de lijst met aandoeningen van de pati√´nt staan"
  },
  "documentation": {
    "open": "Documentatie openen",
    "back_to_actions": "Terug naar Acties"
  },
  "anamnesis": {
    "title": "Anamnese",
    "part_1": "Deel 1: Algemene vragen",
    "part_2": "Deel 2: Therapietrouw",
    "part_3": "Deel 3: Effectiviteit & bijwerkingen",
    "general_questions": "Algemene vragen",
    "therapy_adherence": "Therapietrouw",
    "effectiveness_side_effects": "Effectiviteit & bijwerkingen",
    "question_categories": "Vragencategorie√´n",
    "general_notes": "Algemene notities",
    "select_category": "Selecteer een categorie om vragen te bekijken",
    "categories": {
      "concerns": "Zorgen/Ervaringen",
      "medication_help": "Hulp bij medicatie-inname",
      "practical_problems": "Praktische problemen",
      "incidents": "Incidenten",
      "follow_up": "Opvolging/Monitoring",
      "understanding": "Begrip van medicatie",
      "adherence_barriers": "Barri√®res voor therapietrouw",
      "adherence_assessment": "Beoordeling therapietrouw",
      "symptom_control": "Symptoomcontrole",
      "common_side_effects": "Veelvoorkomende bijwerkingen",
      "side_effect_severity": "Ernst van bijwerkingen",
      "overall_effectiveness": "Algehele effectiviteit"
    },
    "questions": {
      "anxiety": "Heeft de pati√´nt zorgen of angst over diens medicatie?",
      "medication_purpose": "Begrijpt de pati√´nt het doel van elke medicatie?",
      "correct_dosing": "Kent de pati√´nt de juiste dosering?",
      "swallowing_difficulty": "Slikproblemen",
      "movement_limitation": "Bewegingsbeperking",
      "vision_problems": "Zichtproblemen",
      "hearing_problems": "Gehoorproblemen",
      "cognitive_impairment": "Cognitieve beperking",
      "dexterity_issues": "Problemen met handvaardigheid",
      "falls": "Aantal valpartijen in de afgelopen 6 maanden",
      "hospitalizations": "Aantal ziekenhuisopnames in het afgelopen jaar",
      "care_providers": "Wie helpt met het medicatiebeheer?",
      "parameter_monitoring": "Welke parameters worden opgevolgd?",
      "forgetfulness": "Vergeet medicatie in te nemen",
      "side_effects": "Ondervindt bijwerkingen",
      "regimen_complexity": "Schema te complex",
      "cost_concerns": "Zorgen over de kosten",
      "adherence_rating": "Algehele therapietrouw (1-10)",
      "adherence_notes": "Aanvullende notities over therapietrouw",
      "prescribed_intake": "Wordt de medicatie ingenomen zoals voorgeschreven?",
      "frequency_forgotten": "Hoe vaak wordt het vergeten?",
      "intake_problems": "Welke problemen heeft de pati√´nt?",
      "additional_comments": "Aanvullende opmerkingen",
      "symptom_control_rating": "Hoe goed zijn de symptomen onder controle? (1-10)",
      "nausea": "Misselijkheid",
      "dizziness": "Duizeligheid",
      "fatigue": "Vermoeidheid",
      "headache": "Hoofdpijn",
      "gi_issues": "Maag-darmklachten",
      "severity_rating": "Ernst (1-10)",
      "qol_impact": "Impact op de levenskwaliteit",
      "effectiveness_rating": "Algehele effectiviteit (1-10)",
      "benefit_risk": "Weegt het voordeel op tegen de risico's?",
      "effectiveness_notes": "Aanvullende notities over effectiviteit",
      "is_effective": "Is de medicatie effectief?",
      "experienced_side_effects": "Welke bijwerkingen worden ervaren?",
      "severity": "Ernst (1-10)",
      "qol_impact_question": "Impact op de levenskwaliteit?"
    }
  },
  "notes": {
    "notes_overview": "Notitieoverzicht",
    "add_note": "Notitie toevoegen",
    "edit_note": "Notitie bewerken",
    "delete_note": "Notitie verwijderen",
    "note_text": "Notitietekst",
    "note_placeholder": "Voer hier uw notitie in...",
    "note_category": "Categorie",
    "for_patient": "Voor pati√´nt",
    "for_gp": "Voor huisarts",
    "add_to_patient_conversation": "Toevoegen aan pati√´ntgesprek",
    "add_to_gp_report": "Toevoegen aan huisartsenverslag",
    "add_to_anamnesis": "Toevoegen aan anamnese",
    "general_note": "Algemeen",
    "no_notes": "Geen notities beschikbaar",
    "pharmacist_comment": "Opmerking apotheker",
    "add_comment": "Voeg uw opmerking over deze notitie toe...",
    "existing_notes": "Bestaande notities",
    "medication_note": "Medicatienotitie",
    "save_note": "Notitie opslaan",
    "cancel_note": "Annuleren",
    "start_conversation": "Gesprek Starten",
    "preset_reduce_intake": "Innamemomenten verminderen",
    "preset_move_intake": "Innamemoment verplaatsen",
    "preset_too_few_units": "Pati√´nt had te weinig eenheden",
    "preset_too_many_units": "Pati√´nt had te veel eenheden",
    "preset_advice_alternative": "Alternatief adviseren",
    "preset_inform_patient": "Pati√´nt informeren",
    "preset_dose_too_high": "Dosis is te hoog",
    "preset_dose_too_low": "Dosis is te laag",
    "preset_dosing_adjustment": "Dosering vereist aanpassingen",
    "preset_renal_followup": "Nierfunctie-opvolging"
  },
  "frequency": {
    "daily": "dagelijks",
    "twice_weekly": "tweemaal per week",
    "three_times_weekly": "driemaal per week",
    "weekly": "wekelijks",
    "every_2_weeks": "elke 2 weken",
    "every_3_weeks": "elke 3 weken",
    "every_4_weeks": "elke 4 weken",
    "monthly": "maandelijks",
    "every_2_months": "elke 2 maanden",
    "quarterly": "driemaandelijks",
    "annually": "jaarlijks"
  },
  "pdf": {
    "preview": "Pdf-voorbeeld",
    "download": "Pdf downloaden",
    "print": "Afdrukken",
    "generating": "Pdf genereren...",
    "part_1_title": "Deel 1: Algemene vragen",
    "part_2_title": "Medicatieschema",
    "part_3_title": "Deel 2: Therapietrouw",
    "part_4_title": "Deel 3: Effectiviteit & bijwerkingen",
    "part_1": "Deel 1: Algemene informatie",
    "part_2": "Deel 2: Therapietrouw",
    "part_3": "Deel 3: Effectiviteit & bijwerkingen",
    "patient_summary": "Patientenrapport",
    "doctor_summary": "Artsenrapport",
    "pharmacy_summary": "Apotheekrapport",
    "patient_information": "Pati√´ntinformatie",
    "current_medications": "Actuele medicatie",
    "medication": "Medicatie",
    "dosage": "Dosering",
    "frequency_per_day": "Frequentie/Dag",
    "indication": "Indicatie",
    "pharmacist_notes": "Opmerkingen apotheker",
    "complete_notes": "Volledige notities",
    "patient_concerns": "Zorgen van de pati√´nt",
    "medication_assistance": "Hulp bij medicatie-inname",
    "practical_problems": "Praktische problemen",
    "incidents": "Incidenten",
    "follow_up_monitoring": "Opvolging/Monitoring",
    "medication_adherence": "Therapietrouw",
    "effectiveness_side_effects": "Effectiviteit & bijwerkingen",
    "as_needed": "Zo nodig",
    "x_daily": "{{count}}x per dag",
    "units_x_daily": "{{units}} eenheden, {{count}}x per dag",
    "no_medication": "Geen medicatie",
    "no_notes": "Geen notities",
    "patient_concern_tooMany": "Voelt de pati√´nt dat hij/zij te veel medicatie neemt?",
    "patient_concern_financialBurden": "Ervaart de pati√´nt financi√´le last door medicatie?",
    "patient_concern_anxiety": "Heeft de pati√´nt zorgen of angst over medicatie?",
    "patient_concern_untreatedComplaints": "Heeft de pati√´nt onbehandelde klachten?",
    "patient_concern_other": "Andere zorgen?",
    "medication_help_hasAssistance": "Heeft de pati√´nt hulp bij het innemen van medicatie?",
    "medication_help_additionalNeeded": "Is extra hulp wenselijk?",
    "practical_problem_swallowing": "Slikproblemen?",
    "practical_problem_movement": "Bewegingsbeperking?",
    "practical_problem_vision": "Zichtproblemen?",
    "practical_problem_hearing": "Gehoorproblemen?",
    "practical_problem_cognitive": "Cognitieve beperking?",
    "practical_problem_dexterity": "Problemen met handvaardigheid?",
    "practical_problem_other": "Andere praktische problemen?",
    "incidents_falls": "Aantal valpartijen (afgelopen 6 maanden)",
    "incidents_hospitalizations": "Aantal ziekenhuisopnames (afgelopen jaar)",
    "incidents_actionNeeded": "Is actie nodig?",
    "followup_careProviders": "Wie helpt met medicatiebeheer?",
    "followup_parameterMonitoring": "Welke parameters worden opgevolgd?",
    "followup_actionNeeded": "Is actie nodig?",
    "adherence_takes_as_prescribed": "Neemt als voorgeschreven?",
    "adherence_frequency_forgotten": "Hoe vaak vergeten?",
    "adherence_problems": "Welke problemen?",
    "effectiveness_is_effective": "Is effectief?",
    "effectiveness_has_side_effects": "Bijwerkingen?"
  },
  "reports": {
    "patient_summary": "Patientenrapport",
    "doctor_summary": "Artsenrapport",
    "pharmacy_summary": "Apotheekrapport",
    "select_tool": "Selecteer een tool aan de linkerkant om een rapport te genereren"
  },
  "validation": {
    "required": "Dit veld is verplicht",
    "invalid_email": "Ongeldig e-mailadres",
    "invalid_phone": "Ongeldig telefoonnummer",
    "min_length": "Minimale lengte is {{min}} tekens",
    "max_length": "Maximale lengte is {{max}} tekens",
    "min_value": "Minimale waarde is {{min}}",
    "max_value": "Maximale waarde is {{max}}"
  },
  "messages": {
    "save_success": "Succesvol opgeslagen",
    "save_error": "Fout bij het opslaan van gegevens",
    "delete_success": "Succesvol verwijderd",
    "delete_error": "Fout bij het verwijderen van gegevens",
    "load_error": "Fout bij het laden van gegevens",
    "network_error": "Er is een netwerkfout opgetreden",
    "session_expired": "Sessie verlopen. U wordt teruggebracht naar de inlogpagina.",
    "confirm_delete": "Weet u zeker dat u dit item wilt verwijderen?",
    "confirm_delete_medication": "Weet u zeker dat u \"{{name}}\" wilt verwijderen? Deze actie kan niet ongedaan worden gemaakt.",
    "confirm_delete_lab_value": "Weet u zeker dat u deze labowaarde wilt verwijderen?",
    "delete_lab_value_error": "Het verwijderen van de labowaarde is mislukt. Probeer het opnieuw.",
    "unsaved_changes": "U heeft niet-opgeslagen wijzigingen. Weet u zeker dat u wilt vertrekken?",
    "confirm_delete_note": "Weet u zeker dat u deze notitie wilt verwijderen? Deze actie kan niet ongedaan worden gemaakt.",
    "delete_note_title": "Notitie verwijderen"
  },
  "lab_values": {
    "add_lab_value": "Labowaarde toevoegen",
    "name": "Naam",
    "value": "Waarde",
    "unit": "Eenheid",
    "unnamed": "Naamloos",
    "name_placeholder": "bijv. Glucose, Cholesterol, HbA1c",
    "value_placeholder": "bijv. 95, 5.6",
    "unit_placeholder": "bijv. mg/dL, mmol/L, %",
    "no_lab_values": "Nog geen labowaarden toegevoegd"
  },
  "anamnesis_dynamic": {
    "medication_help_title": "Hulp bij inname medicatie",
    "takes_as_prescribed": "Neemt de pati√´nt dit medicijn zoals voorgeschreven?",
    "how_often_forgotten": "Hoe vaak vergeet de pati√´nt dit medicijn?",
    "what_problems": "Welke problemen heeft de pati√´nt met dit medicijn?",
    "is_effective": "Is dit medicijn effectief voor de pati√´nt?",
    "which_side_effects": "Welke bijwerkingen ervaart de pati√´nt?",
  "additional_notes": "Aanvullende opmerkingen",
    "pharmacist_notes": "Opmerkingen apotheker",
    "pharmacist_action": "Apothekers actie",
    "share_with_patient": "Delen met pati√´nt",
    "share_with_doctor": "Delen met arts",
    "pharmacist_action_placeholder": "Beschrijf de actie die u zult nemen...",
    "medication_effective_question": "Is dit medicijn effectief voor de pati√´nt?",
    "side_effects_question": "Ervaart de pati√´nt bijwerkingen?",
    "yes": "Ja",
    "no": "Nee",
    "action_if_not_effective": "Actie indien niet effectief",
    "action_for_side_effects": "Actie voor bijwerkingen"
  },
  "therapy_adherence": {
    "loading_history": "Afleverhistoriek laden...",
    "uploading": "Uploaden...",
    "retry": "Opnieuw proberen",
    "choose_csv": "CSV-bestand kiezen",
    "upload_dispensing_history": "Upload afleveringhistoriek",
    "upload_new_file": "Nieuw Bestand Uploaden",
    "add_manual_moments": "Handmatige Momenten Toevoegen",
    "view_all_moments": "Alle Momenten Bekijken"
  },
  "manage_moments": {
    "title": "Aflevermomenten Beheren",
    "loading": "Aflevermomenten laden...",
    "no_data": "Geen afleverhistoriek beschikbaar. Upload een CSV-bestand of voeg handmatige momenten toe.",
    "select_medication": "Selecteer Medicijn",
    "no_manual_moments": "Geen handmatige aflevermomenten gevonden voor dit medicijn. Alleen handmatig toegevoegde momenten kunnen worden verwijderd.",
    "date": "Datum",
    "amount": "Hoeveelheid",
    "actions": "Acties",
    "delete": "Verwijderen",
    "total": "Totaal",
    "medication": "Medicijn"
  },
  "manual_dispensing": {
    "title": "Handmatige Aflevermomenten Toevoegen",
    "loading_medications": "Medicijnen laden...",
    "add_moment": "Aflevermoment Toevoegen",
    "select_medication": "Selecteer Medicijn",
    "select_medication_placeholder": "Kies een medicijn...",
    "cnk": "CNK Code",
    "description": "Beschrijving",
    "description_placeholder": "bv. Paracetamol 500mg tabletten",
    "date": "Datum",
    "amount": "Aantal (verpakkingen)",
    "add_to_list": "Toevoegen aan Lijst",
    "moments_to_add": "Toe te Voegen Momenten",
    "remove": "Verwijderen",
    "submit_all": "Alles Verzenden",
    "submitting": "Verzenden...",
    "success_message": "Succesvol {{count}} aflevermoment(en) toegevoegd"
  },
  "posology": {
    "loading_info": "Doseringsinfo laden...",
    "retry": "Opnieuw proberen"
  },
  "renadaptor": {
    "loading": "Renadaptor laden...",
    "try_again": "Opnieuw proberen"
  },
  "pdf_errors": {
    "failed_to_generate": "PDF genereren mislukt"
  },
  "interaction_types": {
    "drug_drug": "Geneesmiddel-Geneesmiddel",
    "drug_food": "Geneesmiddel-Voedsel"
  },
  "interactions": {
    "loading_details": "Details laden...",
    "checking": "Controleren op interacties...",
    "drug_drug_title": "Geneesmiddel-geneesmiddelinteracties",
    "drug_food_title": "Geneesmiddel-voedselinteracties",
    "header_left": "Links",
    "header_right": "Rechts",
    "header_severity": "Ernst",
    "header_number": "Nummer",
    "header_details": "Details",
    "header_notes": "Notities",
    "header_medication": "Geneesmiddel",
    "header_condition": "Aandoening",
    "header_type": "Type",
    "header_food": "Voedsel",
    "no_drug_drug": "Geen geneesmiddel-geneesmiddelinteracties gevonden!",
    "no_drug_food": "Geen geneesmiddel-voedselinteracties gevonden!"
  },
  "note_modal": {
    "save_changes": "Wijzigingen opslaan",
    "cancel_editing": "Bewerken annuleren",
    "edit_note": "Notitie bewerken",
    "delete_note": "Notitie verwijderen",
    "save": "Opslaan",
    "cancel": "Annuleren"
  },
  "contraindications": {
    "checking": "Contra-indicaties controleren...",
    "no_contraindications_found": "Geen contra-indicaties gevonden voor de pati√´ntcondities"
  },
  "fallbacks": {
    "not_applicable": "N/A",
    "no_medication_name": "GEEN MEDICIJNNAAM",
    "no_condition": "GEEN AANDOENING",
    "no_direction": "Geen richting"
  }
}
```
--- END OF FILE: public\i18n\nl.json ---

--- START OF FILE: src\index.html ---
```typescript
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MVP5</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="/images/Top_bar_logo.png">
</head>
<body>
  <app-root></app-root>
</body>
</html>

```
--- END OF FILE: src\index.html ---

--- START OF FILE: src\main.ts ---
```typescript
import { bootstrapApplication } from '@angular/platform-browser';
import { appConfig } from './app/app.config';
import { App } from './app/app';

bootstrapApplication(App, appConfig)
  .catch((err) => console.error(err));

```
--- END OF FILE: src\main.ts ---

--- START OF FILE: src\styles.scss ---
```typescript
/* You can add global styles to this file, and also import other style files */
@import './styles/colors';
@import './styles/fonts';
@import './styles/add-note-buttons';

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: $primary-font;
  width: 100%;
  height: 100vh;
  overflow: hidden;
}

/* Make headers use the thin font weight by default */
h1, h2, h3, h4, h5, h6 {
  font-family: $primary-font;
  font-weight: $font-weight-thin;
}

```
--- END OF FILE: src\styles.scss ---

--- START OF FILE: src\web.config ---
```typescript
<?xml version="1.0"?>
<configuration>
    <system.webServer>
        <httpProtocol>
            <customHeaders>
                <add name="Cache-Control" value="no-cache" />
            </customHeaders>
        </httpProtocol>
        <staticContent>
            <mimeMap fileExtension=".json" mimeType="application/json" />
            <mimeMap fileExtension=".js" mimeType="application/javascript" />
            <mimeMap fileExtension="woff" mimeType="application/font-woff" />
            <mimeMap fileExtension="config" mimeType="application/xhtml+xml" />
            <remove fileExtension=".woff2" />
            <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
        </staticContent>
        <rewrite>
            <rules>
                <rule name="React Routes" stopProcessing="true">
                    <match url=".*" />
                    <conditions logicalGrouping="MatchAll">
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="/" />
                </rule>
            </rules>
        </rewrite>
    </system.webServer>
</configuration>

```
--- END OF FILE: src\web.config ---

--- START OF FILE: src\app\app.config.ts ---
```typescript
import { ApplicationConfig, provideBrowserGlobalErrorListeners, provideZoneChangeDetection, isDevMode } from '@angular/core';
import { provideRouter } from '@angular/router';
import { provideHttpClient } from '@angular/common/http';

import { routes } from './app.routes';
import { TranslocoHttpLoader } from './transloco-loader';
import { provideTransloco, TranslocoService } from '@jsverse/transloco';
import { APP_INITIALIZER } from '@angular/core';

export const appConfig: ApplicationConfig = {
  providers: [
    provideBrowserGlobalErrorListeners(),
    provideZoneChangeDetection({ eventCoalescing: true }),
    provideRouter(routes),
    provideHttpClient(), provideHttpClient(), provideTransloco({
        config: { 
          availableLangs: ['en', 'nl', 'fr'],
          // If a user previously selected a language, prefer that as the default
          defaultLang: (localStorage.getItem('selectedLang') || 'en'),
          // Remove this option if your application doesn't support changing language in runtime.
          reRenderOnLangChange: true,
          prodMode: !isDevMode(),
        },
        loader: TranslocoHttpLoader
      }),
      // Ensure TranslocoService uses stored language when the app starts
      {
        provide: APP_INITIALIZER,
        useFactory: (transloco: TranslocoService) => {
          return () => {
            const saved = localStorage.getItem('selectedLang');
            if (saved) {
              transloco.setActiveLang(saved);
            }
          };
        },
        deps: [TranslocoService],
        multi: true
      }
  ]
};

```
--- END OF FILE: src\app\app.config.ts ---

--- START OF FILE: src\app\app.html ---
```typescript
<div class="app-container">
  <app-header *ngIf="!isLoginPage" (openNoteOverview)="onOpenNoteOverview()"></app-header>
  <main class="main-content">
    <router-outlet />
  </main>
</div>
```
--- END OF FILE: src\app\app.html ---

--- START OF FILE: src\app\app.routes.ts ---
```typescript
import { Routes } from '@angular/router';
import { LoginPage } from './pages/login/login.page';
import { InputPage } from './pages/input/input.page';
import { AnalysisPage } from './pages/analysis/analysis.page';
import { AnamnesisPage } from './pages/anamnesis/anamnesis.page';
import { ReportGenerationPage } from './pages/report-generation/report-generation.page';

export const routes: Routes = [
  {
    path: '',
    redirectTo: 'login',
    pathMatch: 'full'
  },
  {
    path: 'login',
    component: LoginPage
  },
  {
    path: 'input',
    component: InputPage
  },
  {
    path: 'analysis',
    component: AnalysisPage
  },
  {
    path: 'anamnesis',
    component: AnamnesisPage
  },
  {
    path: 'report-generation',
    component: ReportGenerationPage
  }
];

```
--- END OF FILE: src\app\app.routes.ts ---

--- START OF FILE: src\app\app.scss ---
```typescript
@import '../styles/colors';

.app-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  width: 100%;
  overflow: hidden;

  .main-content {
    flex: 1;
    background-color: $main-background;
    overflow-y: auto;
  }
}
```
--- END OF FILE: src\app\app.scss ---

--- START OF FILE: src\app\app.spec.ts ---
```typescript
import { TestBed } from '@angular/core/testing';
import { App } from './app';

describe('App', () => {
  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [App],
    }).compileComponents();
  });

  it('should create the app', () => {
    const fixture = TestBed.createComponent(App);
    const app = fixture.componentInstance;
    expect(app).toBeTruthy();
  });

  it('should render title', () => {
    const fixture = TestBed.createComponent(App);
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    expect(compiled.querySelector('h1')?.textContent).toContain('Hello, MVP-5');
  });
});

```
--- END OF FILE: src\app\app.spec.ts ---

--- START OF FILE: src\app\app.ts ---
```typescript
import { Component, signal } from '@angular/core';
import { RouterOutlet, Router, NavigationEnd } from '@angular/router';
import { HeaderComponent } from './components/header/header.component';
import { CommonModule } from '@angular/common';
import { filter } from 'rxjs/operators';
import { StateService } from './services/state.service';

@Component({
  selector: 'app-root',
  imports: [RouterOutlet, HeaderComponent, CommonModule],
  templateUrl: './app.html',
  styleUrls: ['./app.scss']
})
export class App {
  protected readonly title = signal('MVP-5');
  isLoginPage: boolean = false;

  constructor(private router: Router, private stateService: StateService) {
    // Check current route on initialization
    this.checkRoute(this.router.url);

    // Subscribe to route changes
    this.router.events
      .pipe(filter(event => event instanceof NavigationEnd))
      .subscribe((event: any) => {
        this.checkRoute(event.url);
      });
  }

  private checkRoute(url: string) {
    this.isLoginPage = url === '/login' || url === '/';
  }

  onOpenNoteOverview() {
    console.log('[App] Note overview requested');
    // Emit to state service so analysis page can listen
    this.stateService.openNoteOverviewModal();
  }
}

```
--- END OF FILE: src\app\app.ts ---

--- START OF FILE: src\app\transloco-loader.ts ---
```typescript
import { inject, Injectable } from "@angular/core";
import { Translation, TranslocoLoader } from "@jsverse/transloco";
import { HttpClient } from "@angular/common/http";

@Injectable({ providedIn: 'root' })
export class TranslocoHttpLoader implements TranslocoLoader {
    private http = inject(HttpClient);

    getTranslation(lang: string) {
        return this.http.get<Translation>(`/i18n/${lang}.json`);
    }
}

```
--- END OF FILE: src\app\transloco-loader.ts ---

--- START OF FILE: src\app\components\add-lab-value-modal\add-lab-value-modal.component.html ---
```typescript
<div class="modal-overlay" (click)="onCancel()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ 'lab_values.add_lab_value' | transloco }}</h2>
      <button class="close-button" (click)="onCancel()">&times;</button>
    </div>

    <div class="modal-body">
      <form (ngSubmit)="onSubmit()">
        <!-- Name Input -->
        <div class="form-group">
          <label for="lab-value-name">{{ 'lab_values.name' | transloco }}</label>
          <input
            type="text"
            id="lab-value-name"
            [(ngModel)]="name"
            name="name"
            [placeholder]="'lab_values.name_placeholder' | transloco"
            class="form-input"
            autofocus
          />
        </div>

        <!-- Value Input -->
        <div class="form-group">
          <label for="lab-value-value">{{ 'lab_values.value' | transloco }}</label>
          <input
            type="number"
            id="lab-value-value"
            [(ngModel)]="value"
            name="value"
            [placeholder]="'lab_values.value_placeholder' | transloco"
            step="0.1"
            class="form-input"
          />
        </div>

        <!-- Unit Input -->
        <div class="form-group">
          <label for="lab-value-unit">{{ 'lab_values.unit' | transloco }}</label>
          <input
            type="text"
            id="lab-value-unit"
            [(ngModel)]="unit"
            name="unit"
            [placeholder]="'lab_values.unit_placeholder' | transloco"
            class="form-input"
          />
        </div>

        <!-- Error Message -->
        @if (errorMessage) {
          <div class="error-message">{{ errorMessage }}</div>
        }

        <!-- Action Buttons -->
        <div class="modal-actions">
          <button type="button" class="btn btn-cancel" (click)="onCancel()">{{ 'common.cancel' | transloco }}</button>
          <button type="submit" class="btn btn-submit">{{ 'lab_values.add_lab_value' | transloco }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\components\add-lab-value-modal\add-lab-value-modal.component.html ---

--- START OF FILE: src\app\components\add-lab-value-modal\add-lab-value-modal.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.2s ease;

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
}

.modal-container {
  background-color: $box-background;
  border-radius: $box-border-radius;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  max-width: 450px;
  width: 90%;
  animation: slideUp 0.2s ease;

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
}

.modal-header {
  padding: 1.5rem 1.5rem 1rem 1.5rem;
  border-bottom: 1px solid #e8e8e8;
  display: flex;
  justify-content: space-between;
  align-items: center;

  h2 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: $font-weight-bold;
    color: $text-primary;
  }

  .close-button {
    background: none;
    border: none;
    font-size: 1.75rem;
    color: $text-secondary;
    cursor: pointer;
    padding: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: $box-border-radius-small;
    transition: all 0.2s ease;

    &:hover {
      background-color: #f3f4f6;
      color: $text-primary;
    }
  }
}

.modal-body {
  padding: 1.5rem;

  form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;

    label {
      font-size: 0.875rem;
      font-weight: $font-weight-semibold;
      color: $text-primary;
    }

    .form-input {
      width: 100%;
      padding: 0.625rem 0.875rem;
      border: $box-border-width solid #d1d5db;
      border-radius: $box-border-radius-small;
      font-family: $primary-font;
      font-size: 0.9375rem;
      color: $text-primary;
      background-color: $input-background;
      box-sizing: border-box;
      transition: all 0.2s ease;

      &:hover {
        border-color: #9ca3af;
      }

      &:focus {
        outline: none;
        border-color: $button-primary-background;
        box-shadow: 0 0 0 3px rgba(69, 75, 96, 0.1);
      }

      &::placeholder {
        color: $text-tertiary;
        opacity: 0.6;
      }
    }
  }

  .error-message {
    padding: 0.75rem;
    background-color: #fee2e2;
    border: 1px solid #fca5a5;
    border-radius: $box-border-radius-small;
    color: #991b1b;
    font-size: 0.875rem;
    font-weight: $font-weight-medium;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 0.5rem;

    .btn {
      padding: 0.625rem 1.25rem;
      border: none;
      border-radius: $box-border-radius-small;
      font-family: $primary-font;
      font-size: 0.875rem;
      font-weight: $font-weight-semibold;
      cursor: pointer;
      transition: all 0.2s ease;

      &.btn-cancel {
        background-color: #f3f4f6;
        color: $text-primary;

        &:hover {
          background-color: #e5e7eb;
        }

        &:active {
          background-color: #d1d5db;
        }
      }

      &.btn-submit {
        background-color: $button-primary-background;
        color: white;

        &:hover {
          background-color: darken($button-primary-background, 5%);
        }

        &:active {
          background-color: darken($button-primary-background, 10%);
        }
      }
    }
  }
}

```
--- END OF FILE: src\app\components\add-lab-value-modal\add-lab-value-modal.component.scss ---

--- START OF FILE: src\app\components\add-lab-value-modal\add-lab-value-modal.component.ts ---
```typescript
import { Component, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { TranslocoModule } from '@jsverse/transloco';

export interface LabValueData {
  name: string;
  value: number;
  unit: string;
}

@Component({
  selector: 'app-add-lab-value-modal',
  standalone: true,
  imports: [CommonModule, FormsModule, TranslocoModule],
  templateUrl: './add-lab-value-modal.component.html',
  styleUrls: ['./add-lab-value-modal.component.scss']
})
export class AddLabValueModalComponent {
  @Output() close = new EventEmitter<void>();
  @Output() labValueAdded = new EventEmitter<LabValueData>();

  name = '';
  value: number | null = null;
  unit = '';
  errorMessage = '';

  onCancel() {
    this.close.emit();
  }

  onSubmit() {
    // Validation
    if (!this.name.trim()) {
      this.errorMessage = 'Please enter a name for the lab value.';
      return;
    }

    if (this.value === null || this.value === undefined) {
      this.errorMessage = 'Please enter a value.';
      return;
    }

    if (!this.unit.trim()) {
      this.errorMessage = 'Please enter a unit.';
      return;
    }

    // Emit the lab value data
    this.labValueAdded.emit({
      name: this.name.trim(),
      value: this.value,
      unit: this.unit.trim()
    });

    // Close modal
    this.close.emit();
  }
}

```
--- END OF FILE: src\app\components\add-lab-value-modal\add-lab-value-modal.component.ts ---

--- START OF FILE: src\app\components\analysis-medication-item\analysis-medication-item.component.html ---
```typescript
<div class="analysis-medication-item">
  <app-medication-item
    [medication]="medication"
    [expandable]="false"
    (medicationDeleted)="onMedicationDeleted($event)"
    (editRequested)="onEditRequested($event)">
  </app-medication-item>
</div>

```
--- END OF FILE: src\app\components\analysis-medication-item\analysis-medication-item.component.html ---

--- START OF FILE: src\app\components\analysis-medication-item\analysis-medication-item.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.analysis-medication-item {
  display: block;
  position: relative;
  
  .doses-per-day {
    position: absolute;
    bottom: 0.5rem;
    right: 10rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--primary-color);
    background: rgba(255, 255, 255, 0.9);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    z-index: 10;
  }
  
  ::ng-deep .medication-item {
    height: 4.5rem; // Fixed height to align with schema rows
    margin-bottom: 1rem;
    
    .medication-header {
      height: 100%;
      overflow: hidden;
      pointer-events: none !important;
      cursor: default !important;
      // Drastically reduce padding to fit content
      padding: 0.6rem 0.75rem !important;
    }
    
    // Re-enable pointer events for action buttons
    .action-buttons {
      pointer-events: auto !important;
    }
    
    // Allow header content to flow naturally
    .header-content {
      display: block !important;
      width: 100%;
    }
    
    .medication-name {
      font-size: 0.9rem !important;
      font-weight: 700 !important;
      margin-bottom: 0.25rem !important;
      line-height: 1.2 !important;
      
      /* Force single line for name to save vertical space */
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      display: block !important;
      width: 100%;
    }
    
    .medication-codes {
      display: none !important; // Hide CNK and VMP codes
    }
    
    /* Make Frequency and Indication display inline to save space if needed, or just compact blocks */
    
    .header-frequency {
      display: inline-block !important;
      margin-top: 0 !important;
      margin-right: 0.5rem !important;
      vertical-align: middle !important;
      font-size: 0.7rem !important;
    }

    .as-needed-badge {
      display: inline-block !important;
      margin-top: 0 !important;
      margin-right: 0.5rem !important;
      vertical-align: middle !important;
      font-size: 0.7rem !important;
    }

    .medication-indication {
      display: inline-block !important;
      font-size: 0.75rem !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      max-width: 140px !important; /* Prevent it from pushing layout too wide */
      opacity: 0.95 !important;
      visibility: visible !important;
      margin-top: 0 !important;
      vertical-align: middle !important;
      color: #15803d !important; /* Distinct green color */
      font-style: italic !important;
      line-height: 1.2 !important;
    }
    
    .medication-details {
      display: none !important;
    }
  }
}
```
--- END OF FILE: src\app\components\analysis-medication-item\analysis-medication-item.component.scss ---

--- START OF FILE: src\app\components\analysis-medication-item\analysis-medication-item.component.ts ---
```typescript
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { MedicationItemComponent, Medication } from '../medication-item/medication-item.component';

@Component({
  selector: 'app-analysis-medication-item',
  standalone: true,
  imports: [MedicationItemComponent],
  templateUrl: './analysis-medication-item.component.html',
  styleUrls: ['./analysis-medication-item.component.scss']
})
export class AnalysisMedicationItemComponent {
  @Input() medication!: Medication;
  @Output() medicationDeleted = new EventEmitter<string>();
  @Output() editRequested = new EventEmitter<Medication>();

  get dosesPerDay(): number {
    const doses = [
      this.medication.unitsBeforeBreakfast,
      this.medication.unitsDuringBreakfast,
      this.medication.unitsBeforeLunch,
      this.medication.unitsDuringLunch,
      this.medication.unitsBeforeDinner,
      this.medication.unitsDuringDinner,
      this.medication.unitsAtBedtime
    ];
    
    return doses.reduce((sum: number, dose) => sum + (dose ?? 0), 0);
  }

  onMedicationDeleted(medicationId: string) {
    this.medicationDeleted.emit(medicationId);
  }

  onEditRequested(medication: Medication) {
    this.editRequested.emit(medication);
  }
}

```
--- END OF FILE: src\app\components\analysis-medication-item\analysis-medication-item.component.ts ---

--- START OF FILE: src\app\components\analysis-toolbar\analysis-toolbar.component.html ---
```typescript
<aside class="toolbar">
  <div 
  *ngFor="let tool of tools" 
    class="tool-item" 
    (click)="onToolClick(tool.id)" 
    [class.active]="activeTool === tool.id">
    <div class="tool-icon">
      @switch (tool.icon) {
        @case ('grid') {
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
            <line x1="3" y1="9" x2="21" y2="9" stroke="currentColor" stroke-width="2"/>
            <line x1="3" y1="15" x2="21" y2="15" stroke="currentColor" stroke-width="2"/>
            <line x1="9" y1="9" x2="9" y2="21" stroke="currentColor" stroke-width="2"/>
          </svg>
        }
        @case ('clock-pill') {
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
            <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <ellipse cx="18" cy="18" rx="4" ry="2.5" fill="currentColor"/>
          </svg>
        }
        @case ('pills-warning') {
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="8" cy="12" rx="4" ry="6" stroke="currentColor" stroke-width="2"/>
            <ellipse cx="16" cy="12" rx="4" ry="6" stroke="currentColor" stroke-width="2"/>
            <path d="M12 4l-1 3h2l-1 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        }
        @case ('person-warning') {
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/>
            <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2"/>
            <path d="M12 12l4 4m0-4l-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        }
        @case ('pill-times') {
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="12" cy="12" rx="5" ry="8" stroke="currentColor" stroke-width="2"/>
            <text x="18" y="10" font-size="8" fill="currentColor" font-weight="bold">2√ó</text>
          </svg>
        }
        @case ('kidney') {
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 3v3a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V3" stroke="currentColor" stroke-width="2"/>
            <path d="M6 8h12a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="2"/>
            <path d="M8 12h8M8 16h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        }
        @case ('shield-plus') {
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L2 7v10c0 5.5 4.5 9 10 9s10-3.5 10-9V7l-10-5z" stroke="currentColor" stroke-width="2"/>
            <path d="M12 8v8M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        }
        @case ('play-stop') {
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <polygon points="6,4 6,20 18,12" fill="currentColor"/>
            <rect x="18" y="4" width="2" height="16" fill="currentColor"/>
          </svg>
        }
        @case ('document') {
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z" stroke="currentColor" stroke-width="2"/>
            <path d="M14 2v6h6M9 13h6M9 17h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        }
      }
    </div>
    <div class="tool-label">{{ tool.label | transloco }}</div>
  </div>
</aside>

```
--- END OF FILE: src\app\components\analysis-toolbar\analysis-toolbar.component.html ---

--- START OF FILE: src\app\components\analysis-toolbar\analysis-toolbar.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.toolbar {
  width: 9vh; // Same width as header height
  height: calc(100vh - 7vh); // Match the analysis page height
  background-color: $button-primary;
  box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
  flex-shrink: 0;
  z-index: 100;
  display: flex;
  flex-direction: column;
  justify-content: space-evenly;
  padding: 1rem 0;
  position: fixed;
  top: 7vh;
  left: 0;

  .tool-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0.5rem;
    transition: all 0.2s ease;
    opacity: 0.7;
    border-left: 3px solid transparent;

    &:hover {
      opacity: 1;
      background-color: rgba(255, 255, 255, 0.1);
    }

    &.active {
      opacity: 1;
      background-color: rgba(255, 255, 255, 0.2);
      border-left-color: white;
    }

    .tool-icon {
      color: white;
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;

      svg {
        width: 24px;
        height: 24px;
      }
    }

    .tool-label {
      color: white;
      font-family: $primary-font;
      font-weight: $font-weight-thin;
      font-size: 0.6rem;
      text-align: center;
      line-height: 1.1;
      max-width: 100%;
      word-wrap: break-word;
    }
  }
}

```
--- END OF FILE: src\app\components\analysis-toolbar\analysis-toolbar.component.scss ---

--- START OF FILE: src\app\components\analysis-toolbar\analysis-toolbar.component.ts ---
```typescript
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';

export type ToolType = 
  | 'medication-schema' 
  | 'therapy-adherence' 
  | 'interactions' 
  | 'contra-indications' 
  | 'posology' 
  | 'renadapter' 
  | 'gheops' 
  | 'start-stop-nl' 
  | 'questionnaire';

export interface ToolItem {
  id: ToolType;
  label: string;
  icon: string; // SVG path data
}

@Component({
  selector: 'app-analysis-toolbar',
  standalone: true,
  imports: [CommonModule, TranslocoModule],
  templateUrl: './analysis-toolbar.component.html',
  styleUrls: ['./analysis-toolbar.component.scss']
})
export class AnalysisToolbarComponent {
  @Input() activeTool: ToolType | null = null;
  @Output() toolSelected = new EventEmitter<ToolType>();

  tools: ToolItem[] = [
    {
      id: 'medication-schema',
      label: 'tools.medication_schema',
      icon: 'grid'
    },
    {
      id: 'therapy-adherence',
      label: 'tools.therapy_adherence',
      icon: 'clock-pill'
    },
    {
      id: 'interactions',
      label: 'tools.interactions',
      icon: 'pills-warning'
    },
    {
      id: 'contra-indications',
      label: 'tools.contraindications',
      icon: 'person-warning'
    },
    {
      id: 'posology',
      label: 'tools.posology',
      icon: 'pill-times'
    },
    {
      id: 'renadapter',
      label: 'tools.renadaptor',
      icon: 'kidney'
    },
    {
      id: 'gheops',
  label: 'tools.gheops',
      icon: 'shield-plus'
    },
    {
      id: 'start-stop-nl',
      label: 'tools.start_stop',
      icon: 'play-stop'
    },
    {
      id: 'questionnaire',
      label: 'tools.questionnaire',
      icon: 'document'
    }
  ];

  onToolClick(toolId: ToolType) {
    this.toolSelected.emit(toolId);
  }
}

```
--- END OF FILE: src\app\components\analysis-toolbar\analysis-toolbar.component.ts ---

--- START OF FILE: src\app\components\cnk-selection-modal\cnk-selection-modal.component.html ---
```typescript
<div class="modal-overlay" (click)="onCancel()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ 'medication.select_cnk' | transloco }}</h2>
      <button class="close-button" (click)="onCancel()">&times;</button>
    </div>

    <div class="modal-body">
      <div class="medication-info">
        <strong>{{ medication.medicationName }}</strong>
        <span *ngIf="medication.indication" class="indication">{{ medication.indication }}</span>
      </div>

      <p class="instruction">{{ 'medication.select_cnk_instruction' | transloco }}</p>

      <div class="matches-list">
        <div 
          *ngFor="let match of medication.matches" 
          class="match-item"
          (click)="selectMedication(match)">
          <div class="match-name">{{ match.benaming }}</div>
          <div class="match-details">
            <span class="cnk-badge">CNK: {{ match.cnk }}</span>
            <span class="package-info">{{ match.verpakking }}</span>
            <span *ngIf="match.vmp" class="vmp-info">VMP: {{ match.vmp }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="skip-button" (click)="skipMedication()">
        {{ 'medication.skip_medication' | transloco }}
      </button>
      <button class="cancel-button" (click)="onCancel()">
        {{ 'common.cancel' | transloco }}
      </button>
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\components\cnk-selection-modal\cnk-selection-modal.component.html ---

--- START OF FILE: src\app\components\cnk-selection-modal\cnk-selection-modal.component.scss ---
```typescript
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 8px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
  padding: 20px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;

  h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #333;
  }

  .close-button {
    background: none;
    border: none;
    font-size: 28px;
    color: #666;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    
    &:hover {
      color: #333;
    }
  }
}

.modal-body {
  padding: 20px;
  overflow-y: auto;
  flex: 1;

  .medication-info {
    margin-bottom: 16px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 6px;

    strong {
      display: block;
      font-size: 16px;
      color: #333;
      margin-bottom: 4px;
    }

    .indication {
      display: block;
      font-size: 14px;
      color: #666;
      font-style: italic;
    }
  }

  .instruction {
    margin-bottom: 16px;
    color: #555;
    font-size: 14px;
  }

  .matches-list {
    display: flex;
    flex-direction: column;
    gap: 8px;

    .match-item {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;

      &:hover {
        border-color: #2196F3;
        background: #f0f8ff;
      }

      .match-name {
        font-size: 15px;
        font-weight: 500;
        color: #333;
        margin-bottom: 6px;
      }

      .match-details {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        font-size: 13px;

        .cnk-badge {
          background: #2196F3;
          color: white;
          padding: 2px 8px;
          border-radius: 12px;
          font-weight: 500;
        }

        .package-info {
          color: #666;
        }

        .vmp-info {
          color: #888;
          font-size: 12px;
        }
      }
    }
  }
}

.modal-footer {
  padding: 16px 20px;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: flex-end;
  gap: 12px;

  button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .skip-button {
    background: #ff9800;
    color: white;

    &:hover {
      background: #f57c00;
    }
  }

  .cancel-button {
    background: #f5f5f5;
    color: #666;

    &:hover {
      background: #e0e0e0;
    }
  }
}

```
--- END OF FILE: src\app\components\cnk-selection-modal\cnk-selection-modal.component.scss ---

--- START OF FILE: src\app\components\cnk-selection-modal\cnk-selection-modal.component.ts ---
```typescript
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';
import { MedicationSearchResult } from '../../models/api.models';

export interface MedicationWithMatches {
  medicationName: string;
  indication?: string;
  asNeeded?: boolean;
  unitsBeforeBreakfast?: number;
  unitsDuringBreakfast?: number;
  unitsBeforeLunch?: number;
  unitsDuringLunch?: number;
  unitsBeforeDinner?: number;
  unitsDuringDinner?: number;
  unitsAtBedtime?: number;
  matches: MedicationSearchResult[];
}

@Component({
  selector: 'app-cnk-selection-modal',
  standalone: true,
  imports: [CommonModule, TranslocoModule],
  templateUrl: './cnk-selection-modal.component.html',
  styleUrls: ['./cnk-selection-modal.component.scss']
})
export class CnkSelectionModalComponent {
  @Input() medication!: MedicationWithMatches;
  @Output() close = new EventEmitter<void>();
  @Output() medicationSelected = new EventEmitter<MedicationSearchResult>();
  @Output() skip = new EventEmitter<void>();

  selectMedication(match: MedicationSearchResult) {
    console.log('[CnkSelectionModal] Medication selected:', match);
    this.medicationSelected.emit(match);
  }

  skipMedication() {
    console.log('[CnkSelectionModal] Skip medication:', this.medication.medicationName);
    this.skip.emit();
  }

  onCancel() {
    this.close.emit();
  }
}

```
--- END OF FILE: src\app\components\cnk-selection-modal\cnk-selection-modal.component.ts ---

--- START OF FILE: src\app\components\confirmation-modal\confirmation-modal.component.html ---
```typescript
<div class="modal-backdrop" (click)="onBackdropClick($event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">{{ title }}</h3>
    </div>
    <div class="modal-body">
      <p class="modal-message">{{ message }}</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="onCancel()">{{ cancelText }}</button>
      <button class="btn btn-confirm" (click)="onConfirm()">{{ confirmText }}</button>
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\components\confirmation-modal\confirmation-modal.component.html ---

--- START OF FILE: src\app\components\confirmation-modal\confirmation-modal.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.2s ease;

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
}

.modal-content {
  background-color: $box-background;
  border-radius: $box-border-radius;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  max-width: 400px;
  width: 90%;
  animation: slideUp 0.2s ease;

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
}

.modal-header {
  padding: 1.5rem 1.5rem 1rem 1.5rem;
  border-bottom: 1px solid #e8e8e8;

  .modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: $font-weight-bold;
    color: $text-primary;
  }
}

.modal-body {
  padding: 1.5rem;

  .modal-message {
    margin: 0;
    font-size: 0.9375rem;
    color: $text-secondary;
    line-height: 1.5;
  }
}

.modal-footer {
  padding: 1rem 1.5rem 1.5rem 1.5rem;
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;

  .btn {
    padding: 0.625rem 1.25rem;
    border: none;
    border-radius: $box-border-radius-small;
    font-family: $primary-font;
    font-size: 0.875rem;
    font-weight: $font-weight-semibold;
    cursor: pointer;
    transition: all 0.2s ease;

    &.btn-cancel {
      background-color: #f3f4f6;
      color: $text-primary;

      &:hover {
        background-color: #e5e7eb;
      }

      &:active {
        background-color: #d1d5db;
      }
    }

    &.btn-confirm {
      background-color: #dc2626;
      color: white;

      &:hover {
        background-color: #b91c1c;
      }

      &:active {
        background-color: #991b1b;
      }
    }
  }
}

```
--- END OF FILE: src\app\components\confirmation-modal\confirmation-modal.component.scss ---

--- START OF FILE: src\app\components\confirmation-modal\confirmation-modal.component.ts ---
```typescript
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';

@Component({
  selector: 'app-confirmation-modal',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './confirmation-modal.component.html',
  styleUrls: ['./confirmation-modal.component.scss']
})
export class ConfirmationModalComponent {
  @Input() title: string = 'Confirm Action';
  @Input() message: string = 'Are you sure you want to proceed?';
  @Input() confirmText: string = 'Confirm';
  @Input() cancelText: string = 'Cancel';
  @Output() confirm = new EventEmitter<void>();
  @Output() cancel = new EventEmitter<void>();

  onConfirm() {
    this.confirm.emit();
  }

  onCancel() {
    this.cancel.emit();
  }

  onBackdropClick(event: MouseEvent) {
    // Close modal if clicking on the backdrop (not the modal content)
    if (event.target === event.currentTarget) {
      this.onCancel();
    }
  }
}

```
--- END OF FILE: src\app\components\confirmation-modal\confirmation-modal.component.ts ---

--- START OF FILE: src\app\components\contra-indications\contra-indications.component.html ---
```typescript
<div class="contra-indications-box">
  <div class="header">
  <h3 class="box-title">{{ 'header.contraindications' | transloco }}</h3>
  <button class="add-button" (click)="addContraIndication()" [title]="'header.add_contraindication' | transloco">
      <span class="plus-icon">+</span> Add
    </button>
  </div>
  
  <div class="list-container">
    <div *ngIf="isLoading" class="loading">Loading...</div>
    
    <ul class="items-list" *ngIf="!isLoading && contraIndications.length > 0">
      <li *ngFor="let item of contraIndications" class="contraindication-item">
        <span class="item-name">
          <span class="item-code">[{{ item.contraindicationCode }}]</span>
          {{ item.name }}
        </span>
        <button class="delete-button" (click)="deleteContraindication(item)" title="Delete">
          &times;
        </button>
      </li>
    </ul>

    <div *ngIf="!isLoading && contraIndications.length === 0" class="empty-state">
  {{ 'tools.no_data' | transloco }}. {{ 'ui.plus_add' | transloco }}
    </div>
  </div>
</div>

<!-- Modal -->
<app-contraindication-modal 
  *ngIf="showModal" 
  (close)="onModalClose()" 
  (saved)="onModalSaved()"
></app-contraindication-modal>


```
--- END OF FILE: src\app\components\contra-indications\contra-indications.component.html ---

--- START OF FILE: src\app\components\contra-indications\contra-indications.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.contra-indications-box {
  background-color: $box-background;
  border: $box-border-width solid $box-border-primary;
  border-radius: $box-border-radius;
  padding: 1.5rem;
  margin-bottom: 1.5rem;

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;

    .box-title {
      font-size: 1.2rem;
      margin: 0;
      color: $text-primary;
    }

    .add-button {
      padding: 0.5rem 1rem;
      background-color: $button-primary;
      color: $text-button-primary;
      border: $box-border-width solid $box-border-primary;
      border-radius: $box-border-radius;
      font-family: $primary-font;
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background-color 0.2s ease;

      &:hover {
        background-color: $button-primary-hover;
      }

      .plus-icon {
        font-size: 1.2rem;
        font-weight: bold;
      }
    }
  }

  .list-container {
    .loading {
      text-align: center;
      padding: 1rem;
      color: $text-primary;
      font-family: $primary-font;
      font-style: italic;
    }

    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: #999;
      font-family: $primary-font;
      font-style: italic;
      font-size: 0.875rem;
    }

    .items-list {
      list-style: none;
      padding: 0;
      margin: 0;

      .contraindication-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background-color: $main-background;
        border-radius: 4px;
        font-size: 0.875rem;
        color: $text-primary;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s;

        &:hover {
          background-color: #f5f5f5;
        }

        .item-name {
          flex: 1;
          display: flex;
          align-items: center;
          gap: 0.5rem;

          .item-code {
            color: #666;
            font-weight: 600;
            font-size: 0.75rem;
          }
        }

        .delete-button {
          background: none;
          border: none;
          color: #999;
          font-size: 1.5rem;
          cursor: pointer;
          padding: 0;
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: color 0.2s;

          &:hover {
            color: #c00;
          }
        }
      }
    }
  }
}

```
--- END OF FILE: src\app\components\contra-indications\contra-indications.component.scss ---

--- START OF FILE: src\app\components\contra-indications\contra-indications.component.ts ---
```typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';
import { ContraindicationModalComponent } from '../contraindication-modal/contraindication-modal.component';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { Contraindication } from '../../models/api.models';

@Component({
  selector: 'app-contra-indications',
  standalone: true,
  imports: [CommonModule, ContraindicationModalComponent, TranslocoModule],
  templateUrl: './contra-indications.component.html',
  styleUrls: ['./contra-indications.component.scss']
})
export class ContraIndicationsComponent implements OnInit {
  contraIndications: Contraindication[] = [];
  showModal = false;
  isLoading = false;

  constructor(
    private apiService: ApiService,
    private stateService: StateService
  ) {}

  ngOnInit() {
    this.loadContraindications();
  }

  loadContraindications() {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      this.contraIndications = [];
      return;
    }

    this.isLoading = true;
    this.apiService.getContraindications(medicationReviewId).subscribe({
      next: (contraindications) => {
        this.contraIndications = contraindications;
        this.isLoading = false;
      },
      error: (error) => {
        console.error('[ContraIndications] Failed to load:', error);
        this.contraIndications = [];
        this.isLoading = false;
      }
    });
  }

  addContraIndication() {
    this.showModal = true;
  }

  onModalClose() {
    this.showModal = false;
  }

  onModalSaved() {
    // Reload contraindications after saving
    this.loadContraindications();
    // Notify other components
    this.stateService.notifyContraindicationsChanged();
  }

  deleteContraindication(contraindication: Contraindication) {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      return;
    }
    
    this.apiService.deleteContraindication(medicationReviewId, contraindication.contraindicationId).subscribe({
      next: () => {
        this.loadContraindications();
        // Notify other components
        this.stateService.notifyContraindicationsChanged();
      },
      error: (error) => {
        console.error('[ContraIndications] Delete failed:', error);
        alert('Failed to delete contraindication. Please try again.');
      }
    });
  }
}

```
--- END OF FILE: src\app\components\contra-indications\contra-indications.component.ts ---

--- START OF FILE: src\app\components\contraindication-modal\contraindication-modal.component.html ---
```typescript
<div class="modal-overlay" (click)="onCancel()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ 'modals.add_contraindications' | transloco }}</h2>
      <button class="close-button" (click)="onCancel()">&times;</button>
    </div>

    <div class="modal-body">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">
        <p>{{ 'modals.loading_contraindications' | transloco }}</p>
      </div>

      <!-- Error State -->
      <div *ngIf="errorMessage && !isLoading" class="error-message">
        {{ errorMessage }}
      </div>

      <!-- Content -->
      <div *ngIf="!isLoading && !errorMessage">
        <!-- Search and Filter -->
        <div class="filter-section">
          <input 
            type="text" 
            class="search-input" 
            placeholder="{{ 'modals.search_contraindications_placeholder' | transloco }}" 
            [value]="searchTerm"
            (input)="onSearchChange($event)"
          />

          <div class="category-filters">
            <button 
              class="filter-button" 
              [class.active]="selectedCategory === 'all'"
              (click)="onCategoryChange('all')"
            >
              {{ 'modals.filter_all' | transloco }}
            </button>
            <button 
              class="filter-button" 
              [class.active]="selectedCategory === 'hypersensitivity'"
              (click)="onCategoryChange('hypersensitivity')"
            >
              {{ 'modals.filter_hypersensitivities' | transloco }}
            </button>
            <button 
              class="filter-button" 
              [class.active]="selectedCategory === 'pathology'"
              (click)="onCategoryChange('pathology')"
            >
              {{ 'modals.filter_pathologies' | transloco }}
            </button>
            <button 
              class="filter-button" 
              [class.active]="selectedCategory === 'physiologicalCondition'"
              (click)="onCategoryChange('physiologicalCondition')"
            >
              {{ 'modals.filter_physiological_conditions' | transloco }}
            </button>
          </div>
        </div>

        <!-- Contraindications List -->
        <div class="contraindications-list">
          <div 
            *ngFor="let item of filteredContraindications" 
            class="contraindication-item"
            [class.selected]="item.selected"
            (click)="toggleSelection(item)"
          >
            <input 
              type="checkbox" 
              [checked]="item.selected"
              (click)="$event.stopPropagation()"
            />
            <div class="item-content">
              <span class="item-name">
                <span class="item-code">[{{ item.code }}]</span>
                {{ item.name }}
              </span>
              <span class="item-category">{{ getCategoryLabel(item.category) }}</span>
            </div>
          </div>

          <div *ngIf="filteredContraindications.length === 0" class="no-results">
            {{ 'modals.no_contraindications_found' | transloco }}
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <div class="selected-count">
        {{ getSelectedCount() }} {{ 'modals.selected' | transloco }}
      </div>
      <div class="footer-buttons">
        <button class="cancel-button" (click)="onCancel()" [disabled]="isSaving">
          {{ 'common.cancel' | transloco }}
        </button>
        <button class="save-button" (click)="onSave()" [disabled]="isSaving || getSelectedCount() === 0">
          {{ isSaving ? ('common.loading' | transloco) : ('modals.add_selected' | transloco) }}
        </button>
      </div>
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\components\contraindication-modal\contraindication-modal.component.html ---

--- START OF FILE: src\app\components\contraindication-modal\contraindication-modal.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-container {
  background-color: white;
  border: $box-border-width solid $box-border-primary;
  border-radius: $box-border-radius;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: $box-border-width solid $box-border-primary;

  h2 {
    margin: 0;
    font-family: $primary-font;
    font-weight: $font-weight-thin;
    font-size: 24px;
    color: $button-primary;
  }

  .close-button {
    background: none;
    border: none;
    font-size: 32px;
    color: $button-primary;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;

    &:hover {
      opacity: 0.7;
    }
  }
}

.modal-body {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}

.loading-state {
  text-align: center;
  padding: 40px;
  color: $button-primary;
  font-family: $primary-font;
}

.error-message {
  background-color: #fee;
  border: $box-border-width solid #fcc;
  border-radius: $box-border-radius;
  padding: 15px;
  color: #c00;
  font-family: $primary-font;
  margin-bottom: 20px;
}

.filter-section {
  margin-bottom: 20px;

  .search-input {
    width: 100%;
    padding: 10px;
    border: $box-border-width solid $box-border-primary;
    border-radius: $box-border-radius;
    font-family: $primary-font;
    font-size: 14px;
    margin-bottom: 15px;

    &:focus {
      outline: none;
      border-color: $button-primary;
    }
  }

  .category-filters {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;

    .filter-button {
      padding: 8px 16px;
      border: $box-border-width solid $box-border-primary;
      border-radius: $box-border-radius;
      background-color: white;
      color: $button-primary;
      font-family: $primary-font;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;

      &:hover {
        background-color: #f5f5f5;
      }

      &.active {
        background-color: $button-primary;
        color: white;
        border-color: $button-primary;
      }
    }
  }
}

.contraindications-list {
  max-height: 400px;
  overflow-y: auto;
  border: $box-border-width solid $box-border-primary;
  border-radius: $box-border-radius;
  padding: 10px;

  .contraindication-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-bottom: $box-border-width solid #e0e0e0;
    cursor: pointer;
    transition: background-color 0.2s;

    &:last-child {
      border-bottom: none;
    }

    &:hover {
      background-color: #f9f9f9;
    }

    &.selected {
      background-color: #e8f4f8;
    }

    input[type="checkbox"] {
      margin-right: 12px;
      cursor: pointer;
      width: 18px;
      height: 18px;
    }

    .item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;

      .item-name {
        font-family: $primary-font;
        font-weight: $font-weight-regular;
        color: $button-primary;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;

        .item-code {
          color: #666;
          font-weight: $font-weight-semibold;
          font-size: 12px;
          flex-shrink: 0;
        }
      }

      .item-category {
        font-family: $primary-font;
        font-size: 12px;
        color: #666;
        font-style: italic;
      }
    }
  }

  .no-results {
    text-align: center;
    padding: 40px;
    color: #999;
    font-family: $primary-font;
    font-style: italic;
  }
}

.modal-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-top: $box-border-width solid $box-border-primary;

  .selected-count {
    font-family: $primary-font;
    color: $button-primary;
    font-weight: $font-weight-medium;
  }

  .footer-buttons {
    display: flex;
    gap: 10px;

    button {
      padding: 10px 20px;
      border: $box-border-width solid $box-border-primary;
      border-radius: $box-border-radius;
      font-family: $primary-font;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;

      &:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    }

    .cancel-button {
      background-color: white;
      color: $button-primary;

      &:hover:not(:disabled) {
        background-color: #f5f5f5;
      }
    }

    .save-button {
      background-color: $button-primary;
      color: white;
      border-color: $button-primary;

      &:hover:not(:disabled) {
        opacity: 0.9;
      }
    }
  }
}

```
--- END OF FILE: src\app\components\contraindication-modal\contraindication-modal.component.scss ---

--- START OF FILE: src\app\components\contraindication-modal\contraindication-modal.component.ts ---
```typescript
import { Component, OnInit, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { APBContraindicationItem } from '../../models/api.models';
import { forkJoin } from 'rxjs';

interface ContraindicationSelection {
  code: string;
  name: string;
  category: 'hypersensitivity' | 'pathology' | 'physiologicalCondition';
  selected: boolean;
}

@Component({
  selector: 'app-contraindication-modal',
  standalone: true,
  imports: [CommonModule, TranslocoModule],
  templateUrl: './contraindication-modal.component.html',
  styleUrls: ['./contraindication-modal.component.scss']
})
export class ContraindicationModalComponent implements OnInit {
  @Output() close = new EventEmitter<void>();
  @Output() saved = new EventEmitter<void>();

  isLoading = true;
  isSaving = false;
  errorMessage = '';
  
  contraindications: ContraindicationSelection[] = [];
  filteredContraindications: ContraindicationSelection[] = [];
  searchTerm = '';
  selectedCategory: 'all' | 'hypersensitivity' | 'pathology' | 'physiologicalCondition' = 'all';

  constructor(
    private apiService: ApiService,
    private stateService: StateService
  ) {}

  ngOnInit() {
    this.loadContraindications();
  }

  loadContraindications() {
    this.isLoading = true;
    this.errorMessage = '';

    this.apiService.getAPBContraindications({ language: 'NL' }).subscribe({
      next: (response) => {
        const selections: ContraindicationSelection[] = [];

        response.result.hypersensitivities.list.forEach(item => {
          selections.push({
            code: item.code,
            name: item.description,
            category: 'hypersensitivity',
            selected: false
          });
        });

        response.result.pathologies.list.forEach(item => {
          selections.push({
            code: item.code,
            name: item.description,
            category: 'pathology',
            selected: false
          });
        });

        response.result.physiologicalConditions.list.forEach(item => {
          selections.push({
            code: item.code,
            name: item.description,
            category: 'physiologicalCondition',
            selected: false
          });
        });

        this.contraindications = selections;
        this.applyFilters();
        this.isLoading = false;
      },
      error: (error) => {
        console.error('[ContraindicationModal] Failed to load:', error);
        this.errorMessage = 'Failed to load contraindications from APB. Please try again.';
        this.isLoading = false;
      }
    });
  }

  applyFilters() {
    let filtered = this.contraindications;

    // Filter by category
    if (this.selectedCategory !== 'all') {
      filtered = filtered.filter(c => c.category === this.selectedCategory);
    }

    // Filter by search term
    if (this.searchTerm.trim()) {
      const search = this.searchTerm.toLowerCase();
      filtered = filtered.filter(c => 
        c.name.toLowerCase().includes(search) || 
        c.code.toLowerCase().includes(search)
      );
    }

    this.filteredContraindications = filtered;
  }

  onSearchChange(event: Event) {
    this.searchTerm = (event.target as HTMLInputElement).value;
    this.applyFilters();
  }

  onCategoryChange(category: 'all' | 'hypersensitivity' | 'pathology' | 'physiologicalCondition') {
    this.selectedCategory = category;
    this.applyFilters();
  }

  toggleSelection(contraindication: ContraindicationSelection) {
    contraindication.selected = !contraindication.selected;
  }

  getSelectedCount(): number {
    return this.contraindications.filter(c => c.selected).length;
  }

  getCategoryLabel(category: string): string {
    switch(category) {
      case 'hypersensitivity': return 'Hypersensitivity';
      case 'pathology': return 'Pathology';
      case 'physiologicalCondition': return 'Physiological Condition';
      default: return category;
    }
  }

  onCancel() {
    this.close.emit();
  }

  onSave() {
    const selected = this.contraindications.filter(c => c.selected);
    
    if (selected.length === 0) {
      this.close.emit();
      return;
    }

    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      this.errorMessage = 'No medication review selected';
      return;
    }

    this.isSaving = true;
    this.errorMessage = '';

    // Create array of add requests
    const addRequests = selected.map(item => 
      this.apiService.addContraindication(
        medicationReviewId,
        {
          name: item.name,
          contraindicationCode: item.code
        }
      )
    );

    // Execute all requests in parallel
    forkJoin(addRequests).subscribe({
      next: (responses) => {
        this.isSaving = false;
        this.saved.emit();
        this.close.emit();
      },
      error: (error) => {
        console.error('[ContraindicationModal] Save failed:', error);
        this.errorMessage = 'Failed to save contraindications. Please try again.';
        this.isSaving = false;
      }
    });
  }
}

```
--- END OF FILE: src\app\components\contraindication-modal\contraindication-modal.component.ts ---

--- START OF FILE: src\app\components\contraindications\contraindications.component.html ---
```typescript
<div class="contraindications-container">
  @if (loading) {
    <div class="loading-state">
      <p>{{ 'contraindications.checking' | transloco }}</p>
    </div>
  } @else if (error) {
    <div class="error-state">
      <p class="error-message">{{ error }}</p>
      <button class="retry-button" (click)="loadData()">{{ 'common.retry' | transloco }}</button>
    </div>
  } @else {
    <div class="contraindications-content">
      <!-- General note button (top right) -->
      <button class="add-note-button general-note floating-top-right" (click)="openGeneralNotesModal()" title="Add general note">
        +
      </button>

      <!-- Type 1: Contraindication Matches (Patient Conditions vs Medications) -->
      <div class="contraindications-section">
        <div class="section-header">
          <h2>{{ 'tools.patient_contraindications' | transloco }}</h2>
          <span class="count-badge">{{ getFilteredMatches().length }}</span>
        </div>
        <p class="section-description">{{ 'tools.contraindications_based_on_conditions' | transloco }}</p>

        @if (getFilteredMatches().length === 0) {
          <div class="no-contraindications">
            <p>‚úì {{ 'contraindications.no_contraindications_found' | transloco }}</p>
          </div>
        } @else {
          <!-- Table Header -->
          <div class="contraindications-header">
            <div class="header-cell medication-header">{{ 'interactions.header_medication' | transloco }}</div>
            <div class="header-cell condition-header">{{ 'interactions.header_condition' | transloco }}</div>
            <div class="header-cell severity-header">{{ 'interactions.header_type' | transloco }}</div>
            <div class="header-cell description-header">{{ 'interactions.header_details' | transloco }}</div>
            <div class="header-cell notes-header">{{ 'interactions.header_notes' | transloco }}</div>
          </div>

          <div class="contraindications-list">
            @for (contraindication of getFilteredMatches(); track getUniqueKey(contraindication, $index)) {
              <div class="contraindication-row-wrapper">
                <div 
                  class="contraindication-card" 
                  [class.expanded]="expandedContraindication === getUniqueKey(contraindication, $index)"
                >
                  <div class="contraindication-row" (click)="toggleContraindication(getUniqueKey(contraindication, $index))">
                    <div class="cell medication-cell">
                      <span class="medication-name">{{ contraindication.medication || ('fallbacks.no_medication_name' | transloco) }}</span>
                      <span class="cnk-code">CNK: {{ contraindication.medicationCnk || 'NO CNK' }}</span>
                    </div>
                    <div class="cell condition-cell">
                      <span class="condition-name">{{ contraindication.condition || ('fallbacks.no_condition' | transloco) }}</span>
                      <span class="condition-code">{{ contraindication.conditionCode || 'NO CODE' }}</span>
                    </div>
                    <div class="cell severity-cell">
                      <span class="severity-badge" [class]="getSeverityClass(contraindication.appreciationCode)">
                        {{ contraindication.appreciation }}
                      </span>
                    </div>
                    <div class="cell description-cell">
                      <span class="count-badge">{{ contraindication.contraindications.length }} reason(s)</span>
                      <svg class="expand-icon" [class.rotated]="expandedContraindication === getUniqueKey(contraindication, $index)" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="cell notes-cell" (click)="$event.stopPropagation()">
                      <button class="add-note-button" (click)="openNotesModal(contraindication, 'match')" title="Add notes">
                        +
                      </button>
                    </div>
                  </div>
                  
                  @if (expandedContraindication === getUniqueKey(contraindication, $index)) {
                    <div class="contraindication-details" (click)="$event.stopPropagation()">
                      <div class="details-header">
                        <h4>Contraindication Details</h4>
                      </div>
                      <div class="details-list">
                        @for (detail of contraindication.contraindications; track detail.code) {
                          <div class="detail-item">
                            <span class="detail-code">[{{ detail.code }}]</span>
                            <span class="detail-description" [innerHTML]="formatText(detail.description)"></span>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>

      <!-- Type 2: Product Contraindications (All contraindications per medication) -->
      <div class="contraindications-section">
        <div class="section-header">
          <h2>{{ 'tools.additional_contraindications' | transloco }}</h2>
          <span class="count-badge">{{ getFilteredProductContraindications().length }}</span>
        </div>
        <p class="section-description">{{ 'tools.other_contraindications' | transloco }}</p>

        @if (getFilteredProductContraindications().length === 0) {
          <div class="no-contraindications">
            <p>‚úì No additional contraindications found</p>
          </div>
        } @else {
          <!-- Table Header -->
          <div class="contraindications-header">
            <div class="header-cell medication-header">{{ 'interactions.header_medication' | transloco }}</div>
            <div class="header-cell condition-header">{{ 'interactions.header_condition' | transloco }}</div>
            <div class="header-cell severity-header">{{ 'interactions.header_type' | transloco }}</div>
            <div class="header-cell description-header">{{ 'interactions.header_details' | transloco }}</div>
            <div class="header-cell notes-header">{{ 'interactions.header_notes' | transloco }}</div>
          </div>

          <div class="contraindications-list">
            @for (contraindication of getFilteredProductContraindications(); track getUniqueKey(contraindication, $index)) {
              <div class="contraindication-row-wrapper">
                <div 
                  class="contraindication-card" 
                  [class.expanded]="expandedContraindication === getUniqueKey(contraindication, $index)"
                >
                  <div class="contraindication-row" (click)="toggleContraindication(getUniqueKey(contraindication, $index))">
                    <div class="cell medication-cell">
                      <span class="medication-name">{{ contraindication.medicationName || ('fallbacks.no_medication_name' | transloco) }}</span>
                      <span class="cnk-code">CNK: {{ contraindication.cnk || 'NO CNK' }}</span>
                    </div>
                    <div class="cell condition-cell">
                      <span class="condition-name">{{ contraindication.condition || ('fallbacks.no_condition' | transloco) }}</span>
                      <span class="condition-code">{{ contraindication.conditionCode || 'NO CODE' }}</span>
                    </div>
                    <div class="cell severity-cell">
                      <span class="severity-badge" [class]="getSeverityClass(contraindication.appreciationCode)">
                        {{ contraindication.appreciation }}
                      </span>
                    </div>
                    <div class="cell description-cell">
                      <span class="count-badge">{{ contraindication.contraindications.length }} reason(s)</span>
                      <svg class="expand-icon" [class.rotated]="expandedContraindication === getUniqueKey(contraindication, $index)" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="cell notes-cell" (click)="$event.stopPropagation()">
                      <button class="add-note-button" (click)="openNotesModal(contraindication, 'product')" title="Add notes">
                        +
                      </button>
                    </div>
                  </div>
                  
                  @if (expandedContraindication === getUniqueKey(contraindication, $index)) {
                    <div class="contraindication-details" (click)="$event.stopPropagation()">
                      <div class="details-header">
                        <h4>Contraindication Details</h4>
                      </div>
                      <div class="details-list">
                        @for (detail of contraindication.contraindications; track detail.code) {
                          <div class="detail-item">
                            <span class="detail-code">[{{ detail.code }}]</span>
                            <span class="detail-description" [innerHTML]="formatText(detail.description)"></span>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>

```
--- END OF FILE: src\app\components\contraindications\contraindications.component.html ---

--- START OF FILE: src\app\components\contraindications\contraindications.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.contraindications-container {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

// Loading and Error States
.loading-state,
.error-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4rem 2rem;
  background-color: $box-background;
  border-radius: $box-border-radius;
  border: $box-border-width solid $box-border;

  p {
    font-family: $primary-font;
    font-size: 1.1rem;
    color: $text-secondary;
    margin: 0;
  }

  .error-message {
    color: #dc2626;
    margin-bottom: 1rem;
  }

  .retry-button {
    padding: 0.5rem 1.5rem;
    background-color: $button-primary-background;
    color: $text-button-primary;
    border: none;
    border-radius: $box-border-radius;
    font-family: $primary-font;
    font-size: 0.95rem;
    font-weight: $font-weight-medium;
    cursor: pointer;
    transition: background-color 0.2s;

    &:hover {
      background-color: $button-primary-hover;
    }
  }
}

.contraindications-content {
  display: flex;
  flex-direction: column;
  gap: 2rem;
  padding-top: 1.5rem;
  margin-top: 2.5rem;
  overflow-y: auto;
  padding-right: 0.5rem;
  position: relative;

  // Floating general note button in top right
  .floating-top-right {
    position: absolute;
    top: 0.5rem;
    right: 2rem;
    z-index: 10;
  }
}

// Section Headers
.contraindications-section {
  margin-bottom: 1rem;

  .section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;

    h2 {
      margin: 0;
      font-family: $primary-font;
      font-size: 1.5rem;
      font-weight: $font-weight-semibold;
      color: $text-primary;
    }

    .count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 2rem;
      height: 2rem;
      padding: 0 0.75rem;
      background-color: $button-primary-background;
      color: white;
      border-radius: 12px;
      font-family: $primary-font;
      font-size: 0.875rem;
      font-weight: $font-weight-semibold;
    }
  }

  .section-description {
    font-family: $primary-font;
    font-size: 0.875rem;
    color: $text-secondary;
    margin: 0 0 1rem 0;
    font-style: italic;
  }
}

// No Contraindications Message
.no-contraindications {
  background-color: lighten($medication-indication, 20%);
  border: 2px solid $medication-indication;
  border-radius: $box-border-radius;
  padding: 2rem;
  text-align: center;

  p {
    margin: 0;
    font-family: $primary-font;
    font-size: 1.1rem;
    color: darken($medication-indication, 30%);
    font-weight: $font-weight-medium;
  }
}

// Table Header
.contraindications-header {
  display: grid;
  grid-template-columns: 2fr 2fr 1fr 2fr 0.5fr;
  padding: 0.75rem 0;
  background-color: #f8f9fa;
  border: 1px solid $box-border-primary;
  border-radius: $box-border-radius-small;
  margin: 0 0 1rem 0;
  font-weight: $font-weight-semibold;
  color: $text-primary;
  font-family: $primary-font;
  flex-shrink: 0;

  .header-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    padding: 0.75rem 1rem;
  }

  .medication-header,
  .condition-header {
    justify-content: flex-start;
  }
  
  .severity-header,
  .description-header,
  .notes-header {
    justify-content: center;
  }
}

// Contraindications List
.contraindications-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  overflow: visible;
}

// Contraindication Row Wrapper
.contraindication-row-wrapper {
  display: flex;
  align-items: flex-start;
}

// Contraindication Cards
.contraindication-card {
  flex: 1;
  background-color: $box-background;
  border-radius: $box-border-radius;
  border: $box-border-width solid $box-border;
  transition: all 0.2s;
  cursor: pointer;
  overflow: hidden;

  &:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
  }

  &.expanded {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
}

// Contraindication Row
.contraindication-row {
  display: grid;
  grid-template-columns: 2fr 2fr 1fr 2fr 0.5fr;
  min-height: 4.5rem;
  align-items: center;
  cursor: pointer;

  .cell {
    padding: 0.75rem 1rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-start;
    height: 100%;
    min-width: 0; // Allow proper text overflow in grid

    &.medication-cell,
    &.condition-cell {
      gap: 0.25rem;
      align-items: flex-start;

      .medication-name,
      .condition-name {
        font-family: $primary-font;
        font-size: 0.95rem;
        font-weight: $font-weight-semibold;
        color: $text-primary;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 100%;
        display: block;
      }

      .cnk-code,
      .condition-code {
        font-family: $primary-font;
        font-size: 0.75rem;
        color: $text-tertiary;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 100%;
        display: block;
      }
    }

    &.description-cell {
      font-family: $primary-font;
      font-size: 0.875rem;
      color: $text-secondary;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;

      .count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.25rem 0.75rem;
        background-color: rgba($button-primary-background, 0.1);
        color: $button-primary-background;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: $font-weight-semibold;
      }
      
      .expand-icon {
        color: #64748b;
        transition: transform 0.2s ease;
        flex-shrink: 0;
        
        &.rotated {
          transform: rotate(180deg);
        }
      }
    }

    &.severity-cell {
      flex-direction: row;
      align-items: center;
      justify-content: center;
    }
    
    &.notes-cell {
      flex-direction: row;
      align-items: center;
      justify-content: center;
    }

    &.notes-cell {
      cursor: default;
      
      // Note buttons use global styling from _add-note-buttons.scss
    }
  }
}

// Severity Badges
.severity-badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-family: $primary-font;
  font-size: 0.75rem;
  font-weight: $font-weight-semibold;
  text-transform: uppercase;
  letter-spacing: 0.025em;
  white-space: nowrap;

  &.severity-high {
    background-color: #fee2e2;
    color: #991b1b;
  }

  &.severity-medium {
    background-color: #fed7aa;
    color: #9a3412;
  }
}

// Contraindication Details (Expandable)
.contraindication-details {
  padding: 1.5rem 2rem;
  border-top: 1px solid $box-border;
  background-color: #f8f9fa;
  animation: slideDown 0.2s ease-out;
  cursor: default;

  .details-header {
    margin-bottom: 1rem;

    h4 {
      font-family: $primary-font;
      font-size: 1rem;
      font-weight: $font-weight-semibold;
      color: $text-primary;
      margin: 0;
    }
  }

  .details-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;

    .detail-item {
      display: flex;
      gap: 0.5rem;
      align-items: flex-start;
      padding: 0.75rem;
      background-color: white;
      border-radius: 6px;
      border: 1px solid $box-border;

      .detail-code {
        font-family: $primary-font;
        font-size: 0.75rem;
        font-weight: $font-weight-semibold;
        color: $button-primary-background;
        background-color: rgba($button-primary-background, 0.1);
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .detail-description {
        font-family: $primary-font;
        font-size: 0.875rem;
        color: $text-secondary;
        line-height: 1.6;
        flex: 1;
      }
    }
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    max-height: 0;
  }
  to {
    opacity: 1;
    max-height: 1000px;
  }
}

// Responsive Design
@media (max-width: 768px) {
  .contraindications-container {
    padding: 1rem;
  }

  .contraindications-header {
    font-size: 0.75rem;
  }

  .contraindication-row {
    grid-template-columns: 1.5fr 1.5fr 1fr 1.5fr 0.5fr;
    
    .cell {
      padding: 0.5rem;
      font-size: 0.8rem;
    }
  }

  .section-header {
    h2 {
      font-size: 1.25rem;
    }
  }
}

```
--- END OF FILE: src\app\components\contraindications\contraindications.component.scss ---

--- START OF FILE: src\app\components\contraindications\contraindications.component.ts ---
```typescript
import { Component, OnInit, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { Medication } from '../../models/api.models';

// API Interfaces
interface ContraindicationDetail {
  code: string;
  description: string;
}

// Display Interfaces
interface DisplayContraindicationMatch {
  appreciation: string;
  appreciationCode: string;
  medication: string;
  medicationCnk: string;
  condition: string;
  conditionCode: string;
  contraindications: ContraindicationDetail[]; // Array of contraindication details
}

interface DisplayProductContraindication {
  cnk: string;
  medicationName: string;
  appreciation: string;
  appreciationCode: string;
  condition: string;
  conditionCode: string;
  contraindications: ContraindicationDetail[]; // Array of contraindication details
}

@Component({
  selector: 'app-contraindications',
  standalone: true,
  imports: [CommonModule, TranslocoModule],
  templateUrl: './contraindications.component.html',
  styleUrls: ['./contraindications.component.scss']
})
export class ContraindicationsComponent implements OnInit {
  @Output() openNotes = new EventEmitter<{ type: 'match' | 'product', contraindication: any }>();
  
  medications: Medication[] = [];
  patientContraindications: any[] = [];
  loading = false;
  error: string | null = null;
  
  selectedMedicationId: string | null = null;
  expandedContraindication: string | null = null;
  
  contraindicationMatches: DisplayContraindicationMatch[] = [];
  productContraindications: DisplayProductContraindication[] = [];
  
  // Severity order for sorting (highest to lowest)
  private severityOrder: { [key: string]: number } = {
    'CI': 1, // Contraindication (absolute)
    'PR': 2  // Precaution
  };

  constructor(
    private apiService: ApiService,
    private stateService: StateService
  ) {}

  ngOnInit() {
    this.loadData();
    
    // Subscribe to contraindication changes
    this.stateService.contraindicationsChanged$.subscribe(() => {
      console.log('[Contraindications] Contraindications changed, reloading...');
      this.loadData();
    });
  }

  // Public method to refresh contraindications when medications or conditions change
  refreshContraindications() {
    console.log('[Contraindications] Refreshing contraindications data');
    this.loadData();
  }

  loadData() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.loading = true;
    this.error = null;

    // Load medications and patient contraindications in parallel
    Promise.all([
      this.apiService.getMedications(reviewId).toPromise(),
      this.apiService.getContraindications(reviewId).toPromise()
    ])
      .then(([medications, contraindications]) => {
        this.medications = medications || [];
        this.patientContraindications = contraindications || [];
        
        console.log('[Contraindications] Loaded medications:', this.medications);
        console.log('[Contraindications] Loaded patient contraindications:', this.patientContraindications);
        
        if (this.medications.length > 0) {
          this.checkContraindications();
        } else {
          this.loading = false;
        }
      })
      .catch(err => {
        console.error('[Contraindications] Error loading data:', err);
        this.error = 'Failed to load data';
        this.loading = false;
      });
  }

  checkContraindications() {
    // Get CNK codes from medications
    const cnkCodes = this.medications
      .filter(med => med.cnk)
      .map(med => med.cnk!.toString().padStart(7, '0'));

    // Get condition codes from patient contraindications
    const conditionCodes = this.patientContraindications
      .filter(ci => ci.contraindicationCode)
      .map(ci => ci.contraindicationCode);

    console.log('[Contraindications] CNK codes:', cnkCodes);
    console.log('[Contraindications] Condition codes:', conditionCodes);

    // Check matches (Type 1: medications vs patient conditions)
    if (cnkCodes.length > 0 && conditionCodes.length > 0) {
      const matchRequest = {
        language: 'NL',
        participatingProductCodes: cnkCodes,
        participatingPhysioPathologicalConditionCodes: conditionCodes
      };

      this.apiService.getContraindicationMatches(matchRequest).subscribe({
        next: (response) => {
          console.log('[Contraindications] Matches response:', response);
          this.processContraindicationMatches(response);
        },
        error: (err) => {
          console.error('[Contraindications] Error checking matches:', err);
        }
      });
    }

    // Get product contraindications for each medication (Type 2: all contraindications per medication)
    if (cnkCodes.length > 0) {
      const productRequests = cnkCodes.map(cnk => 
        this.apiService.getProductContraindications(cnk, 'NL').toPromise()
          .catch(err => {
            console.error(`[Contraindications] Error getting contraindications for CNK ${cnk}:`, err);
            return null;
          })
      );

      Promise.all(productRequests)
        .then(results => {
          this.processProductContraindications(results.filter(r => r !== null));
          this.loading = false;
        })
        .catch(err => {
          console.error('[Contraindications] Error processing product contraindications:', err);
          this.loading = false;
        });
    } else {
      this.loading = false;
    }
  }

  processContraindicationMatches(response: any) {
    this.contraindicationMatches = [];
    
    if (!response.result || response.result.length === 0) {
      return;
    }

    response.result.forEach((match: any) => {
      // Backend returns Code (capital C) not code (lowercase c)
      const cnkCode = match.product?.Code || match.product?.code;
      const medName = this.getMedicationName(cnkCode);
      
      // Map appreciation codes: '0' = absolute CI, '2'/'3' = precautions
      let appreciationText = 'Precaution';
      let appreciationCode = match.appreciation;
      
      if (match.appreciation === '0') {
        appreciationText = 'Contraindication';
        appreciationCode = 'CI';
      } else if (match.appreciation === '2') {
        appreciationText = 'Moderate Precaution';
        appreciationCode = 'PR';
      } else if (match.appreciation === '3') {
        appreciationText = 'Precaution';
        appreciationCode = 'PR';
      }
      
      this.contraindicationMatches.push({
        appreciation: appreciationText,
        appreciationCode: appreciationCode,
        medication: medName,
        medicationCnk: match.product?.Code || match.product?.code || 'Unknown',
        condition: match.physioPathologicalCondition?.Description || match.physioPathologicalCondition?.description || 'Unknown',
        conditionCode: match.physioPathologicalCondition?.Code || match.physioPathologicalCondition?.code || 'Unknown',
        contraindications: match.contraIndications || [] // Array of contraindication details
      });
    });

    // Sort by severity (CI before PR)
    this.contraindicationMatches.sort((a, b) => {
      return (this.severityOrder[a.appreciationCode] || 999) - (this.severityOrder[b.appreciationCode] || 999);
    });

    console.log('[Contraindications] Processed matches:', this.contraindicationMatches);
  }

  processProductContraindications(results: any[]) {
    this.productContraindications = [];
    
    results.forEach(response => {
      if (!response || !response.result || response.result.length === 0) {
        return;
      }

      const cnk = response.cnk;
      const medName = this.getMedicationName(cnk);

      response.result.forEach((item: any) => {
        // Backend returns Code/Description with capital letters
        const conditionCode = item.physioPathologicalCondition?.Code || item.physioPathologicalCondition?.code;
        const conditionDesc = item.physioPathologicalCondition?.Description || item.physioPathologicalCondition?.description;
        
        // Only add if not already in patient contraindications
        const isInPatientList = this.patientContraindications.some(
          ci => ci.contraindicationCode === conditionCode
        );

        if (!isInPatientList) {
          // Map appreciation codes: '0' = absolute CI, '2'/'3' = precautions
          let appreciationText = 'Precaution';
          let appreciationCode = item.appreciation;
          
          if (item.appreciation === '0') {
            appreciationText = 'Contraindication';
            appreciationCode = 'CI';
          } else if (item.appreciation === '2') {
            appreciationText = 'Moderate Precaution';
            appreciationCode = 'PR';
          } else if (item.appreciation === '3') {
            appreciationText = 'Precaution';
            appreciationCode = 'PR';
          }
          
          this.productContraindications.push({
            cnk: cnk,
            medicationName: medName,
            appreciation: appreciationText,
            appreciationCode: appreciationCode,
            condition: conditionDesc || 'Unknown',
            conditionCode: conditionCode || 'Unknown',
            contraindications: item.contraIndications || [] // Array of contraindication details
          });
        }
      });
    });

    // Sort by severity
    this.productContraindications.sort((a, b) => {
      return (this.severityOrder[a.appreciationCode] || 999) - (this.severityOrder[b.appreciationCode] || 999);
    });

    console.log('[Contraindications] Processed product contraindications:', this.productContraindications);
  }

  getMedicationName(cnkCode: string): string {
    const cnkNumber = parseInt(cnkCode);
    const med = this.medications.find(m => m.cnk === cnkNumber);
    return med?.name || `Unknown Medication (CNK: ${cnkCode})`;
  }

  onMedicationClick(medicationId: string) {
    if (this.selectedMedicationId === medicationId) {
      // Deselect if already selected
      this.selectedMedicationId = null;
    } else {
      // Select medication
      this.selectedMedicationId = medicationId;
    }
  }

  toggleContraindication(key: string) {
    if (this.expandedContraindication === key) {
      // Collapse
      this.expandedContraindication = null;
    } else {
      // Expand
      this.expandedContraindication = key;
    }
  }

  isMedicationSelected(medicationId: string): boolean {
    return this.selectedMedicationId === medicationId;
  }

  getFilteredMatches(): DisplayContraindicationMatch[] {
    if (!this.selectedMedicationId) {
      return this.contraindicationMatches;
    }

    const selectedCnk = this.medications.find(m => m.medicationId === this.selectedMedicationId)?.cnk;
    if (!selectedCnk) return this.contraindicationMatches;

    const selectedCnkStr = selectedCnk.toString().padStart(7, '0');

    return this.contraindicationMatches.filter(ci => 
      ci.medicationCnk === selectedCnkStr
    );
  }

  getFilteredProductContraindications(): DisplayProductContraindication[] {
    if (!this.selectedMedicationId) {
      return this.productContraindications;
    }

    const selectedCnk = this.medications.find(m => m.medicationId === this.selectedMedicationId)?.cnk;
    if (!selectedCnk) return this.productContraindications;

    const selectedCnkStr = selectedCnk.toString().padStart(7, '0');

    return this.productContraindications.filter(ci => 
      ci.cnk === selectedCnkStr
    );
  }

  getSeverityClass(appreciationCode: string): string {
    switch(appreciationCode) {
      case 'CI': return 'severity-high';
      case 'PR': return 'severity-medium';
      default: return 'severity-unknown';
    }
  }

  openNotesModal(contraindication: any, type: 'match' | 'product'): void {
    console.log('[Contraindications] Opening notes for contraindication:', contraindication);
    this.openNotes.emit({ type, contraindication });
  }

  openGeneralNotesModal(): void {
    console.log('[Contraindications] Opening notes for general note (no contraindication)');
    this.openNotes.emit({ type: 'general' as any, contraindication: null });
  }

  getUniqueKey(ci: any, index: number): string {
    if ('medicationCnk' in ci) {
      return `match-${ci.medicationCnk}-${ci.conditionCode}-${index}`;
    } else {
      return `product-${ci.cnk}-${ci.conditionCode}-${index}`;
    }
  }

  formatText(text: string): string {
    if (!text) return '';
    
    let formatted = text;
    
    // First, handle ~n as newline markers (before processing other ~ patterns)
    formatted = formatted.replace(/~n-?/g, '\n');
    
    // Replace ~text~ with <sub>text</sub> for subscript (but not single ~)
    formatted = formatted.replace(/~([^~\n]+)~/g, '<sub>$1</sub>');
    
    // Replace **text** with <strong>text</strong> for bold
    formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    
    // Replace remaining line breaks with <br> tags
    formatted = formatted.replace(/\n/g, '<br>');
    
    // Format inline literature references (e.g., [1], [2-5])
    formatted = formatted.replace(/\[(\d+(?:-\d+)?(?:,\s*\d+(?:-\d+)?)*)\]/g, '<sup class="reference">[$1]</sup>');
    
    return formatted;
  }
}

```
--- END OF FILE: src\app\components\contraindications\contraindications.component.ts ---

--- START OF FILE: src\app\components\gheops\gheops.component.html ---
```typescript
<div class="gheops-container">
  <!-- General note button moved into header actions -->

  <div class="document-header">
    <div class="header-left">
      <h2>{{ 'tools.gheops' | transloco }}</h2>
      <p class="description">{{ 'tools.gheops_description' | transloco }}</p>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" (click)="openInNewTab()" [title]="'tools.open_in_new_tab' | transloco">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
          <polyline points="15 3 21 3 21 9"></polyline>
          <line x1="10" y1="14" x2="21" y2="3"></line>
        </svg>
        {{ 'tools.open_in_new_tab' | transloco }}
      </button>
      <button class="add-note-button general-note" (click)="onAddGeneralNote()" title="Add general note" aria-label="Add general note">
        +
      </button>
    </div>
  </div>

  <div class="info-banner">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
    </svg>
    <span>{{ 'tools.gheops_help' | transloco }}</span>
  </div>

  @if (isLoading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>{{ 'common.loading' | transloco }}</p>
    </div>
  }

  @if (error) {
    <div class="error-state">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <p class="error-message">{{ error }}</p>
      <button class="btn-primary" (click)="openInNewTab()">{{ 'tools.open_in_new_tab' | transloco }}</button>
    </div>
  }

   <div class="iframe-container" [class.loading]="isLoading">
    @if (documentUrl) {
      <iframe
        #pdfFrame
        [src]="documentUrl"
        (load)="onIframeLoad()"
        (error)="onIframeError($event)"
        frameborder="0"
        title="GheOPS Tool Document">
      </iframe>
    }
  </div>
  
  @if (isLoading) {
    <div class="debug-info" style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; font-size: 11px; border-radius: 4px; max-width: 400px; z-index: 1000;">
      <div>{{ 'common.loading' | transloco }}</div>
      <div style="margin-top: 5px; font-size: 10px; opacity: 0.7;">Check browser console for more details</div>
    </div>
  }
</div>

```
--- END OF FILE: src\app\components\gheops\gheops.component.html ---

--- START OF FILE: src\app\components\gheops\gheops.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.gheops-container {
  height: 100%;
  display: flex;
  flex-direction: column;
  background-color: $main-background;
  overflow: hidden;
  position: relative;

  // Floating general note button in top right (below header to avoid overlap)
  .floating-top-right {
    position: absolute;
    top: 5.5rem;
    right: 1.5rem;
    z-index: 10;
  }

  .document-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid $box-border;
    background-color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-shrink: 0;

    .header-left {
      flex: 1;

      h2 {
        margin: 0 0 0.125rem 0;
        font-family: $primary-font;
        font-weight: $font-weight-semibold;
        font-size: 1.125rem;
        color: $text-primary;
      }

      .description {
        margin: 0;
        font-family: $primary-font;
        font-size: 0.8125rem;
        color: $text-secondary;
      }
    }

    .header-actions {
      display: flex;
      gap: 0.75rem;
      flex-shrink: 0;

      button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.875rem;
        border: none;
        border-radius: 6px;
        font-family: $primary-font;
        font-size: 0.8125rem;
        font-weight: $font-weight-medium;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;

        svg {
          flex-shrink: 0;
        }

        // Add note button uses global styling from _add-note-buttons.scss

        &.btn-secondary {
          background-color: transparent;
          color: $button-primary-background;
          border: 1px solid $button-primary-background;

          &:hover {
            background-color: rgba($button-primary-background, 0.1);
          }
        }
      }
    }
  }

  .info-banner {
    padding: 0.625rem 1.5rem;
    background-color: rgba($button-primary-background, 0.06);
    border-bottom: 1px solid rgba($button-primary-background, 0.15);
    display: flex;
    align-items: center;
    gap: 0.625rem;
    flex-shrink: 0;

    svg {
      flex-shrink: 0;
      color: $button-primary-background;
      width: 18px;
      height: 18px;
    }

    span {
      font-family: $primary-font;
      font-size: 0.8125rem;
      color: $text-primary;
      line-height: 1.4;
    }
  }

  .loading-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    color: $text-secondary;

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid $box-border;
      border-top-color: $button-primary-background;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    p {
      margin: 0;
      font-family: $primary-font;
      font-size: 0.875rem;
      color: $text-secondary;
    }
  }

  .error-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 2rem;
    text-align: center;

    svg {
      color: #dc3545;
      opacity: 0.5;
    }

    .error-message {
      margin: 0;
      font-family: $primary-font;
      font-size: 1rem;
      color: $text-primary;
    }

    .btn-primary {
      margin-top: 1rem;
    }
  }

  .iframe-container {
    flex: 1;
    position: relative;
    overflow: hidden;
    background-color: white;
    min-height: 0; // Important for flex child to shrink

    iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

```
--- END OF FILE: src\app\components\gheops\gheops.component.scss ---

--- START OF FILE: src\app\components\gheops\gheops.component.ts ---
```typescript
import { Component, Output, EventEmitter, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';
import { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser';
import { ApiService } from '../../services/api.service';

@Component({
  selector: 'app-gheops',
  standalone: true,
  imports: [CommonModule, TranslocoModule],
  templateUrl: './gheops.component.html',
  styleUrls: ['./gheops.component.scss']
})
export class GheopsComponent implements OnInit, OnDestroy {
  @Output() openNotes = new EventEmitter<void>();

  documentUrl: SafeResourceUrl | null = null;
  isLoading = true;
  error: string | null = null;
  private blobUrl: string | null = null;

  constructor(
    private apiService: ApiService,
    private sanitizer: DomSanitizer
  ) {}

  ngOnInit() {
    this.loadDocument();
  }

  loadDocument() {
    this.isLoading = true;
    this.error = null;

    this.apiService.getReferenceDocument('gheops').subscribe({
      next: (blob) => {
        console.log('[GheopsComponent] Received blob:', blob.size, 'bytes, type:', blob.type);
        
        // Verify blob is a PDF
        if (!blob.type.includes('pdf')) {
          console.warn('[GheopsComponent] Received non-PDF blob:', blob.type);
        }
        
        // Create object URL from blob
        this.blobUrl = URL.createObjectURL(blob);
        console.log('[GheopsComponent] Created blob URL:', this.blobUrl);
        
        // Trust the URL for iframe usage
        this.documentUrl = this.sanitizer.bypassSecurityTrustResourceUrl(this.blobUrl);
        console.log('[GheopsComponent] Document URL ready for iframe');
      },
      error: (err) => {
        console.error('[GheopsComponent] Failed to download document:', err);
        console.error('[GheopsComponent] Error details:', {
          status: err.status,
          statusText: err.statusText,
          message: err.message,
          url: err.url
        });
        this.error = 'Failed to load GheOPS document. Click "Open in New Tab" to try in a separate window.';
        this.isLoading = false;
      }
    });
  }

  ngOnDestroy() {
    // Clean up the blob URL to prevent memory leaks
    if (this.blobUrl) {
      console.log('[GheopsComponent] Cleaning up blob URL');
      URL.revokeObjectURL(this.blobUrl);
    }
  }

  onIframeLoad() {
    console.log('[GheopsComponent] Iframe loaded successfully');
    this.isLoading = false;
  }

  onIframeError(event?: any) {
    console.error('[GheopsComponent] Iframe error:', event);
    this.error = 'Failed to display PDF in iframe. Click "Open in New Tab" to view.';
    this.isLoading = false;
  }

  onAddGeneralNote() {
    this.openNotes.emit();
  }

  openInNewTab() {
    const url = this.apiService.getReferenceDocumentUrl('gheops');
    window.open(url, '_blank', 'noopener,noreferrer');
  }
}
```
--- END OF FILE: src\app\components\gheops\gheops.component.ts ---

--- START OF FILE: src\app\components\header\header.component.html ---
```typescript
<header class="app-header">
  <div class="header-left">
    <img src="/images/Top_bar_logo.png" alt="Salvus Health" class="logo">
    
    @if (showPatientInfo) {
      <!-- Patient icon -->
      <div class="patient-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </div>

      <!-- Patient info -->
      <div class="patient-info">
        <span class="patient-name">{{ patientName }}</span>
        <span class="patient-details">
          @if (patientAge !== null) {
            <span>{{ patientAge }} {{ 'patient.age' | transloco }}</span>
          }
          @if (patientSex) {
            <span class="separator">‚Ä¢</span>
            <span>{{ patientSex }}</span>
          }
        </span>
      </div>
      
      <!-- Contra-indications section -->
      <div class="contraindications-section">
        <div class="contraindications-header">
          <span class="section-label">{{ 'header.contraindications' | transloco }}</span>
          <button class="add-ci-button" (click)="addContraIndication()" [title]="'header.add_contraindication' | transloco">
            +
          </button>
        </div>
        <div class="contraindications-list">
          @if (contraIndications.length === 0) {
            <span class="no-ci-message">{{ 'common.no' | transloco }}</span>
          } @else {
            @for (ci of contraIndications; track ci.contraindicationId) {
              <div class="ci-item">
                <span class="ci-text">{{ ci.name || ci.contraindicationCode }}</span>
                <button class="remove-ci-button" (click)="removeContraIndication(ci)" title="Remove">
                  √ó
                </button>
              </div>
            }
          }
        </div>
      </div>
    }
  </div>
  
  <!-- Center: Step indicator roadmap -->
  @if (!isLoginPage) {
    <div class="header-center">
      <div class="step-indicator">
        @for (step of steps; track step.number; let i = $index) {
          @if (i > 0) {
            <div class="step-connector" [class.completed]="isStepCompleted(step)"></div>
          }
          <div 
            class="step-item" 
            (click)="navigateToStep(step)"
            [class.disabled]="false">
            <div 
              class="step-icon-wrapper"
              [class.active]="isStepActive(step)"
              [class.completed]="isStepCompleted(step)">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" [attr.d]="getStepIcon(step.number)" />
              </svg>
            </div>
            <span class="step-label">{{ step.label | transloco }}</span>
          </div>
        }
      </div>
    </div>
  }
  
  <div class="header-right">
    @if (isAnalysisPage) {
      <div class="separator"></div>
    }
    
    @if (isAnalysisPage) {
  <button class="icon-button conversation-button" (click)="openConversation()" [title]="'notes.notes_overview' | transloco" [class.animate-pop]="animateNotes">
        <!-- Notepad / Notes icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M7 7h10" />
          <path d="M7 11h10" />
          <path d="M7 15h6" />
          <path d="M17 3h-8a2 2 0 0 0-2 2v14l4-2h6a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" />
        </svg>
        @if (notesCount > 0) {
          <span class="notes-badge">{{ notesCount }}</span>
        }
      </button>
    }

    <button class="icon-button" (click)="navigateHome()" [title]="'common.home' | transloco">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
    </button>

    <!-- Language selector -->
    <div class="lang-selector" role="navigation" aria-label="Language selector">
      <div class="lang-pill" tabindex="0" (click)="toggleLangDropdown()" (keydown.enter)="toggleLangDropdown()" aria-haspopup="true" [attr.aria-expanded]="langDropdownOpen">
        <span class="lang-code">{{ activeLang.toUpperCase() }}</span>
        <svg class="caret" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </div>

      @if (langDropdownOpen) {
        <ul class="lang-dropdown" role="menu">
          @for (l of supportedLangs; track l.code) {
            <li role="menuitem" class="lang-item" (click)="changeLanguage(l.code); toggleLangDropdown();" [class.active]="l.code === activeLang" tabindex="0">
              <span class="label">{{ l.label }}</span>
              <span class="code">{{ l.code.toUpperCase() }}</span>
            </li>
          }
        </ul>
      }
    </div>
  </div>
</header>

<!-- Contraindication Modal -->
<app-contraindication-modal
  *ngIf="showContraIndicationsModal"
  (close)="closeContraIndicationsModal()"
  (saved)="onContraIndicationsSaved()"
></app-contraindication-modal>

```
--- END OF FILE: src\app\components\header\header.component.html ---

--- START OF FILE: src\app\components\header\header.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.app-header {
  height: 7vh;
  width: 100%;
  background-color: $header-background;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 2rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  position: relative;
  z-index: 1000;
  min-height: 60px;

  .header-left {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    flex-shrink: 0;

    .logo {
      height: 70%;
      max-height: 40px;
      width: auto;
      object-fit: contain;
    }

    .patient-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      color: $text-primary;
      opacity: 0.8;
      
      svg {
        position: relative;
        left: 10px;
        width: 24px;
        height: 24px;
      }
    }

    .patient-info {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;

      .patient-name {
        font-family: $primary-font;
        font-weight: $font-weight-semibold;
        font-size: 0.9rem;
        color: $text-primary;
      }

      .patient-details {
        font-family: $primary-font;
        font-weight: $font-weight-regular;
        font-size: 0.75rem;
        color: $text-secondary;
        display: flex;
        gap: 0.4rem;
        align-items: center;

        .separator {
          font-weight: $font-weight-bold;
          color: $text-muted;
        }
      }
    }

    .contraindications-section {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      max-width: 400px;
      overflow: hidden;

      .contraindications-header {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        flex-shrink: 0;

        .section-label {
          font-family: $primary-font;
          font-weight: $font-weight-medium;
          font-size: 0.7rem;
          color: $text-secondary;
        }

        .add-ci-button {
          width: 16px;
          height: 16px;
          border-radius: 50%;
          background-color: transparent;
          color: $button-primary-background;
          border: 1px solid $button-primary-background;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.9rem;
          font-weight: bold;
          line-height: 1;
          transition: all 0.2s ease;

          &:hover {
            background-color: $button-primary-background;
            color: white;
          }
        }
      }

      .contraindications-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
        align-items: center;
        min-height: 18px;
        max-height: 36px;
        overflow-y: auto;
        overflow-x: hidden;

        .no-ci-message {
          font-family: $primary-font;
          font-size: 0.65rem;
          color: $text-muted;
          font-style: italic;
        }

        .ci-item {
          display: flex;
          align-items: center;
          gap: 0.25rem;
          background-color: rgba($text-secondary, 0.08);
          border: 1px solid rgba($text-secondary, 0.15);
          border-radius: 10px;
          padding: 0.125rem 0.35rem 0.125rem 0.45rem;
          transition: all 0.2s ease;

          &:hover {
            background-color: rgba($text-secondary, 0.12);
            border-color: rgba($text-secondary, 0.25);
          }

          .ci-text {
            font-family: $primary-font;
            font-size: 0.65rem;
            font-weight: $font-weight-regular;
            color: $text-secondary;
          }

          .remove-ci-button {
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background-color: transparent;
            color: $text-secondary;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            line-height: 1;
            transition: all 0.2s ease;
            opacity: 0.6;

            &:hover {
              background-color: rgba(220, 53, 69, 0.2);
              color: #dc3545;
              opacity: 1;
            }
          }
        }
      }
    }
  }

  .header-center {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    justify-content: center;
    align-items: center;
    pointer-events: none;

    .step-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 24px;
      pointer-events: all;

      .step-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 0.3rem;
        border-radius: 8px;

        &:hover:not(.disabled) {
          background-color: rgba($button-primary-background, 0.08);
        }

        &.disabled {
          cursor: not-allowed;
          opacity: 0.5;
        }

        .step-icon-wrapper {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          background-color: rgba($text-muted, 0.15);
          border: 2px solid rgba($text-muted, 0.3);
          transition: all 0.2s ease;
          position: relative;

          svg {
            width: 18px;
            height: 18px;
            color: $text-muted;
            transition: all 0.2s ease;
          }

          &.active {
            background-color: $button-primary-background;
            border-color: $button-primary-background;

            svg {
              color: white;
            }
          }

          &.completed {
            background-color: rgba($button-primary-background, 0.15);
            border-color: $button-primary-background;

            svg {
              color: $button-primary-background;
            }
          }
        }

        .step-label {
          font-family: $primary-font;
          font-weight: $font-weight-medium;
          font-size: 0.65rem;
          color: $text-secondary;
          white-space: nowrap;
        }
      }

      .step-connector {
        width: 24px;
        height: 2px;
        background-color: rgba($text-muted, 0.3);
        transition: all 0.2s ease;

        &.completed {
          background-color: $button-primary-background;
        }
      }
    }
  }

  .header-right {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    height: 100%;
    flex-shrink: 0;

    .separator {
      width: 2px;
      height: 60%;
      background-color: rgba(0, 0, 0, 0.15);
      margin-right: 0.5rem;
    }

    .icon-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: $icon-color;
      transition: color 0.2s ease;
      border-radius: 4px;
      position: relative;

      &:hover {
        color: $icon-hover;
        background-color: rgba(0, 0, 0, 0.05);
      }

      svg {
        width: 24px;
        height: 24px;
      }

      &.conversation-button {
        &.animate-pop {
          animation: header-notes-pop 520ms cubic-bezier(.2,.8,.2,1);
        }

        @keyframes header-notes-pop {
          0% { transform: scale(1); }
          30% { transform: scale(1.18); }
          60% { transform: scale(0.96); }
          100% { transform: scale(1); }
        }

        .notes-badge {
          position: absolute;
          top: 0;
          right: 0;
          background-color: #dc3545;
          color: white;
          font-size: 0.65rem;
          font-weight: $font-weight-semibold;
          font-family: $primary-font;
          min-width: 18px;
          height: 18px;
          border-radius: 9px;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0 4px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
      }
    }

    .lang-selector {
      position: relative;

      .lang-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        background-color: rgba($text-secondary, 0.06);
        border: 1px solid rgba($text-secondary, 0.08);
        cursor: pointer;
        user-select: none;
        transition: all 0.15s ease;
        outline: none;

        &:hover, &:focus {
          background-color: rgba($text-secondary, 0.09);
          transform: translateY(-1px);
          box-shadow: 0 4px 10px rgba(0,0,0,0.06);
        }

        .lang-code {
          font-family: $primary-font;
          font-weight: $font-weight-semibold;
          font-size: 0.85rem;
          color: $text-primary;
        }

        .caret {
          color: $text-muted;
        }
      }

      .lang-dropdown {
        position: absolute;
        right: 0;
        margin-top: 0.5rem;
        background: white;
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: 8px;
        min-width: 160px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        padding: 0.25rem 0;
        z-index: 1100;

        .lang-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 0.5rem;
          padding: 0.5rem 0.75rem;
          cursor: pointer;
          transition: background 0.12s ease;

          &:hover, &:focus {
            background: rgba($button-primary-background, 0.04);
          }

          &.active {
            background: rgba($button-primary-background, 0.06);
            font-weight: $font-weight-semibold;
          }

          .label {
            font-family: $primary-font;
            font-size: 0.9rem;
            color: $text-primary;
          }

          .code {
            font-family: $primary-font;
            font-size: 0.75rem;
            color: $text-muted;
            border-radius: 4px;
            padding: 0.1rem 0.35rem;
            background: rgba($text-secondary, 0.04);
          }
        }
      }
    }
  }
}

```
--- END OF FILE: src\app\components\header\header.component.scss ---

--- START OF FILE: src\app\components\header\header.component.ts ---
```typescript
import { Component, OnInit, OnDestroy, Output, EventEmitter } from '@angular/core';
import { Router, NavigationEnd } from '@angular/router';
import { CommonModule } from '@angular/common';
import { TranslocoModule, TranslocoService } from '@jsverse/transloco';
import { filter, takeUntil } from 'rxjs/operators';
import { Subject } from 'rxjs';
import { StateService } from '../../services/state.service';
import { ApiService } from '../../services/api.service';
import { SessionData, Contraindication } from '../../models/api.models';
import { ContraindicationModalComponent } from '../contraindication-modal/contraindication-modal.component';
import { ReviewNotesService } from '../../services/review-notes.service';

interface Step {
  number: number;
  label: string;
  route: string;
}

@Component({
  selector: 'app-header',
  imports: [CommonModule, TranslocoModule, ContraindicationModalComponent],
  templateUrl: './header.component.html',
  styleUrls: ['./header.component.scss']
})
export class HeaderComponent implements OnInit, OnDestroy {
  @Output() openNoteOverview = new EventEmitter<void>();

  isLoginPage: boolean = false;
  isInputPage: boolean = false;
  isAnalysisPage: boolean = false;
  showPatientInfo: boolean = false;
  patientName: string = '';
  patientAge: number | null = null;
  patientSex: string = '';
  contraIndications: Contraindication[] = [];
  showContraIndicationsModal: boolean = false;
  notesCount: number = 0;
  animateNotes = false;
  private previousNotesCount = 0;
  
  // Step indicator
  currentStep: Step | null = null;
  steps: Step[] = [
    { number: 1, label: 'header.step_1', route: 'input' },
    { number: 2, label: 'header.step_2', route: 'analysis' },
    { number: 3, label: 'header.step_3', route: 'anamnesis' },
    { number: 4, label: 'header.step_4', route: 'report-generation' }
  ];
  
  private destroy$ = new Subject<void>();

  // Language selector
  supportedLangs = [
    { code: 'en', label: 'EN' },
    { code: 'nl', label: 'NL' },
    { code: 'fr', label: 'FR' }
  ];
  activeLang: string = 'en';
  langDropdownOpen: boolean = false;

  constructor(
    private router: Router,
    private stateService: StateService,
    private apiService: ApiService,
    private reviewNotesService: ReviewNotesService
    , private transloco: TranslocoService
  ) {
    // Check current route on initialization
    this.checkRoute(this.router.url);

    // Subscribe to route changes
    this.router.events
      .pipe(
        filter(event => event instanceof NavigationEnd),
        takeUntil(this.destroy$)
      )
      .subscribe((event: any) => {
        this.checkRoute(event.url);
      });
  }

  ngOnInit() {
    // initialize active language for selector
    try {
      this.activeLang = this.transloco.getActiveLang() || (localStorage.getItem('selectedLang') || 'en');
    } catch (e) {
      // if transloco isn't ready yet, fallback to localStorage
      this.activeLang = localStorage.getItem('selectedLang') || 'en';
    }
    // Subscribe to session data changes
    this.stateService.sessionData$
      .pipe(takeUntil(this.destroy$))
      .subscribe(sessionData => {
        this.updatePatientInfo(sessionData);
        this.loadContraindications();
        this.loadReviewNotes();
      });

    // Subscribe to contraindication changes from other components
    this.stateService.contraindicationsChanged$
      .pipe(takeUntil(this.destroy$))
      .subscribe(() => {
        console.log('[Header] Contraindications changed notification received');
        this.loadContraindications();
      });

    // Subscribe to notes count changes
    this.reviewNotesService.notesCount$
      .pipe(takeUntil(this.destroy$))
      .subscribe(count => {
        // Detect increases in notes count to trigger animation
        this.notesCount = count;
        console.log('[Header] Notes count updated:', count);
        if (count > this.previousNotesCount) {
          this.triggerNotesAnimation();
        }
        this.previousNotesCount = count;
      });
  }

  changeLanguage(lang: string) {
    if (!lang) return;
    try {
      localStorage.setItem('selectedLang', lang);
      this.transloco.setActiveLang(lang);
      this.activeLang = lang;
    } catch (e) {
      console.error('[Header] Failed to change language', e);
    }
  }

  toggleLangDropdown() {
    this.langDropdownOpen = !this.langDropdownOpen;
  }

  private triggerNotesAnimation() {
    this.animateNotes = true;
    // Clear animation after it finishes
    setTimeout(() => this.animateNotes = false, 600);
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
  }

  private checkRoute(url: string) {
    this.isLoginPage = url === '/login' || url === '/';
    this.isInputPage = url === '/input';
    this.isAnalysisPage = url === '/analysis';
    this.showPatientInfo = !this.isLoginPage && !this.isInputPage;
    
    // Update current step based on route
    this.updateCurrentStep(url);
    
    // Reload contraindications when navigating to a page that shows them
    if (this.showPatientInfo) {
      this.loadContraindications();
    }
  }

  private updateCurrentStep(url: string) {
    // Find matching step based on current route
    this.currentStep = this.steps.find(step => 
      url.includes(`/${step.route}`)
    ) || null;
  }

  isStepActive(step: Step): boolean {
    return this.currentStep?.number === step.number;
  }

  isStepCompleted(step: Step): boolean {
    if (!this.currentStep) return false;
    return step.number < this.currentStep.number;
  }

  navigateToStep(step: Step) {
    // Don't navigate if it's a future step (optional: remove this check to allow any navigation)
    // if (!this.currentStep || step.number > this.currentStep.number) return;
    
    this.router.navigate([`/${step.route}`]);
  }

  getStepIcon(stepNumber: number): string {
    const icons: { [key: number]: string } = {
      1: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2', // Clipboard (Input)
      2: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z', // Chart bars (Analysis)
      3: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4', // Clipboard check (Actions)
      4: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' // Document (Documentation)
    };
    return icons[stepNumber] || '';
  }

  private updatePatientInfo(sessionData: SessionData | null) {
    if (!sessionData) {
      this.patientName = '';
      this.patientAge = null;
      this.patientSex = '';
      return;
    }

    // Build patient name from review data
    const firstName = sessionData.review?.firstNameAtTimeOfReview || '';
    const lastName = sessionData.review?.lastNameAtTimeOfReview || '';
    this.patientName = `${firstName} ${lastName}`.trim() || 'Unknown Patient';

    // Calculate age from date of birth
    if (sessionData.patient?.dateOfBirth) {
      this.patientAge = this.calculateAge(sessionData.patient.dateOfBirth);
    } else {
      this.patientAge = null;
    }

    // Get sex
    this.patientSex = sessionData.patient?.sex || '';
  }

  private calculateAge(dateOfBirth: string): number {
    const birthDate = new Date(dateOfBirth);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    
    return age;
  }

  navigateHome() {
    this.router.navigate(['/login']);
  }

  save() {
    // Save functionality will be implemented later
    console.log('Save clicked');
  }

  openConversation() {
    console.log('[Header] Opening note overview modal');
    this.openNoteOverview.emit();
  }

  addContraIndication() {
    this.showContraIndicationsModal = true;
  }

  removeContraIndication(contraindication: Contraindication) {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.apiService.deleteContraindication(reviewId, contraindication.contraindicationId).subscribe({
      next: () => {
        console.log('[Header] Contraindication deleted:', contraindication.contraindicationId);
        this.loadContraindications();
        this.stateService.notifyContraindicationsChanged();
      },
      error: (error) => {
        console.error('[Header] Failed to delete contraindication:', error);
        alert('Failed to remove contra-indication. Please try again.');
      }
    });
  }

  closeContraIndicationsModal() {
    this.showContraIndicationsModal = false;
  }

  onContraIndicationsSaved() {
    this.showContraIndicationsModal = false;
    this.loadContraindications();
    this.stateService.notifyContraindicationsChanged();
  }

  private loadContraindications() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) {
      this.contraIndications = [];
      return;
    }

    this.apiService.getContraindications(reviewId).subscribe({
      next: (contraindications) => {
        this.contraIndications = contraindications;
        console.log('[Header] Loaded contraindications:', contraindications);
      },
      error: (error) => {
        console.error('[Header] Failed to load contraindications:', error);
        this.contraIndications = [];
      }
    });
  }

  private loadReviewNotes() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) {
      this.reviewNotesService.clearNotes();
      return;
    }

    this.reviewNotesService.loadReviewNotes(reviewId);
  }
}

```
--- END OF FILE: src\app\components\header\header.component.ts ---

--- START OF FILE: src\app\components\interaction-notes-modal\interaction-notes-modal.component.html ---
```typescript
<div class="modal-overlay" (click)="onCancel()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Add Note for Interaction</h2>

    <div class="interaction-info" *ngIf="interaction">
      <div class="info-row">
        <span class="info-label">Interaction:</span>
        <span class="info-value">{{ getInteractionTitle() }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Type:</span>
        <span class="info-value">{{ interactionType === 'drug-drug' ? ('interaction_types.drug_drug' | transloco) : ('interaction_types.drug_food' | transloco) }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Severity:</span>
        <span class="info-value">{{ interaction.severity }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Number:</span>
        <span class="info-value">#{{ interaction.interactionNumber }}</span>
      </div>
    </div>

    <div class="form-section">
      <label for="note-text">Note:</label>
      <textarea 
        id="note-text"
        [(ngModel)]="noteText"
        placeholder="Enter your note about this interaction..."
        rows="6"
      ></textarea>
      
      <!-- Preset buttons -->
      <div class="preset-buttons">
        <button 
          type="button"
          class="preset-btn"
          (click)="addPresetText('notes.preset_advice_alternative')"
        >
          {{ 'notes.preset_advice_alternative' | transloco }}
        </button>
        <button 
          type="button"
          class="preset-btn"
          (click)="addPresetText('notes.preset_inform_patient')"
        >
          {{ 'notes.preset_inform_patient' | transloco }}
        </button>
      </div>
    </div>

    <div class="toggle-section">
      <button 
        type="button"
        class="toggle-button"
        [class.active]="addToPatientConversation"
        (click)="addToPatientConversation = !addToPatientConversation"
      >
        <span class="toggle-icon">{{ addToPatientConversation ? '‚úì' : '' }}</span>
        <span class="toggle-text">Add to patient conversation</span>
      </button>

      <button 
        type="button"
        class="toggle-button"
        [class.active]="addToGpReport"
        (click)="addToGpReport = !addToGpReport"
      >
        <span class="toggle-icon">{{ addToGpReport ? '‚úì' : '' }}</span>
        <span class="toggle-text">Add to GP report</span>
      </button>
    </div>

    <div class="button-row">
      <button class="btn-secondary" (click)="onCancel()">{{ 'common.cancel' | transloco }}</button>
      <button class="btn-primary" (click)="onAddToAnamnesis()">Add to anamnesis</button>
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\components\interaction-notes-modal\interaction-notes-modal.component.html ---

--- START OF FILE: src\app\components\interaction-notes-modal\interaction-notes-modal.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background-color: white;
  border-radius: $box-border-radius;
  padding: 2rem;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);

  h2 {
    margin: 0 0 1.5rem 0;
    font-family: $primary-font;
    font-size: 1.5rem;
    font-weight: $font-weight-semibold;
    color: $text-primary;
  }
}

.interaction-info {
  background-color: $main-background;
  border-radius: $box-border-radius-small;
  padding: 1rem;
  margin-bottom: 1.5rem;

  .info-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-family: $primary-font;

    &:last-child {
      margin-bottom: 0;
    }

    .info-label {
      font-weight: $font-weight-semibold;
      color: $text-primary;
      min-width: 100px;
    }

    .info-value {
      color: $text-secondary;
    }
  }
}

.form-section {
  margin-bottom: 1.5rem;

  label {
    display: block;
    margin-bottom: 0.5rem;
    font-family: $primary-font;
    font-weight: $font-weight-semibold;
    color: $text-primary;
  }

  textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid $box-border-primary;
    border-radius: $box-border-radius-small;
    font-family: $primary-font;
    font-size: 0.95rem;
    resize: vertical;
    
    &:focus {
      outline: none;
      border-color: $button-primary-background;
    }
  }

  .preset-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;

    .preset-btn {
      font-family: $primary-font;
      font-size: 0.875rem;
      padding: 0.5rem 1rem;
      border: 1px solid $box-border-primary;
      border-radius: $box-border-radius-small;
      background-color: white;
      color: $text-primary;
      cursor: pointer;
      transition: all 0.2s ease;

      &:hover {
        background-color: rgba($button-primary-background, 0.1);
        border-color: $button-primary-background;
        color: $button-primary-background;
      }

      &:active {
        transform: translateY(1px);
      }
    }
  }
}

.toggle-section {
  margin-bottom: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;

  .toggle-button {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: $primary-font;
    font-size: 0.95rem;
    padding: 0.875rem 1rem;
    border: 2px solid $box-border-primary;
    border-radius: $box-border-radius-small;
    background-color: white;
    color: $text-primary;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;

    .toggle-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid $box-border-primary;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: bold;
      color: transparent;
      transition: all 0.2s ease;
    }

    .toggle-text {
      flex: 1;
    }

    &:hover {
      border-color: darken($box-border-primary, 10%);
      background-color: #f8f9fa;
    }

    &.active {
      border-color: $button-primary-background;
      background-color: rgba($button-primary-background, 0.05);

      .toggle-icon {
        background-color: $button-primary-background;
        border-color: $button-primary-background;
        color: white;
      }
    }

    &:active {
      transform: translateY(1px);
    }
  }
}

.button-row {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;

  button {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: $box-border-radius;
    font-family: $primary-font;
    font-size: 1rem;
    font-weight: $font-weight-medium;
    cursor: pointer;
    transition: all 0.2s ease;

    &.btn-secondary {
      background-color: $box-background;
      color: $text-primary;
      border: 1px solid $box-border-primary;

      &:hover {
        background-color: darken($box-background, 5%);
      }
    }

    &.btn-primary {
      background-color: $button-primary-background;
      color: $text-button-primary;

      &:hover {
        background-color: darken($button-primary-background, 10%);
      }
    }
  }
}

```
--- END OF FILE: src\app\components\interaction-notes-modal\interaction-notes-modal.component.scss ---

--- START OF FILE: src\app\components\interaction-notes-modal\interaction-notes-modal.component.ts ---
```typescript
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { TranslocoModule, TranslocoService } from '@jsverse/transloco';
import { ReviewNotesService } from '../../services/review-notes.service';
import { StateService } from '../../services/state.service';

@Component({
  selector: 'app-interaction-notes-modal',
  standalone: true,
  imports: [CommonModule, FormsModule, TranslocoModule],
  templateUrl: './interaction-notes-modal.component.html',
  styleUrls: ['./interaction-notes-modal.component.scss']
})
export class InteractionNotesModalComponent {
  @Input() interaction: any = null;
  @Input() interactionType: 'drug-drug' | 'drug-food' = 'drug-drug';
  @Output() close = new EventEmitter<void>();

  noteText = '';
  addToPatientConversation = true;
  addToGpReport = true;
  isSubmitting = false;

  constructor(
    private reviewNotesService: ReviewNotesService,
    private stateService: StateService,
    private transloco: TranslocoService
  ) {}

  addPresetText(presetKey: string) {
    const presetText = this.transloco.translate(presetKey);
    if (this.noteText.trim()) {
      this.noteText += '\n' + presetText;
    } else {
      this.noteText = presetText;
    }
  }

  onCancel() {
    this.close.emit();
    this.resetForm();
  }

  onAddToAnamnesis() {
    if (!this.noteText.trim()) {
      console.warn('[InteractionNotesModal] Note text is empty');
      return;
    }

    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) {
      console.error('[InteractionNotesModal] No review ID found');
      return;
    }

    this.isSubmitting = true;

    const noteData = {
      text: this.buildNoteText(),
      category: 'Interactions',
      linkedCnk: this.getLinkedCnk(),
      medicationName: this.getLinkedMedicationName(),
      discussWithPatient: this.addToPatientConversation,
      communicateToDoctor: this.addToGpReport
    };

    console.log('[InteractionNotesModal] Adding to anamnesis:', noteData);

    this.reviewNotesService.addNote(reviewId, noteData).subscribe({
      next: (note) => {
        console.log('[InteractionNotesModal] Successfully added note:', note);
        this.close.emit();
        this.resetForm();
      },
      error: (error) => {
        console.error('[InteractionNotesModal] Error adding note:', error);
        this.isSubmitting = false;
      }
    });
  }

  private buildNoteText(): string {
    // Build a note text that includes interaction context
    let text = `[Interaction: ${this.getInteractionTitle()}]\n\n`;
    text += this.noteText;
    return text;
  }

  private resetForm() {
    this.noteText = '';
    this.addToPatientConversation = true;
    this.addToGpReport = true;
    this.isSubmitting = false;
  }

  getInteractionTitle(): string {
    if (this.interactionType === 'drug-drug') {
      return `${this.interaction.leftMedication} ‚Üî ${this.interaction.rightMedication}`;
    } else {
      return `${this.interaction.medication} ‚Üî ${this.interaction.food}`;
    }
  }

  private getLinkedCnk(): string | undefined {
    // For drug-drug interactions, link to the "left" medication CNK
    if (this.interactionType === 'drug-drug' && this.interaction.leftParticipantId) {
      return this.interaction.leftParticipantId;
    }
    // For drug-food interactions, link to the medication CNK
    else if (this.interactionType === 'drug-food' && this.interaction.participantId) {
      return this.interaction.participantId;
    }
    return undefined;
  }

  private getLinkedMedicationName(): string | undefined {
    // For drug-drug interactions, use the "left" medication name
    if (this.interactionType === 'drug-drug' && this.interaction.leftMedication) {
      return this.interaction.leftMedication;
    }
    // For drug-food interactions, use the medication name
    else if (this.interactionType === 'drug-food' && this.interaction.medication) {
      return this.interaction.medication;
    }
    return undefined;
  }
}

```
--- END OF FILE: src\app\components\interaction-notes-modal\interaction-notes-modal.component.ts ---

--- START OF FILE: src\app\components\interactions\interactions.component.html ---
```typescript
<div class="interactions-container">
  @if (loading) {
    <div class="loading-state">
      <p>{{ 'interactions.checking' | transloco }}</p>
    </div>
  } @else if (error) {
    <div class="error-state">
      <p class="error-message">{{ error }}</p>
      <button class="retry-button" (click)="loadMedications()">{{ 'common.retry' | transloco }}</button>
    </div>
  } @else {
    <div class="interactions-content">
      <!-- General note button (top right) -->
      <button class="add-note-button general-note floating-top-right" (click)="openGeneralNotesModal()" title="Add general note">
        +
      </button>

      <!-- Drug-Drug Interactions -->
      <div class="interactions-section">
          <div class="section-header">
            <h2>{{ 'interactions.drug_drug_title' | transloco }}</h2>
            <span class="count-badge">{{ getFilteredDrugDrugInteractions().length }}</span>
          </div>

        @if (getFilteredDrugDrugInteractions().length === 0) {
          <div class="no-interactions">
            <p>‚úì {{ 'interactions.no_drug_drug' | transloco }}</p>
          </div>
        } @else {
          <!-- Table Header -->
          <div class="interactions-header">
            <div class="header-cell left-header">{{ 'interactions.header_left' | transloco }}</div>
            <div class="header-cell right-header">{{ 'interactions.header_right' | transloco }}</div>
            <div class="header-cell severity-header">{{ 'interactions.header_severity' | transloco }}</div>
            <div class="header-cell number-header">{{ 'interactions.header_number' | transloco }}</div>
            <div class="header-cell details-header">{{ 'interactions.header_details' | transloco }}</div>
            <div class="header-cell notes-header">{{ 'interactions.header_notes' | transloco }}</div>
          </div>

          <div class="interactions-list">
            @for (interaction of getFilteredDrugDrugInteractions(); track interaction.interactionNumber) {
              <div class="interaction-row-wrapper">
                <div 
                  class="interaction-card" 
                  [class.expanded]="expandedInteraction === interaction.interactionNumber"
                >
                  <div class="interaction-row" (click)="toggleInteraction(interaction.interactionNumber)">
                    <div class="cell left-medication">
                      <div class="medication-name">{{ interaction.leftMedication }}</div>
                      <div class="substance">{{ interaction.leftSubstance }}</div>
                    </div>
                    <div class="cell right-medication">
                      <div class="medication-name">{{ interaction.rightMedication }}</div>
                      <div class="substance">{{ interaction.rightSubstance }}</div>
                    </div>
                    <div class="cell severity-cell">
                      <span class="severity-badge" [class]="getSeverityClass(interaction.severityCode)">
                        {{ interaction.severity }}
                      </span>
                    </div>
                    <div class="cell number-cell">
                      #{{ interaction.interactionNumber }}
                    </div>
                    <div class="cell details-cell">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 16v-4M12 8h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </div>
                    <div class="cell notes-cell" (click)="$event.stopPropagation()">
                      <button class="add-note-button" (click)="openNotesModal(interaction)" title="Add notes">
                        +
                      </button>
                    </div>
                  </div>
                  
                  @if (expandedInteraction === interaction.interactionNumber) {
                    <div class="interaction-details" (click)="$event.stopPropagation()">
                      @if (loadingDetails) {
                        <div class="details-loading">{{ 'interactions.loading_details' | transloco }}</div>
                      } @else if (interactionDetails) {
                        @if (interactionDetails.textGroups && interactionDetails.textGroups.length > 0) {
                          @for (group of interactionDetails.textGroups; track group.groupTitle) {
                            <div class="detail-group">
                              <h4 class="group-title">{{ group.groupTitle }}</h4>
                              @for (text of group.texts; track text.title.code) {
                                <div class="detail-text">
                                  <strong>{{ text.title.description }}:</strong>
                                  <p [innerHTML]="formatText(text.text)"></p>
                                </div>
                              }
                            </div>
                          }
                        }
                        @if (interactionDetails.details) {
                          <div class="detail-metadata">
                            @if (interactionDetails.details.direction && interactionDetails.details.direction.description !== 'fallbacks.no_direction') {
                              <div class="detail-row">
                                <span class="detail-label">{{ 'interactions.detail_direction' | transloco }}</span>
                                <span class="detail-value" [innerHTML]="formatText(interactionDetails.details.direction.description)"></span>
                              </div>
                            }
                            @if (interactionDetails.details.plausibility) {
                              <div class="detail-row">
                                <span class="detail-label">{{ 'interactions.detail_plausibility' | transloco }}</span>
                                <span class="detail-value">{{ interactionDetails.details.plausibility.description }}</span>
                              </div>
                            }
                            @if (interactionDetails.details.frequency) {
                              <div class="detail-row">
                                <span class="detail-label">{{ 'interactions.detail_frequency' | transloco }}</span>
                                <span class="detail-value">{{ interactionDetails.details.frequency.description }}</span>
                              </div>
                            }
                            @if (interactionDetails.details.sourceAssessment) {
                              <div class="detail-row">
                                <span class="detail-label">{{ 'interactions.detail_source' | transloco }}</span>
                                <span class="detail-value">{{ interactionDetails.details.sourceAssessment.description }}</span>
                              </div>
                            }
                          </div>
                        }
                      }
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>

      <!-- Drug-Food Interactions -->
      <div class="interactions-section">
        <div class="section-header">
          <h2>{{ 'interactions.drug_food_title' | transloco }}</h2>
          <span class="count-badge">{{ getFilteredDrugFoodInteractions().length }}</span>
        </div>

        @if (getFilteredDrugFoodInteractions().length === 0) {
          <div class="no-interactions">
            <p>‚úì {{ 'interactions.no_drug_food' | transloco }}</p>
          </div>
        } @else {
          <!-- Table Header -->
          <div class="interactions-header">
            <div class="header-cell left-header">{{ 'interactions.header_medication' | transloco }}</div>
            <div class="header-cell right-header">{{ 'interactions.header_food' | transloco }}</div>
            <div class="header-cell severity-header">{{ 'interactions.header_severity' | transloco }}</div>
            <div class="header-cell number-header">{{ 'interactions.header_number' | transloco }}</div>
            <div class="header-cell details-header">{{ 'interactions.header_details' | transloco }}</div>
            <div class="header-cell notes-header">{{ 'interactions.header_notes' | transloco }}</div>
          </div>

          <div class="interactions-list">
            @for (interaction of getFilteredDrugFoodInteractions(); track interaction.interactionNumber) {
              <div class="interaction-row-wrapper">
                <div 
                  class="interaction-card" 
                  [class.expanded]="expandedInteraction === interaction.interactionNumber"
                >
                  <div class="interaction-row" (click)="toggleInteraction(interaction.interactionNumber)">
                    <div class="cell left-medication">
                      <div class="medication-name">{{ interaction.medication }}</div>
                      <div class="substance">{{ interaction.substance }}</div>
                    </div>
                    <div class="cell right-medication">
                      <div class="medication-name">{{ interaction.food }}</div>
                    </div>
                    <div class="cell severity-cell">
                      <span class="severity-badge" [class]="getSeverityClass(interaction.severityCode)">
                        {{ interaction.severity }}
                      </span>
                    </div>
                    <div class="cell number-cell">
                      #{{ interaction.interactionNumber }}
                    </div>
                    <div class="cell details-cell">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 16v-4M12 8h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </div>
                    <div class="cell notes-cell" (click)="$event.stopPropagation()">
                      <button class="add-note-button" (click)="openNotesModal(interaction)" title="Add notes">
                        +
                      </button>
                    </div>
                  </div>
                  
                  @if (expandedInteraction === interaction.interactionNumber) {
                    <div class="interaction-details" (click)="$event.stopPropagation()">
                      @if (loadingDetails) {
                        <div class="details-loading">{{ 'interactions.loading_details' | transloco }}</div>
                      } @else if (interactionDetails) {
                        @if (interactionDetails.textGroups && interactionDetails.textGroups.length > 0) {
                          @for (group of interactionDetails.textGroups; track group.groupTitle) {
                            <div class="detail-group">
                              <h4 class="group-title">{{ group.groupTitle }}</h4>
                              @for (text of group.texts; track text.title.code) {
                                <div class="detail-text">
                                  <strong>{{ text.title.description }}:</strong>
                                  <p [innerHTML]="formatText(text.text)"></p>
                                </div>
                              }
                            </div>
                          }
                        }
                        @if (interactionDetails.details) {
                          <div class="detail-metadata">
                            @if (interactionDetails.details.direction && interactionDetails.details.direction.description !== 'fallbacks.no_direction') {
                              <div class="detail-row">
                                <span class="detail-label">{{ 'interactions.detail_direction' | transloco }}</span>
                                <span class="detail-value" [innerHTML]="formatText(interactionDetails.details.direction.description)"></span>
                              </div>
                            }
                            @if (interactionDetails.details.plausibility) {
                              <div class="detail-row">
                                <span class="detail-label">Plausibility:</span>
                                <span class="detail-value" [innerHTML]="formatText(interactionDetails.details.plausibility.description)"></span>
                              </div>
                            }
                            @if (interactionDetails.details.frequency) {
                              <div class="detail-row">
                                <span class="detail-label">Frequency:</span>
                                <span class="detail-value">{{ interactionDetails.details.frequency.description }}</span>
                              </div>
                            }
                            @if (interactionDetails.details.sourceAssessment) {
                              <div class="detail-row">
                                <span class="detail-label">Source:</span>
                                <span class="detail-value">{{ interactionDetails.details.sourceAssessment.description }}</span>
                              </div>
                            }
                          </div>
                        }
                      }
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>

```
--- END OF FILE: src\app\components\interactions\interactions.component.html ---

--- START OF FILE: src\app\components\interactions\interactions.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.interactions-container {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

// Loading and Error States
.loading-state,
.error-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4rem 2rem;
  background-color: $box-background;
  border-radius: $box-border-radius;
  border: $box-border-width solid $box-border;

  p {
    font-family: $primary-font;
    font-size: 1.1rem;
    color: $text-secondary;
    margin: 0;
  }

  .error-message {
    color: #dc2626;
    margin-bottom: 1rem;
  }

  .retry-button {
    padding: 0.5rem 1.5rem;
    background-color: $button-primary-background;
    color: $text-button-primary;
    border: none;
    border-radius: $box-border-radius;
    font-family: $primary-font;
    font-size: 0.95rem;
    font-weight: $font-weight-medium;
    cursor: pointer;
    transition: background-color 0.2s;

    &:hover {
      background-color: $button-primary-hover;
    }
  }
}

.interactions-content {
  display: flex;
  flex-direction: column;
  gap: 2rem;
  padding-top: 0.83rem; // Padding to account for section header
  margin-top: 2.5rem; // Adjusted to align first box with medication boxes
  overflow-y: auto;
  padding-right: 0.5rem; // Small padding for scrollbar
  position: relative;

  // Floating general note button in top right
  .floating-top-right {
    position: absolute;
    top: 0.5rem;
    right: 2rem;
    z-index: 10;
  }
}

// Section Headers
.interactions-section {
  margin-bottom: 1rem;

  .section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;

    h2 {
      margin: 0;
      font-family: $primary-font;
      font-size: 1.5rem;
      font-weight: $font-weight-semibold;
      color: $text-primary;
    }

    .count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 2rem;
      height: 2rem;
      padding: 0 0.75rem;
      background-color: $button-primary-background;
      color: white;
      border-radius: 12px;
      font-family: $primary-font;
      font-size: 0.875rem;
      font-weight: $font-weight-semibold;
    }
  }
}

// No Interactions Message
.no-interactions {
  background-color: lighten($medication-indication, 20%);
  border: 2px solid $medication-indication;
  border-radius: $box-border-radius;
  padding: 2rem;
  text-align: center;

  p {
    margin: 0;
    font-family: $primary-font;
    font-size: 1.1rem;
    color: darken($medication-indication, 30%);
    font-weight: $font-weight-medium;
  }
}

// Table Header (similar to schema header)
.interactions-header {
  display: grid;
  grid-template-columns: 2fr 2fr 1fr 1fr 0.5fr 0.5fr;
  padding: 0.75rem 2rem;
  background-color: #f8f9fa;
  border: 1px solid $box-border-primary;
  border-radius: $box-border-radius-small;
  margin: 0 0 1rem 0;
  font-weight: $font-weight-semibold;
  color: $text-primary;
  font-family: $primary-font;
  text-align: center;
  flex-shrink: 0; // Prevent header from shrinking

  .header-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
  }

  .left-header,
  .right-header {
    text-align: left;
    justify-content: flex-start;
  }
}

// Interactions List
.interactions-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  overflow: visible; // Prevent nested scrollbar
}

// Interaction Row Wrapper
.interaction-row-wrapper {
  display: flex;
  align-items: flex-start;
}

// Interaction Cards (matching medication box height)
.interaction-card {
  flex: 1;
  background-color: $box-background;
  border-radius: $box-border-radius;
  border: $box-border-width solid $box-border;
  transition: all 0.2s;
  cursor: pointer;
  overflow: hidden;

  &:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
  }

  &.expanded {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
}

// Interaction Row (grid matching header)
.interaction-row {
  display: grid;
  grid-template-columns: 2fr 2fr 1fr 1fr 0.5fr 0.5fr;
  height: 4.5rem; // Match medication box height
  align-items: center;
  cursor: pointer;

  .cell {
    padding: 0.75rem 1rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    height: 100%;

    &.left-medication,
    &.right-medication {
      gap: 0.25rem;

      .medication-name {
        font-family: $primary-font;
        font-size: 0.95rem;
        font-weight: $font-weight-semibold;
        color: $text-primary;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .substance {
        font-family: $primary-font;
        font-size: 0.75rem;
        color: $text-tertiary;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    }

    &.severity-cell,
    &.number-cell,
    &.details-cell,
    &.notes-cell {
      align-items: center;
      justify-content: center;
    }

    &.number-cell {
      font-family: $primary-font;
      font-size: 0.875rem;
      color: $text-tertiary;
      font-weight: $font-weight-medium;
    }

    &.details-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      
      svg {
        flex-shrink: 0;
        color: $text-tertiary;
      }
    }

    &.notes-cell {
      cursor: default;
      
      // Note buttons use global styling from _add-note-buttons.scss
    }
  }
}

// Severity Badges
.severity-badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-family: $primary-font;
  font-size: 0.75rem;
  font-weight: $font-weight-semibold;
  text-transform: uppercase;
  letter-spacing: 0.025em;
  white-space: nowrap;

  &.severity-high {
    background-color: #fee2e2;
    color: #991b1b;
  }

  &.severity-medium {
    background-color: #fed7aa;
    color: #9a3412;
  }

  &.severity-low {
    background-color: #fef3c7;
    color: #92400e;
  }
}

// Interaction Details (Expandable)
.interaction-details {
  padding: 1.5rem 2rem;
  border-top: 1px solid $box-border;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  animation: slideDown 0.2s ease-out;
  background-color: $box-background;
  cursor: default; // Reset cursor for detail area

  .details-loading {
    text-align: center;
    font-family: $primary-font;
    color: $text-secondary;
    padding: 1rem;
  }

  .detail-group {
    margin-bottom: 1rem;

    .group-title {
      font-family: $primary-font;
      font-size: 1rem;
      font-weight: $font-weight-semibold;
      color: $text-primary;
      margin: 0 0 0.5rem 0;
    }

    .detail-text {
      margin-bottom: 0.75rem;
      font-family: $primary-font;
      font-size: 0.875rem;

      strong {
        color: $text-primary;
        font-weight: $font-weight-semibold;
      }

      p {
        margin: 0.25rem 0 0 0;
        color: $text-secondary;
        line-height: 1.6;
        white-space: pre-wrap;
        font-family: $primary-font;
        white-space: pre-wrap;
        font-family: $primary-font;
      }
    }
  }

  .detail-metadata {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding-top: 0.75rem;
    border-top: 1px solid $box-border;

    .detail-row {
      display: flex;
      gap: 0.5rem;
      font-family: $primary-font;
      font-size: 0.875rem;

      .detail-label {
        font-weight: $font-weight-semibold;
        color: $text-primary;
        min-width: 140px;
      }

      .detail-value {
        color: $text-secondary;
      }
    }
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    max-height: 0;
  }
  to {
    opacity: 1;
    max-height: 500px;
  }
}

// Section Divider
.section-divider {
  display: none; // Removed as requested
}

// Responsive Design
@media (max-width: 768px) {
  .interactions-container {
    padding: 1rem;
  }

  .interactions-header {
    font-size: 0.75rem;
  }

  .interaction-row {
    grid-template-columns: 1.5fr 1.5fr 1fr 1fr 0.5fr;
    
    .cell {
      padding: 0.5rem;
      font-size: 0.8rem;
    }
  }

  .section-header {
    h2 {
      font-size: 1.25rem;
    }
  }
}

```
--- END OF FILE: src\app\components\interactions\interactions.component.scss ---

--- START OF FILE: src\app\components\interactions\interactions.component.ts ---
```typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { Medication } from '../../models/api.models';
import { Output, EventEmitter } from '@angular/core';

// Backend Request/Response Interfaces
interface CNKParticipant {
  cnk: string;
  routeOfAdministrationCode?: string;
}

interface InteractionsRequest {
  language: string;
  cnks: CNKParticipant[];
}

// APB Response Interfaces (returned by backend)
interface Participant {
  id: string;
  type: 'produ';
  routeOfAdministrationCode?: string;
}

interface CodeDescription {
  code: string;
  description: string;
}

interface Substance {
  code: string;
  description: string;
  routeOfAdministrations?: CodeDescription[];
}

interface DrugDrugInteraction {
  interactionNumber: string;
  isFoodDrugInteraction: boolean;
  leftSubstance: Substance;
  rightSubstance: Substance;
  direction: CodeDescription;
  sourceAssessment: CodeDescription | null;
  leftParticipant: Participant;
  rightParticipant: Participant;
}

interface InteractionMatch {
  clinicalRelevance: CodeDescription;
  interactions: DrugDrugInteraction[];
}

interface DrugFoodInteractionInfo {
  interactionNumber: string;
  leftSubstance: Substance;
  rightSubstance: Substance;
  direction: CodeDescription;
  sourceAssessment: CodeDescription | null;
}

interface DrugFoodInteractionItem {
  side: string;
  interactionInformation: DrugFoodInteractionInfo;
}

interface DrugFoodInteractionGroup {
  clinicalRelevance: CodeDescription;
  interactions: DrugFoodInteractionItem[];
}

interface DrugFoodInteraction {
  participant: Participant;
  interactionGroups: DrugFoodInteractionGroup[];
}

interface InteractionsResult {
  interactionMatches: InteractionMatch[];
  drugFoodInteractions: DrugFoodInteraction[];
}

interface InteractionsResponse {
  language: string;
  participants: Participant[];
  result: InteractionsResult;
}

// Display Interfaces
interface DisplayDrugDrugInteraction {
  interactionNumber: string;
  severity: string;
  severityCode: string;
  leftMedication: string;
  rightMedication: string;
  leftSubstance: string;
  rightSubstance: string;
  direction: string;
  leftParticipantId: string;
  rightParticipantId: string;
}

interface DisplayDrugFoodInteraction {
  interactionNumber: string;
  severity: string;
  severityCode: string;
  medication: string;
  substance: string;
  food: string;
  direction: string;
  participantId: string;
}

@Component({
  selector: 'app-interactions',
  standalone: true,
  imports: [CommonModule, TranslocoModule],
  templateUrl: './interactions.component.html',
  styleUrls: ['./interactions.component.scss']
})
export class InteractionsComponent implements OnInit {
  @Output() openNotes = new EventEmitter<{ type: 'drug-drug' | 'drug-food' | 'general', interaction: any }>();
  
  medications: Medication[] = [];
  loading = false;
  error: string | null = null;
  
  selectedMedicationId: string | null = null;
  expandedInteraction: string | null = null;
  loadingDetails = false;
  interactionDetails: any = null;
  
  drugDrugInteractions: DisplayDrugDrugInteraction[] = [];
  drugFoodInteractions: DisplayDrugFoodInteraction[] = [];
  
  // Severity order for sorting (highest to lowest)
  private severityOrder: { [key: string]: number } = {
    '50': 1, // Ernstig
    '40': 2, // Matig ernstig
    '30': 3, // Gering
    '20': 4,
    '10': 5
  };

  constructor(
    private apiService: ApiService,
    private stateService: StateService
  ) {}

  ngOnInit() {
    this.loadMedications();
  }

  // Public method to refresh interactions when medications change
  refreshInteractions() {
    console.log('[Interactions] Refreshing interactions data');
    this.loadMedications();
  }

  loadMedications() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.loading = true;
    this.error = null;

    this.apiService.getMedications(reviewId).subscribe({
      next: (medications) => {
        this.medications = medications;
        console.log('[Interactions] Loaded medications:', this.medications);
        
        if (medications.length > 0) {
          this.checkInteractions();
        }
      },
      error: (err) => {
        console.error('[Interactions] Error loading medications:', err);
        this.error = 'Failed to load medications';
        this.loading = false;
      }
    });
  }

  checkInteractions() {
    const cnks = this.medications
      .filter(med => med.cnk)
      .map(med => ({
        cnk: med.cnk!.toString().padStart(7, '0'),
        routeOfAdministrationCode: med.routeOfAdministration || 'OR'
      }));

    if (cnks.length === 0) {
      this.loading = false;
      return;
    }

    const request = {
      language: 'NL',
      cnks
    };

    console.log('[Interactions] Request:', request);

    this.apiService.checkInteractions(request).subscribe({
      next: (response) => {
        console.log('[Interactions] Response:', response);
        this.processInteractions(response);
        this.loading = false;
      },
      error: (err) => {
        console.error('[Interactions] Error checking interactions:', err);
        this.error = 'Failed to check interactions';
        this.loading = false;
      }
    });
  }

  processInteractions(response: InteractionsResponse) {
    // Process drug-drug interactions
    this.drugDrugInteractions = [];
    response.result.interactionMatches.forEach(match => {
      match.interactions.forEach(interaction => {
        const leftMed = this.getMedicationName(interaction.leftParticipant.id);
        const rightMed = this.getMedicationName(interaction.rightParticipant.id);
        
        this.drugDrugInteractions.push({
          interactionNumber: interaction.interactionNumber,
          severity: match.clinicalRelevance.description,
          severityCode: match.clinicalRelevance.code,
          leftMedication: leftMed,
          rightMedication: rightMed,
          leftSubstance: interaction.leftSubstance.description,
          rightSubstance: interaction.rightSubstance.description,
          direction: interaction.direction.description,
          leftParticipantId: interaction.leftParticipant.id,
          rightParticipantId: interaction.rightParticipant.id
        });
      });
    });

    // Sort by severity
    this.drugDrugInteractions.sort((a, b) => {
      return (this.severityOrder[a.severityCode] || 999) - (this.severityOrder[b.severityCode] || 999);
    });

    // Process drug-food interactions
    this.drugFoodInteractions = [];
    response.result.drugFoodInteractions.forEach(drugFood => {
      drugFood.interactionGroups.forEach(group => {
        group.interactions.forEach(interaction => {
          const med = this.getMedicationName(drugFood.participant.id);
          
          this.drugFoodInteractions.push({
            interactionNumber: interaction.interactionInformation.interactionNumber,
            severity: group.clinicalRelevance.description,
            severityCode: group.clinicalRelevance.code,
            medication: med,
            substance: interaction.interactionInformation.leftSubstance.description,
            food: interaction.interactionInformation.rightSubstance.description,
            direction: interaction.interactionInformation.direction.description,
            participantId: drugFood.participant.id
          });
        });
      });
    });

    // Sort by severity
    this.drugFoodInteractions.sort((a, b) => {
      return (this.severityOrder[a.severityCode] || 999) - (this.severityOrder[b.severityCode] || 999);
    });

    console.log('[Interactions] Processed drug-drug:', this.drugDrugInteractions);
    console.log('[Interactions] Processed drug-food:', this.drugFoodInteractions);
  }

  getMedicationName(cnkCode: string): string {
    const cnkNumber = parseInt(cnkCode);
    const med = this.medications.find(m => m.cnk === cnkNumber);
    return med?.name || cnkCode;
  }

  onMedicationClick(medicationId: string) {
    if (this.selectedMedicationId === medicationId) {
      // Deselect if already selected
      this.selectedMedicationId = null;
    } else {
      // Select medication
      this.selectedMedicationId = medicationId;
    }
  }

  toggleInteraction(interactionNumber: string) {
    if (this.expandedInteraction === interactionNumber) {
      // Collapse
      this.expandedInteraction = null;
      this.interactionDetails = null;
    } else {
      // Expand and fetch details
      this.expandedInteraction = interactionNumber;
      this.loadInteractionDetails(interactionNumber);
    }
  }

  loadInteractionDetails(interactionNumber: string): void {
    this.loadingDetails = true;
    this.interactionDetails = null;

    this.apiService.getInteractionDetails({
      language: 'NL',
      interactionNumber: interactionNumber
    }).subscribe({
      next: (response: any) => {
        console.log('[Interactions] Details response:', response);
        this.interactionDetails = response.result;
        this.loadingDetails = false;
      },
      error: (err: any) => {
        console.error('[Interactions] Error loading details:', err);
        this.loadingDetails = false;
      }
    });
  }

  isMedicationSelected(medicationId: string): boolean {
    return this.selectedMedicationId === medicationId;
  }

  getFilteredDrugDrugInteractions(): DisplayDrugDrugInteraction[] {
    if (!this.selectedMedicationId) {
      return this.drugDrugInteractions;
    }

    const selectedCnk = this.medications.find(m => m.medicationId === this.selectedMedicationId)?.cnk;
    if (!selectedCnk) return this.drugDrugInteractions;

    const selectedCnkStr = selectedCnk.toString().padStart(7, '0');

    return this.drugDrugInteractions.filter(interaction => 
      interaction.leftParticipantId === selectedCnkStr || 
      interaction.rightParticipantId === selectedCnkStr
    );
  }

  getFilteredDrugFoodInteractions(): DisplayDrugFoodInteraction[] {
    if (!this.selectedMedicationId) {
      return this.drugFoodInteractions;
    }

    const selectedCnk = this.medications.find(m => m.medicationId === this.selectedMedicationId)?.cnk;
    if (!selectedCnk) return this.drugFoodInteractions;

    const selectedCnkStr = selectedCnk.toString().padStart(7, '0');

    return this.drugFoodInteractions.filter(interaction => 
      interaction.participantId === selectedCnkStr
    );
  }

  getSeverityClass(severityCode: string): string {
    switch(severityCode) {
      case '50': return 'severity-high';
      case '40': return 'severity-medium';
      case '30': return 'severity-low';
      default: return 'severity-unknown';
    }
  }

  openNotesModal(interaction: any): void {
    console.log('[Interactions] Opening notes for interaction:', interaction);
    // Determine interaction type based on properties
    const type = 'leftMedication' in interaction ? 'drug-drug' : 'drug-food';
    this.openNotes.emit({ type, interaction });
  }

  openGeneralNotesModal(): void {
    console.log('[Interactions] Opening notes for general note (no interaction)');
    this.openNotes.emit({ type: 'general', interaction: null });
  }

  formatText(text: string): string {
    if (!text) return '';
    
    let formatted = text;
    
    // First, handle ~n as newline markers (before processing other ~ patterns)
    formatted = formatted.replace(/~n-?/g, '\n');
    
    // Replace ~text~ with <sub>text</sub> for subscript (but not single ~)
    formatted = formatted.replace(/~([^~\n]+)~/g, '<sub>$1</sub>');
    
    // Replace **text** with <strong>text</strong> for bold
    formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    
    // Extract and format literature section - improved detection
    const literatureMatch = formatted.match(/Literatuur[:.]?\s*(.*?)$/is);
    if (literatureMatch) {
      let literatureText = literatureMatch[1].trim();
      
      // Replace \n with actual newlines if they're escaped
      literatureText = literatureText.replace(/\\n/g, '\n');
      
      // Split by newline or by pattern like "Author et al." followed by journal info
      // This regex matches the pattern: Author(s) et al., Journal details (year)
      const refPattern = /([A-Z][a-z√§√∂√º√ü]+(?:,?\s+[A-Z]\.?)+\s+et\s+al\.|[A-Z][a-z√§√∂√º√ü]+\s+et\s+al\.|Fachinformation\s+[^,]+)[^n]*?(?:\([12]\d{3}\)|Stand\))/g;
      const references = literatureText.match(refPattern) || [];
      
      if (references.length > 0) {
        let formattedRefs = '<div class="literature-section"><strong>Literatuur:</strong><ol class="literature-list">';
        references.forEach(ref => {
          const cleanRef = ref.trim().replace(/^n/, ''); // Remove leading 'n' if present
          if (cleanRef && cleanRef.length > 10) { // Only add substantial references
            formattedRefs += `<li>${cleanRef}</li>`;
          }
        });
        formattedRefs += '</ol></div>';
        
        // Replace the original literature section with formatted version
        formatted = formatted.replace(/Literatuur[:.]?\s*.*$/is, formattedRefs);
      }
    }
    
    // Replace remaining line breaks with <br> tags
    formatted = formatted.replace(/\n/g, '<br>');
    
    // Format inline literature references (e.g., [1], [2-5])
    formatted = formatted.replace(/\[(\d+(?:-\d+)?(?:,\s*\d+(?:-\d+)?)*)\]/g, '<sup class="reference">[$1]</sup>');
    
    return formatted;
  }
}

```
--- END OF FILE: src\app\components\interactions\interactions.component.ts ---

--- START OF FILE: src\app\components\lab-value-item\lab-value-item.component.html ---
```typescript
<div class="lab-value-item">
  <div class="lab-value-content">
    <div class="lab-value-name">{{ labValue.name || ('lab_values.unnamed' | transloco) }}</div>
    <div class="lab-value-data">
      <span class="value">{{ labValue.value }}</span>
      @if (labValue.unit) {
        <span class="unit">{{ labValue.unit }}</span>
      }
    </div>
  </div>
  <button class="delete-button" (click)="onDelete()" [title]="'common.delete' | transloco"></button>
</div>

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirmation) {
  <app-confirmation-modal
    [title]="'actions.delete_lab_values' | transloco"
    [message]="('messages.confirm_delete_lab_value' | transloco)"
    [confirmText]="'common.delete' | transloco"
    [cancelText]="'common.cancel' | transloco"
    (confirm)="onDeleteConfirm()"
    (cancel)="onDeleteCancel()">
  </app-confirmation-modal>
}

```
--- END OF FILE: src\app\components\lab-value-item\lab-value-item.component.html ---

--- START OF FILE: src\app\components\lab-value-item\lab-value-item.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.lab-value-item {
  padding: 0.75rem;
  margin-bottom: 0.5rem;
  background-color: $main-background;
  border-radius: 4px;
  font-size: 0.875rem;
  color: $text-primary;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background-color 0.2s;

  &:hover {
    background-color: #f5f5f5;
  }

  .lab-value-content {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 1.5rem;

    .lab-value-name {
      font-weight: $font-weight-semibold;
      min-width: 150px;
    }

    .lab-value-data {
      display: flex;
      align-items: baseline;
      gap: 0.375rem;

      .value {
        font-weight: $font-weight-bold;
        font-size: 1rem;
      }

      .unit {
        font-weight: $font-weight-regular;
        color: $text-secondary;
      }
    }
  }

  .delete-button {
    background: none;
    border: none;
    color: #999;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
    flex-shrink: 0;

    &:hover {
      color: #c00;
    }

    svg {
      display: none;
    }

    &::before {
      content: '√ó';
    }
  }
}

```
--- END OF FILE: src\app\components\lab-value-item\lab-value-item.component.scss ---

--- START OF FILE: src\app\components\lab-value-item\lab-value-item.component.ts ---
```typescript
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';
import { LabValue } from '../../models/api.models';
import { ConfirmationModalComponent } from '../confirmation-modal/confirmation-modal.component';

@Component({
  selector: 'app-lab-value-item',
  standalone: true,
  imports: [CommonModule, ConfirmationModalComponent, TranslocoModule],
  templateUrl: './lab-value-item.component.html',
  styleUrls: ['./lab-value-item.component.scss']
})
export class LabValueItemComponent {
  @Input() labValue!: LabValue;
  @Output() delete = new EventEmitter<string>();
  showDeleteConfirmation = false;

  onDelete() {
    this.showDeleteConfirmation = true;
  }

  onDeleteConfirm() {
    this.showDeleteConfirmation = false;
    this.delete.emit(this.labValue.labValueId);
  }

  onDeleteCancel() {
    this.showDeleteConfirmation = false;
  }
}

```
--- END OF FILE: src\app\components\lab-value-item\lab-value-item.component.ts ---

--- START OF FILE: src\app\components\lab-values\lab-values.component.html ---
```typescript
<div class="lab-values-box">
  <app-lab-values-list></app-lab-values-list>
</div>

```
--- END OF FILE: src\app\components\lab-values\lab-values.component.html ---

--- START OF FILE: src\app\components\lab-values\lab-values.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.lab-values-box {
  background-color: $box-background;
  border: $box-border-width solid $box-border-primary;
  border-radius: $box-border-radius;
  padding: 1.5rem;
  margin-bottom: 1.5rem;

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;

    .box-title {
      font-size: 1.2rem;
      margin: 0;
      color: $text-primary;
    }

    .add-button {
      padding: 0.5rem 1rem;
      background-color: $button-primary;
      color: $text-button-primary;
      border: $box-border-width solid $box-border-primary;
      border-radius: $box-border-radius;
      font-family: $primary-font;
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background-color 0.2s ease;

      &:hover {
        background-color: $button-primary-hover;
      }

      .plus-icon {
        font-size: 1.2rem;
        font-weight: bold;
      }
    }
  }

  .list-container {
    .items-list {
      list-style: none;
      padding: 0;
      margin: 0;

      li {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background-color: $main-background;
        border-radius: 4px;
        font-size: 0.875rem;
        color: $text-primary;
        display: flex;
        justify-content: space-between;

        .lab-name {
          font-weight: $font-weight-medium;
        }

        .lab-value {
          color: $text-secondary;
        }
      }
    }
  }
}

```
--- END OF FILE: src\app\components\lab-values\lab-values.component.scss ---

--- START OF FILE: src\app\components\lab-values\lab-values.component.ts ---
```typescript
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { LabValuesListComponent } from '../lab-values-list/lab-values-list.component';

@Component({
  selector: 'app-lab-values',
  standalone: true,
  imports: [CommonModule, LabValuesListComponent],
  templateUrl: './lab-values.component.html',
  styleUrls: ['./lab-values.component.scss']
})
export class LabValuesComponent {}

```
--- END OF FILE: src\app\components\lab-values\lab-values.component.ts ---

--- START OF FILE: src\app\components\lab-values-list\lab-values-list.component.html ---
```typescript
<div class="lab-values-container">
  <div class="header">
    <h3 class="title">{{ 'tools.lab_values' | transloco }}</h3>
    <button class="add-button" (click)="openAddModal()">
      <span class="plus-icon">+</span> {{ 'common.add' | transloco }}
    </button>
  </div>

  <div class="list-container">
    @if (isLoading) {
      <div class="loading">{{ 'common.loading' | transloco }}</div>
    } @else if (labValues.length === 0) {
      <div class="empty-state">
        {{ 'tools.lab_values' | transloco }} - {{ 'tools.add' | transloco }}
      </div>
    } @else {
      <app-lab-value-item
        *ngFor="let labValue of labValues"
        [labValue]="labValue"
        (delete)="onLabValueDeleted($event)">
      </app-lab-value-item>
    }
  </div>
</div>

<!-- Add Lab Value Modal -->
@if (showAddModal) {
  <app-add-lab-value-modal
    (close)="closeAddModal()"
    (labValueAdded)="onLabValueAdded($event)">
  </app-add-lab-value-modal>
}

```
--- END OF FILE: src\app\components\lab-values-list\lab-values-list.component.html ---

--- START OF FILE: src\app\components\lab-values-list\lab-values-list.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.lab-values-container {
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;

    .title {
      font-size: 1.2rem;
      margin: 0;
      color: $text-primary;
    }

    .add-button {
      padding: 0.5rem 1rem;
      background-color: $button-primary;
      color: $text-button-primary;
      border: $box-border-width solid $box-border-primary;
      border-radius: $box-border-radius;
      font-family: $primary-font;
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background-color 0.2s ease;

      &:hover {
        background-color: $button-primary-hover;
      }

      .plus-icon {
        font-size: 1.2rem;
        font-weight: bold;
      }
    }
  }

  .list-container {
    .loading {
      text-align: center;
      padding: 1rem;
      color: $text-primary;
      font-family: $primary-font;
      font-style: italic;
    }

    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: #999;
      font-family: $primary-font;
      font-style: italic;
      font-size: 0.875rem;
    }
  }
}

```
--- END OF FILE: src\app\components\lab-values-list\lab-values-list.component.scss ---

--- START OF FILE: src\app\components\lab-values-list\lab-values-list.component.ts ---
```typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';
import { LabValueItemComponent } from '../lab-value-item/lab-value-item.component';
import { AddLabValueModalComponent, LabValueData } from '../add-lab-value-modal/add-lab-value-modal.component';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { LabValue } from '../../models/api.models';

@Component({
  selector: 'app-lab-values-list',
  standalone: true,
  imports: [CommonModule, TranslocoModule, LabValueItemComponent, AddLabValueModalComponent],
  templateUrl: './lab-values-list.component.html',
  styleUrls: ['./lab-values-list.component.scss']
})
export class LabValuesListComponent implements OnInit {
  labValues: LabValue[] = [];
  showAddModal = false;
  isLoading = false;

  constructor(
    private apiService: ApiService,
    private stateService: StateService
  ) {}

  ngOnInit() {
    this.loadLabValues();
  }

  loadLabValues() {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      this.labValues = [];
      return;
    }

    this.isLoading = true;
    this.apiService.getLabValues(medicationReviewId).subscribe({
      next: (labValues) => {
        this.labValues = labValues;
        this.isLoading = false;
      },
      error: (error) => {
        console.error('[LabValuesList] Failed to load lab values:', error);
        this.labValues = [];
        this.isLoading = false;
      }
    });
  }

  openAddModal() {
    this.showAddModal = true;
  }

  closeAddModal() {
    this.showAddModal = false;
  }

  onLabValueAdded(data: LabValueData) {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      console.error('[LabValuesList] No medication review ID');
      return;
    }

    this.apiService.addLabValue(
      medicationReviewId,
      {
        name: data.name,
        value: data.value,
        unit: data.unit
      }
    ).subscribe({
      next: (response) => {
        console.log('[LabValuesList] Lab value added:', response);
        this.loadLabValues();
      },
      error: (error) => {
        console.error('[LabValuesList] Failed to add lab value:', error);
        alert('Failed to add lab value. Please try again.');
      }
    });
  }

  onLabValueDeleted(labValueId: string) {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      console.error('[LabValuesList] No medication review ID');
      return;
    }

    this.apiService.deleteLabValue(medicationReviewId, labValueId).subscribe({
      next: () => {
        console.log('[LabValuesList] Lab value deleted:', labValueId);
        this.labValues = this.labValues.filter(lv => lv.labValueId !== labValueId);
      },
      error: (error) => {
        console.error('[LabValuesList] Failed to delete lab value:', error);
        alert('Failed to delete lab value. Please try again.');
      }
    });
  }
}

```
--- END OF FILE: src\app\components\lab-values-list\lab-values-list.component.ts ---

--- START OF FILE: src\app\components\manage-moments-modal\manage-moments-modal.component.html ---
```typescript
<div class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ 'manage_moments.title' | transloco }}</h2>
      <button class="close-button" (click)="closeModal()">√ó</button>
    </div>

    <div class="modal-body">
      @if (loading) {
        <div class="loading-state">
          <p>{{ 'manage_moments.loading' | transloco }}</p>
        </div>
      } @else if (!dispensingHistory || dispensingHistory.dispensingData.length === 0) {
        <div class="no-data">
          <p>{{ 'manage_moments.no_data' | transloco }}</p>
        </div>
      } @else {
        <div class="medication-selector">
          <label for="medication-select">{{ 'manage_moments.select_medication' | transloco }}</label>
          <select 
            id="medication-select" 
            [(ngModel)]="selectedCnk"
            (change)="onMedicationSelected()"
          >
            @for (cnkGroup of dispensingHistory.dispensingData; track cnkGroup.cnk) {
              <option [value]="cnkGroup.cnk">{{ cnkGroup.description }} (CNK: {{ cnkGroup.cnk }})</option>
            }
          </select>
        </div>

        @if (filteredMoments.length === 0) {
          <div class="no-moments">
            <p>{{ 'manage_moments.no_manual_moments' | transloco }}</p>
          </div>
        } @else {
          <div class="moments-table">
            <div class="table-header">
              <div class="col-date">{{ 'manage_moments.date' | transloco }}</div>
              <div class="col-amount">{{ 'manage_moments.amount' | transloco }}</div>
              <div class="col-actions">{{ 'manage_moments.actions' | transloco }}</div>
            </div>

            @for (moment of filteredMoments; track moment.id) {
              <div class="table-row" [class.deleting]="isDeleting(moment.id)">
                <div class="col-date">{{ formatDate(moment.date) }}</div>
                <div class="col-amount">{{ moment.amount }}</div>
                <div class="col-actions">
                  <button 
                    class="delete-button" 
                    (click)="deleteMoment(moment)"
                    [disabled]="isDeleting(moment.id)"
                  >
                    @if (isDeleting(moment.id)) {
                      <span>{{ 'common.loading' | transloco }}</span>
                    } @else {
                      <span>{{ 'manage_moments.delete' | transloco }}</span>
                    }
                  </button>
                </div>
              </div>
            }
          </div>

          <div class="summary">
            <p>{{ 'manage_moments.total' | transloco }}: {{ filteredMoments.length }}</p>
          </div>
        }

        @if (error) {
          <div class="error-message">{{ error }}</div>
        }
      }
    </div>

    <div class="modal-footer">
      <button class="close-footer-button" (click)="closeModal()">
        {{ 'common.close' | transloco }}
      </button>
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\components\manage-moments-modal\manage-moments-modal.component.html ---

--- START OF FILE: src\app\components\manage-moments-modal\manage-moments-modal.component.scss ---
```typescript
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 8px;
  width: 90%;
  max-width: 700px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid #e0e0e0;

  h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
  }

  .close-button {
    background: none;
    border: none;
    font-size: 2rem;
    line-height: 1;
    color: #666;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;

    &:hover {
      background-color: #f5f5f5;
      color: #333;
    }
  }
}

.modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 1.5rem;
}

.modal-footer {
  padding: 1rem 1.5rem;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
}

.loading-state,
.no-data,
.no-moments {
  text-align: center;
  padding: 3rem;
  color: #666;
  font-size: 1rem;
}

.medication-selector {
  margin-bottom: 1.5rem;

  label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #333;
  }

  select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    background-color: white;
    cursor: pointer;

    &:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }
  }
}

.moments-table {
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  overflow: hidden;

  .table-header,
  .table-row {
    display: grid;
    grid-template-columns: 150px 100px 80px;
    gap: 12px;
    padding: 12px;
    align-items: center;
  }

  .table-header {
    background-color: #f5f5f5;
    font-weight: 600;
    font-size: 13px;
    color: #555;
    border-bottom: 1px solid #e0e0e0;
  }

  .table-row {
    background-color: white;
    font-size: 14px;
    border-bottom: 1px solid #f0f0f0;

    &:last-child {
      border-bottom: none;
    }

    &:hover:not(.deleting) {
      background-color: #fafafa;
    }

    &.deleting {
      opacity: 0.5;
      pointer-events: none;
    }
  }

  .col-actions {
    display: flex;
    justify-content: center;
  }

  .delete-button {
    background: none;
    border: 1px solid #f44336;
    font-size: 12px;
    line-height: 1;
    color: #f44336;
    cursor: pointer;
    padding: 6px 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
    font-family: inherit;
    font-weight: 500;

    &:hover:not(:disabled) {
      background-color: #f44336;
      color: white;
    }

    &:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    span {
      display: block;
    }
  }
}

.summary {
  margin-top: 1rem;
  padding: 0.75rem;
  background-color: #f5f5f5;
  border-radius: 4px;
  text-align: center;
  font-weight: 500;
  color: #555;

  p {
    margin: 0;
  }
}

.error-message {
  margin-top: 1rem;
  padding: 1rem;
  background-color: #ffebee;
  color: #c62828;
  border-radius: 4px;
  font-size: 0.875rem;
}

.close-footer-button {
  padding: 0.5rem 1.5rem;
  background-color: #6c757d;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;

  &:hover {
    background-color: #5a6268;
  }
}

```
--- END OF FILE: src\app\components\manage-moments-modal\manage-moments-modal.component.scss ---

--- START OF FILE: src\app\components\manage-moments-modal\manage-moments-modal.component.ts ---
```typescript
import { Component, OnInit, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { TranslocoModule } from '@jsverse/transloco';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { DispensingHistoryResponse, DispensingMoment } from '../../models/api.models';

@Component({
  selector: 'app-manage-moments-modal',
  standalone: true,
  imports: [CommonModule, FormsModule, TranslocoModule],
  templateUrl: './manage-moments-modal.component.html',
  styleUrls: ['./manage-moments-modal.component.scss']
})
export class ManageMomentsModalComponent implements OnInit {
  @Output() close = new EventEmitter<void>();
  @Output() momentsDeleted = new EventEmitter<void>();

  dispensingHistory: DispensingHistoryResponse | null = null;
  selectedCnk: string = '';
  filteredMoments: DispensingMoment[] = [];
  deletingIds = new Set<string>();
  
  loading = false;
  error: string | null = null;

  constructor(
    private apiService: ApiService,
    private stateService: StateService
  ) {}

  ngOnInit() {
    this.loadDispensingHistory();
  }

  loadDispensingHistory() {
    const apbNumber = this.stateService.apbNumber;
    const reviewId = this.stateService.medicationReviewId;

    if (!apbNumber || !reviewId) {
      this.error = 'Session data not available. Please log in again.';
      return;
    }

    this.loading = true;
    this.error = null;

    this.apiService.queryDispensingHistory(apbNumber, reviewId).subscribe({
      next: (response) => {
        console.log('[ManageMoments] Dispensing history loaded:', response);
        console.log('[ManageMoments] First CNK group:', response.dispensingData?.[0]);
        console.log('[ManageMoments] First moment in first CNK:', response.dispensingData?.[0]?.dispensingMoments?.[0]);
        
        this.dispensingHistory = response;
        this.loading = false;
        
        // Auto-select first medication if available
        if (response.dispensingData && response.dispensingData.length > 0) {
          this.selectedCnk = response.dispensingData[0].cnk;
          this.onMedicationSelected();
        }
      },
      error: (err) => {
        console.error('Error loading dispensing history:', err);
        this.loading = false;
        this.error = err.status === 404 
          ? 'No dispensing history found. Please upload a CSV file or add manual moments first.'
          : 'Failed to load dispensing history';
      }
    });
  }

  onMedicationSelected() {
    if (!this.dispensingHistory || !this.selectedCnk) {
      this.filteredMoments = [];
      return;
    }

    const cnkGroup = this.dispensingHistory.dispensingData.find(
      group => group.cnk === this.selectedCnk || group.cnk === this.selectedCnk.toString()
    );

    if (cnkGroup) {
      // Only show manual moments (can be deleted)
      this.filteredMoments = cnkGroup.dispensingMoments.filter(
        moment => moment.source === 'manual'
      );
      console.log('[ManageMoments] Filtered moments for CNK', this.selectedCnk, ':', this.filteredMoments);
      console.log('[ManageMoments] First moment ID:', this.filteredMoments[0]?.id);
    } else {
      this.filteredMoments = [];
    }
  }

  getMedicationName(cnk: string): string {
    if (!this.dispensingHistory) return cnk;
    
    const cnkGroup = this.dispensingHistory.dispensingData.find(
      group => group.cnk === cnk || group.cnk === cnk.toString()
    );
    
    return cnkGroup ? cnkGroup.description : cnk;
  }

  formatDate(isoDate: string): string {
    // Handle both DD/MM/YYYY and YYYY-MM-DD formats
    if (isoDate.includes('/')) {
      return isoDate; // Already in DD/MM/YYYY format
    }
    
    const date = new Date(isoDate);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  deleteMoment(moment: DispensingMoment) {
    console.log('[ManageMoments] Delete moment called:', moment);
    console.log('[ManageMoments] Moment ID value:', moment.id);
    console.log('[ManageMoments] Moment ID type:', typeof moment.id);
    console.log('[ManageMoments] Full moment object:', moment);
    
    if (!moment.id || moment.id.trim?.() === '' || moment.id === null) {
      this.error = 'Cannot delete: moment ID is missing or empty. ID value: "' + moment.id + '". Properties: ' + Object.keys(moment).join(', ') + '. Values: ' + JSON.stringify(moment);
      console.error('[ManageMoments] Moment missing or empty ID. Full moment object:', moment);
      return;
    }

    const apbNumber = this.stateService.apbNumber;
    const reviewId = this.stateService.medicationReviewId;

    if (!apbNumber || !reviewId) {
      this.error = 'Session data not available. Please log in again.';
      return;
    }

    this.deletingIds.add(moment.id);
    this.error = null;

    this.apiService.deleteManualDispensingMoment(apbNumber, reviewId, moment.id).subscribe({
      next: (response) => {
        console.log('Deleted manual dispensing moment:', response);
        this.deletingIds.delete(moment.id!);
        
        // Remove from local data
        this.removeFromLocalData(moment.id!);
        
        // Notify parent to refresh
        this.momentsDeleted.emit();
      },
      error: (err) => {
        this.deletingIds.delete(moment.id!);
        
        if (err.status === 404) {
          // Already deleted, remove from local data
          this.removeFromLocalData(moment.id!);
          this.momentsDeleted.emit();
        } else {
          this.error = err.error?.error || 'Failed to delete dispensing moment';
        }
        
        console.error('Delete manual dispensing moment failed:', err);
      }
    });
  }

  private removeFromLocalData(id: string) {
    if (!this.dispensingHistory) return;

    for (const cnkGroup of this.dispensingHistory.dispensingData) {
      const momentIndex = cnkGroup.dispensingMoments.findIndex(m => m.id === id);
      if (momentIndex !== -1) {
        cnkGroup.dispensingMoments.splice(momentIndex, 1);
        if (this.dispensingHistory.manualMoments !== undefined) {
          this.dispensingHistory.manualMoments--;
        }
        this.dispensingHistory.totalDispensingMoments--;
        
        // Refresh filtered moments
        this.onMedicationSelected();
        
        // If CNK group is now empty, remove it
        if (cnkGroup.dispensingMoments.length === 0) {
          const cnkIndex = this.dispensingHistory.dispensingData.indexOf(cnkGroup);
          this.dispensingHistory.dispensingData.splice(cnkIndex, 1);
          this.dispensingHistory.totalCnkCodes--;
          
          // Select first remaining medication or clear selection
          if (this.dispensingHistory.dispensingData.length > 0) {
            this.selectedCnk = this.dispensingHistory.dispensingData[0].cnk;
            this.onMedicationSelected();
          } else {
            this.selectedCnk = '';
            this.filteredMoments = [];
          }
        }
        
        break;
      }
    }
  }

  isDeleting(id: string | undefined): boolean {
    return id ? this.deletingIds.has(id) : false;
  }

  closeModal() {
    this.close.emit();
  }
}

```
--- END OF FILE: src\app\components\manage-moments-modal\manage-moments-modal.component.ts ---

--- START OF FILE: src\app\components\manual-dispensing-modal\manual-dispensing-modal.component.html ---
```typescript
<div class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ 'manual_dispensing.title' | transloco }}</h2>
      <button class="close-button" (click)="closeModal()" [disabled]="submitting">√ó</button>
    </div>

    <div class="modal-body">
      @if (loading) {
        <div class="loading-state">
          <p>{{ 'manual_dispensing.loading_medications' | transloco }}</p>
        </div>
      } @else {
        <!-- Add dispensing moment form -->
        <div class="add-moment-form">
          <h3>{{ 'manual_dispensing.add_moment' | transloco }}</h3>

          <div class="form-group">
            <label for="medication-select">{{ 'manual_dispensing.select_medication' | transloco }} *</label>
            <select 
              id="medication-select" 
              [(ngModel)]="currentMoment.cnk"
              (change)="onMedicationSelected($event)"
              [disabled]="submitting"
              [class.error]="currentMoment.errors?.medication"
            >
              <option value="">{{ 'manual_dispensing.select_medication_placeholder' | transloco }}</option>
              @for (med of medications; track med.medicationId) {
                <option [value]="med.cnk?.toString() || ''">{{ med.name }} (CNK: {{ med.cnk }})</option>
              }
            </select>
            @if (currentMoment.errors?.medication) {
              <small class="error-text">{{ currentMoment.errors?.medication }}</small>
            }
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="date">{{ 'manual_dispensing.date' | transloco }} *</label>
              <input 
                id="date" 
                type="date" 
                [(ngModel)]="currentMoment.date"
                [disabled]="submitting"
                [class.error]="currentMoment.errors?.date"
              />
              @if (currentMoment.errors?.date) {
                <small class="error-text">{{ currentMoment.errors?.date }}</small>
              }
            </div>

            <div class="form-group">
              <label for="amount">{{ 'manual_dispensing.amount' | transloco }} *</label>
              <input 
                id="amount" 
                type="number" 
                [(ngModel)]="currentMoment.amount" 
                min="1"
                [disabled]="submitting"
                [class.error]="currentMoment.errors?.amount"
              />
              @if (currentMoment.errors?.amount) {
                <small class="error-text">{{ currentMoment.errors?.amount }}</small>
              }
            </div>
          </div>

          <button 
            class="add-to-list-button" 
            (click)="addToList()"
            [disabled]="submitting"
          >
            {{ 'manual_dispensing.add_to_list' | transloco }}
          </button>
        </div>

        <!-- List of moments to be added -->
        @if (moments.length > 0) {
          <div class="moments-list">
            <h3>{{ 'manual_dispensing.moments_to_add' | transloco }} ({{ moments.length }})</h3>
            
            <div class="moments-table">
              <div class="table-header">
                <div class="col-medication">{{ 'manual_dispensing.medication' | transloco }}</div>
                <div class="col-date">{{ 'manual_dispensing.date' | transloco }}</div>
                <div class="col-amount">{{ 'manual_dispensing.amount' | transloco }}</div>
                <div class="col-actions"></div>
              </div>

              @for (moment of moments; track $index) {
                <div class="table-row">
                  <div class="col-medication">{{ moment.description }}</div>
                  <div class="col-date">{{ formatDate(moment.date) }}</div>
                  <div class="col-amount">{{ moment.amount }}</div>
                  <div class="col-actions">
                    <button 
                      class="remove-button" 
                      (click)="removeFromList($index)"
                      [disabled]="submitting"
                      title="{{ 'manual_dispensing.remove' | transloco }}"
                    >
                      √ó
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        @if (error) {
          <div class="error-message">{{ error }}</div>
        }

        @if (successCount > 0 && !submitting) {
          <div class="success-message">
            {{ 'manual_dispensing.success_message' | transloco: { count: successCount } }}
          </div>
        }
      }
    </div>

    <div class="modal-footer">
      <button 
        class="cancel-button" 
        (click)="closeModal()"
        [disabled]="submitting"
      >
        {{ 'common.cancel' | transloco }}
      </button>
      
      <button 
        class="submit-button" 
        (click)="submitAll()"
        [disabled]="moments.length === 0 || submitting || loading"
      >
        @if (submitting) {
          <span>{{ 'manual_dispensing.submitting' | transloco }}</span>
        } @else {
          <span>{{ 'manual_dispensing.submit_all' | transloco }} ({{ moments.length }})</span>
        }
      </button>
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\components\manual-dispensing-modal\manual-dispensing-modal.component.html ---

--- START OF FILE: src\app\components\manual-dispensing-modal\manual-dispensing-modal.component.scss ---
```typescript
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.modal-content {
  background: white;
  border-radius: 8px;
  max-width: 900px;
  width: 100%;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;

  h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #333;
  }

  .close-button {
    background: none;
    border: none;
    font-size: 28px;
    line-height: 1;
    color: #666;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;

    &:hover:not(:disabled) {
      background-color: #f5f5f5;
      color: #333;
    }

    &:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
  }
}

.modal-body {
  padding: 24px;
  overflow-y: auto;
  flex: 1;
}

.loading-state {
  text-align: center;
  padding: 40px 20px;
  color: #666;
}

.add-moment-form {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 6px;
  margin-bottom: 24px;

  h3 {
    margin: 0 0 16px 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }

  .form-group {
    margin-bottom: 16px;

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
      color: #555;
    }

    input,
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.2s;

      &:focus {
        outline: none;
        border-color: #4CAF50;
      }

      &.error {
        border-color: #f44336;
      }

      &:disabled {
        background-color: #f5f5f5;
        cursor: not-allowed;
      }
    }

    select {
      cursor: pointer;
    }

    .error-text {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      color: #f44336;
    }
  }

  .form-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 12px;
  }

  .add-to-list-button {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;

    &:hover:not(:disabled) {
      background-color: #45a049;
    }

    &:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  }
}

.moments-list {
  h3 {
    margin: 0 0 12px 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }
}

.moments-table {
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  overflow: hidden;

  .table-header,
  .table-row {
    display: grid;
    grid-template-columns: 1fr 120px 80px 50px;
    gap: 12px;
    padding: 12px;
    align-items: center;
  }

  .table-header {
    background-color: #f5f5f5;
    font-weight: 600;
    font-size: 13px;
    color: #555;
    border-bottom: 1px solid #e0e0e0;
  }

  .table-row {
    background-color: white;
    font-size: 14px;
    border-bottom: 1px solid #f0f0f0;

    &:last-child {
      border-bottom: none;
    }

    &:hover {
      background-color: #fafafa;
    }
  }

  .col-medication {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .col-actions {
    display: flex;
    justify-content: center;
  }

  .remove-button {
    background: none;
    border: none;
    font-size: 24px;
    line-height: 1;
    color: #f44336;
    cursor: pointer;
    padding: 0;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;

    &:hover:not(:disabled) {
      background-color: #ffebee;
    }

    &:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
  }
}

.error-message,
.success-message {
  padding: 12px 16px;
  border-radius: 4px;
  margin-top: 16px;
  font-size: 14px;
}

.error-message {
  background-color: #ffebee;
  color: #c62828;
  border: 1px solid #ef9a9a;
}

.success-message {
  background-color: #e8f5e9;
  color: #2e7d32;
  border: 1px solid #a5d6a7;
}

.modal-footer {
  padding: 16px 24px;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: flex-end;
  gap: 12px;

  button {
    padding: 10px 24px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;

    &:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
  }

  .cancel-button {
    background-color: #fff;
    color: #666;
    border: 1px solid #ddd;

    &:hover:not(:disabled) {
      background-color: #f5f5f5;
    }
  }

  .submit-button {
    background-color: #2196F3;
    color: white;

    &:hover:not(:disabled) {
      background-color: #1976D2;
    }

    &:disabled {
      background-color: #ccc;
    }
  }
}

```
--- END OF FILE: src\app\components\manual-dispensing-modal\manual-dispensing-modal.component.scss ---

--- START OF FILE: src\app\components\manual-dispensing-modal\manual-dispensing-modal.component.ts ---
```typescript
import { Component, OnInit, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { TranslocoModule } from '@jsverse/transloco';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { AddManualDispensingMomentRequest, AddManualDispensingMomentResponse, Medication } from '../../models/api.models';

interface DispensingMomentEntry {
  cnk: string;
  description: string;
  date: string;
  amount: number;
  errors?: {
    medication?: string;
    date?: string;
    amount?: string;
  };
}

@Component({
  selector: 'app-manual-dispensing-modal',
  standalone: true,
  imports: [CommonModule, FormsModule, TranslocoModule],
  templateUrl: './manual-dispensing-modal.component.html',
  styleUrls: ['./manual-dispensing-modal.component.scss']
})
export class ManualDispensingModalComponent implements OnInit {
  @Output() close = new EventEmitter<void>();
  @Output() momentsAdded = new EventEmitter<void>();

  medications: Medication[] = [];
  moments: DispensingMomentEntry[] = [];
  currentMoment: DispensingMomentEntry = this.createEmptyMoment();
  
  loading = false;
  submitting = false;
  error: string | null = null;
  successCount = 0;
  failureCount = 0;

  constructor(
    private apiService: ApiService,
    private stateService: StateService
  ) {}

  ngOnInit() {
    this.loadMedications();
    // Pre-fill with today's date
    this.currentMoment.date = new Date().toISOString().split('T')[0];
  }

  loadMedications() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.loading = true;
    this.apiService.getMedications(reviewId).subscribe({
      next: (medications) => {
        // Only include medications with CNK codes
        this.medications = medications.filter(m => m.cnk);
        this.loading = false;
      },
      error: (err) => {
        console.error('Error loading medications:', err);
        this.loading = false;
        this.error = 'Failed to load medications';
      }
    });
  }

  createEmptyMoment(): DispensingMomentEntry {
    return {
      cnk: '',
      description: '',
      date: new Date().toISOString().split('T')[0],
      amount: 1
    };
  }

  onMedicationSelected(event: Event) {
    const select = event.target as HTMLSelectElement;
    const cnk = select.value;
    
    if (cnk) {
      const medication = this.medications.find(m => m.cnk?.toString() === cnk);
      if (medication) {
        this.currentMoment.description = medication.name || '';
        this.currentMoment.cnk = cnk; // Ensure CNK is set as string
      }
    } else {
      this.currentMoment.description = '';
      this.currentMoment.cnk = '';
    }
  }

  validateCurrentMoment(): boolean {
    this.currentMoment.errors = {};
    let isValid = true;

    // Validate medication selection
    if (!this.currentMoment.cnk || this.currentMoment.cnk.trim() === '') {
      this.currentMoment.errors.medication = 'Please select a medication';
      isValid = false;
    }

    // Validate date
    if (!this.currentMoment.date) {
      this.currentMoment.errors.date = 'Date is required';
      isValid = false;
    }

    // Validate amount
    if (!this.currentMoment.amount || this.currentMoment.amount < 1) {
      this.currentMoment.errors.amount = 'Amount must be at least 1';
      isValid = false;
    }

    return isValid;
  }

  addToList() {
    if (this.validateCurrentMoment()) {
      // Create a copy without errors property for the list
      const momentCopy: DispensingMomentEntry = {
        cnk: this.currentMoment.cnk,
        description: this.currentMoment.description,
        date: this.currentMoment.date,
        amount: this.currentMoment.amount
      };
      
      this.moments.push(momentCopy);
      
      // Reset only date and amount, keep the selected medication
      const selectedCnk = this.currentMoment.cnk;
      const selectedDescription = this.currentMoment.description;
      this.currentMoment.date = new Date().toISOString().split('T')[0];
      this.currentMoment.amount = 1;
      this.currentMoment.errors = {};
      
      // Preserve the medication selection
      this.currentMoment.cnk = selectedCnk;
      this.currentMoment.description = selectedDescription;
      
      this.error = null;
    }
  }

  removeFromList(index: number) {
    this.moments.splice(index, 1);
  }

  formatDate(isoDate: string): string {
    const date = new Date(isoDate);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  async submitAll() {
    if (this.moments.length === 0) {
      this.error = 'Please add at least one dispensing moment';
      return;
    }

    const apbNumber = this.stateService.apbNumber;
    const reviewId = this.stateService.medicationReviewId;

    if (!apbNumber || !reviewId) {
      this.error = 'Session data not available. Please log in again.';
      return;
    }

    this.submitting = true;
    this.successCount = 0;
    this.failureCount = 0;
    this.error = null;

    for (const moment of this.moments) {
      const request: AddManualDispensingMomentRequest = {
        cnk: moment.cnk.toString(), // Ensure CNK is string
        description: moment.description,
        date: moment.date, // Send as ISO format (YYYY-MM-DD)
        amount: moment.amount
      };

      try {
        await this.apiService.addManualDispensingMoment(apbNumber, reviewId, request).toPromise();
        this.successCount++;
      } catch (err: any) {
        this.failureCount++;
        console.error('Failed to add moment:', moment, err);
      }
    }

    this.submitting = false;

    if (this.failureCount === 0) {
      // All succeeded
      this.momentsAdded.emit();
      setTimeout(() => this.closeModal(), 1000); // Close after brief delay
    } else if (this.successCount > 0) {
      // Partial success
      this.error = `Added ${this.successCount} moments, but ${this.failureCount} failed`;
      this.moments = []; // Clear the list since some were added
      this.momentsAdded.emit(); // Refresh data even on partial success
    } else {
      // All failed
      this.error = 'Failed to add all dispensing moments. Please try again.';
    }
  }

  closeModal() {
    this.close.emit();
  }
}

```
--- END OF FILE: src\app\components\manual-dispensing-modal\manual-dispensing-modal.component.ts ---

--- START OF FILE: src\app\components\medication-item\medication-item.component.html ---
```typescript
<div class="medication-item" [ngClass]="{ 'is-new': isNew }" [attr.data-cnk]="medication.cnk ?? ''" [attr.data-vmp]="medication.vmp ?? ''" [attr.data-package-size]="medication.packageSize ?? ''">
  <div class="medication-header" (click)="toggleExpand()">
    <div class="header-content">
      <div class="medication-name">{{ medication.name }}</div>
      @if (!medication.asNeeded && !notDaily) {
        <div class="header-frequency">{{ dosesPerDay }}x{{ 'medication.per_day' | transloco }}</div>
      }
      @if (!medication.asNeeded && notDaily && medication.specialFrequency && medication.specialDescription) {
        <div class="header-frequency">{{ medication.specialFrequency }}x {{ getLocalizedPeriod() }}</div>
      }
      <div class="medication-codes"><!-- metadata --></div>

      @if (medication.asNeeded) {
        <div class="as-needed-badge">{{ 'ui.as_needed_with_translation' | transloco }}</div>
      }

      @if (medication.indication) {
        <div class="medication-indication" title="{{ medication.indication }}">{{ medication.indication }}</div>
      }
    </div>

    <div class="action-buttons">
      <button class="action-button edit-button" (click)="editMedication($event)" [title]="'actions.edit_medication' | transloco">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M11.333 2.00004C11.5081 1.82494 11.716 1.68605 11.9447 1.59129C12.1735 1.49653 12.4187 1.44775 12.6663 1.44775C12.914 1.44775 13.1592 1.49653 13.3879 1.59129C13.6167 1.68605 13.8246 1.82494 13.9997 2.00004C14.1748 2.17513 14.3137 2.383 14.4084 2.61178C14.5032 2.84055 14.552 3.08575 14.552 3.33337C14.552 3.58099 14.5032 3.82619 14.4084 4.05497C14.3137 4.28374 14.1748 4.49161 13.9997 4.66671L5.33301 13.3334L1.33301 14.6667L2.66634 10.6667L11.333 2.00004Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <button class="action-button delete-button" (click)="deleteMedication($event)" [title]="'actions.delete_medication' | transloco">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    @if (expandable) {
      <div class="expand-icon" [class.expanded]="isExpanded">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    }
  </div>

  @if (isExpanded) {
    <div class="medication-body">
      <div class="indication-section">
        <label for="indication-{{ medication.medicationId }}">{{ 'ui.indication_label' | transloco }}</label>
        <input
          type="text"
          id="indication-{{ medication.medicationId }}"
          [(ngModel)]="medication.indication"
          (ngModelChange)="onValueChange()"
          [placeholder]="'medication.indication' | transloco"
          class="indication-input"
        />
      </div>

      <div class="as-needed-section">
        <label class="checkbox-label">
          <input
            type="checkbox"
            [(ngModel)]="medication.asNeeded"
            (ngModelChange)="onValueChange()"
          />
          <span>{{ 'ui.as_needed_with_translation' | transloco }}</span>
        </label>
        
        <label class="checkbox-label">
          <input
            type="checkbox"
            [(ngModel)]="notDaily"
            (ngModelChange)="onNotDailyChange()"
          />
          <span>{{ 'medication.not_daily' | transloco }}</span>
        </label>
      </div>

      @if (notDaily && !medication.asNeeded) {
        <div class="special-frequency-section">
          <div class="field-group">
            <label for="special-frequency-{{ medication.medicationId }}">{{ 'medication.frequency' | transloco }}</label>
            <input
              type="number"
              id="special-frequency-{{ medication.medicationId }}"
              [(ngModel)]="medication.specialFrequency"
              (ngModelChange)="onValueChange()"
              min="1"
              step="1"
              placeholder="1"
              class="frequency-input"
            />
          </div>
          <div class="field-group">
            <label for="special-description-{{ medication.medicationId }}">{{ 'medication.period' | transloco }}</label>
            <select
              id="special-description-{{ medication.medicationId }}"
              [(ngModel)]="medication.specialDescription"
              (ngModelChange)="onValueChange()"
              class="period-select"
            >
              <option value="">{{ 'medication.select_period' | transloco }}</option>
              <option value="weekly">{{ 'medication.period_weekly' | transloco }}</option>
              <option value="biweekly">{{ 'medication.period_biweekly' | transloco }}</option>
              <option value="monthly">{{ 'medication.period_monthly' | transloco }}</option>
              <option value="quarterly">{{ 'medication.period_quarterly' | transloco }}</option>
              <option value="yearly">{{ 'medication.period_yearly' | transloco }}</option>
            </select>
          </div>
        </div>
      }

      @if (!medication.asNeeded && !notDaily) {
        <table class="intake-schedule">
          <thead>
            <tr>
              <th class="time-column">Time</th>
              <th class="before-column">{{ 'medication.before' | transloco }}</th>
              <th class="during-column">{{ 'medication.during' | transloco }}</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="time-label">{{ 'medication.breakfast' | transloco }}</td>
              <td>
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsBeforeBreakfast"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                />
              </td>
              <td>
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsDuringBreakfast"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                />
              </td>
            </tr>
            <tr>
              <td class="time-label">{{ 'medication.lunch' | transloco }}</td>
              <td>
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsBeforeLunch"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                />
              </td>
              <td>
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsDuringLunch"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                />
              </td>
            </tr>
            <tr>
              <td class="time-label">{{ 'medication.dinner' | transloco }}</td>
              <td>
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsBeforeDinner"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                />
              </td>
              <td>
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsDuringDinner"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                />
              </td>
            </tr>
            <tr>
              <td class="time-label">{{ 'medication.at_bedtime' | transloco }}</td>
              <td colspan="2">
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="medication.unitsAtBedtime"
                  (ngModelChange)="onValueChange()"
                  placeholder="0"
                  class="night-input"
                />
              </td>
            </tr>
          </tbody>
        </table>
      }
    </div>
  }
</div>

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirmation) {
  <app-confirmation-modal
    [title]="'actions.delete_medication' | transloco"
    [message]="'messages.confirm_delete_medication' | transloco:{ name: medication.name }"
    [confirmText]="'common.delete' | transloco"
    [cancelText]="'common.cancel' | transloco"
    (confirm)="onDeleteConfirm()"
    (cancel)="onDeleteCancel()">
  </app-confirmation-modal>
}

```
--- END OF FILE: src\app\components\medication-item\medication-item.component.html ---

--- START OF FILE: src\app\components\medication-item\medication-item.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.medication-item {
  background-color: $box-background;
  border: $box-border-width solid $box-border-primary;
  border-radius: $box-border-radius;
  margin-bottom: 1rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  overflow: hidden;
  transition: box-shadow 0.2s ease;

  &.is-new {
    animation: fadeIn 0.6s ease-out, highlightNew 1.5s ease-in-out;

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes highlightNew {
      0% {
        background-color: rgba(16, 185, 129, 0.1);
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
      }
      50% {
        background-color: rgba(16, 185, 129, 0.15);
        box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
      }
      100% {
        background-color: $box-background;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
    }
  }

  &:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }

  .medication-header {
    padding: 1.25rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    transition: background-color 0.2s ease;

    &:hover {
      background-color: #fafbfc;
    }

    .header-content {
      flex: 1;

      .medication-name {
        font-weight: $font-weight-bold;
        font-size: 1.125rem;
        color: $text-primary;
        margin-bottom: 0.5rem;
      }

      .header-frequency {
        display: inline-block;
        margin-left: 0.5rem;
        padding: 0.15rem 0.4rem;
        background-color: rgba($button-primary-background, 0.06);
        color: $button-primary-background;
        font-size: 0.75rem;
        border-radius: 0.25rem;
        font-weight: $font-weight-medium;
      }

      .medication-codes {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.025rem;

        .code {
          font-size: 0.75rem;
          font-weight: $font-weight-regular;
          color: $text-secondary;
          opacity: 0.7;
        }
      }
      .as-needed-badge {
        display: inline-block;
        margin-top: 0.25rem;
        padding: 0.2rem 0.5rem;
        background-color: rgba($button-primary-background, 0.08);
        color: $button-primary-background;
        font-size: 0.75rem;
        font-weight: $font-weight-semibold;
        border-radius: 0.375rem;
      }
      .medication-indication {
        display: block;
        max-width: 36rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.8rem;
        font-weight: $font-weight-regular;
        color: #15803d; /* Tailwind green-700-ish for good contrast */
        font-style: italic;
        opacity: 0.95;
      }

      .medication-details {
        font-weight: $font-weight-regular;
        font-size: 0.875rem;
        color: $text-secondary;
        opacity: 0.8;

        span {
          display: inline;
        }
      }
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
      margin-left: 1rem;
      flex-shrink: 0;

      .action-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        border: none;
        border-radius: $box-border-radius-small;
        background-color: transparent;
        color: $text-secondary;
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 0;

        &:hover {
          background-color: rgba(0, 0, 0, 0.05);
        }

        &.edit-button:hover {
          color: $button-primary-background;
          background-color: rgba(69, 75, 96, 0.1);
        }

        &.delete-button:hover {
          color: #dc2626;
          background-color: rgba(220, 38, 38, 0.1);
        }

        svg {
          display: block;
        }
      }
    }

    .expand-icon {
      flex-shrink: 0;
      margin-left: 1rem;
      color: $text-secondary;
      transition: transform 0.3s ease;

      &.expanded {
        transform: rotate(180deg);
      }

      svg {
        display: block;
      }
    }
  }

  .medication-body {
    padding: 0 1.25rem 1.25rem 1.25rem;
    border-top: 1px solid #e8e8e8;
    animation: slideDown 0.3s ease;

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .indication-section {
      margin: 1.25rem 0 0.75rem 0;

      label {
        display: block;
        font-size: 0.875rem;
        font-weight: $font-weight-semibold;
        color: $text-primary;
        margin-bottom: 0.5rem;
      }

      .indication-input {
        width: 100%;
        padding: 0.625rem 0.875rem;
        border: $box-border-width solid #d1d5db;
        border-radius: $box-border-radius-small;
        font-family: $primary-font;
        font-size: 0.875rem;
        color: $text-primary;
        background-color: $input-background;
        box-sizing: border-box;
        transition: all 0.2s ease;

        &:hover {
          border-color: #9ca3af;
        }

        &:focus {
          outline: none;
          border-color: $button-primary-background;
          box-shadow: 0 0 0 3px rgba(69, 75, 96, 0.1);
        }

        &::placeholder {
          color: $text-tertiary;
          opacity: 0.6;
        }
      }
    }

    .as-needed-section {
      margin: 0.75rem 0 1.25rem 0;
      display: flex;
      gap: 1.5rem;

      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        color: $text-primary;
        font-weight: $font-weight-medium;

        input[type="checkbox"] {
          width: 18px;
          height: 18px;
          cursor: pointer;
          accent-color: $button-primary-background;
        }

        span {
          user-select: none;
        }
      }
    }

    .special-frequency-section {
      margin: 0 0 1.25rem 0;
      display: flex;
      gap: 1rem;
      padding: 1rem;
      background-color: rgba(#10b981, 0.05);
      border: 1px solid rgba(#10b981, 0.2);
      border-radius: 6px;

      .field-group {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;

        label {
          font-size: 0.875rem;
          font-weight: $font-weight-semibold;
          color: $text-secondary;
          margin-bottom: 0.25rem;
        }

        .frequency-input,
        .period-select {
          padding: 0.5rem 0.75rem;
          font-family: $primary-font;
          font-size: 0.875rem;
          border: $box-border-width solid $box-border-primary;
          border-radius: $box-border-radius;
          background-color: $input-background;
          color: $text-primary;
          transition: all 0.2s ease;

          &:focus {
            outline: none;
            border-color: $button-primary-background;
            box-shadow: 0 0 0 3px rgba($button-primary-background, 0.1);
          }

          &:hover:not(:focus) {
            border-color: darken($box-border-primary, 10%);
          }
        }

        .frequency-input {
          max-width: 100px;
        }

        .period-select {
          cursor: pointer;
          appearance: none;
          background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23454B60' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
          background-repeat: no-repeat;
          background-position: right 0.75rem center;
          padding-right: 2.5rem;
        }
      }
    }

    .intake-schedule {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.875rem;

      thead {
        th {
          background-color: #f8f9fa;
          font-weight: $font-weight-semibold;
          color: $text-primary;
          padding: 0.75rem;
          border: $box-border-width solid $box-border-primary;
          text-align: center;

          &:first-child {
            border-top-left-radius: $box-border-radius-small;
          }

          &:last-child {
            border-top-right-radius: $box-border-radius-small;
          }

          &.time-column {
            width: 30%;
            text-align: left;
            padding-left: 1rem;
          }

          &.before-column,
          &.during-column {
            width: 35%;
          }
        }
      }

      tbody {
        tr {
          &:last-child {
            td:first-child {
              border-bottom-left-radius: $box-border-radius-small;
            }

            td:last-child {
              border-bottom-right-radius: $box-border-radius-small;
            }
          }

          td {
            padding: 0.75rem;
            border: $box-border-width solid $box-border-primary;
            border-top: none;
            background-color: $box-background;

            &:not(:first-child) {
              border-left: none;
            }

            &.time-label {
              font-weight: $font-weight-medium;
              color: $text-primary;
              background-color: #fafbfc;
              padding-left: 1rem;
            }

            input {
              width: 100%;
              padding: 0.5rem 0.75rem;
              border: $box-border-width solid #d1d5db;
              border-radius: $box-border-radius-small;
              font-family: $primary-font;
              font-size: 0.875rem;
              color: $text-primary;
              background-color: $input-background;
              box-sizing: border-box;
              text-align: center;
              transition: all 0.2s ease;

              &:hover {
                border-color: #9ca3af;
              }

              &:focus {
                outline: none;
                border-color: $button-primary-background;
                box-shadow: 0 0 0 3px rgba(69, 75, 96, 0.1);
              }

              &::placeholder {
                color: $text-tertiary;
                opacity: 0.6;
              }

              &.night-input {
                text-align: center;
              }
            }

            /* Remove spinner arrows from number input */
            input[type="number"]::-webkit-inner-spin-button,
            input[type="number"]::-webkit-outer-spin-button {
              -webkit-appearance: none;
              margin: 0;
            }

            input[type="number"] {
              -moz-appearance: textfield;
              appearance: textfield;
            }
          }
        }
      }
    }
  }
}

```
--- END OF FILE: src\app\components\medication-item\medication-item.component.scss ---

--- START OF FILE: src\app\components\medication-item\medication-item.component.ts ---
```typescript
import { Component, Input, Output, EventEmitter, OnInit, OnDestroy, OnChanges, SimpleChanges } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { TranslocoModule, TranslocoService } from '@jsverse/transloco';
import { Subject } from 'rxjs';
import { debounceTime, takeUntil } from 'rxjs/operators';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { ConfirmationModalComponent } from '../confirmation-modal/confirmation-modal.component';

export interface Medication {
  medicationId: string;
  name: string;
  dosage: string;
  route: string;
  cnk?: number | null;
  vmp?: number | null;
  packageSize?: number | null;
  indication?: string | null;
  asNeeded?: boolean | null;
  specialFrequency?: number | null;
  specialDescription?: string | null;
  unitsBeforeBreakfast?: number | null;
  unitsDuringBreakfast?: number | null;
  unitsBeforeLunch?: number | null;
  unitsDuringLunch?: number | null;
  unitsBeforeDinner?: number | null;
  unitsDuringDinner?: number | null;
  unitsAtBedtime?: number | null;
  isNew?: boolean;
}

@Component({
  selector: 'app-medication-item',
  standalone: true,
  imports: [CommonModule, FormsModule, TranslocoModule, ConfirmationModalComponent],
  templateUrl: './medication-item.component.html',
  styleUrls: ['./medication-item.component.scss']
})
export class MedicationItemComponent implements OnInit, OnDestroy, OnChanges {
  @Input() medication!: Medication;
  @Input() expandable: boolean = true; // New input to control if item can be expanded
  @Input() isNew: boolean = false; // Flag to indicate this is a newly added medication
  @Output() medicationDeleted = new EventEmitter<string>();
  @Output() editRequested = new EventEmitter<Medication>();
  isExpanded = false;
  showDeleteConfirmation = false;
  notDaily = false;

  private destroy$ = new Subject<void>();
  private valueChanged$ = new Subject<void>();

  constructor(
    private apiService: ApiService,
    private stateService: StateService
    , private transloco: TranslocoService
  ) {}

  ngOnChanges(changes: SimpleChanges) {
    // Detect when isNew changes to true and expand the box
    if (changes['isNew'] && changes['isNew'].currentValue === true) {
      this.isExpanded = true;
      console.log('[MedicationItem] Auto-expanding new medication:', this.medication.name);
    }
  }

  ngOnInit() {
    console.log('[MedicationItem] ngOnInit for medication:', this.medication.name);
    console.log('[MedicationItem] asNeeded:', this.medication.asNeeded);
    console.log('[MedicationItem] specialFrequency:', this.medication.specialFrequency);
    console.log('[MedicationItem] specialDescription:', this.medication.specialDescription);
    
    // Initialize notDaily based on whether special frequency is set
    this.notDaily = !!(this.medication.specialFrequency || this.medication.specialDescription);
    console.log('[MedicationItem] Initialized notDaily to:', this.notDaily);
    
    // Ensure asNeeded is a boolean, not null/undefined
    if (this.medication.asNeeded === null || this.medication.asNeeded === undefined) {
      this.medication.asNeeded = false;
    }
    
    // Set up auto-save with debounce
    this.valueChanged$
      .pipe(
        debounceTime(1000),
        takeUntil(this.destroy$)
      )
      .subscribe(() => {
        console.log('[MedicationItem] Value changed, triggering save...');
        this.saveToBackend();
      });
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
  }

  toggleExpand() {
    if (this.expandable) {
      this.isExpanded = !this.isExpanded;
    }
  }

  onValueChange() {
    console.log('[MedicationItem] onValueChange() called');
    this.valueChanged$.next();
  }

  onNotDailyChange() {
    console.log('[MedicationItem] notDaily changed to:', this.notDaily);
    if (!this.notDaily) {
      // Clear special frequency fields when unchecked
      this.medication.specialFrequency = null;
      this.medication.specialDescription = null;
      this.onValueChange();
    } else {
      // Set default values when checked
      if (!this.medication.specialFrequency) {
        this.medication.specialFrequency = 1;
      }
      if (!this.medication.specialDescription) {
        this.medication.specialDescription = 'weekly';
      }
      this.onValueChange();
    }
  }

  get dosesPerDay(): number {
    if (!this.medication) return 0;
    const doses = [
      this.medication.unitsBeforeBreakfast,
      this.medication.unitsDuringBreakfast,
      this.medication.unitsBeforeLunch,
      this.medication.unitsDuringLunch,
      this.medication.unitsBeforeDinner,
      this.medication.unitsDuringDinner,
      this.medication.unitsAtBedtime
    ];
    return doses.reduce((sum: number, d) => sum + (d ?? 0), 0);
  }

  getLocalizedPeriod(): string {
    if (!this.medication.specialDescription) return '';
    const key = `medication.period_${this.medication.specialDescription}`;
    return this.transloco.translate(key);
  }

  saveToBackend() {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      console.error('[MedicationItem] No medicationReviewId available');
      return;
    }

    // Helper function to convert empty strings and undefined to null, keep valid numbers
    const parseNumber = (value: any): number | null => {
      if (value === '' || value === null || value === undefined) {
        return null;
      }
      const parsed = Number(value);
      return isNaN(parsed) ? null : parsed;
    };

    // Extract dosage number from dosage string (e.g., "500mg" -> 500)
    const parseDosage = (dosage: string): number | null => {
      if (!dosage) return null;
      const match = dosage.match(/(\d+\.?\d*)/);
      return match ? parseFloat(match[1]) : null;
    };

    const updateData = {
      name: this.medication.name || null,
      cnk: this.medication.cnk ?? null,
      vmp: this.medication.vmp ?? null,
      packageSize: this.medication.packageSize ?? null,
      dosageMg: parseDosage(this.medication.dosage),
      routeOfAdministration: this.medication.route || null,
      indication: this.medication.indication ? this.medication.indication : null,
      asNeeded: this.medication.asNeeded ?? false,
      specialFrequency: parseNumber(this.medication.specialFrequency),
      specialDescription: this.medication.specialDescription || null,
      unitsBeforeBreakfast: parseNumber(this.medication.unitsBeforeBreakfast),
      unitsDuringBreakfast: parseNumber(this.medication.unitsDuringBreakfast),
      unitsBeforeLunch: parseNumber(this.medication.unitsBeforeLunch),
      unitsDuringLunch: parseNumber(this.medication.unitsDuringLunch),
      unitsBeforeDinner: parseNumber(this.medication.unitsBeforeDinner),
      unitsDuringDinner: parseNumber(this.medication.unitsDuringDinner),
      unitsAtBedtime: parseNumber(this.medication.unitsAtBedtime)
    };

    console.log('[MedicationItem] === SAVING TO BACKEND ===');
    console.log('[MedicationItem] Medication:', this.medication.name);
    console.log('[MedicationItem] Special Frequency:', this.medication.specialFrequency);
    console.log('[MedicationItem] Special Description:', this.medication.specialDescription);
    console.log('[MedicationItem] Package Size:', this.medication.packageSize);
    console.log('[MedicationItem] Current medication object:', JSON.stringify(this.medication, null, 2));
    console.log('[MedicationItem] Update request payload:', JSON.stringify(updateData, null, 2));

    this.apiService.updateMedication(
      medicationReviewId,
      this.medication.medicationId,
      updateData
    ).subscribe({
      next: (response) => {
        console.log('[MedicationItem] ‚úì Save successful');
        console.log('[MedicationItem] Response:', JSON.stringify(response, null, 2));
      },
      error: (error: any) => {
        console.error('[MedicationItem] ‚úó Save failed');
        console.error('[MedicationItem] Error:', error);
      }
    });
  }

  editMedication(event: Event) {
    // Prevent the header click from toggling expand
    event.stopPropagation();
    // Emit event to parent to open medication searcher
    this.editRequested.emit(this.medication);
  }

  deleteMedication(event: Event) {
    // Prevent the header click from toggling expand
    event.stopPropagation();
    // Show confirmation modal
    this.showDeleteConfirmation = true;
  }

  onDeleteConfirm() {
    this.showDeleteConfirmation = false;

    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      console.error('[MedicationItem] No medicationReviewId available for deletion');
      return;
    }

    console.log('[MedicationItem] === DELETING MEDICATION ===');
    console.log('[MedicationItem] Medication:', this.medication.name);
    console.log('[MedicationItem] MedicationId:', this.medication.medicationId);

    this.apiService.deleteMedication(medicationReviewId, this.medication.medicationId).subscribe({
      next: () => {
        console.log('[MedicationItem] ‚úì Delete successful');
        // Emit event to parent component to remove from list
        this.medicationDeleted.emit(this.medication.medicationId);
      },
      error: (error: any) => {
        console.error('[MedicationItem] ‚úó Delete failed');
        console.error('[MedicationItem] Error:', error);
        const msg = this.transloco.translate('messages.delete_lab_value_error');
        alert(msg);
      }
    });
  }

  onDeleteCancel() {
    this.showDeleteConfirmation = false;
  }
}

```
--- END OF FILE: src\app\components\medication-item\medication-item.component.ts ---

--- START OF FILE: src\app\components\medication-list\medication-list.component.html ---
```typescript
<div class="medication-list-container">
  <div class="header">
    <h2 class="title">{{ 'medication.medication_list' | transloco }}</h2>
    <div class="actions">
      <button class="import-button" (click)="importMedications()">{{ 'common.import' | transloco }}</button>
      <button class="add-button" (click)="addMedication()">
        <span class="plus-icon">+</span> {{ 'common.add' | transloco }}
      </button>
      <button class="delete-all-button" (click)="deleteAllMedications()">
        {{ 'medication.delete_all' | transloco }}
      </button>
    </div>
  </div>

  <div class="medications-scroll" #medicationsScroll>
    <app-medication-item 
      #medicationItems
      *ngFor="let medication of medications; let last = last" 
      [medication]="medication"
      [isNew]="medication.isNew === true"
      (medicationDeleted)="onMedicationDeleted($event)"
      (editRequested)="onEditRequested($event)">
    </app-medication-item>
  </div>
</div>

<!-- Medication Search Modal -->
<app-medication-search-modal 
  *ngIf="showSearchModal" 
  [isEditMode]="editingMedication !== null"
  (close)="onModalClose()" 
  (medicationSelected)="onMedicationSelected($event)"
></app-medication-search-modal>

<!-- CNK Selection Modal -->
<app-cnk-selection-modal
  *ngIf="showCnkSelectionModal && currentMedicationForCnkSelection"
  [medication]="currentMedicationForCnkSelection"
  (close)="onCnkSelectionCancelled()"
  (medicationSelected)="onCnkSelected($event)"
  (skip)="onCnkSkipped()"
></app-cnk-selection-modal>

```
--- END OF FILE: src\app\components\medication-list\medication-list.component.html ---

--- START OF FILE: src\app\components\medication-list\medication-list.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.medication-list-container {
  background-color: $box-background;
  border: $box-border-width solid $box-border-primary;
  border-radius: $box-border-radius;
  padding: 1.5rem;
  height: 100%;
  display: flex;
  flex-direction: column;

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;

    .title {
      font-size: 1.5rem;
      color: $text-primary;
      margin: 0;
    }

    .actions {
      display: flex;
      gap: 0.75rem;

      button {
        padding: 0.5rem 1rem;
        border: $box-border-width solid $box-border-primary;
        border-radius: $box-border-radius;
        font-family: $primary-font;
        font-size: 0.875rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .import-button {
        background-color: $button-secondary;
        color: $text-button-secondary;
        border: 1px solid $box-border;

        &:hover {
          background-color: $button-secondary-hover;
        }
      }

      .add-button {
        background-color: $button-primary;
        color: $text-button-primary;
        display: flex;
        align-items: center;
        gap: 0.5rem;

        &:hover {
          background-color: $button-primary-hover;
        }

        .plus-icon {
          font-size: 1.2rem;
          font-weight: bold;
        }
      }

      .delete-all-button {
        background-color: transparent;
        color: #dc2626; /* red */
        border: 1px solid rgba(220, 38, 38, 0.12);
        padding: 0.5rem 0.75rem;
        border-radius: $box-border-radius;

        &:hover {
          background-color: rgba(220, 38, 38, 0.06);
        }
      }
    }
  }

  .medications-scroll {
    flex: 1;
    overflow-y: visible; // Let parent handle scrolling
    padding-right: 0.5rem;
  }
}

```
--- END OF FILE: src\app\components\medication-list\medication-list.component.scss ---

--- START OF FILE: src\app\components\medication-list\medication-list.component.ts ---
```typescript
import { Component, OnInit, ViewChild, QueryList, ViewChildren } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';
import { MedicationItemComponent, Medication } from '../medication-item/medication-item.component';
import { MedicationSearchModalComponent } from '../medication-search-modal/medication-search-modal.component';
import { CnkSelectionModalComponent, MedicationWithMatches } from '../cnk-selection-modal/cnk-selection-modal.component';
import { MedicationSearchResult } from '../../models/api.models';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { forkJoin, of } from 'rxjs';
import { catchError, map } from 'rxjs/operators';

@Component({
  selector: 'app-medication-list',
  standalone: true,
  imports: [CommonModule, TranslocoModule, MedicationItemComponent, MedicationSearchModalComponent, CnkSelectionModalComponent],
  templateUrl: './medication-list.component.html',
  styleUrls: ['./medication-list.component.scss']
})
export class MedicationListComponent implements OnInit {
  medications: Medication[] = [];
  showSearchModal = false;
  showCnkSelectionModal = false;
  isLoading = false;
  editingMedication: Medication | null = null;
  
  // CNK matching state
  currentMedicationForCnkSelection: MedicationWithMatches | null = null;
  pendingMedicationsToSave: Array<Partial<Medication> & { searchResult?: MedicationSearchResult }> = [];
  currentMedicationIndex = 0;

  @ViewChild('medicationsScroll') medicationsScrollContainer: any;

  constructor(
    private apiService: ApiService,
    private stateService: StateService
  ) {}

  ngOnInit() {
    this.loadMedications();
  }

  loadMedications() {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      this.medications = [];
      return;
    }

    this.isLoading = true;
    console.log('[MedicationList] === LOADING MEDICATIONS ===');
    console.log('[MedicationList] medicationReviewId:', medicationReviewId);
    
    this.apiService.getMedications(medicationReviewId).subscribe({
      next: (medications) => {
        console.log('[MedicationList] Received medications from backend:', JSON.stringify(medications, null, 2));
        
        this.medications = medications.map(med => ({
          medicationId: med.medicationId,
          name: med.name || '',
          dosage: med.dosageMg ? `${med.dosageMg}mg` : '',
          route: med.routeOfAdministration || '',
          cnk: med.cnk ?? null,
          vmp: med.vmp ?? null,
          packageSize: med.packageSize ?? null,
          indication: med.indication ?? null,
          asNeeded: med.asNeeded ?? false,
          specialFrequency: med.specialFrequency ?? null,
          specialDescription: med.specialDescription ?? null,
          unitsBeforeBreakfast: med.unitsBeforeBreakfast ?? null,
          unitsDuringBreakfast: med.unitsDuringBreakfast ?? null,
          unitsBeforeLunch: med.unitsBeforeLunch ?? null,
          unitsDuringLunch: med.unitsDuringLunch ?? null,
          unitsBeforeDinner: med.unitsBeforeDinner ?? null,
          unitsDuringDinner: med.unitsDuringDinner ?? null,
          unitsAtBedtime: med.unitsAtBedtime ?? null
        }));
        
        console.log('[MedicationList] Mapped medications for display:', JSON.stringify(this.medications, null, 2));
        this.isLoading = false;
      },
      error: (error) => {
        console.error('[MedicationList] Failed to load:', error);
        this.medications = [];
        this.isLoading = false;
      }
    });
  }

  importMedications() {
    console.log('Import medications clicked');
    // Create a hidden file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.csv';
    fileInput.style.display = 'none';
    
    fileInput.onchange = (event: any) => {
      const file = event.target.files[0];
      console.log('[MedicationList] file input onchange triggered. File present?', !!file);
      if (file) {
        console.log('[MedicationList] Selected file:', { name: file.name, size: file.size, type: file.type });
        this.handleCsvImport(file);
      } else {
        console.warn('[MedicationList] No file selected in file input');
      }
      // Clean up
      try {
        document.body.removeChild(fileInput);
      } catch (err) {
        // ignore
      }
    };
    
    document.body.appendChild(fileInput);
    fileInput.click();
  }

  private handleCsvImport(file: File) {
    console.log('[MedicationList] Importing CSV file:', file.name, { size: file.size, type: file.type });

    const reader = new FileReader();
    reader.onload = (e: any) => {
      const csvContent = e.target.result;
      // Log the first few hundred characters to help debug format issues
      console.log('[MedicationList] CSV file first 1000 chars:\n', String(csvContent).slice(0, 1000));

      const lines = String(csvContent).split(/\r?\n/).slice(0, 20);
      console.log('[MedicationList] First 20 lines of CSV:', lines);

      const medications = this.parseCsvContent(csvContent);
      console.log('[MedicationList] Parsed medications count:', medications.length);
      console.log('[MedicationList] Parsed medications array:', medications);

      if (medications.length > 0) {
        this.saveParsedMedications(medications);
      } else {
        console.warn('[MedicationList] No medications found after parsing the CSV file.');
        alert('No medications found in the CSV file. Please check the file format or try a different export.');
      }
    };

    reader.onerror = (error) => {
      console.error('[MedicationList] Error reading file:', error);
      alert('Failed to read the CSV file. Please try again.');
    };

    reader.readAsText(file, 'UTF-8');
  }

  private parseCsvContent(csvContent: string): Partial<Medication>[] {
    // Normalize newlines and split
    const lines = String(csvContent).replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
    const medications: Partial<Medication>[] = [];
    
    console.log('[MedicationList] Starting CSV parse. Total lines:', lines.length);
    // Log a sample of lines to help diagnose structure
    for (let li = 0; li < Math.min(15, lines.length); li++) {
      console.log(`[MedicationList] line[${li}]:`, lines[li]);
    }

    // Start at row 11 (index 10) - this is where medications begin
    let isAsNeeded = false;
    
    for (let i = 12; i < lines.length; i++) {
      const columns = lines[i].split(';');
      const columnA = columns[0]?.trim() || '';
      
      console.log(`[MedicationList] Row ${i + 1}: Column A = "${columnA}"`);
      
      // Skip empty rows
      if (!columnA) {
        console.log(`[MedicationList] Row ${i + 1}: Empty, skipping`);
        continue;
      }
      
      // Skip continuation/wrapped lines (these are part of multi-line cells from the previous row)
      // These typically start with keywords like "Gebruiksaanwijzing" or other instruction text
      if (columnA.toLowerCase().includes('gebruiksaanwijzing') || 
          columnA.toLowerCase().includes('opmerking') ||
          columnA.toLowerCase().startsWith('koel bewaren') ||
          columnA.toLowerCase().startsWith('bewaren')) {
        console.log(`[MedicationList] Row ${i + 1}: Continuation/instruction line, skipping`);
        continue;
      }
      
      // Check for "Indien nodig" section marker
      if (columnA.toLowerCase().includes('indien nodig')) {
        isAsNeeded = true;
        console.log(`[MedicationList] Row ${i + 1}: Found "Indien nodig" section marker. All subsequent medications will be marked as needed.`);
        continue;
      }
      
      // Parse this as a medication row
      const medication = this.parseMedicationRow(columns, isAsNeeded, i + 1);
      if (medication) {
        medications.push(medication);
        console.log(`[MedicationList] Row ${i + 1}: Parsed medication "${medication.name}"`);
      } else {
        console.log(`[MedicationList] Row ${i + 1}: Could not parse as medication`);
      }
    }
    
    console.log('[MedicationList] Parsing complete. Total medications found:', medications.length);
    return medications;
  }

  private parseMedicationRow(columns: string[], asNeeded: boolean, rowNumber: number): Partial<Medication> | null {
    // Column A (index 0) = medication name
    const medicationName = columns[0]?.trim();
    
    if (!medicationName || medicationName === '') {
      return null;
    }
    
    console.log(`[MedicationList] Row ${rowNumber}: Parsing medication "${medicationName}"`);
    console.log(`[MedicationList] Row ${rowNumber}: Total columns: ${columns.length}`);
    
    // Helper to parse numbers from various formats
    const parseNumber = (value: string | undefined): number | null => {
      if (!value || value.trim() === '') return null;
      let cleaned = value.trim().replace(',', '.').replace(/\u00A0/g, ' ').trim();

      // Map common Unicode vulgar fraction characters to decimals
      const unicodeFractions: Record<string, number> = {
        '¬º': 0.25,
        '¬Ω': 0.5,
        '¬æ': 0.75,
        '‚Öì': 1 / 3,
        '‚Öî': 2 / 3,
        '‚Öõ': 1 / 8,
        '‚Öú': 3 / 8,
        '‚Öù': 5 / 8,
        '‚Öû': 7 / 8
      };

      // If the string is exactly a unicode fraction or a known replacement char
      if (cleaned.length === 1 && unicodeFractions[cleaned]) {
        return unicodeFractions[cleaned];
      }

      // Handle mixed numbers with unicode fraction like '1¬Ω' or '1 1/2'
      // e.g., '1¬Ω' => 1 + 0.5
      const mixedUnicodeMatch = cleaned.match(/^(\d+)\s*([¬º¬Ω¬æ‚Öì‚Öî‚Öõ‚Öú‚Öù‚Öû])$/);
      if (mixedUnicodeMatch) {
        const whole = parseInt(mixedUnicodeMatch[1], 10);
        const frac = unicodeFractions[mixedUnicodeMatch[2]] || 0;
        return whole + frac;
      }

      // Handle simple fraction like '1/2' or mixed '1 1/2'
      const mixedMatch = cleaned.match(/^(\d+)\s+(\d+)\/(\d+)$/);
      if (mixedMatch) {
        const whole = parseInt(mixedMatch[1], 10);
        const num = parseFloat(mixedMatch[2]);
        const den = parseFloat(mixedMatch[3]);
        if (den === 0) return null;
        return whole + num / den;
      }

      const simpleFracMatch = cleaned.match(/^(\d+)\/(\d+)$/);
      if (simpleFracMatch) {
        const num = parseFloat(simpleFracMatch[1]);
        const den = parseFloat(simpleFracMatch[2]);
        if (den === 0) return null;
        return num / den;
      }

      // Replace any unicode fraction characters inside the string (e.g. '1¬Ω' where regex didn't match)
      let replaced = cleaned;
      Object.keys(unicodeFractions).forEach(u => {
        if (replaced.indexOf(u) !== -1) {
          replaced = replaced.replace(new RegExp(u, 'g'), `+${unicodeFractions[u]}`);
        }
      });
      // If replacement occurred and now contains a '+', evaluate it simply
      if (replaced.indexOf('+') !== -1) {
        // e.g. '1+0.5' or '1 +0.5' -> sum parts
        const parts = replaced.split('+').map(p => p.trim()).filter(Boolean);
        let sum = 0;
        for (const p of parts) {
          const n = parseFloat(p);
          if (isNaN(n)) return null;
          sum += n;
        }
        return sum;
      }

      // Fallback to parseFloat
      const num = parseFloat(cleaned);
      return isNaN(num) ? null : num;
    };
    
    // Fixed column positions (Excel columns converted to 0-based array indices):
    // Column O (index 14) = before breakfast
    // Column Q (index 16) = during breakfast
    // Column S (index 18) = after breakfast (add to during)
    // Column T (index 19) = before lunch
    // Column U (index 20) = during lunch
    // Column V (index 21) = after lunch (add to during)
    // Column W (index 22) = before dinner
    // Column X (index 23) = during dinner
    // Column Y (index 24) = after dinner (add to during)
    // Column AB (index 27) = sleep
    // Column AL (index 37) = indication
    
    // Column N (index 13) may contain a frequency that should be
    // interpreted as 'before breakfast' (edge case). Read it and merge
    // with the normal before-breakfast column (O, index 14).
    const colNBeforeBreakfast = parseNumber(columns[13]);
    const beforeBreakfastBase = parseNumber(columns[14]);
    const duringBreakfastBase = parseNumber(columns[16]);
    const afterBreakfast = parseNumber(columns[18]);
    
    const beforeLunch = parseNumber(columns[19]);
    const duringLunchBase = parseNumber(columns[20]);
    const afterLunch = parseNumber(columns[21]);
    
    const beforeDinner = parseNumber(columns[22]);
    const duringDinnerBase = parseNumber(columns[23]);
    const afterDinner = parseNumber(columns[24]);
    
    const atBedtime = parseNumber(columns[27]);
    
    // Combine column N (if present) into beforeBreakfast, and combine "after" into "during"
    const beforeBreakfast = ((colNBeforeBreakfast || 0) + (beforeBreakfastBase || 0)) || null;
    const duringBreakfast = (duringBreakfastBase || 0) + (afterBreakfast || 0) || null;
    const duringLunch = (duringLunchBase || 0) + (afterLunch || 0) || null;
    const duringDinner = (duringDinnerBase || 0) + (afterDinner || 0) || null;
    
    // Extract indication from column AL (index 37)
    let indication = columns[37]?.trim() || '';
    
    // Clean up indication - remove "Indicatie:" prefix if present
    if (indication.includes('Indicatie:')) {
      indication = indication.replace('Indicatie:', '').trim();
    }
    // Remove usage instructions if present
    if (indication.includes('Gebruiksaanwijzing:')) {
      indication = indication.split('Gebruiksaanwijzing:')[0].trim();
    }
    
    console.log(`[MedicationList] Row ${rowNumber}: Dosing - Before Breakfast: ${beforeBreakfast}, During Breakfast: ${duringBreakfast} (base: ${duringBreakfastBase}, after: ${afterBreakfast})`);
    console.log(`[MedicationList] Row ${rowNumber}: Before Lunch: ${beforeLunch}, During Lunch: ${duringLunch} (base: ${duringLunchBase}, after: ${afterLunch})`);
    console.log(`[MedicationList] Row ${rowNumber}: Before Dinner: ${beforeDinner}, During Dinner: ${duringDinner} (base: ${duringDinnerBase}, after: ${afterDinner})`);
    console.log(`[MedicationList] Row ${rowNumber}: At Bedtime: ${atBedtime}`);
    console.log(`[MedicationList] Row ${rowNumber}: Indication: "${indication}"`);
    console.log(`[MedicationList] Row ${rowNumber}: As Needed: ${asNeeded}`);
    
    return {
      name: medicationName,
      indication: indication || undefined,
      asNeeded: asNeeded,
      unitsBeforeBreakfast: beforeBreakfast ?? undefined,
      unitsDuringBreakfast: duringBreakfast ?? undefined,
      unitsBeforeLunch: beforeLunch ?? undefined,
      unitsDuringLunch: duringLunch ?? undefined,
      unitsBeforeDinner: beforeDinner ?? undefined,
      unitsDuringDinner: duringDinner ?? undefined,
      unitsAtBedtime: atBedtime ?? undefined
    };
  }  private saveParsedMedications(medications: Partial<Medication>[]) {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      console.error('[MedicationList] No medication review ID');
      alert('Please create or select a medication review first.');
      return;
    }
    
    console.log('[MedicationList] Starting CNK matching for', medications.length, 'medications');
    this.isLoading = true;
    
    // Step 1: Search for CNK matches for all medications in parallel
    const searchObservables = medications.map(med => 
      this.apiService.searchMedications({ searchTerm: med.name || '', maxResults: 10 }).pipe(
        map(response => ({ medication: med, matches: response.results })),
        catchError(error => {
          console.error('[MedicationList] CNK search failed for:', med.name, error);
          return of({ medication: med, matches: [] });
        })
      )
    );
    
    forkJoin(searchObservables).subscribe({
      next: (searchResults) => {
        console.log('[MedicationList] CNK search complete. Results:', searchResults);
        this.processCnkMatches(searchResults);
      },
      error: (error) => {
        console.error('[MedicationList] CNK matching failed:', error);
        this.isLoading = false;
        alert('Failed to match medications to CNK codes. Please try again.');
      }
    });
  }

  private processCnkMatches(searchResults: Array<{ medication: Partial<Medication>, matches: MedicationSearchResult[] }>) {
    this.pendingMedicationsToSave = [];
    
    for (const result of searchResults) {
      const { medication, matches } = result;
      
      if (matches.length === 0) {
        // No matches found - will save without CNK
        console.log('[MedicationList] No CNK match for:', medication.name);
        this.pendingMedicationsToSave.push(medication);
      } else if (matches.length === 1) {
        // Single match - auto-select it
        console.log('[MedicationList] Auto-matching single CNK for:', medication.name, '‚Üí', matches[0].cnk);
        this.pendingMedicationsToSave.push({ ...medication, searchResult: matches[0] });
      } else {
        // Multiple matches - need user selection
        const bestMatch = this.findBestMatch(medication.name || '', matches);
        if (bestMatch && this.isCloseMatch(medication.name || '', bestMatch.benaming)) {
          // If there's a very close match (exact or near-exact), auto-select it
          console.log('[MedicationList] Auto-matching best CNK for:', medication.name, '‚Üí', bestMatch.cnk);
          this.pendingMedicationsToSave.push({ ...medication, searchResult: bestMatch });
        } else {
          // Ambiguous - need user selection
          console.log('[MedicationList] Multiple CNK matches for:', medication.name, '- will prompt user');
          this.pendingMedicationsToSave.push({ ...medication, needsUserSelection: true, matches } as any);
        }
      }
    }
    
    this.isLoading = false;
    this.currentMedicationIndex = 0;
    this.processNextMedication();
  }

  private findBestMatch(searchTerm: string, matches: MedicationSearchResult[]): MedicationSearchResult | null {
    if (matches.length === 0) return null;
    
    const normalizedSearch = searchTerm.toLowerCase().trim();
    
    // Try exact match first
    for (const match of matches) {
      if (match.benaming.toLowerCase().trim() === normalizedSearch) {
        return match;
      }
    }
    
    // Return the first match as best guess
    return matches[0];
  }

  private isCloseMatch(searchTerm: string, matchName: string): boolean {
    const normalizedSearch = searchTerm.toLowerCase().trim();
    const normalizedMatch = matchName.toLowerCase().trim();
    
    // Exact match
    if (normalizedSearch === normalizedMatch) return true;
    
    // One starts with the other
    if (normalizedMatch.startsWith(normalizedSearch) || normalizedSearch.startsWith(normalizedMatch)) {
      return true;
    }
    
    return false;
  }

  private processNextMedication() {
    if (this.currentMedicationIndex >= this.pendingMedicationsToSave.length) {
      // All medications processed - now save them
      this.saveAllMedicationsWithCnk();
      return;
    }
    
    const med = this.pendingMedicationsToSave[this.currentMedicationIndex] as any;
    
    if (med.needsUserSelection && med.matches && med.matches.length > 0) {
      // Show modal for user to select CNK
      this.currentMedicationForCnkSelection = {
        medicationName: med.name || '',
        indication: med.indication,
        asNeeded: med.asNeeded,
        unitsBeforeBreakfast: med.unitsBeforeBreakfast,
        unitsDuringBreakfast: med.unitsDuringBreakfast,
        unitsBeforeLunch: med.unitsBeforeLunch,
        unitsDuringLunch: med.unitsDuringLunch,
        unitsBeforeDinner: med.unitsBeforeDinner,
        unitsDuringDinner: med.unitsDuringDinner,
        unitsAtBedtime: med.unitsAtBedtime,
        matches: med.matches
      };
      this.showCnkSelectionModal = true;
    } else {
      // No user selection needed - move to next
      this.currentMedicationIndex++;
      this.processNextMedication();
    }
  }

  onCnkSelected(searchResult: MedicationSearchResult) {
    console.log('[MedicationList] User selected CNK:', searchResult.cnk, 'for medication:', this.currentMedicationForCnkSelection?.medicationName);
    
    // Update the pending medication with the selected CNK
    const med = this.pendingMedicationsToSave[this.currentMedicationIndex] as any;
    med.searchResult = searchResult;
    delete med.needsUserSelection;
    delete med.matches;
    
    this.showCnkSelectionModal = false;
    this.currentMedicationForCnkSelection = null;
    this.currentMedicationIndex++;
    this.processNextMedication();
  }

  onCnkSkipped() {
    console.log('[MedicationList] User skipped CNK selection for:', this.currentMedicationForCnkSelection?.medicationName);
    
    // Keep the medication without CNK
    const med = this.pendingMedicationsToSave[this.currentMedicationIndex] as any;
    delete med.needsUserSelection;
    delete med.matches;
    
    this.showCnkSelectionModal = false;
    this.currentMedicationForCnkSelection = null;
    this.currentMedicationIndex++;
    this.processNextMedication();
  }

  onCnkSelectionCancelled() {
    console.log('[MedicationList] User cancelled entire import');
    this.showCnkSelectionModal = false;
    this.currentMedicationForCnkSelection = null;
    this.pendingMedicationsToSave = [];
    this.currentMedicationIndex = 0;
  }

  private saveAllMedicationsWithCnk() {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      console.error('[MedicationList] No medication review ID');
      return;
    }
    
    console.log('[MedicationList] Saving', this.pendingMedicationsToSave.length, 'medications with CNK data to backend');
    this.isLoading = true;
    
    let savedCount = 0;
    const saveNext = (index: number) => {
      if (index >= this.pendingMedicationsToSave.length) {
        console.log('[MedicationList] All medications saved:', savedCount);
        this.isLoading = false;
        alert(`Successfully imported ${savedCount} medication(s).`);
        this.loadMedications();
        this.pendingMedicationsToSave = [];
        return;
      }
      
      const med = this.pendingMedicationsToSave[index] as any;
      const payload: any = {
        name: med.name || '',
        indication: med.indication,
        asNeeded: med.asNeeded,
        unitsBeforeBreakfast: med.unitsBeforeBreakfast,
        unitsDuringBreakfast: med.unitsDuringBreakfast,
        unitsBeforeLunch: med.unitsBeforeLunch,
        unitsDuringLunch: med.unitsDuringLunch,
        unitsBeforeDinner: med.unitsBeforeDinner,
        unitsDuringDinner: med.unitsDuringDinner,
        unitsAtBedtime: med.unitsAtBedtime
      };
      
      // Add CNK/VMP/packageSize if available
      if (med.searchResult) {
        payload.cnk = parseInt(med.searchResult.cnk) || undefined;
        payload.vmp = med.searchResult.vmp ? parseInt(med.searchResult.vmp) : undefined;
        payload.packageSize = med.searchResult.verpakking || undefined;
      }
      
      console.log('[MedicationList] Saving medication index', index, 'payload:', payload);
      this.apiService.addMedication(medicationReviewId, payload).subscribe({
        next: (response) => {
          console.log('[MedicationList] Medication saved:', med.name, 'response:', response);
          savedCount++;
          saveNext(index + 1);
        },
        error: (error) => {
          console.error('[MedicationList] Failed to save medication:', med.name, error);
          // Continue with next medication
          saveNext(index + 1);
        }
      });
    };
    
    saveNext(0);
  }

  addMedication() {
    this.editingMedication = null;
    this.showSearchModal = true;
  }

  onModalClose() {
    this.showSearchModal = false;
    this.editingMedication = null;
  }

  onMedicationSelected(medication: MedicationSearchResult) {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      console.error('[MedicationList] No medication review ID');
      return;
    }

    // Check if we're editing an existing medication
    if (this.editingMedication) {
      console.log('[MedicationList] Replacing medication:', this.editingMedication.name, 'with:', medication.benaming);
      console.log('[MedicationList] New package size (verpakking):', medication.verpakking);
      console.log('[MedicationList] Old package size:', this.editingMedication.packageSize);

      // Update the existing medication while preserving intake and indication
      this.apiService.updateMedication(
        medicationReviewId,
        this.editingMedication.medicationId,
        {
          name: medication.benaming,
          cnk: parseInt(medication.cnk) || undefined,
          vmp: medication.vmp ? parseInt(medication.vmp) : undefined,
          packageSize: medication.verpakking ?? undefined,
          // Preserve existing values
          indication: this.editingMedication.indication || undefined,
          specialFrequency: this.editingMedication.specialFrequency ?? undefined,
          specialDescription: this.editingMedication.specialDescription || undefined,
          unitsBeforeBreakfast: this.editingMedication.unitsBeforeBreakfast ?? undefined,
          unitsDuringBreakfast: this.editingMedication.unitsDuringBreakfast ?? undefined,
          unitsBeforeLunch: this.editingMedication.unitsBeforeLunch ?? undefined,
          unitsDuringLunch: this.editingMedication.unitsDuringLunch ?? undefined,
          unitsBeforeDinner: this.editingMedication.unitsBeforeDinner ?? undefined,
          unitsDuringDinner: this.editingMedication.unitsDuringDinner ?? undefined,
          unitsAtBedtime: this.editingMedication.unitsAtBedtime ?? undefined
        }
      ).subscribe({
        next: (response) => {
          console.log('[MedicationList] Medication updated:', response);
          this.showSearchModal = false;
          this.editingMedication = null;
          this.loadMedications();
        },
        error: (error) => {
          console.error('[MedicationList] Failed to update medication:', error);
          alert('Failed to update medication. Please try again.');
        }
      });
    } else {
      // Adding new medication
      console.log('[MedicationList] Adding medication:', medication);
      console.log('[MedicationList] Package size (verpakking):', medication.verpakking);

      this.apiService.addMedication(
        medicationReviewId,
        {
          name: medication.benaming,
          cnk: parseInt(medication.cnk) || undefined,
          vmp: medication.vmp ? parseInt(medication.vmp) : undefined,
          packageSize: medication.verpakking ?? undefined
        }
      ).subscribe({
        next: (response) => {
          console.log('[MedicationList] Medication added:', response);
          this.showSearchModal = false;
          this.loadMedications();
          
          // Mark as new and scroll to it after a brief delay to allow rendering
          setTimeout(() => {
            this.scrollToNewMedication();
          }, 100);
        },
        error: (error) => {
          console.error('[MedicationList] Failed to add medication:', error);
          alert('Failed to add medication. Please try again.');
        }
      });
    }
  }

  onMedicationDeleted(medicationId: string) {
    console.log('[MedicationList] Medication deleted:', medicationId);
    // Remove from local array
    this.medications = this.medications.filter(med => med.medicationId !== medicationId);
  }

  onEditRequested(medication: Medication) {
    console.log('[MedicationList] Edit requested for medication:', medication.name);
    this.editingMedication = medication;
    this.showSearchModal = true;
  }

  deleteAllMedications() {
    if (!this.medications || this.medications.length === 0) {
      alert('No medications to delete.');
      return;
    }

    const confirmMsg = 'Are you sure you want to delete ALL medications for this review? This action cannot be undone.';
    if (!confirm(confirmMsg)) {
      console.log('[MedicationList] deleteAllMedications cancelled by user');
      return;
    }

    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      console.error('[MedicationList] No medication review ID');
      alert('Please create or select a medication review first.');
      return;
    }

    console.log('[MedicationList] Deleting all medications. Count:', this.medications.length);
    // Delete sequentially to avoid hitting backend limits
    const medsToDelete = [...this.medications];
    let deletedCount = 0;

    const deleteNext = (index: number) => {
      if (index >= medsToDelete.length) {
        console.log('[MedicationList] Completed deleting medications. Deleted count:', deletedCount);
        alert(`Deleted ${deletedCount} medication(s).`);
        this.loadMedications();
        return;
      }

      const med = medsToDelete[index];
      if (!med.medicationId) {
        console.warn('[MedicationList] Skipping medication with no medicationId:', med);
        deleteNext(index + 1);
        return;
      }

      console.log('[MedicationList] Deleting medication:', med.medicationId, med.name);
      this.apiService.deleteMedication(medicationReviewId, med.medicationId).subscribe({
        next: () => {
          deletedCount++;
          deleteNext(index + 1);
        },
        error: (err) => {
          console.error('[MedicationList] Failed to delete medication:', med.medicationId, err);
          // continue with next
          deleteNext(index + 1);
        }
      });
    };

    deleteNext(0);
  }

  private scrollToNewMedication() {
    if (this.medications.length === 0) return;
    
    // Mark the last medication as new
    const lastMedication = this.medications[this.medications.length - 1];
    if (lastMedication) {
      (lastMedication as any).isNew = true;
      
      // Scroll to the last medication after rendering
      setTimeout(() => {
        const scrollContainer = this.medicationsScrollContainer?.nativeElement;
        if (scrollContainer) {
          // Get the last medication item element
          const lastItem = scrollContainer.lastElementChild;
          if (lastItem) {
            // Scroll the item into view smoothly
            lastItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            console.log('[MedicationList] Scrolled to new medication');
          }
        }
      }, 50);

      // Remove the new flag after animation completes
      setTimeout(() => {
        (lastMedication as any).isNew = false;
      }, 2500);
    }
  }
}

```
--- END OF FILE: src\app\components\medication-list\medication-list.component.ts ---

--- START OF FILE: src\app\components\medication-notes-modal\medication-notes-modal.component.html ---
```typescript
<div class="modal-overlay" (click)="onCancel()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>{{ 'notes.add_note' | transloco }}</h2>

    <div class="medication-info" *ngIf="medication">
      <div class="info-row">
        <span class="info-label">{{ 'patient.name' | transloco }}:</span>
        <span class="info-value">{{ medication.name }}</span>
      </div>
      <div class="info-row" *ngIf="getFrequencyDisplay()">
        <span class="info-label">{{ 'medication.frequency' | transloco }}:</span>
        <span class="info-value">{{ getFrequencyDisplay() }}</span>
      </div>
    </div>

    <div class="form-section">
      <label for="note-text">{{ 'notes.note_text' | transloco }}:</label>
      <textarea 
        id="note-text"
        [(ngModel)]="noteText"
        [placeholder]="'notes.note_placeholder' | transloco"
        rows="6"
      ></textarea>
      
      <!-- Preset buttons -->
      <div class="preset-buttons" *ngIf="presetButtons.length > 0">
        <button 
          *ngFor="let preset of presetButtons" 
          type="button"
          class="preset-btn"
          (click)="addPresetText(preset)"
        >
          {{ preset | transloco }}
        </button>
      </div>
    </div>

    <div class="toggle-section">
      <button 
        type="button"
        class="toggle-button"
        [class.active]="addToPatientConversation"
        (click)="addToPatientConversation = !addToPatientConversation"
      >
        <span class="toggle-icon">{{ addToPatientConversation ? '‚úì' : '' }}</span>
        <span class="toggle-text">{{ 'notes.add_to_patient_conversation' | transloco }}</span>
      </button>

      <button 
        type="button"
        class="toggle-button"
        [class.active]="addToGpReport"
        (click)="addToGpReport = !addToGpReport"
      >
        <span class="toggle-icon">{{ addToGpReport ? '‚úì' : '' }}</span>
        <span class="toggle-text">{{ 'notes.add_to_gp_report' | transloco }}</span>
      </button>
    </div>

    <div class="button-row">
      <button class="btn-secondary" (click)="onCancel()">{{ 'common.cancel' | transloco }}</button>
      <button class="btn-primary" (click)="onAddToAnamnesis()">{{ 'notes.add_to_anamnesis' | transloco }}</button>
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\components\medication-notes-modal\medication-notes-modal.component.html ---

--- START OF FILE: src\app\components\medication-notes-modal\medication-notes-modal.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(2px);
}

.modal-content {
  background-color: white;
  border-radius: $box-border-radius;
  padding: 2rem;
  max-width: 600px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);

  h2 {
    font-family: $primary-font;
    font-weight: $font-weight-semibold;
    color: $text-primary;
    margin: 0 0 1.5rem 0;
    font-size: 1.5rem;
  }

  .medication-info {
    background-color: #f8f9fa;
    border-radius: $box-border-radius-small;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border: 1px solid $box-border-primary;

    .info-row {
      display: flex;
      gap: 0.75rem;
      padding: 0.35rem 0;
      font-family: $primary-font;

      &:not(:last-child) {
        border-bottom: 1px solid rgba($box-border-primary, 0.3);
      }

      .info-label {
        font-weight: $font-weight-semibold;
        color: $text-secondary;
        font-size: 0.875rem;
        min-width: 4.5rem;
      }

      .info-value {
        color: $text-primary;
        font-size: 0.875rem;
      }
    }
  }

  .form-section {
    margin-bottom: 1.5rem;

    label {
      display: block;
      font-family: $primary-font;
      font-weight: $font-weight-semibold;
      color: $text-primary;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    textarea {
      width: 100%;
      font-family: $primary-font;
      font-size: 0.95rem;
      color: $text-primary;
      border: 2px solid $box-border-primary;
      border-radius: $box-border-radius-small;
      padding: 0.75rem;
      resize: vertical;
      transition: all 0.2s ease;

      &:hover {
        border-color: darken($box-border-primary, 10%);
      }

      &:focus {
        outline: none;
        border-color: $button-primary-background;
        box-shadow: 0 0 0 3px rgba($button-primary-background, 0.1);
      }

      &::placeholder {
        color: $text-secondary;
        opacity: 0.6;
      }
    }

    .preset-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;

      .preset-btn {
        font-family: $primary-font;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        border: 1px solid $box-border-primary;
        border-radius: $box-border-radius-small;
        background-color: white;
        color: $text-primary;
        cursor: pointer;
        transition: all 0.2s ease;

        &:hover {
          background-color: rgba($button-primary-background, 0.1);
          border-color: $button-primary-background;
          color: $button-primary-background;
        }

        &:active {
          transform: translateY(1px);
        }
      }
    }
  }

  .toggle-section {
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;

    .toggle-button {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-family: $primary-font;
      font-size: 0.95rem;
      padding: 0.875rem 1rem;
      border: 2px solid $box-border-primary;
      border-radius: $box-border-radius-small;
      background-color: white;
      color: $text-primary;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;

      .toggle-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 1.5rem;
        height: 1.5rem;
        border: 2px solid $box-border-primary;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: bold;
        color: transparent;
        transition: all 0.2s ease;
      }

      .toggle-text {
        flex: 1;
      }

      &:hover {
        border-color: darken($box-border-primary, 10%);
        background-color: #f8f9fa;
      }

      &.active {
        border-color: $button-primary-background;
        background-color: rgba($button-primary-background, 0.05);

        .toggle-icon {
          background-color: $button-primary-background;
          border-color: $button-primary-background;
          color: white;
        }
      }

      &:active {
        transform: translateY(1px);
      }
    }
  }

  .button-row {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;

    button {
      font-family: $primary-font;
      font-weight: $font-weight-semibold;
      font-size: 0.95rem;
      padding: 0.75rem 1.5rem;
      border-radius: $box-border-radius-small;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;

      &.btn-secondary {
        background-color: white;
        color: $text-primary;
        border: 2px solid $box-border-primary;

        &:hover {
          background-color: #f8f9fa;
          border-color: darken($box-border-primary, 10%);
        }

        &:active {
          transform: translateY(1px);
        }
      }

      &.btn-primary {
        background-color: $button-primary-background;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

        &:hover {
          background-color: darken($button-primary-background, 5%);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        &:active {
          transform: translateY(1px);
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
      }
    }
  }
}

```
--- END OF FILE: src\app\components\medication-notes-modal\medication-notes-modal.component.scss ---

--- START OF FILE: src\app\components\medication-notes-modal\medication-notes-modal.component.ts ---
```typescript
import { Component, Input, Output, EventEmitter, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { TranslocoModule, TranslocoService } from '@jsverse/transloco';
import { Medication } from '../medication-item/medication-item.component';
import { ReviewNotesService } from '../../services/review-notes.service';
import { StateService } from '../../services/state.service';

@Component({
  selector: 'app-medication-notes-modal',
  standalone: true,
  imports: [CommonModule, FormsModule, TranslocoModule],
  templateUrl: './medication-notes-modal.component.html',
  styleUrls: ['./medication-notes-modal.component.scss']
})
export class MedicationNotesModalComponent implements OnInit {
  @Input() medication: Medication | null = null;
  @Input() category: string = 'General'; // Category based on tool/source
  @Output() close = new EventEmitter<void>();

  noteText = '';
  addToPatientConversation = true;
  addToGpReport = true;
  isSubmitting = false;
  presetButtons: string[] = [];

  constructor(
    private reviewNotesService: ReviewNotesService,
    private stateService: StateService,
    private transloco: TranslocoService
  ) {}

  ngOnInit() {
    this.updatePresetButtons();
  }

  updatePresetButtons() {
    const presetMap: Record<string, string[]> = {
      'MedicationSchema': ['notes.preset_reduce_intake', 'notes.preset_move_intake'],
      'TherapyAdherence': ['notes.preset_too_few_units', 'notes.preset_too_many_units'],
      'Interactions': ['notes.preset_advice_alternative', 'notes.preset_inform_patient'],
      'Contraindications': ['notes.preset_advice_alternative', 'notes.preset_inform_patient'],
      'Posology': ['notes.preset_dose_too_high', 'notes.preset_dose_too_low'],
      'Renadapter': ['notes.preset_dosing_adjustment', 'notes.preset_renal_followup']
    };
    this.presetButtons = presetMap[this.category] || [];
  }

  getFrequencyDisplay(): string {
    if (!this.medication) return '';
    
    // Check for special frequency (non-daily)
    if (this.medication.specialFrequency && this.medication.specialDescription) {
      const frequencyMap: Record<number, string> = {
        1: this.transloco.translate('frequency.daily'),
        2: this.transloco.translate('frequency.twice_weekly'),
        3: this.transloco.translate('frequency.three_times_weekly'),
        4: this.transloco.translate('frequency.weekly'),
        5: this.transloco.translate('frequency.every_2_weeks'),
        6: this.transloco.translate('frequency.every_3_weeks'),
        7: this.transloco.translate('frequency.every_4_weeks'),
        8: this.transloco.translate('frequency.monthly'),
        9: this.transloco.translate('frequency.every_2_months'),
        10: this.transloco.translate('frequency.quarterly'),
        11: this.transloco.translate('frequency.annually')
      };
      const freqText = frequencyMap[this.medication.specialFrequency] || `${this.medication.specialFrequency}x`;
      return `${this.medication.specialFrequency}x ${freqText}`;
    }
    
    // If daily medication, show dosage if available
    if (this.medication.dosage) {
      return this.medication.dosage;
    }
    
    return '';
  }

  addPresetText(presetKey: string) {
    const presetText = this.transloco.translate(presetKey);
    if (this.noteText.trim()) {
      this.noteText += '\n' + presetText;
    } else {
      this.noteText = presetText;
    }
  }

  onCancel() {
    this.close.emit();
    this.resetForm();
  }

  onAddToAnamnesis() {
    if (!this.noteText.trim()) {
      console.warn('[MedicationNotesModal] Note text is empty');
      return;
    }

    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) {
      console.error('[MedicationNotesModal] No review ID found');
      return;
    }

    this.isSubmitting = true;

    const noteData = {
      text: this.noteText.trim(),
      category: this.category,
      linkedCnk: this.medication?.cnk?.toString() || undefined,
      medicationName: this.medication?.name || undefined,
      discussWithPatient: this.addToPatientConversation,
      communicateToDoctor: this.addToGpReport
    };

    console.log('[MedicationNotesModal] Adding to anamnesis:', noteData);

    this.reviewNotesService.addNote(reviewId, noteData).subscribe({
      next: (note) => {
        console.log('[MedicationNotesModal] Successfully added note:', note);
        this.close.emit();
        this.resetForm();
      },
      error: (error) => {
        console.error('[MedicationNotesModal] Error adding note:', error);
        this.isSubmitting = false;
      }
    });
  }

  private resetForm() {
    this.noteText = '';
    this.addToPatientConversation = true;
    this.addToGpReport = true;
    this.isSubmitting = false;
  }
}

```
--- END OF FILE: src\app\components\medication-notes-modal\medication-notes-modal.component.ts ---

--- START OF FILE: src\app\components\medication-search-modal\medication-search-modal.component.html ---
```typescript
<div class="modal-overlay" (click)="onCancel()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditMode ? ('medication.replace_medication' | transloco) : ('medication.search_medication' | transloco) }}</h2>
      <button class="close-button" (click)="onCancel()">&times;</button>
    </div>

    <div class="modal-body">
      <!-- Search Input -->
      <div class="search-section">
        <input 
          #searchInput
          type="text" 
          class="search-input" 
          placeholder="{{ 'medication.search_placeholder' | transloco }}" 
          [value]="searchTerm"
          (input)="onSearchInput($event)"
          autofocus
        />
        <div *ngIf="isSearching" class="searching-indicator">{{ 'common.loading' | transloco }}</div>
      </div>

      <!-- Error Message -->
      <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
      </div>

      <!-- Search Results Dropdown -->
      <div class="results-container" *ngIf="searchResults.length > 0">
        <div 
          *ngFor="let medication of searchResults" 
          class="result-item"
          (click)="selectMedication(medication)"
        >
          <div class="medication-name">{{ medication.benaming }}</div>
          <div class="medication-details">
            <span class="cnk-code">CNK: {{ medication.cnk }}</span>
            <span class="vmp-code" *ngIf="medication.vmp">VMP: {{ medication.vmp }}</span>
            <span class="packaging">{{ medication.verpakking }}</span>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isSearching && searchTerm.length >= 2 && searchResults.length === 0" class="empty-state">
        {{ 'medication.no_results' | transloco:{term: searchTerm} }}
      </div>

      <!-- Initial State -->
      <div *ngIf="!isSearching && searchTerm.length < 2 && searchResults.length === 0" class="initial-state">
        {{ 'medication.search_hint' | transloco }}
      </div>
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\components\medication-search-modal\medication-search-modal.component.html ---

--- START OF FILE: src\app\components\medication-search-modal\medication-search-modal.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-container {
  background-color: white;
  border: $box-border-width solid $box-border-primary;
  border-radius: $box-border-radius;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: $box-border-width solid $box-border-primary;

  h2 {
    margin: 0;
    font-family: $primary-font;
    font-weight: $font-weight-thin;
    font-size: 24px;
    color: $button-primary;
  }

  .close-button {
    background: none;
    border: none;
    font-size: 32px;
    color: $button-primary;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;

    &:hover {
      opacity: 0.7;
    }
  }
}

.modal-body {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}

.search-section {
  margin-bottom: 15px;
  position: relative;

  .search-input {
    width: 100%;
    padding: 12px;
    border: $box-border-width solid $box-border-primary;
    border-radius: $box-border-radius;
    font-family: $primary-font;
    font-size: 16px;
    box-sizing: border-box;

    &:focus {
      outline: none;
      border-color: $button-primary;
    }
  }

  .searching-indicator {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: $button-primary;
    font-family: $primary-font;
    font-size: 14px;
    font-style: italic;
  }
}

.error-message {
  background-color: #fee;
  border: $box-border-width solid #fcc;
  border-radius: $box-border-radius;
  padding: 12px;
  color: #c00;
  font-family: $primary-font;
  margin-bottom: 15px;
  font-size: 14px;
}

.results-container {
  border: $box-border-width solid $box-border-primary;
  border-radius: $box-border-radius;
  max-height: 400px;
  overflow-y: auto;

  .result-item {
    padding: 12px;
    border-bottom: $box-border-width solid #e0e0e0;
    cursor: pointer;
    transition: background-color 0.2s;

    &:last-child {
      border-bottom: none;
    }

    &:hover {
      background-color: #f0f7ff;
    }

    .medication-name {
      font-family: $primary-font;
      font-weight: $font-weight-medium;
      color: $button-primary;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .medication-details {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      font-family: $primary-font;
      font-size: 13px;
      color: #666;

      span {
        &.cnk-code {
          font-weight: $font-weight-semibold;
        }

        &.vmp-code {
          color: $button-primary;
        }

        &.packaging {
          font-style: italic;
        }
      }
    }
  }
}

.empty-state,
.initial-state {
  text-align: center;
  padding: 40px 20px;
  color: #999;
  font-family: $primary-font;
  font-style: italic;
  font-size: 14px;
}

.initial-state {
  color: #666;
}

```
--- END OF FILE: src\app\components\medication-search-modal\medication-search-modal.component.scss ---

--- START OF FILE: src\app\components\medication-search-modal\medication-search-modal.component.ts ---
```typescript
import { Component, Input, Output, EventEmitter, ViewChild, ElementRef, AfterViewInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';
import { FormsModule } from '@angular/forms';
import { Subject } from 'rxjs';
import { debounceTime, distinctUntilChanged } from 'rxjs/operators';
import { ApiService } from '../../services/api.service';
import { MedicationSearchResult } from '../../models/api.models';

@Component({
  selector: 'app-medication-search-modal',
  standalone: true,
  imports: [CommonModule, FormsModule, TranslocoModule],
  templateUrl: './medication-search-modal.component.html',
  styleUrls: ['./medication-search-modal.component.scss']
})
export class MedicationSearchModalComponent implements AfterViewInit {
  @Input() isEditMode = false;
  @Output() close = new EventEmitter<void>();
  @Output() medicationSelected = new EventEmitter<MedicationSearchResult>();
  @ViewChild('searchInput') searchInput!: ElementRef;

  searchTerm = '';
  searchResults: MedicationSearchResult[] = [];
  isSearching = false;
  errorMessage = '';
  
  private searchSubject = new Subject<string>();

  constructor(private apiService: ApiService) {
    // Set up debounced search
    this.searchSubject.pipe(
      debounceTime(300),
      distinctUntilChanged()
    ).subscribe(term => {
      if (term.trim().length >= 2) {
        this.performSearch(term);
      } else {
        this.searchResults = [];
      }
    });
  }

  ngAfterViewInit() {
    // Focus the search input after the view is initialized
    if (this.searchInput) {
      setTimeout(() => {
        this.searchInput.nativeElement.focus();
        console.log('[MedicationSearchModal] Search input focused');
      }, 100);
    }
  }

  onSearchInput(event: Event) {
    const value = (event.target as HTMLInputElement).value;
    this.searchTerm = value;
    this.searchSubject.next(value);
  }

  performSearch(term: string) {
    this.isSearching = true;
    this.errorMessage = '';

    this.apiService.searchMedications({ searchTerm: term, maxResults: 20 }).subscribe({
      next: (response) => {
        console.log('[MedicationSearchModal] RAW BACKEND RESPONSE:', JSON.stringify(response, null, 2));
        this.searchResults = response.results;
        this.isSearching = false;
      },
      error: (error) => {
        console.error('[MedicationSearchModal] Search failed:', error);
        this.errorMessage = 'Search failed. Please try again.';
        this.searchResults = [];
        this.isSearching = false;
      }
    });
  }

  selectMedication(medication: MedicationSearchResult) {
    console.log('[MedicationSearchModal] Medication selected:', medication);
    this.medicationSelected.emit(medication);
    this.onCancel();
  }

  onCancel() {
    this.close.emit();
  }
}

```
--- END OF FILE: src\app\components\medication-search-modal\medication-search-modal.component.ts ---

--- START OF FILE: src\app\components\note-overview-modal\note-overview-modal.component.html ---
```typescript
<div class="modal-overlay" (click)="close()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h1>Note Overview</h1>
      <div class="header-actions">
        <div class="notes-count">{{ notes.length }} note{{ notes.length !== 1 ? 's' : '' }}</div>
        <button class="btn-secondary" (click)="showAddGeneralNote()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add General Note
        </button>
        <button class="btn-primary" (click)="generatePatientConversation()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          {{ 'notes.start_conversation' | transloco }}
        </button>
        <button class="close-button" (click)="close()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    <div class="modal-body">
      @if (notes.length === 0) {
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <h2>No notes yet</h2>
          <p>Add notes from the analysis page using the "Add Note" buttons on each tool.</p>
        </div>
      } @else {
        <div class="notes-list">
          @for (note of notes; track note.rowKey) {
            <div class="note-card">
              <!-- Note content -->
              <div class="note-content">
                <div class="note-header">
                  @if (note.medicationName) {
                    <div class="medication-flag">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                      </svg>
                      {{ note.medicationName }}
                    </div>
                  } @else {
                    <div class="medication-flag general">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                      </svg>
                      General
                    </div>
                  }
                  @if (note.category) {
                    <span class="note-category">{{ note.category }}</span>
                  }
                </div>

                @if (isEditing(note)) {
                  <textarea 
                    class="note-edit-input"
                    [(ngModel)]="editingNoteText"
                    rows="3"
                  ></textarea>
                } @else {
                  <p class="note-text">{{ note.text }}</p>
                }
                
                @if (note.timestamp) {
                  <div class="note-timestamp">
                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    {{ formatTimestamp(note.timestamp) }}
                  </div>
                }
              </div>

              <!-- Note actions -->
              <div class="note-actions">
                @if (isEditing(note)) {
                  <div class="edit-actions">
                    <button class="btn-save" (click)="saveEdit(note)" [title]="'note_modal.save_changes' | transloco">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                      {{ 'note_modal.save' | transloco }}
                    </button>
                    <button class="btn-cancel" (click)="cancelEditing()" [title]="'note_modal.cancel_editing' | transloco">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                      {{ 'note_modal.cancel' | transloco }}
                    </button>
                  </div>
                } @else {
                  <div class="toggle-buttons">
                    <button 
                      class="toggle-btn"
                      [class.active]="note.discussWithPatient"
                      (click)="toggleDiscussWithPatient(note)"
                      title="Include in patient conversation">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                      </svg>
                      Patient
                    </button>
                    <button 
                      class="toggle-btn"
                      [class.active]="note.communicateToDoctor"
                      (click)="toggleCommunicateToDoctor(note)"
                      title="Include in GP report">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                      </svg>
                      GP
                    </button>
                  </div>
                  <div class="action-buttons">
                    <button class="btn-edit" (click)="startEditing(note)" [title]="'note_modal.edit_note' | transloco">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </button>
                    <button class="btn-delete" (click)="deleteNote(note)" [title]="'note_modal.delete_note' | transloco">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- Add general note form -->
    @if (showGeneralNoteForm) {
      <div class="general-note-form">
        <h3>Add General Note</h3>
        <div class="form-group">
          <label for="noteText">Note Text:</label>
          <textarea 
            id="noteText" 
            [(ngModel)]="newNoteText" 
            placeholder="Enter your note here..."
            rows="4"
          ></textarea>
        </div>
        <div class="form-group">
          <label for="noteCategory">Category:</label>
          <select id="noteCategory" [(ngModel)]="newNoteCategory">
            <option value="TherapyAdherence">Therapy Adherence (Part 2)</option>
            <option value="Effectiveness">Effectiveness (Part 3)</option>
          </select>
        </div>
        <div class="form-actions">
          <button class="btn-secondary" (click)="cancelAddGeneralNote()">Cancel</button>
          <button class="btn-primary" (click)="saveGeneralNote()" [disabled]="!newNoteText.trim()">Save Note</button>
        </div>
      </div>
    }

    <!-- Delete confirmation modal -->
    @if (showDeleteConfirmation) {
      <app-confirmation-modal
        [title]="'messages.delete_note_title' | transloco"
        [message]="'messages.confirm_delete_note' | transloco"
        [confirmText]="'common.delete' | transloco"
        [cancelText]="'common.cancel' | transloco"
        (confirm)="onConfirmDelete()"
        (cancel)="onCancelDelete()"
      ></app-confirmation-modal>
    }
  </div>
</div>

```
--- END OF FILE: src\app\components\note-overview-modal\note-overview-modal.component.html ---

--- START OF FILE: src\app\components\note-overview-modal\note-overview-modal.component.scss ---
```typescript
@import '../../../styles/_colors';
@import '../../../styles/_fonts';

// Modal overlay
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 2rem;
}

// Modal container - styled like a notebook
.modal-container {
  background: linear-gradient(to right,
    darken($button-primary-background, 12%) 0%,
    darken($button-primary-background, 12%) 40px,
    darken($button-primary-background, 6%) 40px,
    darken($button-primary-background, 6%) 42px,
    $main-background 42px,
    $main-background 100%
  );
  width: 90vw;
  max-width: 1400px;
  height: 85vh;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  box-shadow: 
    0 2px 4px rgba(0,0,0,0.1),
    0 8px 16px rgba(0,0,0,0.1),
    0 16px 32px rgba(0,0,0,0.15);
  overflow: hidden;
  position: relative;

  // Notebook binding rings effect
  &::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: repeating-linear-gradient(
      to bottom,
      transparent,
      transparent 30px,
      rgba($box-background, 0.08) 30px,
      rgba($box-background, 0.08) 35px
    );
    z-index: 1;
  }
}

// Modal header - notebook cover style
.modal-header {
  background: linear-gradient(135deg, darken($button-primary-background, 6%) 0%, $button-primary-background 100%);
  padding: 1.25rem 1.5rem 1.25rem 60px;
  border-bottom: 3px solid darken($button-primary-background, 18%);
  display: flex;
  align-items: center;
  gap: 1.25rem;
  flex-shrink: 0;
  position: relative;

  // Add subtle texture
  &::after {
    content: '';
    position: absolute;
    top: 0;
    left: 42px;
    right: 0;
    bottom: 0;
    background: repeating-linear-gradient(
      90deg,
      transparent,
      transparent 2px,
      rgba(255,255,255,0.01) 2px,
      rgba(255,255,255,0.01) 4px
    );
    pointer-events: none;
  }

  h1 {
    flex: 1;
    margin: 0;
    font-family: $primary-font;
    font-weight: $font-weight-bold;
    font-size: 1.5rem;
    color: $text-button-primary;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    letter-spacing: 0.5px;
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;

    .notes-count {
      padding: 0.35rem 0.75rem;
      background-color: rgba($box-background, 0.15);
      color: $text-button-primary;
      border: 1px solid rgba($box-background, 0.25);
      border-radius: 16px;
      font-family: $primary-font;
      font-size: 0.85rem;
      font-weight: $font-weight-medium;
    }

    .btn-secondary {
      padding: 0.55rem 1rem;
      background-color: rgba($box-background, 0.85);
      color: $text-primary;
      border: 1.5px solid rgba($box-background, 0.5);
      border-radius: $box-border-radius-small;
      font-family: $primary-font;
      font-size: 0.9rem;
      font-weight: $font-weight-semibold;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;

      svg {
        flex-shrink: 0;
      }

      &:hover {
        background-color: $box-background;
        border-color: rgba($box-background, 0.8);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      &:active {
        transform: translateY(0);
      }
    }

    .btn-primary {
      padding: 0.55rem 1rem;
      background-color: rgba($box-background, 0.95);
      color: $text-primary;
      border: 1px solid rgba($box-background, 0.3);
      border-radius: $box-border-radius-small;
      font-family: $primary-font;
      font-size: 0.9rem;
      font-weight: $font-weight-semibold;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;

      svg {
        flex-shrink: 0;
      }

      &:hover { 
        background-color: $box-background;
        transform: translateY(-1px); 
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12); 
      }
    }

    .close-button {
      padding: 0.5rem;
      background-color: transparent;
      border: 1px solid rgba($box-background, 0.3);
      border-radius: $box-border-radius-small;
      color: rgba($box-background, 0.7);
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;

      &:hover {
        background-color: rgba($text-secondary, 0.1);
        border-color: rgba($text-secondary, 0.9);
        color: $text-button-primary;
      }

      svg {
        display: block;
      }
    }
  }
}

// Modal body - notebook pages area
.modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 1.5rem 1.5rem 1.5rem calc(1.5rem + 42px);
  background-color: transparent;
  position: relative;
}

// Empty State
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem;
  text-align: center;
  height: 100%;

  svg { 
    color: $text-muted; 
    margin-bottom: 1.25rem; 
  }

  h2 { 
    font-family: $primary-font; 
    font-weight: $font-weight-semibold; 
    font-size: 1.25rem; 
    color: $text-primary; 
    margin: 0 0 0.5rem 0; 
  }

  p { 
    font-family: $primary-font; 
    color: $text-secondary; 
    margin: 0; 
    font-size: 0.95rem;
  }
}

// Notes List
.notes-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

// Note Card - paper note style
  .note-card {
  background-color: $box-background;
  background-image: 
    linear-gradient(90deg, rgba($box-background, 0.5) 1px, transparent 1px),
    linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px);
  background-size: 100% 100%, 100% 1.5rem;
  background-position: 0 0, 0 0.25rem;
  border: 1px solid $box-border;
  border-left: 3px solid $box-border-primary;
  border-radius: 2px;
  padding: 1.25rem 1.25rem 1.25rem 1rem;
  display: flex;
  gap: 1rem;
  transition: all 0.2s ease;
  position: relative;
  box-shadow: 
    0 2px 4px rgba(0, 0, 0, 0.06),
    0 1px 2px rgba(0, 0, 0, 0.04);

  &:hover {
    box-shadow: 
      0 4px 12px rgba(0, 0, 0, 0.08),
      0 2px 4px rgba(0, 0, 0, 0.06);
    transform: translateY(-1px);
  }

  .note-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;

    .note-header {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .medication-flag {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.85rem;
      background: rgba($button-primary-background, 0.08);
      border: 1px solid rgba($button-primary-background, 0.2);
      border-radius: 12px;
      font-family: $primary-font;
      font-size: 0.8rem;
      font-weight: $font-weight-semibold;
      color: $text-primary;
      letter-spacing: 0.01em;

      svg {
        flex-shrink: 0;
        color: $button-primary-background;
        opacity: 0.85;
      }

      &.general {
        background: rgba($text-muted, 0.08);
        border-color: rgba($text-muted, 0.2);

        svg {
          color: $text-muted;
        }
      }
    }

    .note-category {
      display: inline-flex;
      padding: 0.3rem 0.7rem;
      background-color: rgba($button-primary-background, 0.08);
      border: 1px solid rgba($button-primary-background, 0.15);
      color: $button-primary-background;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: $font-weight-medium;
      font-family: $primary-font;
    }

    .note-text {
      margin: 0 0 0.75rem 0;
      line-height: 1.6;
      font-family: $primary-font;
      font-size: 0.95rem;
      color: $text-primary;
      line-height: 1.65;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-weight: $font-weight-semibold;
    }

    .note-edit-input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      font-family: $primary-font;
      font-size: 0.95rem;
      color: $text-primary;
      background-color: rgba($box-background, 0.6);
      border: 1px solid $box-border;
      border-radius: 4px;
      resize: vertical;
      min-height: 4rem;
      transition: all 0.15s ease;
      line-height: 1.6;

      &:focus {
        outline: none;
        border-color: $button-primary-background;
        background-color: rgba($box-background, 0.9);
        box-shadow: 0 0 0 3px rgba($button-primary-background, 0.1);
      }
    }

    .note-timestamp {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      color: $text-muted;
      font-family: $primary-font;
      font-weight: $font-weight-regular;
      margin-top: auto;
      padding-top: 0.25rem;

      svg {
        flex-shrink: 0;
        opacity: 0.6;
      }
    }
  }

  .note-actions {
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    align-items: flex-end;
    flex-shrink: 0;

    .toggle-buttons {
      display: flex;
      gap: 0.5rem;

  .toggle-btn {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.4rem 0.75rem;
  background-color: rgba($box-background, 0.6);
  border: 1px solid $box-border;
  border-radius: 10px;
  font-family: $primary-font;
  font-size: 0.8rem;
  color: $text-secondary;
  cursor: pointer;
  transition: all 0.15s ease;
  white-space: nowrap;

        svg {
          flex-shrink: 0;
        }

        &:hover {
          background-color: rgba(255, 255, 255, 0.9);
          border-color: $button-primary-background;
          color: $button-primary-background;
          transform: translateY(-1px);
        }

        &.active {
          background-color: $button-primary-background;
          border-color: $button-primary-background;
          color: white;
        }
      }
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;

      .btn-edit,
      .btn-delete {
        padding: 0.45rem;
        background-color: rgba($box-background, 0.6);
        border: 1px solid $box-border;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: center;

        svg {
          display: block;
        }
      }

      .btn-edit {
        color: $text-secondary;

        &:hover {
          background-color: rgba($button-primary-background, 0.15);
          border-color: $button-primary-background;
          color: $button-primary-background;
          transform: translateY(-1px);
        }
      }

      .btn-delete {
        color: $text-secondary;
        border-color: rgba($text-secondary, 0.3);

        &:hover {
          background-color: rgba($text-secondary, 0.08);
          border-color: rgba($text-secondary, 0.9);
          transform: translateY(-1px);
        }
      }
    }

    .edit-actions {
      display: flex;
      gap: 0.5rem;

      .btn-save,
      .btn-cancel {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.75rem;
        border: 1px solid;
        border-radius: 10px;
        font-family: $primary-font;
        font-size: 0.8rem;
        font-weight: $font-weight-medium;
        cursor: pointer;
        transition: all 0.15s ease;

        svg {
          flex-shrink: 0;
        }
      }

      .btn-save {
        background-color: $button-primary-background;
        border-color: $button-primary-background;
        color: white;

        &:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba($button-primary-background, 0.25);
        }
      }

      .btn-cancel {
        background-color: rgba(255, 255, 255, 0.6);
        border-color: #d4c5a9;
        color: $text-secondary;

        &:hover {
          background-color: rgba(255, 255, 255, 0.9);
          border-color: $text-secondary;
          transform: translateY(-1px);
        }
      }
    }
  }
}

// General note form
.general-note-form {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  width: 90%;
  max-width: 500px;
  z-index: 10;

  h3 {
    margin: 0 0 1.5rem 0;
    font-family: $primary-font;
    font-size: 1.5rem;
    font-weight: $font-weight-semibold;
    color: $text-primary;
  }

  .form-group {
    margin-bottom: 1.25rem;

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-family: $primary-font;
      font-size: 0.9rem;
      font-weight: $font-weight-medium;
      color: $text-secondary;
    }

    textarea,
    select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d4c5a9;
      border-radius: 8px;
      font-family: $primary-font;
      font-size: 0.9rem;
      color: $text-primary;
      background-color: white;
      transition: border-color 0.15s ease;

      &:focus {
        outline: none;
        border-color: $button-primary-background;
      }
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1.5rem;

    button {
      padding: 0.6rem 1.25rem;
      border: none;
      border-radius: 10px;
      font-family: $primary-font;
      font-size: 0.9rem;
      font-weight: $font-weight-medium;
      cursor: pointer;
      transition: all 0.15s ease;

      &.btn-primary {
        background-color: $button-primary-background;
        color: white;

        &:hover:not(:disabled) {
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba($button-primary-background, 0.25);
        }

        &:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }
      }

      &.btn-secondary {
        background-color: rgba(255, 255, 255, 0.6);
        border: 1px solid #d4c5a9;
        color: $text-secondary;

        &:hover {
          background-color: rgba(255, 255, 255, 0.9);
          border-color: $text-secondary;
          transform: translateY(-1px);
        }
      }
    }
  }
}

```
--- END OF FILE: src\app\components\note-overview-modal\note-overview-modal.component.scss ---

--- START OF FILE: src\app\components\note-overview-modal\note-overview-modal.component.ts ---
```typescript
import { Component, OnInit, OnDestroy, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { Router } from '@angular/router';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { TranslocoModule } from '@jsverse/transloco';
import { ReviewNotesService, ReviewNote } from '../../services/review-notes.service';
import { StateService } from '../../services/state.service';
import { ConfirmationModalComponent } from '../confirmation-modal/confirmation-modal.component';

@Component({
  selector: 'app-note-overview-modal',
  standalone: true,
  imports: [CommonModule, FormsModule, ConfirmationModalComponent, TranslocoModule],
  templateUrl: './note-overview-modal.component.html',
  styleUrls: ['./note-overview-modal.component.scss']
})
export class NoteOverviewModalComponent implements OnInit, OnDestroy {
  @Output() closeModal = new EventEmitter<void>();
  @Output() createConversation = new EventEmitter<void>();

  notes: ReviewNote[] = [];
  
  private destroy$ = new Subject<void>();
  showDeleteConfirmation = false;
  selectedNoteToDelete: ReviewNote | null = null;
  editingNoteId: string | null = null;
  editingNoteText: string = '';
  
  // General note form state
  showGeneralNoteForm = false;
  newNoteText = '';
  newNoteCategory: 'TherapyAdherence' | 'Effectiveness' = 'TherapyAdherence';

  constructor(
    private reviewNotesService: ReviewNotesService,
    private stateService: StateService,
    private router: Router
  ) {}

  ngOnInit() {
    // Subscribe to notes changes
    this.reviewNotesService.notes$
      .pipe(takeUntil(this.destroy$))
      .subscribe(notes => {
        // Sort notes by timestamp descending (newest first)
        this.notes = (notes || []).slice().sort((a, b) => {
          const ta = this.parseTimestamp(a.timestamp);
          const tb = this.parseTimestamp(b.timestamp);
          return tb - ta;
        });
      });

    // Load notes if not already loaded
    const reviewId = this.stateService.medicationReviewId;
    if (reviewId && this.reviewNotesService.getNotesCount() === 0) {
      this.reviewNotesService.loadReviewNotes(reviewId);
    }
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
  }

  generatePatientConversation() {
    // Close modal and navigate directly to anamnesis page
    this.closeModal.emit();
    this.router.navigate(['/anamnesis']);
  }

  deleteNote(note: ReviewNote) {
    // Show confirmation modal instead of browser confirm
    this.selectedNoteToDelete = note;
    this.showDeleteConfirmation = true;
  }

  onConfirmDelete() {
    if (!this.selectedNoteToDelete) return;
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) {
      console.error('[NoteOverviewModal] No review ID found');
      this.showDeleteConfirmation = false;
      this.selectedNoteToDelete = null;
      return;
    }

    const rowKey = this.selectedNoteToDelete.rowKey;
    this.reviewNotesService.deleteNote(reviewId, rowKey).subscribe({
      next: () => {
        console.log('[NoteOverviewModal] Note deleted successfully');
        this.showDeleteConfirmation = false;
        this.selectedNoteToDelete = null;
      },
      error: (error) => {
        console.error('[NoteOverviewModal] Error deleting note:', error);
        alert('Failed to delete note. Please try again.');
        this.showDeleteConfirmation = false;
        this.selectedNoteToDelete = null;
      }
    });
  }

  onCancelDelete() {
    this.showDeleteConfirmation = false;
    this.selectedNoteToDelete = null;
  }

  toggleDiscussWithPatient(note: ReviewNote) {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.reviewNotesService.updateNote(reviewId, note.rowKey, {
      discussWithPatient: !note.discussWithPatient
    }).subscribe({
      error: (error) => {
        console.error('[NoteOverviewModal] Error updating note:', error);
        alert('Failed to update note. Please try again.');
      }
    });
  }

  toggleCommunicateToDoctor(note: ReviewNote) {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.reviewNotesService.updateNote(reviewId, note.rowKey, {
      communicateToDoctor: !note.communicateToDoctor
    }).subscribe({
      error: (error) => {
        console.error('[NoteOverviewModal] Error updating note:', error);
        alert('Failed to update note. Please try again.');
      }
    });
  }

  startEditing(note: ReviewNote) {
    this.editingNoteId = note.rowKey;
    this.editingNoteText = note.text || '';
  }

  cancelEditing() {
    this.editingNoteId = null;
    this.editingNoteText = '';
  }

  saveEdit(note: ReviewNote) {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId || !this.editingNoteText.trim()) {
      this.cancelEditing();
      return;
    }

    this.reviewNotesService.updateNote(reviewId, note.rowKey, {
      text: this.editingNoteText.trim()
    }).subscribe({
      next: () => {
        console.log('[NoteOverviewModal] Note updated successfully');
        this.cancelEditing();
      },
      error: (error) => {
        console.error('[NoteOverviewModal] Error updating note:', error);
        alert('Failed to update note. Please try again.');
      }
    });
  }

  isEditing(note: ReviewNote): boolean {
    return this.editingNoteId === note.rowKey;
  }

  private parseTimestamp(ts: any): number {
    // Accept Date, ISO string, or numeric timestamp. Fallback to 0.
    if (!ts) return 0;
    if (ts instanceof Date) return ts.getTime();
    const n = Number(ts);
    if (!isNaN(n)) return n;
    const parsed = Date.parse(String(ts));
    return isNaN(parsed) ? 0 : parsed;
  }

  formatTimestamp(timestamp: any): string {
    if (!timestamp) return '';

    const date = new Date(timestamp);
    // Use user's locale with a concise, absolute format including time
    const options: Intl.DateTimeFormatOptions = {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    };
    return date.toLocaleString(undefined, options);
  }

  close() {
    this.closeModal.emit();
  }

  showAddGeneralNote() {
    this.showGeneralNoteForm = true;
    this.newNoteText = '';
    this.newNoteCategory = 'TherapyAdherence';
  }

  cancelAddGeneralNote() {
    this.showGeneralNoteForm = false;
    this.newNoteText = '';
  }

  saveGeneralNote() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId || !this.newNoteText.trim()) {
      console.error('[NoteOverviewModal] Cannot save general note - missing review ID or text');
      return;
    }

    console.log('[NoteOverviewModal] Saving general note with category:', this.newNoteCategory);

    this.reviewNotesService.addNote(reviewId, {
      text: this.newNoteText.trim(),
      discussWithPatient: true,
      communicateToDoctor: false,
      category: this.newNoteCategory,
      linkedCnk: undefined // No linked CNK for general notes
    }).subscribe({
      next: (note) => {
        console.log('[NoteOverviewModal] General note saved successfully:', note);
        this.showGeneralNoteForm = false;
        this.newNoteText = '';
      },
      error: (error) => {
        console.error('[NoteOverviewModal] Error saving general note:', error);
        alert('Failed to save note. Please try again.');
      }
    });
  }
}

```
--- END OF FILE: src\app\components\note-overview-modal\note-overview-modal.component.ts ---

--- START OF FILE: src\app\components\patient-details\patient-details.component.html ---
```typescript
<div class="patient-details-box">
  <h3 class="box-title">{{ 'patient.patient_details' | transloco }}</h3>
  
  <div class="fields-grid">
    <div class="field-group">
      <label for="firstName">{{ 'patient.name' | transloco }}</label>
      <input type="text" id="firstName" [(ngModel)]="firstName" (ngModelChange)="onFirstNameChange()" [placeholder]="'patient.name' | transloco">
    </div>
    
    <div class="field-group">
      <label for="lastName">{{ 'patient.name' | transloco }}</label>
      <input type="text" id="lastName" [(ngModel)]="lastName" (ngModelChange)="onLastNameChange()" [placeholder]="'patient.name' | transloco">
    </div>
    
    <div class="field-group">
      <label for="dateOfBirth">{{ 'patient.birth_date' | transloco }}</label>
      <input type="date" id="dateOfBirth" [(ngModel)]="dateOfBirth" (ngModelChange)="onDateOfBirthChange()">
    </div>
    
    <div class="field-group">
      <label for="sex">{{ 'patient.sex' | transloco }}</label>
      <input type="text" id="sex" [(ngModel)]="sex" (ngModelChange)="onSexChange()" [placeholder]="'patient.sex' | transloco">
    </div>
    
    <div class="field-group">
      <label for="renalFunction">{{ 'patient.renal_function' | transloco }}</label>
      <input type="text" id="renalFunction" [(ngModel)]="renalFunction" (ngModelChange)="onRenalFunctionChange()" [placeholder]="'patient.renal_function_placeholder' | transloco">
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\components\patient-details\patient-details.component.html ---

--- START OF FILE: src\app\components\patient-details\patient-details.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.patient-details-box {
  background-color: $box-background;
  border: $box-border-width solid $box-border-primary;
  border-radius: $box-border-radius;
  padding: 1.5rem;
  margin-bottom: 1.5rem;

  .box-title {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: $text-primary;
  }

  .fields-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;

    .field-group {
      display: flex;
      flex-direction: column;

      label {
        font-size: 0.875rem;
        color: $text-secondary;
        margin-bottom: 0.25rem;
        font-weight: $font-weight-regular;
      }

      input {
        padding: 0.5rem;
        border: $box-border-width solid $box-border-primary;
        border-radius: $box-border-radius;
        font-family: $primary-font;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        
        &:hover {
          border-color: rgba($button-primary-background, 0.3);
        }

        &:focus {
          outline: none;
          border-color: $button-primary-background;
          box-shadow: 0 0 0 3px rgba($button-primary-background, 0.1);
        }

        &::placeholder {
          color: $text-muted;
        }
      }

      &#renalFunction {
        grid-column: 1 / -1;
        
        input {
          max-width: 300px;
          padding: 0.75rem 0.875rem;
          border: 2px solid rgba(#10b981, 0.3);
          font-size: 0.95rem;
          background: linear-gradient(to right, rgba(#10b981, 0.02), transparent);

          &:hover {
            border-color: rgba(#10b981, 0.5);
            background: linear-gradient(to right, rgba(#10b981, 0.05), transparent);
          }

          &:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 4px rgba(#10b981, 0.15);
            background: white;
          }
        }

        label {
          color: #059669;
          font-weight: $font-weight-semibold;
          margin-bottom: 0.5rem;
        }
      }
    }
  }
}

```
--- END OF FILE: src\app\components\patient-details\patient-details.component.scss ---

--- START OF FILE: src\app\components\patient-details\patient-details.component.ts ---
```typescript
import { Component, OnInit, OnDestroy } from '@angular/core';
import { FormsModule } from '@angular/forms';
import { Subject } from 'rxjs';
import { debounceTime, distinctUntilChanged, takeUntil } from 'rxjs/operators';
import { TranslocoModule } from '@jsverse/transloco';
import { StateService } from '../../services/state.service';
import { ApiService } from '../../services/api.service';

@Component({
  selector: 'app-patient-details',
  imports: [FormsModule, TranslocoModule],
  templateUrl: './patient-details.component.html',
  styleUrls: ['./patient-details.component.scss']
})
export class PatientDetailsComponent implements OnInit, OnDestroy {
  firstName: string = '';
  lastName: string = '';
  dateOfBirth: string = '';
  sex: string = '';
  // Renal function is stored as a textual summary per API docs (e.g., "eGFR: 45 mL/min/1.73m2")
  renalFunction: string | null = null;

  private destroy$ = new Subject<void>();
  private dateOfBirthChanged$ = new Subject<string>();
  private sexChanged$ = new Subject<string>();
  private firstNameChanged$ = new Subject<string>();
  private lastNameChanged$ = new Subject<string>();
  private renalFunctionChanged$ = new Subject<string | null>();

  constructor(
    private stateService: StateService,
    private apiService: ApiService
  ) {}

  ngOnInit() {
    console.log('[PatientDetails] ngOnInit - loading from session');
    // Prepopulate from session data
    const sessionData = this.stateService.getSessionData();
    if (sessionData) {
      console.log('[PatientDetails] Session data:', JSON.stringify(sessionData.patient, null, 2));
      // Populate from review (first/last name)
      if (sessionData.review.firstNameAtTimeOfReview) {
        this.firstName = sessionData.review.firstNameAtTimeOfReview;
      }
      if (sessionData.review.lastNameAtTimeOfReview) {
        this.lastName = sessionData.review.lastNameAtTimeOfReview;
      }

      // Populate from patient (dateOfBirth, sex, renalFunction)
      if (sessionData.patient.dateOfBirth) {
        // Convert ISO 8601 to YYYY-MM-DD format for date input
        this.dateOfBirth = sessionData.patient.dateOfBirth.split('T')[0];
      }
      if (sessionData.patient.sex) {
        this.sex = sessionData.patient.sex;
      }
      // renalFunction may be provided under sessionData.patient.renalFunction or at top-level sessionData.renalFunction
      let rf: any = undefined;
      let rfFound = false;
      if (sessionData.patient && sessionData.patient.renalFunction !== undefined) {
        rf = sessionData.patient.renalFunction;
        rfFound = true;
        console.log('[PatientDetails] Found renalFunction under sessionData.patient:', rf);
      } else if ((sessionData as any).renalFunction !== undefined) {
        rf = (sessionData as any).renalFunction;
        rfFound = true;
        console.log('[PatientDetails] Found renalFunction at top-level sessionData:', rf);
      }

      if (rfFound) {
        this.renalFunction = rf === null ? null : String(rf);
        console.log('[PatientDetails] Loaded renal function assigned to field:', this.renalFunction);
      } else {
        console.log('[PatientDetails] No renalFunction found in session data');
      }
    } else {
      console.warn('[PatientDetails] No session data available');
    }

    // Set up auto-save for dateOfBirth changes (debounced)
    this.dateOfBirthChanged$
      .pipe(
        debounceTime(1000), // Wait 1 second after user stops typing
        distinctUntilChanged(),
        takeUntil(this.destroy$)
      )
      .subscribe(value => this.savePatientData());

    // Set up auto-save for sex changes (debounced)
    this.sexChanged$
      .pipe(
        debounceTime(1000),
        distinctUntilChanged(),
        takeUntil(this.destroy$)
      )
      .subscribe(value => this.savePatientData());

    // Set up auto-save for first name changes (debounced)
    this.firstNameChanged$
      .pipe(
        debounceTime(1000),
        distinctUntilChanged(),
        takeUntil(this.destroy$)
      )
      .subscribe(value => this.saveMedicationReviewData());

    // Set up auto-save for last name changes (debounced)
    this.lastNameChanged$
      .pipe(
        debounceTime(1000),
        distinctUntilChanged(),
        takeUntil(this.destroy$)
      )
      .subscribe(value => this.saveMedicationReviewData());

    // Set up auto-save for renal function changes (debounced)
    this.renalFunctionChanged$
      .pipe(
        debounceTime(1000),
        distinctUntilChanged(),
        takeUntil(this.destroy$)
      )
      .subscribe(value => this.savePatientData());
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
  }

  onDateOfBirthChange() {
    this.dateOfBirthChanged$.next(this.dateOfBirth);
  }

  onSexChange() {
    this.sexChanged$.next(this.sex);
  }

  onFirstNameChange() {
    this.firstNameChanged$.next(this.firstName);
  }

  onLastNameChange() {
    this.lastNameChanged$.next(this.lastName);
  }

  onRenalFunctionChange() {
    this.renalFunctionChanged$.next(this.renalFunction);
  }

  private savePatientData() {
    const sessionData = this.stateService.getSessionData();
    if (!sessionData) {
      console.warn('[PatientDetails] No session data available, cannot save');
      return;
    }

    // Get APB number and patient ID from state service
    const apbNumber = this.stateService.apbNumber;
    const patientId = this.stateService.patientId;
    
    // Only update if we have valid data
    const request: any = {
      apbNumber: apbNumber,
      patientId: patientId
    };

    // Only include fields that have values
    if (this.dateOfBirth) {
      // Convert YYYY-MM-DD to ISO 8601 format
      request.dateOfBirth = `${this.dateOfBirth}T00:00:00Z`;
    }
    
    if (this.sex) {
      request.sex = this.sex;
    }
    
    // The API accepts renalFunction as string | null per documentation
    if (this.renalFunction !== null && this.renalFunction !== undefined) {
      request.renalFunction = this.renalFunction;
    }

    // Only save if we have at least one field to update
    // Save if at least one updatable field is present. Note: renalFunction may be an empty string to clear the field.
    if (request.dateOfBirth || request.sex || request.hasOwnProperty('renalFunction')) {
      console.log('[PatientDetails] === SAVING PATIENT DATA ===');
      console.log('[PatientDetails] Request payload:', JSON.stringify(request, null, 2));
      
      this.apiService.updatePatient(request).subscribe({
        next: (response) => {
          console.log('[PatientDetails] ‚úì Patient updated successfully');
          console.log('[PatientDetails] Response:', JSON.stringify(response, null, 2));
          // Update session data with new values
          if (sessionData.patient) {
            sessionData.patient.dateOfBirth = response.dateOfBirth;
            sessionData.patient.sex = response.sex;
            sessionData.patient.renalFunction = response.renalFunction ?? null;
            // Also set top-level renalFunction for compatibility with different session shapes
            (sessionData as any).renalFunction = response.renalFunction ?? null;
            console.log('[PatientDetails] Updated session data - patient.renalFunction:', sessionData.patient.renalFunction);
            console.log('[PatientDetails] Updated session data - top-level renalFunction:', (sessionData as any).renalFunction);
            this.stateService.setSessionData(sessionData);
            console.log('[PatientDetails] Session data has been set with renalFunction');
          }
        },
        error: (error) => {
          console.error('[PatientDetails] ‚úó Failed to update patient');
          console.error('[PatientDetails] Error:', error);
          if (error.status === 404) {
            console.error('[PatientDetails] Patient not found in database - may not have been created during login');
            // Don't show error to user - this happens when patient doesn't exist yet
            // The login endpoint should have created the patient
          } else {
            // For other errors, you might want to show a user-friendly message
            console.error('[PatientDetails] Unexpected error updating patient');
          }
        }
      });
    }
  }

  private saveMedicationReviewData() {
    const sessionData = this.stateService.getSessionData();
    if (!sessionData) {
      console.warn('[PatientDetails] No session data available, cannot save review');
      return;
    }

    const apbNumber = this.stateService.apbNumber;
    const medicationReviewId = this.stateService.medicationReviewId;

    const request: any = {
      apbNumber: apbNumber,
      medicationReviewId: medicationReviewId
    };

    // Only include fields that have values
    if (this.firstName) {
      request.firstNameAtTimeOfReview = this.firstName;
    }

    if (this.lastName) {
      request.lastNameAtTimeOfReview = this.lastName;
    }

    // Only save if we have at least one field to update
    if (request.firstNameAtTimeOfReview || request.lastNameAtTimeOfReview) {
      console.log('[PatientDetails] === SAVING MEDICATION REVIEW DATA ===');
      console.log('[PatientDetails] Request payload:', JSON.stringify(request, null, 2));
      
      this.apiService.updateMedicationReview(request).subscribe({
        next: (response) => {
          console.log('[PatientDetails] ‚úì Medication review updated successfully');
          console.log('[PatientDetails] Response:', JSON.stringify(response, null, 2));
          // Update session data with new values
          if (sessionData.review) {
            sessionData.review.firstNameAtTimeOfReview = response.firstNameAtTimeOfReview;
            sessionData.review.lastNameAtTimeOfReview = response.lastNameAtTimeOfReview;
            sessionData.review.reviewDate = response.reviewDate;
            this.stateService.setSessionData(sessionData);
          }
        },
        error: (error) => {
          console.error('[PatientDetails] ‚úó Failed to update medication review');
          console.error('[PatientDetails] Error:', error);
          if (error.status === 404) {
            console.error('[PatientDetails] Medication review not found in database - may not have been created during login');
            // Don't show error to user - this happens when review doesn't exist yet
          } else if (error.status === 400) {
            console.error('[PatientDetails] Bad request - check if all required fields are present');
          } else {
            console.error('[PatientDetails] Unexpected error updating medication review');
          }
        }
      });
    }
  }
}

```
--- END OF FILE: src\app\components\patient-details\patient-details.component.ts ---

--- START OF FILE: src\app\components\posology\posology.component.html ---
```typescript
<div class="posology-container">
  <!-- General note button (top right) -->
  <button class="add-note-button general-note floating-top-right" (click)="openGeneralNotesModal()" title="Add general note">
    +
  </button>

  @if (medications.length === 0) {
    <div class="no-medications">
      <p>No medications with CNK codes found</p>
      <p class="hint">Click on a medication in the left panel to view dosage information</p>
    </div>
  } @else if (!selectedMedicationId) {
    <div class="no-selection">
      <p>Select a medication from the left panel</p>
      <p class="hint">Click on any medication box to view posology information</p>
    </div>
  } @else {
    @if (getSelectedMedicationDosage(); as medDosage) {
      <div class="posology-content">
        <!-- Header with medication name and add note button -->
        <div class="posology-header">
          <div class="header-info">
            <h2>{{ medDosage.medicationName }}</h2>
            <span class="cnk-badge">CNK: {{ medDosage.cnk }}</span>
          </div>
          <button class="add-note-button" (click)="openNotesModal()" title="Add note">
            +
          </button>
        </div>
        
        <!-- Loading state -->
        @if (medDosage.loading) {
          <div class="loading-state">
            <p>{{ 'posology.loading_info' | transloco }}</p>
          </div>
        }

        <!-- Error state -->
        @if (medDosage.error) {
          <div class="error-state">
            <p class="error-message">{{ medDosage.error }}</p>
            <button class="retry-button" (click)="loadDosageInfo(medDosage)">{{ 'posology.retry' | transloco }}</button>
          </div>
        }

        <!-- Dosage information -->
        @if (medDosage.dosageInfo && medDosage.dosageInfo.result) {
          <div class="dosage-content">
            <!-- Dosing Instructions -->
            @if (medDosage.dosageInfo.result.dosage && medDosage.dosageInfo.result.dosage.textBlocks && medDosage.dosageInfo.result.dosage.textBlocks.length > 0) {
              <div class="dosage-section">
                <div class="section-header">
                  <h3>{{ 'medication.dosing_instructions' | transloco }}</h3>
                </div>
                @for (block of medDosage.dosageInfo.result.dosage.textBlocks; track $index) {
                  <div class="dosage-block">
                    <h4 class="block-title">{{ block.title }}</h4>
                    <div class="block-lines">
                      @for (line of block.lines; track $index) {
                        <div class="dosage-line">
                          <span class="line-content">{{ line.content }}</span>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            }

            <!-- Maximum Dosages -->
            @if (medDosage.dosageInfo.result.maximumDosage) {
              <div class="dosage-section">
                <div class="section-header">
                  <h3>{{ 'tools.maximum_dosages' | transloco }}</h3>
                </div>
                
                <!-- Adults -->
                @if (medDosage.dosageInfo.result.maximumDosage.adults && medDosage.dosageInfo.result.maximumDosage.adults.lines && medDosage.dosageInfo.result.maximumDosage.adults.lines.length > 0) {
                  <div class="max-dosage-block">
                    <h4 class="block-title high">{{ medDosage.dosageInfo.result.maximumDosage.adults.title }}</h4>
                    <div class="block-lines">
                      @for (line of medDosage.dosageInfo.result.maximumDosage.adults.lines; track $index) {
                        <div class="dosage-line">
                          <span class="line-content">{{ line }}</span>
                        </div>
                      }
                    </div>
                  </div>
                }
                
                <!-- Children -->
                @if (medDosage.dosageInfo.result.maximumDosage.children && medDosage.dosageInfo.result.maximumDosage.children.lines && medDosage.dosageInfo.result.maximumDosage.children.lines.length > 0) {
                  <div class="max-dosage-block">
                    <h4 class="block-title medium">{{ medDosage.dosageInfo.result.maximumDosage.children.title }}</h4>
                    <div class="block-lines">
                      @for (line of medDosage.dosageInfo.result.maximumDosage.children.lines; track $index) {
                        <div class="dosage-line">
                          <span class="line-content">{{ line }}</span>
                        </div>
                      }
                    </div>
                  </div>
                }
                
                <!-- Remarks -->
                @if (medDosage.dosageInfo.result.maximumDosage.remarks && medDosage.dosageInfo.result.maximumDosage.remarks.lines && medDosage.dosageInfo.result.maximumDosage.remarks.lines.length > 0) {
                  <div class="remarks-block">
                    <h4 class="block-title warning">{{ medDosage.dosageInfo.result.maximumDosage.remarks.title }}</h4>
                    <div class="block-lines">
                      @for (line of medDosage.dosageInfo.result.maximumDosage.remarks.lines; track $index) {
                        <div class="dosage-line warning-line">
                          <span class="warning-icon">‚ö†Ô∏è</span>
                          <span class="line-content">{{ line }}</span>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }
  }
</div>

```
--- END OF FILE: src\app\components\posology\posology.component.html ---

--- START OF FILE: src\app\components\posology\posology.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.posology-container {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  padding: 1.5rem;
  position: relative;

  // Floating general note button in top right
  .floating-top-right {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    z-index: 10;
  }
}

// No Selection / No Medications State
.no-medications,
.no-selection {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4rem 2rem;
  text-align: center;

  p {
    font-family: $primary-font;
    font-size: 1.2rem;
    color: $text-secondary;
    margin: 0 0 0.5rem 0;
    font-weight: $font-weight-medium;
  }

  .hint {
    font-size: 0.95rem;
    color: $text-tertiary;
    font-weight: $font-weight-regular;
    font-style: italic;
  }
}

// Loading and Error States
.loading-state,
.error-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem 2rem;
  background-color: $box-background;
  border-radius: $box-border-radius;
  border: $box-border-width solid $box-border;
  margin-bottom: 1.5rem;

  p {
    font-family: $primary-font;
    font-size: 1.1rem;
    color: $text-secondary;
    margin: 0;
  }

  .error-message {
    color: #dc2626;
    margin-bottom: 1rem;
  }

  .retry-button {
    padding: 0.5rem 1.5rem;
    background-color: $button-primary-background;
    color: $text-button-primary;
    border: none;
    border-radius: $box-border-radius;
    font-family: $primary-font;
    font-size: 0.95rem;
    font-weight: $font-weight-medium;
    cursor: pointer;
    transition: background-color 0.2s;

    &:hover {
      background-color: $button-primary-hover;
    }
  }
}

// Posology Content
.posology-content {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

// Header with medication name and add note button
.posology-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1.5rem;
  background-color: $box-background;
  border-radius: $box-border-radius;
  border: $box-border-width solid $box-border;
  margin-bottom: 1rem;

  .header-info {
    display: flex;
    align-items: center;
    gap: 1rem;

    h2 {
      margin: 0;
      font-family: $primary-font;
      font-size: 1.4rem;
      font-weight: $font-weight-semibold;
      color: $text-primary;
    }

    .cnk-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.375rem 0.875rem;
      background-color: rgba($button-primary-background, 0.1);
      color: $button-primary-background;
      border-radius: 12px;
      font-family: $primary-font;
      font-size: 0.85rem;
      font-weight: $font-weight-semibold;
    }
  }

  // Add note button uses global styling from _add-note-buttons.scss
}

// Dosage Content
.dosage-content {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

// Dosage Sections
.dosage-section {
  background-color: $box-background;
  border-radius: $box-border-radius;
  border: $box-border-width solid $box-border;
  padding: 1.5rem;

  .section-header {
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid $button-primary-background;

    h3 {
      margin: 0;
      font-family: $primary-font;
      font-size: 1.15rem;
      font-weight: $font-weight-semibold;
      color: $text-primary;
    }
  }
}

// Dosage Blocks
.dosage-block,
.max-dosage-block,
.remarks-block {
  margin-bottom: 1.25rem;
  padding: 1.25rem;
  background-color: white;
  border-radius: 8px;
  border: 1px solid $box-border;

  &:last-child {
    margin-bottom: 0;
  }

  .block-title {
    font-family: $primary-font;
    font-size: 1rem;
    font-weight: $font-weight-semibold;
    color: $text-primary;
    margin: 0 0 1rem 0;
    padding: 0.625rem 0.875rem;
    background-color: rgba($button-primary-background, 0.05);
    border-radius: 6px;
    border-left: 3px solid $button-primary-background;

    &.high {
      background-color: rgba(#dc2626, 0.05);
      border-left-color: #dc2626;
      color: #dc2626;
    }

    &.medium {
      background-color: rgba(#ea580c, 0.05);
      border-left-color: #ea580c;
      color: #ea580c;
    }

    &.warning {
      background-color: rgba(#f59e0b, 0.05);
      border-left-color: #f59e0b;
      color: #d97706;
    }
  }

  .block-lines {
    display: flex;
    flex-direction: column;
    gap: 0.625rem;

    .dosage-line {
      display: flex;
      align-items: flex-start;
      padding: 0.75rem;
      background-color: #f8f9fa;
      border-radius: 6px;
      gap: 0.5rem;

      &.warning-line {
        background-color: rgba(#f59e0b, 0.05);
        border-left: 2px solid #f59e0b;
      }

      .warning-icon {
        flex-shrink: 0;
        font-size: 1.1rem;
        line-height: 1.6;
      }

      .line-content {
        font-family: $primary-font;
        font-size: 0.9rem;
        color: $text-secondary;
        line-height: 1.6;
        flex: 1;
        white-space: pre-wrap;
      }
    }
  }
}

// Responsive Design
@media (max-width: 768px) {
  .posology-container {
    padding: 1rem;
  }

  .medication-row {
    grid-template-columns: 2fr 1.5fr 0.5fr;
    
    .cell {
      padding: 0.5rem;
      font-size: 0.8rem;
    }
  }

  .section-header {
    h2 {
      font-size: 1.25rem;
    }
  }
}

```
--- END OF FILE: src\app\components\posology\posology.component.scss ---

--- START OF FILE: src\app\components\posology\posology.component.ts ---
```typescript
import { Component, OnInit, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { Medication } from '../../models/api.models';

interface DosageLine {
  content: string;
  keywords: Array<{
    externalFileName: string;
    description: string;
  }>;
}

interface DosageTextBlock {
  title: string;
  lines: DosageLine[];
}

interface MaximumDosageSection {
  title: string;
  lines: string[];
}

interface ProductDosageResponse {
  cnk: string;
  result?: {
    dosage?: {
      textBlocks?: DosageTextBlock[];
    };
    maximumDosage?: {
      adults?: MaximumDosageSection;
      children?: MaximumDosageSection;
      remarks?: MaximumDosageSection;
    };
  };
}

interface MedicationDosage {
  medicationId: string;
  cnk: string;
  medicationName: string;
  dosageInfo: ProductDosageResponse | null;
  loading: boolean;
  error: string | null;
}

@Component({
  selector: 'app-posology',
  standalone: true,
  imports: [CommonModule, TranslocoModule],
  templateUrl: './posology.component.html',
  styleUrls: ['./posology.component.scss']
})
export class PosologyComponent implements OnInit {
  @Output() openNotes = new EventEmitter<{ medication: Medication, dosageInfo: ProductDosageResponse | null }>();
  
  medications: Medication[] = [];
  medicationDosages: Map<string, MedicationDosage> = new Map();
  selectedMedicationId: string | null = null;
  loading = false;
  error: string | null = null;

  constructor(
    private apiService: ApiService,
    private stateService: StateService
  ) {}

  ngOnInit() {
    this.loadMedications();
  }

  loadMedications() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.loading = true;
    this.error = null;

    this.apiService.getMedications(reviewId).subscribe({
      next: (medications) => {
        this.medications = medications.filter(m => m.cnk); // Only medications with CNK
        
        // Initialize dosage map
        this.medicationDosages.clear();
        this.medications.forEach(med => {
          this.medicationDosages.set(med.medicationId, {
            medicationId: med.medicationId,
            cnk: med.cnk!.toString(),
            medicationName: med.name || `CNK ${med.cnk}`,
            dosageInfo: null,
            loading: false,
            error: null
          });
        });
        
        this.loading = false;
        console.log('[Posology] Loaded medications:', this.medications);
      },
      error: (err) => {
        console.error('[Posology] Error loading medications:', err);
        this.error = 'Failed to load medications';
        this.loading = false;
      }
    });
  }

  onMedicationClick(medicationId: string) {
    console.log('[Posology] Medication clicked:', medicationId);
    
    if (this.selectedMedicationId === medicationId) {
      // Deselect if already selected
      this.selectedMedicationId = null;
      return;
    }
    
    this.selectedMedicationId = medicationId;
    
    // Load dosage info if not already loaded
    const medDosage = this.medicationDosages.get(medicationId);
    if (medDosage && !medDosage.dosageInfo && !medDosage.loading) {
      this.loadDosageInfo(medDosage);
    }
  }

  loadDosageInfo(medDosage: MedicationDosage) {
    medDosage.loading = true;
    medDosage.error = null;

    this.apiService.getProductDosage(medDosage.cnk, 'NL').subscribe({
      next: (response) => {
        medDosage.dosageInfo = response;
        medDosage.loading = false;
        console.log('[Posology] Loaded dosage info for CNK', medDosage.cnk, response);
      },
      error: (err) => {
        console.error('[Posology] Error loading dosage info:', err);
        medDosage.error = 'Failed to load dosage information';
        medDosage.loading = false;
      }
    });
  }

  isMedicationSelected(medicationId: string): boolean {
    return this.selectedMedicationId === medicationId;
  }

  getSelectedMedicationDosage(): MedicationDosage | null {
    if (!this.selectedMedicationId) return null;
    return this.medicationDosages.get(this.selectedMedicationId) || null;
  }

  getSelectedMedication(): Medication | null {
    if (!this.selectedMedicationId) return null;
    return this.medications.find(m => m.medicationId === this.selectedMedicationId) || null;
  }

  openNotesModal() {
    const medication = this.getSelectedMedication();
    const dosageData = this.getSelectedMedicationDosage();
    
    if (!medication) return;
    
    console.log('[Posology] Opening notes for medication:', medication);
    this.openNotes.emit({ 
      medication: medication, 
      dosageInfo: dosageData?.dosageInfo || null
    });
  }

  openGeneralNotesModal() {
    console.log('[Posology] Opening notes for general note (no medication)');
    this.openNotes.emit({ 
      medication: null as any, 
      dosageInfo: null
    });
  }
}

```
--- END OF FILE: src\app\components\posology\posology.component.ts ---

--- START OF FILE: src\app\components\questionnaire\questionnaire.component.html ---
```typescript
<div class="questionnaire-container">
  <!-- Note button (top right) - creates general notes for Step 1 -->
  <button class="add-note-button general-note floating-top-right" (click)="openNotesModal()" title="Add note to Step 1: General Questions">
      <button class="add-note-button general-note floating-top-right" (click)="openNotesModal()" [title]="'anamnesis.part_1' | transloco">
      </button>
  </button>

  @if (!pdfUrl) {
    <!-- Upload/Drop Zone -->
    <div 
      class="upload-zone"
      [class.dragging]="isDragging"
      (dragover)="onDragOver($event)"
      (dragleave)="onDragLeave($event)"
      (drop)="onDrop($event)">
      
      <div class="upload-content">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="12" y1="18" x2="12" y2="12"></line>
          <line x1="9" y1="15" x2="15" y2="15"></line>
        </svg>
        
        @if (isDragging) {
            <h3>{{ 'tools.questionnaire_drop_here' | transloco }}</h3>
        } @else {
            <h3>{{ 'tools.questionnaire_drag_drop' | transloco }}</h3>
          <p>or</p>
          <label class="file-input-label">
            <input 
              type="file" 
              accept="application/pdf"
              (change)="onFileSelected($event)"
              style="display: none;">
              <span class="btn-primary">{{ 'tools.questionnaire_browse' | transloco }}</span>
          </label>
            <p class="file-hint">{{ 'tools.questionnaire_file_hint' | transloco }}</p>
        }
        
        @if (error) {
          <div class="error-message">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
              {{ error }}
          </div>
        }
      </div>
    </div>

    <!-- Info section -->
    <div class="info-section">
      <div class="info-card">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 16v-4M12 8h.01"></path>
        </svg>
        <div>
            <h4>{{ 'tools.questionnaire' | transloco }}</h4>
            <p>{{ 'tools.questionnaire_description' | transloco }}</p>
        </div>
      </div>
    </div>
  } @else {
    <!-- PDF Viewer -->
    <div class="pdf-viewer">
      <div class="pdf-header">
        <div class="pdf-info">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
          <span class="pdf-name">{{ pdfFileName }}</span>
        </div>
        <button class="btn-secondary" (click)="removePdf()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
            {{ 'tools.questionnaire_remove' | transloco }}
        </button>
      </div>
      
      <div class="pdf-frame">
        <iframe 
          [src]="pdfUrl" 
          frameborder="0"
          title="Questionnaire PDF">
        </iframe>
      </div>
    </div>
  }
</div>

```
--- END OF FILE: src\app\components\questionnaire\questionnaire.component.html ---

--- START OF FILE: src\app\components\questionnaire\questionnaire.component.scss ---
```typescript
.questionnaire-container {
  position: relative;
  height: 100%;
  display: flex;
  flex-direction: column;
  padding: 20px;
  background: #f8f9fa;
}

.upload-zone {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 3px dashed #cbd5e0;
  border-radius: 12px;
  background: white;
  transition: all 0.3s ease;
  cursor: pointer;
  min-height: 400px;
  margin-bottom: 20px;

  &.dragging {
    border-color: #2196F3;
    background: #e3f2fd;
    transform: scale(1.02);
  }

  &:hover:not(.dragging) {
    border-color: #a0aec0;
    background: #f7fafc;
  }
}

.upload-content {
  text-align: center;
  padding: 40px;

  svg {
    color: #4a5568;
    margin-bottom: 20px;
  }

  h3 {
    font-size: 24px;
    font-weight: 600;
    color: #2d3748;
    margin: 0 0 12px 0;
  }

  p {
    color: #718096;
    margin: 8px 0;
    font-size: 16px;
  }

  .file-hint {
    font-size: 14px;
    color: #a0aec0;
    margin-top: 16px;
  }
}

.file-input-label {
  display: inline-block;
  margin: 16px 0;

  .btn-primary {
    display: inline-block;
    padding: 12px 24px;
    background: #2196F3;
    color: white;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;

    &:hover {
      background: #1976D2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }
  }
}

.error-message {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: #fff5f5;
  border: 1px solid #fc8181;
  border-radius: 6px;
  color: #c53030;
  margin-top: 16px;
  font-size: 14px;

  svg {
    flex-shrink: 0;
    color: #c53030;
    margin: 0;
  }
}

.info-section {
  margin-top: auto;
}

.info-card {
  display: flex;
  gap: 16px;
  padding: 20px;
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 8px;

  svg {
    flex-shrink: 0;
    color: #2196F3;
  }

  h4 {
    margin: 0 0 8px 0;
    font-size: 16px;
    font-weight: 600;
    color: #2d3748;
  }

  p {
    margin: 0;
    font-size: 14px;
    color: #4a5568;
    line-height: 1.6;

    strong {
      color: #2d3748;
      font-weight: 600;
    }
  }
}

// PDF Viewer Styles
.pdf-viewer {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.pdf-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  background: #f8f9fa;
  border-bottom: 1px solid #e2e8f0;
}

.pdf-info {
  display: flex;
  align-items: center;
  gap: 12px;

  svg {
    color: #e53e3e;
  }

  .pdf-name {
    font-weight: 500;
    color: #2d3748;
    font-size: 14px;
  }
}

.btn-secondary {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: white;
  border: 1px solid #cbd5e0;
  border-radius: 6px;
  color: #4a5568;
  font-weight: 500;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;

  &:hover {
    background: #f7fafc;
    border-color: #a0aec0;
  }

  svg {
    width: 16px;
    height: 16px;
  }
}

.pdf-frame {
  flex: 1;
  position: relative;
  background: #525659;

  iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
}

// Note button styling
.add-note-button {
  position: absolute;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: #2196F3;
  color: white;
  border: none;
  font-size: 24px;
  font-weight: 300;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;

  &.floating-top-right {
    top: 20px;
    right: 20px;
  }

  &:hover {
    background: #1976D2;
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
  }

  &:active {
    transform: scale(0.95);
  }
}

```
--- END OF FILE: src\app\components\questionnaire\questionnaire.component.scss ---

--- START OF FILE: src\app\components\questionnaire\questionnaire.component.ts ---
```typescript
import { Component, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule, TranslocoService } from '@jsverse/transloco';
import { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser';

@Component({
  selector: 'app-questionnaire',
  standalone: true,
  imports: [CommonModule, TranslocoModule],
  templateUrl: './questionnaire.component.html',
  styleUrls: ['./questionnaire.component.scss']
})
export class QuestionnaireComponent {
  @Output() openNotes = new EventEmitter<void>();
  
  pdfUrl: SafeResourceUrl | null = null;
  pdfFileName: string = '';
  isDragging = false;
  error: string | null = null;

  constructor(private sanitizer: DomSanitizer, private transloco: TranslocoService) {}

  onDragOver(event: DragEvent) {
    event.preventDefault();
    event.stopPropagation();
    this.isDragging = true;
  }

  onDragLeave(event: DragEvent) {
    event.preventDefault();
    event.stopPropagation();
    this.isDragging = false;
  }

  onDrop(event: DragEvent) {
    event.preventDefault();
    event.stopPropagation();
    this.isDragging = false;

    const files = event.dataTransfer?.files;
    if (files && files.length > 0) {
      this.handleFile(files[0]);
    }
  }

  onFileSelected(event: Event) {
    const input = event.target as HTMLInputElement;
    if (input.files && input.files.length > 0) {
      this.handleFile(input.files[0]);
    }
  }

  handleFile(file: File) {
    this.error = null;

    // Validate file type
    if (file.type !== 'application/pdf') {
      this.error = this.transloco.translate('tools.questionnaire_invalid_pdf');
      return;
    }

    // Validate file size (max 50MB)
    const maxSize = 50 * 1024 * 1024;
    if (file.size > maxSize) {
      this.error = this.transloco.translate('tools.questionnaire_file_too_large');
      return;
    }

    // Create object URL for the PDF
    const objectUrl = URL.createObjectURL(file);
    this.pdfUrl = this.sanitizer.bypassSecurityTrustResourceUrl(objectUrl);
    this.pdfFileName = file.name;
    
    console.log('[Questionnaire] PDF loaded:', file.name, 'Size:', file.size);
  }

  removePdf() {
    if (this.pdfUrl) {
      // Revoke the object URL to free memory
      const url = (this.pdfUrl as any).changingThisBreaksApplicationSecurity;
      if (url) {
        URL.revokeObjectURL(url);
      }
    }
    this.pdfUrl = null;
    this.pdfFileName = '';
    this.error = null;
  }

  openNotesModal() {
    console.log('[Questionnaire] Opening general notes modal');
    this.openNotes.emit();
  }

  ngOnDestroy() {
    // Clean up object URL when component is destroyed
    this.removePdf();
  }
}

```
--- END OF FILE: src\app\components\questionnaire\questionnaire.component.ts ---

--- START OF FILE: src\app\components\renadaptor\renadaptor.component.html ---
```typescript
<div class="renadaptor-container">
  @if (medications.length === 0) {
    <div class="no-medications">
      <p>No medications with CNK codes found</p>
      <p class="hint">Click on a medication in the left panel to access Renadaptor</p>
    </div>
  } @else if (!selectedMedicationId) {
    <div class="no-selection">
      <p>Select a medication from the left panel</p>
      <p class="hint">Click on any medication box to access Renadaptor for renal dosing information</p>
    </div>
  } @else {
    @if (getSelectedRenadaptorData(); as data) {
      <div class="renadaptor-content">
        <!-- Header with medication name and controls -->
        <div class="renadaptor-header">
          <div class="header-info">
            <h2>{{ data.medicationName }}</h2>
            <span class="cnk-badge">CNK: {{ data.cnk }}</span>
            @if (data.lastGenerated && !isUrlExpired()) {
              <span class="timer-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                  <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                {{ getTimeRemaining() }}
              </span>
            }
            @if (isUrlExpired() && data.lastGenerated) {
              <span class="expired-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                  <line x1="8" y1="8" x2="16" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <line x1="16" y1="8" x2="8" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Expired
              </span>
            }
          </div>
          <div class="header-actions">
            <button 
              class="refresh-button" 
              (click)="refreshUrl()"
              [disabled]="data.loading"
              title="Refresh URL (generates new 5-minute link)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Refresh
            </button>
            <button class="add-note-button" (click)="openNotesModal()" title="Add note" aria-label="Add note">
              +
            </button>
          </div>
        </div>

        <!-- Renal Function Section -->
        <div class="renal-function-section">
          <label for="renalFunctionInput">{{ 'patient.renal_function' | transloco }}</label>
          <div class="renal-function-input-wrapper">
            <input 
              type="text" 
              id="renalFunctionInput"
              [(ngModel)]="renalFunction" 
              (ngModelChange)="onRenalFunctionChange()"
              [placeholder]="'patient.renal_function_placeholder' | transloco">
            <span class="unit-label">mL/min (optional)</span>
          </div>
        </div>

        <!-- Info banner -->
        <div class="info-banner">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M12 16v-4M12 8h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span>Renadaptor provides renal dosing adjustments and guidance for patients with kidney disease. URLs expire after 5 minutes.</span>
        </div>

        <!-- Loading state -->
        @if (data.loading) {
          <div class="loading-state">
            <div class="spinner"></div>
            <p>{{ 'renadaptor.loading' | transloco }}</p>
          </div>
        }

        <!-- Error state -->
        @if (data.error && !data.loading) {
          <div class="error-state">
            <p class="error-message">{{ data.error }}</p>
            <button class="retry-button" (click)="refreshUrl()">{{ 'renadaptor.try_again' | transloco }}</button>
          </div>
        }

        <!-- Renadaptor iframe -->
        @if (data.safeUrl && !data.loading && !data.error) {
          <div class="iframe-container">
            @if (isUrlExpired()) {
              <div class="expired-overlay">
                <div class="expired-message">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <line x1="8" y1="8" x2="16" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="16" y1="8" x2="8" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  <h3>URL Expired</h3>
                  <p>This Renadaptor link has expired. Click refresh to generate a new one.</p>
                  <button class="refresh-large-button" (click)="refreshUrl()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Refresh URL
                  </button>
                </div>
              </div>
            }
            <iframe 
              [src]="data.safeUrl" 
              frameborder="0"
              title="Renadaptor - Renal dosing information">
            </iframe>
          </div>
        }
      </div>
    }
  }
</div>

```
--- END OF FILE: src\app\components\renadaptor\renadaptor.component.html ---

--- START OF FILE: src\app\components\renadaptor\renadaptor.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.renadaptor-container {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  position: relative;

  // Floating general note button in top right
  .floating-top-right {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    z-index: 10;
  }
}

// No Selection / No Medications State
.no-medications,
.no-selection {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4rem 2rem;
  text-align: center;
  height: 100%;

  p {
    font-family: $primary-font;
    font-size: 1.2rem;
    color: $text-secondary;
    margin: 0 0 0.5rem 0;
    font-weight: $font-weight-medium;
  }

  .hint {
    font-size: 0.95rem;
    color: $text-tertiary;
    font-weight: $font-weight-regular;
    font-style: italic;
  }
}

// Renadaptor Content
.renadaptor-content {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}

// Header with medication name and controls
.renadaptor-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1.25rem 1.5rem;
  background-color: $box-background;
  border-bottom: $box-border-width solid $box-border;
  flex-shrink: 0;

  .header-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;

    h2 {
      margin: 0;
      font-family: $primary-font;
      font-size: 1.3rem;
      font-weight: $font-weight-semibold;
      color: $text-primary;
    }

    .cnk-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.375rem 0.875rem;
      background-color: rgba($button-primary-background, 0.1);
      color: $button-primary-background;
      border-radius: 12px;
      font-family: $primary-font;
      font-size: 0.85rem;
      font-weight: $font-weight-semibold;
    }

    .timer-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.875rem;
      background-color: rgba($medication-indication, 0.1);
      color: darken($medication-indication, 25%);
      border-radius: 12px;
      font-family: $primary-font;
      font-size: 0.85rem;
      font-weight: $font-weight-semibold;

      svg {
        flex-shrink: 0;
      }
    }

    .expired-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.875rem;
      background-color: rgba(#dc2626, 0.1);
      color: #dc2626;
      border-radius: 12px;
      font-family: $primary-font;
      font-size: 0.85rem;
      font-weight: $font-weight-semibold;

      svg {
        flex-shrink: 0;
      }
    }
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;

    .refresh-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      border: none;
      border-radius: $box-border-radius;
      font-family: $primary-font;
      font-size: 0.95rem;
      font-weight: $font-weight-medium;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: rgba($button-primary-background, 0.1);
      color: $button-primary-background;

      svg {
        flex-shrink: 0;
      }

      &:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      &:hover:not(:disabled) {
        background-color: rgba($button-primary-background, 0.2);
      }
    }

    // Add note button uses global styling from _add-note-buttons.scss
  }
}

// Info Banner
// Renal Function Section
.renal-function-section {
  padding: 1.25rem 1.5rem;
  background: linear-gradient(135deg, rgba(#10b981, 0.08) 0%, rgba(#059669, 0.04) 100%);
  border-bottom: 2px solid rgba(#10b981, 0.3);
  flex-shrink: 0;

  label {
    display: block;
    font-family: $primary-font;
    font-size: 0.875rem;
    font-weight: $font-weight-semibold;
    color: $text-primary;
    margin-bottom: 0.75rem;
    letter-spacing: 0.3px;
  }

  .renal-function-input-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;

    input[type="text"] {
      flex: 1;
      max-width: 220px;
      padding: 0.75rem 0.875rem;
      font-family: $primary-font;
      font-size: 0.95rem;
      border: 2px solid rgba(#10b981, 0.3);
      border-radius: 8px;
      background-color: white;
      color: $text-primary;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(#10b981, 0.05);

      &:hover {
        border-color: rgba(#10b981, 0.5);
        box-shadow: 0 2px 8px rgba(#10b981, 0.1);
      }

      &:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 4px rgba(#10b981, 0.15), 0 2px 8px rgba(#10b981, 0.1);
        background-color: rgba(#10b981, 0.02);
      }

      &::placeholder {
        color: $text-tertiary;
      }
    }

    .unit-label {
      font-family: $primary-font;
      font-size: 0.8rem;
      color: $text-secondary;
      font-weight: $font-weight-medium;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  }
}

.info-banner {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 1rem 1.5rem;
  background-color: rgba(#3b82f6, 0.05);
  border-bottom: 1px solid rgba(#3b82f6, 0.2);
  flex-shrink: 0;

  svg {
    flex-shrink: 0;
    color: #3b82f6;
    margin-top: 0.125rem;
  }

  span {
    font-family: $primary-font;
    font-size: 0.875rem;
    color: #1e40af;
    line-height: 1.5;
  }
}

// Loading State
.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4rem 2rem;
  flex: 1;

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid rgba($button-primary-background, 0.1);
    border-top-color: $button-primary-background;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 1rem;
  }

  p {
    font-family: $primary-font;
    font-size: 1.1rem;
    color: $text-secondary;
    margin: 0;
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

// Error State
.error-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem 2rem;
  flex: 1;

  .error-message {
    font-family: $primary-font;
    font-size: 1.1rem;
    color: #dc2626;
    margin: 0 0 1.5rem 0;
    text-align: center;
  }

  .retry-button {
    padding: 0.625rem 1.5rem;
    background-color: $button-primary-background;
    color: white;
    border: none;
    border-radius: $box-border-radius;
    font-family: $primary-font;
    font-size: 0.95rem;
    font-weight: $font-weight-medium;
    cursor: pointer;
    transition: all 0.2s;

    &:hover {
      background-color: darken($button-primary-background, 8%);
      transform: translateY(-1px);
    }
  }
}

// Iframe Container
.iframe-container {
  flex: 1;
  position: relative;
  overflow: hidden;
  background-color: white;

  iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  .expired-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;

    .expired-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 3rem;
      background-color: white;
      border-radius: $box-border-radius;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      text-align: center;

      svg {
        color: #dc2626;
      }

      h3 {
        margin: 0;
        font-family: $primary-font;
        font-size: 1.5rem;
        font-weight: $font-weight-semibold;
        color: $text-primary;
      }

      p {
        margin: 0;
        font-family: $primary-font;
        font-size: 1rem;
        color: $text-secondary;
        line-height: 1.6;
      }

      .refresh-large-button {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        padding: 0.875rem 1.75rem;
        background-color: $button-primary-background;
        color: white;
        border: none;
        border-radius: $box-border-radius;
        font-family: $primary-font;
        font-size: 1rem;
        font-weight: $font-weight-semibold;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 0.5rem;

        &:hover {
          background-color: darken($button-primary-background, 8%);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba($button-primary-background, 0.3);
        }

        svg {
          flex-shrink: 0;
        }
      }
    }
  }
}

// Responsive Design
@media (max-width: 768px) {
  .renadaptor-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;

    .header-actions {
      width: 100%;
      justify-content: stretch;

      button {
        flex: 1;
      }
    }
  }

  .info-banner {
    font-size: 0.8rem;
  }
}

```
--- END OF FILE: src\app\components\renadaptor\renadaptor.component.scss ---

--- START OF FILE: src\app\components\renadaptor\renadaptor.component.ts ---
```typescript
import { Component, OnInit, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { TranslocoModule } from '@jsverse/transloco';
import { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { Medication } from '../../models/api.models';

interface RenadaptorData {
  medicationId: string;
  cnk: string;
  medicationName: string;
  url: string | null;
  safeUrl: SafeResourceUrl | null;
  loading: boolean;
  error: string | null;
  lastGenerated: Date | null;
}

@Component({
  selector: 'app-renadaptor',
  standalone: true,
  imports: [CommonModule, FormsModule, TranslocoModule],
  templateUrl: './renadaptor.component.html',
  styleUrls: ['./renadaptor.component.scss']
})
export class RenadaptorComponent implements OnInit {
  @Output() openNotes = new EventEmitter<Medication>();
  
  medications: Medication[] = [];
  renadaptorData: Map<string, RenadaptorData> = new Map();
  selectedMedicationId: string | null = null;
  // Renal function stored as a textual summary per backend API
  renalFunction: string | null = null;
  loading = false;
  error: string | null = null;

  // URL expires after 5 minutes
  private readonly URL_EXPIRY_MS = 5 * 60 * 1000;

  constructor(
    private apiService: ApiService,
    private stateService: StateService,
    private sanitizer: DomSanitizer
  ) {}

  ngOnInit() {
    this.loadRenalFunction();
    this.loadMedications();
  }

  loadMedications() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.loading = true;
    this.error = null;

    this.apiService.getMedications(reviewId).subscribe({
      next: (medications) => {
        this.medications = medications.filter(m => m.cnk); // Only medications with CNK
        
        // Initialize renadaptor data map
        this.renadaptorData.clear();
        this.medications.forEach(med => {
          this.renadaptorData.set(med.medicationId, {
            medicationId: med.medicationId,
            cnk: med.cnk!.toString(),
            medicationName: med.name || `CNK ${med.cnk}`,
            url: null,
            safeUrl: null,
            loading: false,
            error: null,
            lastGenerated: null
          });
        });
        
        this.loading = false;
        console.log('[Renadaptor] Loaded medications:', this.medications);
      },
      error: (err) => {
        console.error('[Renadaptor] Error loading medications:', err);
        this.error = 'Failed to load medications';
        this.loading = false;
      }
    });
  }

  onMedicationClick(medicationId: string) {
    console.log('[Renadaptor] Medication clicked:', medicationId);
    
    if (this.selectedMedicationId === medicationId) {
      // Deselect if already selected
      this.selectedMedicationId = null;
      return;
    }
    
    this.selectedMedicationId = medicationId;
    
    // Load or refresh Renadaptor URL
    const data = this.renadaptorData.get(medicationId);
    if (data) {
      // Check if URL exists and is still valid (less than 5 minutes old)
      const needsRefresh = !data.url || 
                          !data.lastGenerated || 
                          (Date.now() - data.lastGenerated.getTime() > this.URL_EXPIRY_MS);
      
      if (needsRefresh) {
        this.loadRenadaptorUrl(data);
      }
    }
  }

  loadRenadaptorUrl(data: RenadaptorData) {
    data.loading = true;
    data.error = null;

    this.apiService.getProductRenadaptor(data.cnk, 'NL').subscribe({
      next: (response) => {
        data.url = response.url;
        data.safeUrl = this.sanitizer.bypassSecurityTrustResourceUrl(response.url);
        data.lastGenerated = new Date();
        data.loading = false;
        console.log('[Renadaptor] Loaded URL for CNK', data.cnk);
      },
      error: (err) => {
        console.error('[Renadaptor] Error loading URL:', err);
        data.error = 'Failed to load Renadaptor. Please try again.';
        data.loading = false;
      }
    });
  }

  refreshUrl() {
    const data = this.getSelectedRenadaptorData();
    if (data) {
      console.log('[Renadaptor] Refreshing URL');
      this.loadRenadaptorUrl(data);
    }
  }

  isMedicationSelected(medicationId: string): boolean {
    return this.selectedMedicationId === medicationId;
  }

  getSelectedRenadaptorData(): RenadaptorData | null {
    if (!this.selectedMedicationId) return null;
    return this.renadaptorData.get(this.selectedMedicationId) || null;
  }

  getSelectedMedication(): Medication | null {
    if (!this.selectedMedicationId) return null;
    return this.medications.find(m => m.medicationId === this.selectedMedicationId) || null;
  }

  openNotesModal() {
    const medication = this.getSelectedMedication();
    
    // If a medication is selected, attach note to it. Otherwise, treat as general note.
    if (medication) {
      console.log('[Renadaptor] Opening notes for medication:', medication);
      this.openNotes.emit(medication);
    } else {
      console.log('[Renadaptor] Opening notes for general note (no medication selected)');
      this.openNotes.emit(null as any);
    }
  }

  getTimeRemaining(): string {
    const data = this.getSelectedRenadaptorData();
    if (!data || !data.lastGenerated) return '';

    const elapsed = Date.now() - data.lastGenerated.getTime();
    const remaining = this.URL_EXPIRY_MS - elapsed;

    if (remaining <= 0) return 'Expired';

    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }

  isUrlExpired(): boolean {
    const data = this.getSelectedRenadaptorData();
    if (!data || !data.lastGenerated) return true;

    const elapsed = Date.now() - data.lastGenerated.getTime();
    return elapsed > this.URL_EXPIRY_MS;
  }

  loadRenalFunction() {
    const sessionData = this.stateService.getSessionData();
    if (!sessionData) return;

    let rf: any = undefined;
    if (sessionData.patient && sessionData.patient.renalFunction !== undefined) {
      rf = sessionData.patient.renalFunction;
      console.log('[Renadaptor] Found renalFunction under sessionData.patient');
    } else if ((sessionData as any).renalFunction !== undefined) {
      rf = (sessionData as any).renalFunction;
      console.log('[Renadaptor] Found renalFunction at top-level sessionData');
    }

    if (rf !== null && rf !== undefined) {
      this.renalFunction = rf === null ? null : String(rf);
      console.log('[Renadaptor] Loaded renal function:', this.renalFunction);
    }
  }

  onRenalFunctionChange() {
    console.log('[Renadaptor] Renal function changed to:', this.renalFunction);
    this.saveRenalFunction();
  }

  private saveRenalFunction() {
    const sessionData = this.stateService.getSessionData();
    if (!sessionData) {
      console.warn('[Renadaptor] No session data available, cannot save renal function');
      return;
    }

    const apbNumber = this.stateService.apbNumber;
    const patientId = this.stateService.patientId;

    const request: any = {
      apbNumber: apbNumber,
      patientId: patientId,
      renalFunction: this.renalFunction
    };

    console.log('[Renadaptor] Saving renal function:', this.renalFunction);
    this.apiService.updatePatient(request).subscribe({
      next: (response) => {
        console.log('[Renadaptor] Renal function updated successfully');
        // Update session data
        if (sessionData.patient) {
          sessionData.patient.renalFunction = response.renalFunction ?? null;
          // Also set top-level renalFunction for compatibility
          (sessionData as any).renalFunction = response.renalFunction ?? null;
          this.stateService.setSessionData(sessionData);
        }
      },
      error: (error) => {
        console.error('[Renadaptor] Failed to update renal function:', error);
      }
    });
  }
}

```
--- END OF FILE: src\app\components\renadaptor\renadaptor.component.ts ---

--- START OF FILE: src\app\components\start-stop\start-stop.component.html ---
```typescript
<div class="start-stop-container">
  <!-- General note button moved into header actions -->

  <div class="document-header">
    <div class="header-left">
      <h2>{{ 'tools.start_stop' | transloco }}</h2>
      <p class="description">{{ 'tools.start_stop_description' | transloco }}</p>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" (click)="openInNewTab()" [title]="'tools.open_in_new_tab' | transloco">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
          <polyline points="15 3 21 3 21 9"></polyline>
          <line x1="10" y1="14" x2="21" y2="3"></line>
        </svg>
        {{ 'tools.open_in_new_tab' | transloco }}
      </button>
      <button class="add-note-button general-note" (click)="onAddGeneralNote()" title="Add general note" aria-label="Add general note">
        +
      </button>
    </div>
  </div>

  <div class="info-banner">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12.01" y2="8"></line>
    </svg>
    <span>{{ 'tools.start_stop_help' | transloco }}</span>
  </div>

  @if (isLoading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>{{ 'common.loading' | transloco }}</p>
    </div>
  }

  @if (error) {
    <div class="error-state">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <p class="error-message">{{ error }}</p>
      <button class="btn-primary" (click)="openInNewTab()">{{ 'tools.open_in_new_tab' | transloco }}</button>
    </div>
  }

  <div class="iframe-container" [class.loading]="isLoading">
    @if (documentUrl) {
      <iframe
        [src]="documentUrl"
        (load)="onIframeLoad()"
        (error)="onIframeError()"
        frameborder="0"
        title="START-STOP Criteria Document">
      </iframe>
    }
  </div>
</div>

```
--- END OF FILE: src\app\components\start-stop\start-stop.component.html ---

--- START OF FILE: src\app\components\start-stop\start-stop.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.start-stop-container {
  height: 100%;
  display: flex;
  flex-direction: column;
  background-color: $main-background;
  overflow: hidden;
  position: relative;

  // Floating general note button in top right (below header to avoid overlap)
  .floating-top-right {
    position: absolute;
    top: 5.5rem;
    right: 1.5rem;
    z-index: 10;
  }

  .document-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid $box-border;
    background-color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-shrink: 0;

    .header-left {
      flex: 1;

      h2 {
        margin: 0 0 0.125rem 0;
        font-family: $primary-font;
        font-weight: $font-weight-semibold;
        font-size: 1.125rem;
        color: $text-primary;
      }

      .description {
        margin: 0;
        font-family: $primary-font;
        font-size: 0.8125rem;
        color: $text-secondary;
      }
    }

    .header-actions {
      display: flex;
      gap: 0.75rem;
      flex-shrink: 0;

      button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.875rem;
        border: none;
        border-radius: 6px;
        font-family: $primary-font;
        font-size: 0.8125rem;
        font-weight: $font-weight-medium;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;

        svg {
          flex-shrink: 0;
        }

        // Add note button uses global styling from _add-note-buttons.scss

        &.btn-secondary {
          background-color: transparent;
          color: $button-primary-background;
          border: 1px solid $button-primary-background;

          &:hover {
            background-color: rgba($button-primary-background, 0.1);
          }
        }
      }
    }
  }

  .info-banner {
    padding: 0.625rem 1.5rem;
    background-color: rgba(76, 175, 80, 0.06);
    border-bottom: 1px solid rgba(76, 175, 80, 0.15);
    display: flex;
    align-items: center;
    gap: 0.625rem;
    flex-shrink: 0;

    svg {
      flex-shrink: 0;
      color: #4CAF50;
      width: 18px;
      height: 18px;
    }

    span {
      font-family: $primary-font;
      font-size: 0.8125rem;
      color: $text-primary;
      line-height: 1.4;
    }
  }

  .loading-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    color: $text-secondary;

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid $box-border;
      border-top-color: #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    p {
      margin: 0;
      font-family: $primary-font;
      font-size: 0.875rem;
      color: $text-secondary;
    }
  }

  .error-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 2rem;
    text-align: center;

    svg {
      color: #dc3545;
      opacity: 0.5;
    }

    .error-message {
      margin: 0;
      font-family: $primary-font;
      font-size: 1rem;
      color: $text-primary;
    }

    .btn-primary {
      margin-top: 1rem;
    }
  }

  .iframe-container {
    flex: 1;
    position: relative;
    overflow: hidden;
    background-color: white;
    min-height: 0; // Important for flex child to shrink

    iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

```
--- END OF FILE: src\app\components\start-stop\start-stop.component.scss ---

--- START OF FILE: src\app\components\start-stop\start-stop.component.ts ---
```typescript
import { Component, Output, EventEmitter, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule } from '@jsverse/transloco';
import { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser';
import { ApiService } from '../../services/api.service';

@Component({
  selector: 'app-start-stop',
  standalone: true,
  imports: [CommonModule, TranslocoModule],
  templateUrl: './start-stop.component.html',
  styleUrls: ['./start-stop.component.scss']
})
export class StartStopComponent implements OnInit, OnDestroy {
  @Output() openNotes = new EventEmitter<void>();

  documentUrl: SafeResourceUrl | null = null;
  isLoading = true;
  error: string | null = null;
  private blobUrl: string | null = null;

  constructor(
    private apiService: ApiService,
    private sanitizer: DomSanitizer
  ) {}

  ngOnInit() {
    this.loadDocument();
  }

  loadDocument() {
    this.isLoading = true;
    this.error = null;

    this.apiService.getReferenceDocument('start-stop').subscribe({
      next: (blob) => {
        console.log('[StartStopComponent] Received blob:', blob.size, 'bytes, type:', blob.type);
        
        // Verify blob is a PDF
        if (!blob.type.includes('pdf')) {
          console.warn('[StartStopComponent] Received non-PDF blob:', blob.type);
        }
        
        // Create object URL from blob
        this.blobUrl = URL.createObjectURL(blob);
        console.log('[StartStopComponent] Created blob URL:', this.blobUrl);
        
        // Trust the URL for iframe usage
        this.documentUrl = this.sanitizer.bypassSecurityTrustResourceUrl(this.blobUrl);
        console.log('[StartStopComponent] Document URL ready for iframe');
      },
      error: (err) => {
        console.error('[StartStopComponent] Failed to download document:', err);
        console.error('[StartStopComponent] Error details:', {
          status: err.status,
          statusText: err.statusText,
          message: err.message,
          url: err.url
        });
        this.error = 'Failed to load START-STOP document. Click "Open in New Tab" to try in a separate window.';
        this.isLoading = false;
      }
    });
  }

  ngOnDestroy() {
    if (this.blobUrl) {
      console.log('[StartStopComponent] Cleaning up blob URL');
      URL.revokeObjectURL(this.blobUrl);
    }
  }

  onIframeLoad() {
    console.log('[StartStopComponent] Iframe loaded successfully');
    this.isLoading = false;
  }

  onIframeError() {
    console.error('[StartStopComponent] Iframe failed to load');
    this.error = 'Failed to display PDF in iframe. Click "Open in New Tab" to view.';
    this.isLoading = false;
  }

  onAddGeneralNote() {
    this.openNotes.emit();
  }

  openInNewTab() {
    const url = this.apiService.getReferenceDocumentUrl('start-stop');
    window.open(url, '_blank', 'noopener,noreferrer');
  }
}
```
--- END OF FILE: src\app\components\start-stop\start-stop.component.ts ---

--- START OF FILE: src\app\components\therapy-adherence\therapy-adherence.component.html ---
```typescript
<div class="therapy-adherence-container">
  @if (loading) {
    <div class="loading-state">
      <p>{{ 'therapy_adherence.loading_history' | transloco }}</p>
    </div>
  } @else if (!uploadSuccess) {
    <div class="upload-prompt">
      <p class="prompt-text">{{ 'therapy_adherence.upload_dispensing_history' | transloco }}</p>
      
      <input 
        type="file" 
        id="file-input"
        accept=".csv" 
        (change)="onFileSelected($event)"
        style="display: none;"
      />
      
      <div class="button-group">
        <button 
          class="upload-button-prompt" 
          (click)="triggerFileInput()"
          [disabled]="uploading"
        >
          @if (uploading) {
            <span>{{ 'therapy_adherence.uploading' | transloco }}</span>
          } @else {
            <span>{{ 'therapy_adherence.choose_csv' | transloco }}</span>
          }
        </button>
        
        <button 
          class="manual-dispensing-button-prompt" 
          (click)="openManualDispensingModal()"
          [disabled]="uploading"
        >
          <span>{{ 'therapy_adherence.add_manual_moments' | transloco }}</span>
        </button>
      </div>
      
      @if (uploadError) {
        <p class="error-message">{{ uploadError }}</p>
      }
      
      @if (queryError) {
        <div class="error-message">
          <p>{{ queryError }}</p>
          <button class="retry-button" (click)="retryLoadFile()">{{ 'therapy_adherence.retry' | transloco }}</button>
        </div>
      }
    </div>
  } @else {
    <div class="graphs-container">
      <input 
        type="file" 
        id="file-input"
        accept=".csv" 
        (change)="onFileSelected($event)"
        style="display: none;"
      />

      <div class="therapy-view">
        <!-- General note button (top right) -->
        <button class="add-note-button general-note floating-top-right" (click)="openNotesModal()" title="Add general note">
          +
        </button>
        
        <!-- Date filter controls -->
        <div class="date-controls">
          <div class="date-filter-group">
            <label for="filter-start">From:</label>
            <input 
              type="date" 
              id="filter-start" 
              [(ngModel)]="filterStartDate"
              (change)="onDateFilterChange()"
              class="date-input"
            />
            
            <label for="filter-end">Until:</label>
            <input 
              type="date" 
              id="filter-end" 
              [(ngModel)]="filterEndDate"
              (change)="onDateFilterChange()"
              class="date-input"
            />
            
            <button class="control-button reset-button" (click)="resetDateFilter()" title="Reset filters">
              <span>Reset</span>
            </button>
            
            <!-- Pan slider (only visible when zoomed in) -->
            @if (isPanEnabled()) {
              <div class="pan-control-inline">
                <label for="pan-slider">Pan:</label>
                <input 
                  type="range" 
                  id="pan-slider" 
                  min="0" 
                  max="100" 
                  step="1"
                  [value]="panPosition"
                  (input)="onPanChange($event)"
                  class="pan-slider"
                />
              </div>
            }
          </div>
          
          <div class="zoom-controls">
            <button class="control-button zoom-button" (click)="zoomOut()" [disabled]="zoomLevel >= 1" title="Zoom out">
              <span>‚àí</span>
            </button>
            <span class="zoom-label">Zoom: {{ (zoomLevel * 100).toFixed(0) }}%</span>
            <button class="control-button zoom-button" (click)="zoomIn()" [disabled]="zoomLevel <= 0.1" title="Zoom in">
              <span>+</span>
            </button>
          </div>
        </div>

        <!-- Header showing timeline (like medication schema header) -->

        <!-- Graph rows (aligned with medication boxes on left) -->
        <div class="graph-rows">
          @for (item of medicationsWithData; track item.medication.medicationId) {
            @if (item.medication.asNeeded) {
              <div class="graph-row-wrapper">
                <div class="graph-wrapper">
                  <div class="no-data-compact">
                    <span>Zo nodig medicatie</span>
                  </div>
                </div>
                <button class="add-note-button" (click)="openNotesModal(item.medication)" title="Add note">
                  +
                </button>
              </div>
            } @else if (item.dispensingData) {
              <div class="graph-row-wrapper">
                <div class="graph-wrapper">
                  <div class="graph-container">
                    <canvas [id]="item.chartId"></canvas>
                  </div>
                </div>
                <button class="add-note-button" (click)="openNotesModal(item.medication)" title="Add note">
                  +
                </button>
              </div>
            } @else {
              <div class="graph-row-wrapper">
                <div class="graph-wrapper">
                  <div class="no-data-compact">
                    <span>No dispensing data</span>
                  </div>
                </div>
                <button class="add-note-button" (click)="openNotesModal(item.medication)" title="Add note">
                  +
                </button>
              </div>
            }
          }
          
          @if (medicationsWithData.length === 0) {
            <div class="no-medications">
              <p>No medications in the medication review</p>
            </div>
          }
        </div>
        
        <!-- Action buttons -->
        <div class="upload-footer">
          <button 
            class="upload-button secondary" 
            (click)="triggerFileInput()"
            [disabled]="uploading"
          >
            {{ 'therapy_adherence.upload_new_file' | transloco }}
          </button>
          
          <button 
            class="manual-dispensing-button" 
            (click)="openManualDispensingModal()"
            [disabled]="uploading"
          >
            {{ 'therapy_adherence.add_manual_moments' | transloco }}
          </button>
          
          <button 
            class="manage-moments-button" 
            (click)="openManageMomentsModal()"
            [disabled]="uploading"
          >
            {{ 'therapy_adherence.view_all_moments' | transloco }}
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Manual Dispensing Modal -->
  @if (showManualDispensingModal) {
    <app-manual-dispensing-modal
      (close)="closeManualDispensingModal()"
      (momentsAdded)="onManualMomentsAdded()"
    />
  }
  
  <!-- Manage Moments Modal -->
  @if (showManageMomentsModal) {
    <app-manage-moments-modal
      (close)="closeManageMomentsModal()"
      (momentsDeleted)="onMomentsDeleted()"
    />
  }
</div>


```
--- END OF FILE: src\app\components\therapy-adherence\therapy-adherence.component.html ---

--- START OF FILE: src\app\components\therapy-adherence\therapy-adherence.component.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.therapy-adherence-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow-y: visible; // Let parent handle scrolling
  overflow-x: visible; // Ensure controls are not clipped horizontally
  margin-top: 0; // Remove top margin to align controls
}

.loading-state {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  
  p {
    font-family: $primary-font;
    font-size: 1.125rem;
    color: $text-secondary;
  }
}

.upload-prompt {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1.5rem;
  max-width: 500px;
  width: 100%;
  margin: auto;
}

.button-group {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  width: 100%;
  align-items: center;
}

.upload-button-prompt,
.manual-dispensing-button-prompt {
  padding: 0.75rem 2rem;
  width: 100%;
  max-width: 300px;
  background-color: $button-primary-background;
  color: white;
  border: none;
  border-radius: $box-border-radius;
  font-family: $primary-font;
  font-weight: $font-weight-semibold;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  
  span {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  &:hover:not(:disabled) {
    background-color: darken($button-primary-background, 5%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  &:active:not(:disabled) {
    transform: translateY(1px);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  &:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
}

.error-message {
  font-family: $primary-font;
  font-size: 0.875rem;
  color: #dc3545;
  text-align: center;
  margin: 0;
}

.graphs-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: visible; // Ensure controls are not clipped
}

.therapy-view {
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: visible; // Ensure controls above are not clipped
  margin-top: 2rem; // Add top margin to replace removed graphs-header spacing

  // Floating general note button in top right
  .floating-top-right {
    position: absolute;
    top: 0.5rem;
    right: 2rem;
    z-index: 10;
  }
}

.upload-footer {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem 2rem;
  margin: 0 2rem;
}

.upload-button.secondary,
.manual-dispensing-button,
.manage-moments-button {
  padding: 0.5rem 1rem;
  background-color: $button-primary-background;
  color: white;
  border: none;
  border-radius: $box-border-radius;
  font-family: $primary-font;
  font-weight: $font-weight-semibold;
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

  &:hover:not(:disabled) {
    background-color: darken($button-primary-background, 5%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  &:active:not(:disabled) {
    transform: translateY(1px);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  &:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
}

.date-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 2rem;
  background-color: #f8f9fa;
  border: 1px solid $box-border-primary;
  border-radius: $box-border-radius-small;
  margin: 0 5rem 0.25rem 2rem;
  gap: 1rem;
  position: relative;
  top: 0rem; // Move controls above the graph area
}

.date-filter-group {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  
  label {
    font-family: $primary-font;
    font-size: 0.875rem;
    color: $text-primary;
    font-weight: $font-weight-medium;
  }
}

.date-input {
  padding: 0.375rem 0.5rem;
  border: 1px solid $box-border-primary;
  border-radius: $box-border-radius-small;
  font-family: $primary-font;
  font-size: 0.875rem;
  color: $text-primary;
  
  &:focus {
    outline: none;
    border-color: $button-primary-background;
  }
}

.zoom-controls {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.zoom-label {
  font-family: $primary-font;
  font-size: 0.875rem;
  color: $text-secondary;
  min-width: 70px;
  text-align: center;
}

.control-button {
  padding: 0.375rem 0.75rem;
  border: 1px solid $box-border-primary;
  border-radius: $box-border-radius-small;
  background-color: white;
  font-family: $primary-font;
  font-size: 0.875rem;
  font-weight: $font-weight-medium;
  cursor: pointer;
  transition: all 0.2s ease;
  
  &:hover:not(:disabled) {
    background-color: #e9ecef;
    border-color: darken($box-border-primary, 10%);
  }
  
  &:active:not(:disabled) {
    background-color: #dee2e6;
  }
  
  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
}

.zoom-button {
  width: 32px;
  height: 32px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  font-weight: bold;
  
  span {
    line-height: 1;
  }
}

.reset-button {
  color: #dc3545;
  
  &:hover:not(:disabled) {
    background-color: #fff5f5;
    border-color: #dc3545;
  }
}

.pan-control-inline {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-left: 1rem;
  padding-left: 1rem;
  border-left: 1px solid $box-border-primary;
  
  label {
    font-family: $primary-font;
    font-size: 0.875rem;
    color: $text-primary;
    font-weight: $font-weight-medium;
    white-space: nowrap;
  }
}

.pan-slider {
  width: 150px;
  height: 4px;
  border-radius: 2px;
  background: linear-gradient(to right, #dee2e6 0%, $button-primary-background 100%);
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  
  &::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: $button-primary-background;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    
    &:hover {
      background: darken($button-primary-background, 5%);
    }
  }
  
  &::-moz-range-thumb {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: $button-primary-background;
    cursor: pointer;
    border: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    
    &:hover {
      background: darken($button-primary-background, 5%);
    }
  }
}

.graph-rows {
  display: flex;
  flex-direction: column;
  margin-top: 0.95rem;
  overflow: visible; // Allow tooltips to render outside
}

.graph-row-wrapper {
  display: flex;
  align-items: center;
  position: relative;
  gap: 1rem;
  margin-bottom: 1rem; // Match medication item margin-bottom
  overflow: visible; // Allow tooltip to render outside
}

.graph-wrapper {
  height: 4.5rem; // Match medication box height
  margin-left: 2rem;
  flex: 1;
  overflow: visible; // Allow tooltip to render outside
}

// Add note button uses global styling from _add-note-buttons.scss
// Custom positioning for this component
.graph-row-wrapper {
  .add-note-button {
    margin-right: 2rem;
  }
}

.graph-container {
  width: 100%;
  height: 100%;
  background-color: $box-background;
  border: 1px solid $box-border-primary;
  border-radius: $box-border-radius;
  padding: 0.5rem;
  position: relative;
  overflow: visible; // Allow tooltip to render outside box
  
  canvas {
    width: 100% !important;
    height: 100% !important;
  }
}

.no-data-compact {
  width: 100%;
  height: 100%;
  background-color: #f8f9fa;
  border: 1px solid $box-border-primary;
  border-radius: $box-border-radius;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  
  span {
    font-family: $primary-font;
    font-size: 0.875rem;
    color: $text-secondary;
    font-style: italic;
  }
}

.no-medications {
  padding: 3rem;
  text-align: center;
  
  p {
    font-family: $primary-font;
    font-size: 1.125rem;
    color: $text-secondary;
    margin: 0;
  }
}

```
--- END OF FILE: src\app\components\therapy-adherence\therapy-adherence.component.scss ---

--- START OF FILE: src\app\components\therapy-adherence\therapy-adherence.component.ts ---
```typescript
import { Component, OnInit, AfterViewInit, OnDestroy, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { TranslocoModule } from '@jsverse/transloco';
import { Chart, ChartConfiguration, registerables } from 'chart.js';
import 'chartjs-adapter-date-fns';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { DispensingHistoryResponse, CnkDispensingData, Medication as ApiMedication } from '../../models/api.models';
import { ManualDispensingModalComponent } from '../manual-dispensing-modal/manual-dispensing-modal.component';
import { ManageMomentsModalComponent } from '../manage-moments-modal/manage-moments-modal.component';

// Register Chart.js components
Chart.register(...registerables);

interface MedicationWithDispensingData {
  medication: ApiMedication;
  dispensingData: CnkDispensingData | null;
  chartId: string;
}

interface StockDataPoint {
  x: Date;
  y: number;
  status: 'sufficient' | 'depleted' | 'oversupply';
}

interface DispensingMomentWithUnits {
  date: Date;
  amount: number;          // Number of packages
  unitsPerPackage: number; // Units in one package
  totalUnits: number;      // amount √ó unitsPerPackage
  dateString: string;
  source?: 'csv' | 'manual'; // Source of dispensing moment
}

@Component({
  selector: 'app-therapy-adherence',
  standalone: true,
  imports: [CommonModule, FormsModule, TranslocoModule, ManualDispensingModalComponent, ManageMomentsModalComponent],
  templateUrl: './therapy-adherence.component.html',
  styleUrls: ['./therapy-adherence.component.scss']
})
export class TherapyAdherenceComponent implements OnInit, AfterViewInit, OnDestroy {
  @Output() openNotes = new EventEmitter<ApiMedication>();
  
  selectedFile: File | null = null;
  uploading = false;
  uploadSuccess = false;
  uploadError: string | null = null;
  showManualDispensingModal = false;
  showManageMomentsModal = false;
  
  dispensingHistory: DispensingHistoryResponse | null = null;
  medications: ApiMedication[] = [];
  medicationsWithData: MedicationWithDispensingData[] = [];
  
  loading = false;
  queryError: string | null = null;
  
  dateRange: { earliest: Date | null, latest: Date | null } = { earliest: null, latest: null };
  fullDateRange: { earliest: Date | null, latest: Date | null } = { earliest: null, latest: null }; // Store the full unfiltered range
  maxStockValue: number = 0; // Maximum stock value across all medications for y-axis scaling
  
  // Filtering and zoom controls
  filterStartDate: string = ''; // ISO date string for input
  filterEndDate: string = ''; // ISO date string for input
  zoomLevel: number = 1; // 1 = full range, values < 1 = zoomed in
  panPosition: number = 0; // 0 to 100, percentage of how far panned
  
  private charts: Map<string, Chart> = new Map();

  constructor(
    private apiService: ApiService,
    private stateService: StateService
  ) {}

  ngOnInit() {
    console.log('[TherapyAdherence] ngOnInit - Component initialized');
    this.refreshData();
  }

  ngAfterViewInit() {
    // Charts will be created after data is loaded
    console.log('[TherapyAdherence] ngAfterViewInit - View initialized');
  }

  ngOnDestroy() {
    console.log('[TherapyAdherence] ngOnDestroy - Cleaning up charts');
    // Clean up all charts
    this.charts.forEach(chart => chart.destroy());
    this.charts.clear();
  }

  // Public method to refresh all data and charts
  refreshData() {
    console.log('[TherapyAdherence] refreshData - Refreshing medications and dispensing data');
    this.loadMedications();
    this.checkExistingFile();
  }

  loadMedications() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.apiService.getMedications(reviewId).subscribe({
      next: (medications) => {
        this.medications = medications;
        console.log('Loaded medications:', this.medications);
        
        // If we already have dispensing data, match it
        if (this.dispensingHistory) {
          this.matchDispensingData();
        }
      },
      error: (err) => {
        console.error('Error loading medications:', err);
      }
    });
  }

  checkExistingFile() {
    const apbNumber = this.stateService.apbNumber;
    const reviewId = this.stateService.medicationReviewId;

    if (!apbNumber || !reviewId) return;

    this.loading = true;
    this.uploadError = null;
    this.queryError = null;
    
    this.apiService.queryDispensingHistory(apbNumber, reviewId).subscribe({
      next: (response) => {
        console.log('[TherapyAdherence] === DISPENSING HISTORY FOUND ===');
        console.log('[TherapyAdherence] Full response:', JSON.stringify(response, null, 2));
        console.log('[TherapyAdherence] Has dispensingData?', 'dispensingData' in response);
        console.log('[TherapyAdherence] Response keys:', Object.keys(response));
        
        this.dispensingHistory = response;
        this.uploadSuccess = true;
        this.loading = false;
        
        // Check if we have the new format with dispensingData
        if (response.dispensingData && Array.isArray(response.dispensingData)) {
          console.log('[TherapyAdherence] Dispensing data array length:', response.dispensingData.length);
          // Match with medications
          this.matchDispensingData();
        } else {
          console.error('[TherapyAdherence] Backend returned old format without dispensingData array');
          this.queryError = 'Backend API needs to be updated to return dispensing data in the new format';
        }
      },
      error: (err) => {
        console.log('[TherapyAdherence] === DISPENSING HISTORY CHECK ERROR ===');
        console.log('[TherapyAdherence] Error status:', err.status);
        console.log('[TherapyAdherence] Error message:', err.error?.error || err.message);
        
        this.loading = false;
        
        // 404 means no file uploaded yet - show upload form
        if (err.status === 404) {
          console.log('[TherapyAdherence] No file found (404) - showing upload form');
          this.uploadSuccess = false;
          this.dispensingHistory = null;
          this.medicationsWithData = [];
        } else {
          // Other errors - still try to show upload form but display error
          console.error('[TherapyAdherence] Error checking existing file:', err);
          this.uploadSuccess = false;
          this.queryError = err.error?.error || 'Failed to load dispensing history';
        }
      }
    });
  }

  matchDispensingData() {
    if (!this.dispensingHistory || this.medications.length === 0) {
      console.log('Cannot match data:', {
        hasHistory: !!this.dispensingHistory,
        medicationCount: this.medications.length
      });
      return;
    }

    if (!this.dispensingHistory.dispensingData) {
      console.error('Dispensing history does not have dispensingData array');
      return;
    }

    console.log('Matching dispensing data with medications...');
    console.log('Available CNKs in dispensing data:', this.dispensingHistory.dispensingData.map(d => d.cnk));
    console.log('Medication CNKs:', this.medications.map(m => ({ name: m.name, cnk: m.cnk })));
    
    this.medicationsWithData = this.medications.map(medication => {
      // Match by CNK code
      const cnkString = medication.cnk?.toString();
      const matchingData = cnkString 
        ? this.dispensingHistory!.dispensingData.find(d => d.cnk === cnkString)
        : null;
      
      const chartId = `chart-${medication.medicationId}`;
      
      console.log(`Medication ${medication.name} (CNK: ${cnkString}):`, matchingData ? 'Found data' : 'No data');
      
      return {
        medication,
        dispensingData: matchingData || null,
        chartId
      };
    });

    // Calculate date range from all dispensing moments
    this.calculateDateRange();

    // Create charts after a short delay to ensure DOM is ready
    setTimeout(() => this.createCharts(), 100);
  }

  calculateDateRange() {
    let earliestTime: number | null = null;
    let latestTime: number | null = null;

    this.dispensingHistory?.dispensingData.forEach(cnkData => {
      cnkData.dispensingMoments.forEach(moment => {
        const date = this.parseDate(moment.date);
        const time = date.getTime();
        
        if (earliestTime === null || time < earliestTime) {
          earliestTime = time;
        }
        
        if (latestTime === null || time > latestTime) {
          latestTime = time;
        }
      });
    });

    // Extend latest to current date if it's after the last dispensing
    const now = new Date().getTime();
    if (latestTime === null || now > latestTime) {
      latestTime = now;
    }

    // Add padding to prevent points from being cut off at edges
    // Add 7 days before earliest and after latest
    const sevenDays = 7 * 24 * 60 * 60 * 1000;
    const paddedEarliest = earliestTime !== null ? new Date(earliestTime - sevenDays) : null;
    const paddedLatest = latestTime !== null ? new Date(latestTime + sevenDays) : null;

    // Store full range for reset functionality
    this.fullDateRange = { earliest: paddedEarliest, latest: paddedLatest };
    
    // Apply filters and zoom
    this.applyDateRangeFilters();
  }

  applyDateRangeFilters() {
    let earliest = this.fullDateRange.earliest;
    let latest = this.fullDateRange.latest;

    if (!earliest || !latest) {
      this.dateRange = { earliest, latest };
      return;
    }

    // Apply custom date filters if set
    if (this.filterStartDate) {
      const filterStart = new Date(this.filterStartDate);
      if (filterStart.getTime() > earliest.getTime()) {
        earliest = filterStart;
      }
    }

    if (this.filterEndDate) {
      const filterEnd = new Date(this.filterEndDate);
      if (filterEnd.getTime() < latest.getTime()) {
        latest = filterEnd;
      }
    }

    // Apply zoom level (zoom reduces the visible range)
    if (this.zoomLevel < 1) {
      const totalRange = latest.getTime() - earliest.getTime();
      const visibleRange = totalRange * this.zoomLevel;
      
      // Apply pan position
      const maxPanOffset = totalRange - visibleRange;
      const panOffset = (this.panPosition / 100) * maxPanOffset;
      
      const newStart = earliest.getTime() + panOffset;
      const newEnd = newStart + visibleRange;
      
      earliest = new Date(newStart);
      latest = new Date(newEnd);
    }

    this.dateRange = { earliest, latest };
  }

  onDateFilterChange() {
    this.applyDateRangeFilters();
    this.createCharts();
  }

  resetDateFilter() {
    this.filterStartDate = '';
    this.filterEndDate = '';
    this.zoomLevel = 1;
    this.panPosition = 0;
    this.applyDateRangeFilters();
    this.createCharts();
  }

  zoomIn() {
    if (this.zoomLevel > 0.1) {
      this.zoomLevel = Math.max(0.1, this.zoomLevel - 0.1);
      this.applyDateRangeFilters();
      this.createCharts();
    }
  }

  zoomOut() {
    if (this.zoomLevel < 1) {
      this.zoomLevel = Math.min(1, this.zoomLevel + 0.1);
      if (this.zoomLevel >= 0.99) {
        this.zoomLevel = 1;
        this.panPosition = 0; // Reset pan when fully zoomed out
      }
      this.applyDateRangeFilters();
      this.createCharts();
    }
  }

  onPanChange(event: Event) {
    const input = event.target as HTMLInputElement;
    this.panPosition = parseFloat(input.value);
    this.applyDateRangeFilters();
    this.createCharts();
  }

  isPanEnabled(): boolean {
    return this.zoomLevel < 1;
  }

  getDateTicks(): string[] {
    if (!this.dateRange.earliest || !this.dateRange.latest) {
      return [];
    }

    const formatDate = (date: Date) => {
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
    };

    const ticks: string[] = [];
    const current = new Date(this.dateRange.earliest);
    const end = this.dateRange.latest;

    // Generate monthly ticks
    while (current <= end) {
      ticks.push(formatDate(current));
      current.setMonth(current.getMonth() + 1);
    }

    // Limit to reasonable number of ticks (show every 2-3 months if too many)
    if (ticks.length > 8) {
      return ticks.filter((_, index) => index % 2 === 0);
    }

    return ticks;
  }

  getTimeScaleConfig() {
    if (!this.dateRange.earliest || !this.dateRange.latest) {
      return {
        unit: 'month' as const,
        displayFormats: {
          month: 'MMM yyyy'
        }
      };
    }

    // Calculate the visible date range in days
    const rangeMs = this.dateRange.latest.getTime() - this.dateRange.earliest.getTime();
    const rangeDays = rangeMs / (24 * 60 * 60 * 1000);

    // Determine appropriate time unit based on visible range
    // Use days and weeks earlier for more granular ticks when zooming in
    if (rangeDays <= 30) {
      // 30 days or less - show days
      return {
        unit: 'day' as const,
        displayFormats: {
          day: 'dd MMM'
        }
      };
    } else if (rangeDays <= 180) {
      // Up to ~6 months - show weeks
      return {
        unit: 'week' as const,
        displayFormats: {
          week: 'dd MMM'
        }
      };
    } else {
      // Default to months for larger ranges
      return {
        unit: 'month' as const,
        displayFormats: {
          month: 'MMM yyyy'
        }
      };
    }
    // Do not use quarters/years - when zoomed out beyond 1 year, still display months
    return {
      unit: 'month' as const,
      displayFormats: {
        month: 'MMM yyyy'
      }
    };
  }

  createCharts() {
    // Destroy existing charts
    this.charts.forEach(chart => chart.destroy());
    this.charts.clear();

    // Calculate maximum stock value across all medications for consistent y-axis scaling
    this.calculateMaxStockValue();

    this.medicationsWithData.forEach(item => {
      if (item.dispensingData) {
        this.createChart(item);
      }
    });
  }

  calculateMaxStockValue() {
    let maxStock = 0;

    this.medicationsWithData.forEach(item => {
      if (!item.dispensingData) return;

      const dailyUsage = this.calculateDailyUsage(item.medication);
      if (dailyUsage <= 0) return;

      const unitsPerPackage = item.medication.packageSize ?? 0;
      if (unitsPerPackage <= 0) return;

      const moments = item.dispensingData.dispensingMoments.map(moment => ({
        date: this.parseDate(moment.date),
        amount: moment.amount,
        unitsPerPackage: unitsPerPackage,
        totalUnits: moment.amount * unitsPerPackage,
        dateString: moment.date
      })).sort((a, b) => a.date.getTime() - b.date.getTime());

      const stockTimeline = this.generateStockTimeline(moments, dailyUsage);
      
      stockTimeline.forEach(point => {
        if (point.y > maxStock) {
          maxStock = point.y;
        }
      });
    });

    // Add 20% padding to the max value to prevent points from being above visible area
    this.maxStockValue = Math.ceil(maxStock * 1.2);
    console.log('[TherapyAdherence] Maximum stock value across all medications:', this.maxStockValue);
  }

  createChart(item: MedicationWithDispensingData) {
    const canvas = document.getElementById(item.chartId) as HTMLCanvasElement;
    if (!canvas) {
      console.warn(`Canvas not found for ${item.chartId}`);
      return;
    }

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Calculate daily usage
    const dailyUsage = this.calculateDailyUsage(item.medication);
    
    // Get units per package from packageSize (now an integer)
    const unitsPerPackage = item.medication.packageSize ?? 0;
    
    console.log(`=== Chart for ${item.medication.name} ===`);
    console.log('Package size:', item.medication.packageSize);
    console.log('Units per package:', unitsPerPackage);
    console.log('Daily usage:', dailyUsage, 'units');
    console.log('Medication dosage:', {
      unitsBeforeBreakfast: item.medication.unitsBeforeBreakfast,
      unitsDuringBreakfast: item.medication.unitsDuringBreakfast,
      unitsBeforeLunch: item.medication.unitsBeforeLunch,
      unitsDuringLunch: item.medication.unitsDuringLunch,
      unitsBeforeDinner: item.medication.unitsBeforeDinner,
      unitsDuringDinner: item.medication.unitsDuringDinner,
      unitsAtBedtime: item.medication.unitsAtBedtime
    });
    
    if (dailyUsage === 0 || unitsPerPackage === 0) {
      console.warn(`Missing info for ${item.medication.name} (daily usage: ${dailyUsage}, units/package: ${unitsPerPackage}), using fallback scatter chart`);
      // Fall back to simple scatter plot
      this.createSimpleScatterChart(item);
      return;
    }

    // Parse dates and sort chronologically, calculate total units
    const moments: DispensingMomentWithUnits[] = item.dispensingData!.dispensingMoments.map(moment => ({
      date: this.parseDate(moment.date),
      amount: moment.amount,
      unitsPerPackage: unitsPerPackage,
      totalUnits: moment.amount * unitsPerPackage,
      dateString: moment.date,
      source: moment.source || 'csv' // Default to csv if not specified
    })).sort((a, b) => a.date.getTime() - b.date.getTime());

    console.log('Dispensing moments with units:', moments);

    // Generate stock timeline with status
    const stockTimeline = this.generateStockTimeline(moments, dailyUsage);
    
    console.log('Stock timeline points:', stockTimeline.length);
    console.log('Sample timeline points (first 5):', stockTimeline.slice(0, 5).map(p => ({
      date: this.formatDateForTooltip(p.x),
      stock: p.y,
      status: p.status
    })));
    console.log('Status distribution:', {
      sufficient: stockTimeline.filter(p => p.status === 'sufficient').length,
      depleted: stockTimeline.filter(p => p.status === 'depleted').length,
      oversupply: stockTimeline.filter(p => p.status === 'oversupply').length
    });

    // Create datasets for different statuses - only include points with matching status
    const allStockData: any[] = [];
    const dispensingPoints: any[] = [];

    // Add all stock data points at fixed y-value (0.5 = middle of chart)
    stockTimeline.forEach(point => {
      allStockData.push({
        x: point.x,
        y: 0.5, // Fixed y-value - all nodes at same height
        originalY: point.y, // Keep original value for tooltip
        status: point.status
      });
    });

    // Add dispensing markers at fixed y-value
    moments.forEach(moment => {
      dispensingPoints.push({
        x: moment.date,
        y: 0.5, // Fixed y-value - all nodes at same height
        dateString: moment.dateString,
        amount: moment.amount,
        unitsPerPackage: moment.unitsPerPackage,
        totalUnits: moment.totalUnits,
        source: moment.source || 'csv'
      });
    });

    console.log('[TherapyAdherence] Total stock data points:', allStockData.length);
    console.log('[TherapyAdherence] Sample stock data (first 10):');
    allStockData.slice(0, 10).forEach((p, i) => {
      console.log(`  [${i}] x: ${new Date(p.x).toISOString().split('T')[0]}, y: ${p.y}, status: ${p.status}`);
    });
    console.log('[TherapyAdherence] Dispensing points:');
    dispensingPoints.forEach((p, i) => {
      console.log(`  [${i}] x: ${new Date(p.x).toISOString().split('T')[0]}, y: ${p.y}, amount: ${p.amount}, totalUnits: ${p.totalUnits}`);
    });

    const config: ChartConfiguration<'line'> = {
      type: 'line',
      data: {
        datasets: [
          {
            label: 'Stock Level',
            data: allStockData,
            borderColor: (context: any) => {
              if (!context.raw) return 'rgb(200, 200, 200)';
              const status = context.raw.status;
              if (status === 'sufficient') return 'rgb(54, 162, 235)'; // Blue
              if (status === 'depleted') return 'rgb(255, 99, 132)'; // Red
              if (status === 'oversupply') return 'rgb(153, 102, 255)'; // Purple
              return 'rgb(200, 200, 200)';
            },
            segment: {
              borderColor: (context: any) => {
                const point = context.p1 as any;
                if (!point || !point.raw) return 'rgb(200, 200, 200)';
                const status = point.raw.status;
                if (status === 'sufficient') return 'rgb(54, 162, 235)'; // Blue
                if (status === 'depleted') return 'rgb(255, 99, 132)'; // Red
                if (status === 'oversupply') return 'rgb(153, 102, 255)'; // Purple
                return 'rgb(200, 200, 200)';
              }
            },
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            pointRadius: 0,
            pointHoverRadius: 0,
            pointHitRadius: 50, // Much larger hit area for easier hovering
            borderWidth: 3,
            hoverBorderWidth: 5, // Thicker on hover
            fill: true,
            tension: 0.1
          },
          {
            label: 'Dispensing',
            data: dispensingPoints,
            borderColor: (context: any) => {
              if (!context.raw) return 'rgb(0, 0, 0)';
              return context.raw.source === 'manual' ? 'rgb(255, 152, 0)' : 'rgb(0, 0, 0)'; // Orange for manual, black for CSV
            },
            backgroundColor: (context: any) => {
              if (!context.raw) return 'rgb(0, 0, 0)';
              return context.raw.source === 'manual' ? 'rgb(255, 152, 0)' : 'rgb(0, 0, 0)'; // Orange for manual, black for CSV
            },
            pointRadius: 6,
            pointHoverRadius: 8,
            pointHitRadius: 50, // Much larger hit area for easier hovering
            showLine: false,
            order: -1 // Draw on top
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: {
            left: 5,
            right: 10,
            top: 5,
            bottom: 0
          }
        },
        scales: {
          x: {
            type: 'time',
            time: this.getTimeScaleConfig(),
            min: this.dateRange.earliest?.getTime(),
            max: this.dateRange.latest?.getTime(),
            display: true,
            grid: {
              display: true,
              drawOnChartArea: false,
              color: 'rgba(0, 0, 0, 0.1)'
            },
            ticks: {
              font: {
                size: 9
              },
              maxRotation: 0,
              autoSkipPadding: 10,
              color: '#666'
            },
            border: {
              display: true,
              color: 'rgba(0, 0, 0, 0.2)'
            }
          },
          y: {
            display: false,
            grid: {
              display: false
            },
            beginAtZero: true,
            min: 0,
            max: 1
          }
        },
        plugins: {
          tooltip: {
            enabled: true,
            position: 'nearest',
            yAlign: 'top',
            xAlign: 'center',
            caretPadding: 20,
            displayColors: false,
            backgroundColor: 'rgba(0, 0, 0, 0.85)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: 'rgba(0, 0, 0, 0.9)',
            borderWidth: 1,
            padding: 10,
            callbacks: {
              title: (context: any) => {
                const date = new Date(context[0].parsed.x);
                return this.formatDateForTooltip(date);
              },
              label: (context: any) => {
                const datasetLabel = context.dataset.label;
                const raw = context.raw as any;
                
                if (datasetLabel === 'Dispensing') {
                  const sourceLabel = raw.source === 'manual' ? ' (Manual)' : ' (CSV)';
                  return [
                    `Dispensed: ${raw.amount} package(s)${sourceLabel}`,
                    `Package size: ${raw.unitsPerPackage} units`,
                    `Total: ${raw.totalUnits} units`
                  ];
                }
                
                // Show original stock value from stored data
                const stock = raw.originalY !== undefined ? raw.originalY : 0;
                return `Stock: ${stock.toFixed(1)} units`;
              }
            }
          },
          legend: {
            display: false
          }
        }
      }
    };

    const chart = new Chart(ctx, config);
    this.charts.set(item.chartId, chart);
  }

  calculateDailyUsage(medication: ApiMedication): number {
    const before = (medication.unitsBeforeBreakfast || 0) + 
                   (medication.unitsBeforeLunch || 0) + 
                   (medication.unitsBeforeDinner || 0);
    const during = (medication.unitsDuringBreakfast || 0) + 
                   (medication.unitsDuringLunch || 0) + 
                   (medication.unitsDuringDinner || 0);
    const bedtime = medication.unitsAtBedtime || 0;
    
    return before + during + bedtime;
  }

  generateStockTimeline(
    moments: DispensingMomentWithUnits[],
    dailyUsage: number
  ): StockDataPoint[] {
    const timeline: StockDataPoint[] = [];
    const oneDay = 24 * 60 * 60 * 1000; // milliseconds in a day

    if (moments.length === 0) return timeline;

    // Normalize all dispensing dates to midnight UTC to avoid timezone issues
    const normalizedMoments = moments.map(m => {
      const year = m.date.getFullYear();
      const month = m.date.getMonth();
      const day = m.date.getDate();
      return {
        ...m,
        normalizedDate: new Date(Date.UTC(year, month, day, 0, 0, 0, 0))
      };
    });

    // Start from first dispensing
    const firstDate = normalizedMoments[0].normalizedDate;
    const lastDate = normalizedMoments[normalizedMoments.length - 1].normalizedDate;
    
    // Extend end date to show depletion after last dispensing
    const extendedEndDate = new Date(lastDate.getTime() + (90 * oneDay)); // 90 days after last

    let currentStock = 0;
    let currentDate = new Date(firstDate.getTime()); // Clone the start date

    console.log('[TherapyAdherence] === GENERATING STOCK TIMELINE ===');
    console.log('[TherapyAdherence] Total dispensing moments:', moments.length);
    console.log('[TherapyAdherence] Daily usage:', dailyUsage, 'units');
    console.log('[TherapyAdherence] Dispensing dates:');
    normalizedMoments.forEach((m, idx) => {
      console.log(`  [${idx}] ${m.dateString} ‚Üí UTC normalized: ${m.normalizedDate.toISOString()} ‚Üí timestamp: ${m.normalizedDate.getTime()} ‚Üí units: ${m.totalUnits}`);
    });

    // Generate daily data points
    let dayCounter = 0;
    let lastDispensingDay = -1; // Track when we last received medication
    let oversupplyUntilDay = -1; // Track how many days the oversupply lasts
    console.log('[TherapyAdherence] === STARTING DAILY ITERATION ===');
    
    while (currentDate <= extendedEndDate) {
      const currentDateKey = currentDate.getTime();
      
      // Check if we have any dispensings on this date
      let totalUnitsDispensedToday = 0;
      let receivedDispensingToday = false;
      
      // Check all dispensing moments for this date
      for (let i = 0; i < normalizedMoments.length; i++) {
        if (normalizedMoments[i].normalizedDate.getTime() === currentDateKey) {
          totalUnitsDispensedToday += normalizedMoments[i].totalUnits;
          receivedDispensingToday = true;
          console.log(`[TherapyAdherence] ‚úì MATCH! Day ${dayCounter}: ${currentDate.toISOString().split('T')[0]} (${currentDateKey}) matches dispensing ${i}: ${normalizedMoments[i].totalUnits} units`);
        }
      }
      
      // Track stock BEFORE receiving today's dispensing
      const stockBeforeDispensing = currentStock;
      
      // Add dispensed units at the start of the day
      if (totalUnitsDispensedToday > 0) {
        currentStock += totalUnitsDispensedToday;
        
        // If we received medication while still having stock, calculate oversupply period
        if (stockBeforeDispensing > 0) {
          // The oversupply lasts for as many days as the previous stock would have lasted
          const daysOfOversupply = Math.floor(stockBeforeDispensing / dailyUsage);
          oversupplyUntilDay = dayCounter + daysOfOversupply;
          
          console.log(`[TherapyAdherence] üì¶ DISPENSING on day ${dayCounter} (${currentDate.toISOString().split('T')[0]}): Added ${totalUnitsDispensedToday} units, stock ${stockBeforeDispensing} ‚Üí ${currentStock}`);
          console.log(`[TherapyAdherence] üü£ OVERSUPPLY DETECTED: Had ${stockBeforeDispensing} units left = ${daysOfOversupply} days of supply. Oversupply until day ${oversupplyUntilDay}`);
        } else {
          console.log(`[TherapyAdherence] üì¶ DISPENSING on day ${dayCounter} (${currentDate.toISOString().split('T')[0]}): Added ${totalUnitsDispensedToday} units, stock ${stockBeforeDispensing} ‚Üí ${currentStock}`);
        }
        
        lastDispensingDay = dayCounter;
      }

      // Determine current status BEFORE depleting
      let status: 'sufficient' | 'depleted' | 'oversupply';
      
      if (currentStock <= 0) {
        status = 'depleted';
        if (dayCounter % 50 === 0 || totalUnitsDispensedToday > 0) {
          console.log(`[TherapyAdherence] üî¥ Day ${dayCounter}: DEPLETED (stock: ${currentStock})`);
        }
      } else if (dayCounter <= oversupplyUntilDay) {
        // Still in oversupply period - consuming medication from previous dispensing
        status = 'oversupply';
        if (dayCounter % 50 === 0 || totalUnitsDispensedToday > 0 || dayCounter === oversupplyUntilDay) {
          console.log(`[TherapyAdherence] üü£ Day ${dayCounter}: OVERSUPPLY - still using stock from previous dispensing (oversupply until day ${oversupplyUntilDay})`);
        }
      } else {
        // Normal/sufficient usage
        status = 'sufficient';
        if (dayCounter % 50 === 0 || totalUnitsDispensedToday > 0) {
          console.log(`[TherapyAdherence] üîµ Day ${dayCounter}: SUFFICIENT - normal usage (stock: ${currentStock})`);
        }
      }

      // Record the stock level for this day (never go below 0 for display)
      const displayStock = Math.max(0, currentStock);
      timeline.push({
        x: new Date(currentDate),
        y: displayStock,
        status
      });

      if (dayCounter % 50 === 0 || totalUnitsDispensedToday > 0) {
        console.log(`[TherapyAdherence] üìä Day ${dayCounter} timeline point: date=${currentDate.toISOString().split('T')[0]}, stock=${displayStock}, status=${status}`);
      }

      // Deplete stock by daily usage at END of day (but don't go below 0)
      currentStock -= dailyUsage;
      if (currentStock < 0) {
        currentStock = 0; // Patient cannot have negative medication
      }
      
      if (dayCounter % 50 === 0 || totalUnitsDispensedToday > 0) {
        console.log(`[TherapyAdherence] üíä Day ${dayCounter} after usage: stock depleted by ${dailyUsage} ‚Üí ${currentStock}`);
      }

      // Move to next day
      currentDate = new Date(currentDate.getTime() + oneDay);
      dayCounter++;
    }

    console.log('[TherapyAdherence] Generated', timeline.length, 'timeline points');
    
    // Log some sample timeline points to verify data
    console.log('[TherapyAdherence] === TIMELINE SAMPLES ===');
    console.log('[TherapyAdherence] First 10 points:');
    timeline.slice(0, 10).forEach((p, i) => {
      console.log(`  Point ${i}: ${p.x.toISOString().split('T')[0]} - stock: ${p.y}, status: ${p.status}`);
    });
    
    console.log('[TherapyAdherence] Points around dispensing 1 (day ~100):');
    timeline.slice(98, 103).forEach((p, i) => {
      console.log(`  Point ${98 + i}: ${p.x.toISOString().split('T')[0]} - stock: ${p.y}, status: ${p.status}`);
    });

    return timeline;
  }

  createSimpleScatterChart(item: MedicationWithDispensingData) {
    const canvas = document.getElementById(item.chartId) as HTMLCanvasElement;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Get package size for display
    const packageSize = item.medication.packageSize ?? 0;

    // Parse dates and sort chronologically
    const moments = item.dispensingData!.dispensingMoments.map(moment => ({
      date: this.parseDate(moment.date),
      amount: moment.amount,
      dateString: moment.date,
      packageSize: packageSize,
      source: moment.source || 'csv'
    })).sort((a, b) => a.date.getTime() - b.date.getTime());

    // Create simple data points at fixed y-value (0.5 = middle of chart)
    const dataPoints = moments.map(moment => ({
      x: moment.date,
      y: 0.5, // Fixed y-value - all nodes at same height
      dateString: moment.dateString,
      amount: moment.amount,
      packageSize: moment.packageSize,
      source: moment.source
    }));

    const config: ChartConfiguration<'line'> = {
      type: 'line',
      data: {
        datasets: [{
          label: 'Dispensed',
          data: dataPoints as any,
          borderColor: (context: any) => {
            if (!context.raw) return 'rgb(75, 192, 192)';
            return context.raw.source === 'manual' ? 'rgb(255, 152, 0)' : 'rgb(75, 192, 192)'; // Orange for manual, teal for CSV
          },
          backgroundColor: (context: any) => {
            if (!context.raw) return 'rgb(75, 192, 192)';
            return context.raw.source === 'manual' ? 'rgb(255, 152, 0)' : 'rgb(75, 192, 192)'; // Orange for manual, teal for CSV
          },
          pointRadius: 4,
          pointHoverRadius: 6,
          pointHitRadius: 50, // Much larger hit area for easier hovering
          showLine: false,
          tension: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: {
            left: 5,
            right: 10,
            top: 5,
            bottom: 0
          }
        },
        scales: {
          x: {
            type: 'time',
            time: this.getTimeScaleConfig(),
            min: this.dateRange.earliest?.getTime(),
            max: this.dateRange.latest?.getTime(),
            display: true,
            grid: {
              display: true,
              drawOnChartArea: false,
              color: 'rgba(0, 0, 0, 0.1)'
            },
            ticks: {
              font: {
                size: 9
              },
              maxRotation: 0,
              autoSkipPadding: 10,
              color: '#666'
            },
            border: {
              display: true,
              color: 'rgba(0, 0, 0, 0.2)'
            }
          },
          y: {
            display: false,
            grid: {
              display: false
            },
            min: 0,
            max: 1
          }
        },
        plugins: {
          tooltip: {
            enabled: true,
            position: 'nearest',
            yAlign: 'top',
            xAlign: 'center',
            caretPadding: 20,
            displayColors: false,
            backgroundColor: 'rgba(0, 0, 0, 0.85)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: 'rgba(0, 0, 0, 0.9)',
            borderWidth: 1,
            padding: 10,
            callbacks: {
              title: (context: any) => {
                const point = context[0].raw as any;
                return point.dateString;
              },
              label: (context: any) => {
                const point = context.raw as any;
                const sourceLabel = point.source === 'manual' ? ' (Manual)' : ' (CSV)';
                if (point.packageSize > 0) {
                  return [
                    `Dispensed: ${point.amount} package(s)${sourceLabel}`,
                    `Package size: ${point.packageSize} units`
                  ];
                }
                return `Dispensed: ${point.amount} package(s)${sourceLabel}`;
              }
            }
          },
          legend: {
            display: false
          }
        }
      }
    };

    const chart = new Chart(ctx, config);
    this.charts.set(item.chartId, chart);
  }

  formatDateForTooltip(date: Date): string {
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  parseDate(dateString: string): Date {
    // Handle DD/MM/YYYY format (from CSV and backend response)
    if (dateString.includes('/')) {
      const parts = dateString.split('/');
      if (parts.length === 3) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1; // JS months are 0-indexed
        const year = parseInt(parts[2], 10);
        return new Date(year, month, day);
      }
    }
    
    // Handle YYYY-MM-DD format (ISO format, just in case)
    if (dateString.includes('-')) {
      const parts = dateString.split('-');
      if (parts.length === 3) {
        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1; // JS months are 0-indexed
        const day = parseInt(parts[2], 10);
        return new Date(year, month, day);
      }
    }
    
    // Fallback to Date constructor
    return new Date(dateString);
  }

  onFileSelected(event: Event) {
    const input = event.target as HTMLInputElement;
    if (input.files && input.files.length > 0) {
      this.selectedFile = input.files[0];
      this.uploadFile();
    }
  }

  uploadFile() {
    if (!this.selectedFile) return;

    const apbNumber = this.stateService.apbNumber;
    const reviewId = this.stateService.medicationReviewId;

    if (!apbNumber || !reviewId) {
      this.uploadError = 'Session data not available. Please log in again.';
      return;
    }

    console.log('[TherapyAdherence] === UPLOADING FILE ===');
    console.log('[TherapyAdherence] File name:', this.selectedFile.name);
    console.log('[TherapyAdherence] File size:', this.selectedFile.size);

    this.uploading = true;
    this.uploadSuccess = false;
    this.uploadError = null;
    this.queryError = null;

    this.apiService.uploadDispensingHistory(apbNumber, reviewId, this.selectedFile).subscribe({
      next: (response) => {
        console.log('[TherapyAdherence] Upload successful:', response);
        console.log('[TherapyAdherence] Blob URI:', response.blobUri);
        this.uploading = false;
        this.selectedFile = null;
        
        // Reset the file input
        const fileInput = document.getElementById('file-input') as HTMLInputElement;
        if (fileInput) {
          fileInput.value = '';
        }
        
        // Wait a moment for backend to update the MedicationReview record, then query
        setTimeout(() => {
          console.log('[TherapyAdherence] Querying dispensing history after upload...');
          this.checkExistingFileAfterUpload();
        }, 1000);
      },
      error: (err) => {
        console.error('[TherapyAdherence] Upload failed:', err);
        this.uploading = false;
        this.uploadSuccess = false;
        this.uploadError = err.error?.error || 'Failed to upload file';
        this.selectedFile = null;
        
        // Reset the file input
        const fileInput = document.getElementById('file-input') as HTMLInputElement;
        if (fileInput) {
          fileInput.value = '';
        }
      }
    });
  }

  checkExistingFileAfterUpload() {
    const apbNumber = this.stateService.apbNumber;
    const reviewId = this.stateService.medicationReviewId;

    if (!apbNumber || !reviewId) return;

    this.loading = true;
    this.uploadError = null;
    this.queryError = null;
    
    this.apiService.queryDispensingHistory(apbNumber, reviewId).subscribe({
      next: (response) => {
        console.log('[TherapyAdherence] === DISPENSING HISTORY LOADED AFTER UPLOAD ===');
        console.log('[TherapyAdherence] Full response:', JSON.stringify(response, null, 2));
        
        this.dispensingHistory = response;
        this.uploadSuccess = true;
        this.loading = false;
        
        if (response.dispensingData && Array.isArray(response.dispensingData)) {
          console.log('[TherapyAdherence] Dispensing data array length:', response.dispensingData.length);
          this.matchDispensingData();
        } else {
          console.error('[TherapyAdherence] Backend returned old format without dispensingData array');
          this.queryError = 'Backend API needs to be updated to return dispensing data in the new format';
        }
      },
      error: (err) => {
        console.error('[TherapyAdherence] === ERROR LOADING AFTER UPLOAD ===');
        console.error('[TherapyAdherence] Error status:', err.status);
        console.error('[TherapyAdherence] Error:', err);
        
        this.loading = false;
        
        // The file was uploaded but the backend might not have updated the MedicationReview record yet
        if (err.status === 404) {
          this.uploadSuccess = true; // Show as uploaded
          this.queryError = 'File uploaded successfully, but needs processing. Please refresh the page or click "Upload New File" to try again.';
        } else {
          this.uploadSuccess = false;
          this.queryError = err.error?.error || 'Failed to load dispensing history after upload';
        }
      }
    });
  }

  private shouldRetryQuery = false;
  private currentRetryAttempt = 0;

  retryLoadFile() {
    console.log('[TherapyAdherence] Retrying file load...');
    this.queryError = null;
    this.checkExistingFile();
  }

  triggerFileInput() {
    const fileInput = document.getElementById('file-input') as HTMLInputElement;
    fileInput?.click();
  }

  openNotesModal(medication?: ApiMedication) {
    if (medication) {
      console.log('[TherapyAdherence] Opening notes for medication:', medication.name);
      this.openNotes.emit(medication);
    } else {
      console.log('[TherapyAdherence] Opening notes for general note (no medication)');
      this.openNotes.emit(undefined as any); // Emit undefined for general notes
    }
  }

  openManualDispensingModal() {
    console.log('[TherapyAdherence] Opening manual dispensing modal');
    this.showManualDispensingModal = true;
  }

  closeManualDispensingModal() {
    console.log('[TherapyAdherence] Closing manual dispensing modal');
    this.showManualDispensingModal = false;
  }

  onManualMomentsAdded() {
    console.log('[TherapyAdherence] Manual moments added, refreshing data');
    this.showManualDispensingModal = false;
    // Refresh the dispensing history to show the new manual entries
    this.checkExistingFile();
  }

  openManageMomentsModal() {
    console.log('[TherapyAdherence] Opening manage moments modal');
    this.showManageMomentsModal = true;
  }

  closeManageMomentsModal() {
    console.log('[TherapyAdherence] Closing manage moments modal');
    this.showManageMomentsModal = false;
  }

  onMomentsDeleted() {
    console.log('[TherapyAdherence] Moments deleted, refreshing data');
    // Refresh the dispensing history to reflect deletions
    this.checkExistingFile();
  }
}

```
--- END OF FILE: src\app\components\therapy-adherence\therapy-adherence.component.ts ---

--- START OF FILE: src\app\models\api.models.ts ---
```typescript
export interface Patient {
  dateOfBirth: string | null;
  sex: string | null;
  renalFunction?: string | null;
}

export interface MedicationReview {
  reviewDate: string | null;
  firstNameAtTimeOfReview: string | null;
  lastNameAtTimeOfReview: string | null;
}

// Medication Search
export interface MedicationSearchRequest {
  searchTerm: string;
  maxResults?: number;
}

export interface MedicationSearchResult {
  benaming: string;
  cnk: string;
  verpakking: number;
  vmp: string | null;
}

export interface MedicationSearchResponse {
  searchTerm: string;
  count: number;
  results: MedicationSearchResult[];
}

export interface LoginRequest {
  apbNumber: string;
  medicationReviewId?: string;
}

export interface LoginResponse {
  patientCreated: boolean;
  reviewCreated: boolean;
  patientId: string;
  medicationReviewId: string;
  patient: Patient;
  review: MedicationReview;
}

export interface SessionData extends LoginResponse {
  apbNumber: string; // Store the APB number from login request
}

export interface UpdatePatientRequest {
  apbNumber: string;
  patientId: string;
  dateOfBirth?: string | null;
  sex?: string | null;
  renalFunction?: string | null;
}

export interface UpdatePatientResponse {
  patientId: string;
  dateOfBirth: string | null;
  sex: string | null;
  renalFunction?: string | null;
  updated: boolean;
}

export interface UpdateMedicationReviewRequest {
  apbNumber: string;
  medicationReviewId: string;
  patientId?: string;
  firstNameAtTimeOfReview?: string | null;
  lastNameAtTimeOfReview?: string | null;
  reviewDate?: string | null;
}

export interface UpdateMedicationReviewResponse {
  medicationReviewId: string;
  firstNameAtTimeOfReview: string | null;
  lastNameAtTimeOfReview: string | null;
  reviewDate: string | null;
  updated: boolean;
}

// APB Contraindications
export interface APBContraindicationItem {
  code: string;
  description: string;
}

export interface APBContraindicationsRequest {
  language: 'NL' | 'FR' | 'EN';
}

export interface APBContraindicationsResponse {
  language: string;
  result: {
    hypersensitivities: {
      list: APBContraindicationItem[];
    };
    pathologies: {
      list: APBContraindicationItem[];
    };
    physiologicalConditions: {
      list: APBContraindicationItem[];
    };
  };
}

// Backend uses PascalCase, so add aliases
export interface APBContraindicationsResponseBackend {
  Language: string;
  Result: {
    Hypersensitivities: {
      List: APBContraindicationItem[];
    };
    Pathologies: {
      List: APBContraindicationItem[];
    };
    PhysiologicalConditions: {
      List: APBContraindicationItem[];
    };
  };
}

// Contraindication Management
export interface Contraindication {
  contraindicationId: string;
  name: string | null;
  contraindicationCode: string;
}

export interface AddContraindicationRequest {
  medicationReviewId: string;
  name: string;
  contraindicationCode: string;
}

export interface UpdateContraindicationRequest {
  medicationReviewId: string;
  contraindicationId: string;
  name?: string;
  contraindicationCode?: string;
}

export interface ContraindicationResponse {
  contraindicationId: string;
  name: string | null;
  contraindicationCode: string;
}

// Medication Management
export interface Medication {
  medicationId: string;
  name?: string | null;
  cnk?: number | null;
  vmp?: number | null;
  packageSize?: number | null;
  dosageMg?: number | null;
  routeOfAdministration?: string | null;
  indication?: string | null;
  asNeeded?: boolean | null;
  specialFrequency?: number | null;
  specialDescription?: string | null;
  unitsBeforeBreakfast?: number | null;
  unitsDuringBreakfast?: number | null;
  unitsBeforeLunch?: number | null;
  unitsDuringLunch?: number | null;
  unitsBeforeDinner?: number | null;
  unitsDuringDinner?: number | null;
  unitsAtBedtime?: number | null;
  timestamp?: string | null;
}

export interface AddMedicationRequest {
  medicationReviewId: string;
  medicationId?: string;
  name?: string;
  cnk?: number;
  vmp?: number;
  packageSize?: number;
  dosageMg?: number;
  routeOfAdministration?: string;
  indication?: string;
  asNeeded?: boolean;
  specialFrequency?: number;
  specialDescription?: string;
  unitsBeforeBreakfast?: number;
  unitsDuringBreakfast?: number;
  unitsBeforeLunch?: number;
  unitsDuringLunch?: number;
  unitsBeforeDinner?: number;
  unitsDuringDinner?: number;
  unitsAtBedtime?: number;
}

export interface UpdateMedicationRequest {
  medicationReviewId: string;
  medicationId: string;
  name?: string | null;
  cnk?: number | null;
  vmp?: number | null;
  packageSize?: number | null;
  dosageMg?: number | null;
  routeOfAdministration?: string | null;
  indication?: string | null;
  asNeeded?: boolean | null;
  specialFrequency?: number | null;
  specialDescription?: string | null;
  unitsBeforeBreakfast?: number | null;
  unitsDuringBreakfast?: number | null;
  unitsBeforeLunch?: number | null;
  unitsDuringLunch?: number | null;
  unitsBeforeDinner?: number | null;
  unitsDuringDinner?: number | null;
  unitsAtBedtime?: number | null;
}

export interface MedicationResponse {
  medicationId: string;
  name?: string | null;
  cnk?: number | null;
  vmp?: number | null;
  packageSize?: number | null;
  dosageMg?: number | null;
  routeOfAdministration?: string | null;
  indication?: string | null;
  asNeeded?: boolean | null;
  specialFrequency?: number | null;
  specialDescription?: string | null;
  unitsBeforeBreakfast?: number | null;
  unitsDuringBreakfast?: number | null;
  unitsBeforeLunch?: number | null;
  unitsDuringLunch?: number | null;
  unitsBeforeDinner?: number | null;
  unitsDuringDinner?: number | null;
  unitsAtBedtime?: number | null;
}

// Lab Value Management
export interface LabValue {
  labValueId: string;
  name?: string | null;
  value: number;
  unit?: string | null;
}

export interface AddLabValueRequest {
  medicationReviewId: string;
  labValueId?: string;
  name?: string;
  value: number;
  unit?: string;
}

export interface UpdateLabValueRequest {
  medicationReviewId: string;
  labValueId: string;
  name?: string;
  value: number;
  unit?: string;
}

export interface LabValueResponse {
  labValueId: string;
  name?: string | null;
  value: number;
  unit?: string | null;
}

// Dispensing History
export interface DispensingMoment {
  date: string;          // DD/MM/YYYY format
  amount: number;        // Quantity dispensed
  source?: 'csv' | 'manual'; // Source of the dispensing moment
  id?: string;           // Unique ID for manual moments (GUID)
}

export interface CnkDispensingData {
  cnk: string;           // CNK medication code
  description: string;   // Medication description
  dispensingMoments: DispensingMoment[];
}

export interface DispensingHistoryResponse {
  medicationReviewId: string;
  blobUri: string;
  totalCnkCodes: number;
  totalDispensingMoments: number;
  csvMoments?: number;
  manualMoments?: number;
  dispensingData: CnkDispensingData[];
}

// Manual Dispensing Moment
export interface AddManualDispensingMomentRequest {
  cnk: string;           // CNK medication code (7-digit)
  description: string;   // Human-readable medication name
  date: string;          // ISO 8601 date (YYYY-MM-DD)
  amount: number;        // Quantity dispensed (> 0)
}

export interface AddManualDispensingMomentResponse {
  id: string;
  apbNumber: string;
  medicationReviewId: string;
  cnk: string;
  description: string;
  date: string;
  amount: number;
  message: string;
}

// Question Answer Management
export interface QuestionAnswer {
  medicationReviewId: string;
  questionName: string;
  value?: string | null;
  shareWithPatient?: boolean;
  shareWithDoctor?: boolean;
}

export interface AddQuestionAnswerRequest {
  medicationReviewId: string;
  questionName: string;
  value?: string;
  shareWithPatient?: boolean;
  shareWithDoctor?: boolean;
}

export interface UpdateQuestionAnswerRequest {
  medicationReviewId: string;
  questionName: string;
  value?: string;
  shareWithPatient?: boolean;
  shareWithDoctor?: boolean;
}

export interface QuestionAnswerResponse {
  medicationReviewId: string;
  questionName: string;
  value?: string | null;
  shareWithPatient?: boolean;
  shareWithDoctor?: boolean;
}

```
--- END OF FILE: src\app\models\api.models.ts ---

--- START OF FILE: src\app\pages\analysis\analysis.page.html ---
```typescript
<div class="analysis-page">
  <app-analysis-toolbar 
    [activeTool]="activeTool" 
    (toolSelected)="onToolSelected($event)">
  </app-analysis-toolbar>
  
  <div class="medications-panel">
    <h2 class="medications-panel-title">{{ getToolTitle() }}</h2>
    <div class="medications-scroll">
      <app-analysis-medication-item
        *ngFor="let medication of medications" 
        [medication]="medication"
        [class.clickable]="activeTool === 'interactions' || activeTool === 'contra-indications' || activeTool === 'posology' || activeTool === 'renadapter'"
        [class.selected]="(activeTool === 'interactions' && isSelectedForInteractions(medication.medicationId)) || (activeTool === 'contra-indications' && isSelectedForContraindications(medication.medicationId)) || (activeTool === 'posology' && isSelectedForPosology(medication.medicationId)) || (activeTool === 'renadapter' && isSelectedForRenadaptor(medication.medicationId))"
        (click)="onMedicationBoxClick(medication)"
        (medicationDeleted)="onMedicationDeleted($event)"
        (editRequested)="onEditRequested($event)">
      </app-analysis-medication-item>
      
      <button class="add-medication-button" (click)="addMedication()">
        {{ 'medication.add_medication' | transloco }} +
      </button>
    </div>
  </div>
  
  <div class="tools-panel" [class]="'tool-' + activeTool">
    @if (activeTool === 'medication-schema') {
      <div class="medication-schema-view">
        <!-- General note button (top right) -->
        <button class="add-note-button general-note floating-top-right" (click)="openGeneralNotesModal('medication-schema')" [title]="'tools.add_note' | transloco">
          +
        </button>

        <!-- Table headers at the top -->
        <div class="schema-header">
          <div class="schema-time-header">
            <span class="time-title">{{ 'medication.breakfast' | transloco }}</span>
            <div class="time-subtitle">
              <span>{{ 'medication.before' | transloco }}</span>
              <span>{{ 'medication.during' | transloco }}</span>
            </div>
          </div>
          <div class="schema-time-header">
            <span class="time-title">{{ 'medication.lunch' | transloco }}</span>
            <div class="time-subtitle">
              <span>{{ 'medication.before' | transloco }}</span>
              <span>{{ 'medication.during' | transloco }}</span>
            </div>
          </div>
          <div class="schema-time-header">
            <span class="time-title">{{ 'medication.dinner' | transloco }}</span>
            <div class="time-subtitle">
              <span>{{ 'medication.before' | transloco }}</span>
              <span>{{ 'medication.during' | transloco }}</span>
            </div>
          </div>
          <div class="schema-time-header">
            <span class="time-title">{{ 'medication.at_bedtime' | transloco }}</span>
          </div>
        </div>
        
        <!-- One row per medication -->
        <div class="schema-row-wrapper" *ngFor="let medication of medications">
          @if (medication.asNeeded) {
            <div class="schema-as-needed">
              <span class="as-needed-text">{{ 'medication.as_needed_short' | transloco }}</span>
            </div>
          } @else if (medication.specialFrequency && medication.specialDescription) {
            <div class="schema-special-frequency">
              <span class="special-frequency-text">{{ medication.specialFrequency }}x {{ getLocalizedPeriod(medication.specialDescription) }}</span>
            </div>
          } @else {
            <div class="schema-medication-row">
              <div class="schema-cell">
              <div class="sub-box">
                <span class="value-label">{{ 'medication.before' | transloco }}</span>
                <input 
                  type="number" 
                  class="value-input"
                  [(ngModel)]="medication.unitsBeforeBreakfast"
                  (ngModelChange)="onSchemaValueChange(medication)"
                  placeholder="-"
                  min="0"
                  step="0.5">
              </div>
              <div class="sub-box">
                <span class="value-label">{{ 'medication.during' | transloco }}</span>
                <input 
                  type="number" 
                  class="value-input"
                  [(ngModel)]="medication.unitsDuringBreakfast"
                  (ngModelChange)="onSchemaValueChange(medication)"
                  placeholder="-"
                  min="0"
                  step="0.5">
              </div>
            </div>
            
            <div class="schema-cell">
              <div class="sub-box">
                <span class="value-label">{{ 'medication.before' | transloco }}</span>
                <input 
                  type="number" 
                  class="value-input"
                  [(ngModel)]="medication.unitsBeforeLunch"
                  (ngModelChange)="onSchemaValueChange(medication)"
                  placeholder="-"
                  min="0"
                  step="0.5">
              </div>
              <div class="sub-box">
                <span class="value-label">{{ 'medication.during' | transloco }}</span>
                <input 
                  type="number" 
                  class="value-input"
                  [(ngModel)]="medication.unitsDuringLunch"
                  (ngModelChange)="onSchemaValueChange(medication)"
                  placeholder="-"
                  min="0"
                  step="0.5">
              </div>
            </div>
            
            <div class="schema-cell">
              <div class="sub-box">
                <span class="value-label">{{ 'medication.before' | transloco }}</span>
                <input 
                  type="number" 
                  class="value-input"
                  [(ngModel)]="medication.unitsBeforeDinner"
                  (ngModelChange)="onSchemaValueChange(medication)"
                  placeholder="-"
                  min="0"
                  step="0.5">
              </div>
              <div class="sub-box">
                <span class="value-label">{{ 'medication.during' | transloco }}</span>
                <input 
                  type="number" 
                  class="value-input"
                  [(ngModel)]="medication.unitsDuringDinner"
                  (ngModelChange)="onSchemaValueChange(medication)"
                  placeholder="-"
                  min="0"
                  step="0.5">
              </div>
            </div>
            
            <div class="schema-cell night-cell">
              <input 
                type="number" 
                class="value-input night-input"
                [(ngModel)]="medication.unitsAtBedtime"
                (ngModelChange)="onSchemaValueChange(medication)"
                placeholder="-"
                min="0"
                step="0.5">
            </div>
            </div>
          }

          <button class="add-note-button" (click)="openNotesModal(medication)" [title]="'tools.add_note' | transloco">
            +
          </button>
        </div>
      </div>
    } @else if (activeTool === 'therapy-adherence') {
      <app-therapy-adherence (openNotes)="openNotesModal($event)"></app-therapy-adherence>
    } @else if (activeTool === 'interactions') {
      <app-interactions (openNotes)="openInteractionNotesModal($event)"></app-interactions>
    } @else if (activeTool === 'contra-indications') {
      <app-contraindications (openNotes)="openContraindicationNotesModal($event)"></app-contraindications>
    } @else if (activeTool === 'posology') {
      <app-posology (openNotes)="openNotesModal($event.medication)"></app-posology>
    } @else if (activeTool === 'renadapter') {
      <app-renadaptor (openNotes)="openNotesModal($event)"></app-renadaptor>
    } @else if (activeTool === 'gheops') {
      <app-gheops (openNotes)="openReferenceNotesModal('gheops')"></app-gheops>
    } @else if (activeTool === 'start-stop-nl') {
      <app-start-stop (openNotes)="openReferenceNotesModal('start-stop-nl')"></app-start-stop>
    } @else if (activeTool === 'questionnaire') {
      <app-questionnaire (openNotes)="openQuestionnaireNotesModal()"></app-questionnaire>
    } @else if (activeTool) {
      <div class="tool-content">
        <h2>{{ getToolTitle() }}</h2>
        <p>Tool panel for {{ getToolTitle() }}</p>
      </div>
    } @else {
      <div class="no-tool-selected">
        <p>Select a tool from the toolbar to begin</p>
      </div>
    }
  </div>
</div>

<!-- Medication Search Modal -->
<app-medication-search-modal 
  *ngIf="showSearchModal" 
  [isEditMode]="editingMedication !== null"
  (close)="onModalClose()" 
  (medicationSelected)="onMedicationSelected($event)">
</app-medication-search-modal>

<!-- Medication Notes Modal -->
<app-medication-notes-modal
  *ngIf="showNotesModal"
  [medication]="selectedMedicationForNotes"
  [category]="noteCategory"
  (close)="onNotesModalClose()"
></app-medication-notes-modal>

<!-- Interaction Notes Modal -->
<app-interaction-notes-modal
  *ngIf="showInteractionNotesModal"
  [interaction]="selectedInteraction"
  [interactionType]="selectedInteractionType"
  (close)="onInteractionNotesModalClose()"
></app-interaction-notes-modal>

<!-- Note Overview Modal -->
@if (showNoteOverviewModal) {
  <app-note-overview-modal
    (closeModal)="closeNoteOverview()"
    (createConversation)="onCreatePatientConversation()"
  ></app-note-overview-modal>
}

```
--- END OF FILE: src\app\pages\analysis\analysis.page.html ---

--- START OF FILE: src\app\pages\analysis\analysis.page.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.analysis-page {
  display: flex;
  height: calc(100vh - 7vh); // Full viewport height minus header (7vh)
  width: 100%;
  position: relative;
  padding-left: 9vh; // Account for fixed toolbar width
  overflow-y: auto; // Single scroll for the entire page
  overflow-x: hidden;

  .medications-panel {
    width: 30%;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    margin-top: 4rem;
    margin-left: 2rem; // Margin between toolbar and medication boxes
    padding-right: 2rem; // Padding on the right side

    .medications-panel-title {
      font-family: $primary-font;
      font-weight: $font-weight-semibold;
      color: $text-primary;
      font-size: 1.5rem;
      margin: 0 0 1rem 0;
      padding: 1rem 0 0.5rem 0;
      position: sticky;
      top: 4rem; // Offset from the top when scrolling
      background-color: white;
      z-index: 10;
    }

    .medications-scroll {
      flex: 1;
      padding: 0 0 2rem 0;

      app-analysis-medication-item {
        &.clickable {
          cursor: pointer;
          transition: transform 0.15s ease;
          
          &:hover {
            transform: translateY(-2px);
            
            ::ng-deep .medication-item {
              border: 2px solid rgba($button-primary-background, 0.4);
              box-shadow: 0 4px 12px rgba($button-primary-background, 0.2);
              background-color: rgba($button-primary-background, 0.02);
            }
          }
        }

        &.selected {
          ::ng-deep .medication-item {
            border: 3px solid $button-primary-background;
            box-shadow: 0 6px 16px rgba($button-primary-background, 0.3);
            background-color: rgba($button-primary-background, 0.05);
          }
        }
      }

      .add-medication-button {
        width: 100%;
        padding: 1rem;
        margin-top: 1rem;
        background-color: $button-primary-background;
        color: white;
        border: none;
        border-radius: $box-border-radius;
        font-family: $primary-font;
        font-weight: $font-weight-semibold;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

        &:hover {
          background-color: darken($button-primary-background, 5%);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        &:active {
          transform: translateY(1px);
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
      }
    }
  }

  .tools-panel {
    flex: 1; // Takes remaining 60% of the space
    padding: 2rem 2rem 2rem 1rem; // Match left padding with gap between schema rows and add note buttons
    overflow-x: visible; // Ensure controls extending beyond edge are not clipped
    transition: background-color 0.3s ease;

    .tool-content,
    .no-tool-selected {
      h2 {
        font-family: $primary-font;
        font-weight: $font-weight-semibold;
        color: $text-primary;
        margin-bottom: 1rem;
      }

      p {
        font-family: $primary-font;
        color: $text-secondary;
      }
    }

    .no-tool-selected {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      
      p {
        font-size: 1.125rem;
        opacity: 0.5;
      }
    }
  }

  // Medication Schema specific styles
  .medication-schema-view {
    display: flex;
    flex-direction: column;
    height: 100%;
    padding-top: 1.5rem; // Align with medications-scroll padding-top
    margin-top: 0.125rem; // nudge the entire schema down ~3px for visual alignment
    position: relative;

    // Floating general note button in top right
    .floating-top-right {
      position: absolute;
      top: 2.5rem;
      right: 0rem;
      z-index: 11;
    }
    
    .schema-header {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 0.5fr;
      padding: 0.75rem 2rem;
      background-color: #f8f9fa;
      border: 1px solid $box-border-primary;
      border-radius: $box-border-radius-small;
      margin: 0 5rem 1rem 2rem;
      font-weight: $font-weight-semibold;
      color: $text-primary;
      font-family: $primary-font;
      text-align: center;
      position: sticky;
      top: 2rem;
      z-index: 10;

      .schema-time-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;

        .time-title {
          font-size: 0.875rem;
        }

        .time-subtitle {
          font-size: 0.65rem;
          font-weight: $font-weight-thin;
          color: $text-secondary;
          display: flex;
          gap: 0.5rem;
          justify-content: center;
        }
      }
    }

    .schema-row-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .schema-as-needed {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba($button-primary-background, 0.08);
      border: 1px solid rgba($button-primary-background, 0.2);
      border-radius: $box-border-radius;
      margin-left: 2rem;
      height: 4.5rem;
      flex: 1;

      .as-needed-text {
        font-family: $primary-font;
        font-size: 0.95rem;
        font-weight: $font-weight-semibold;
        color: $button-primary-background;
        font-style: italic;
      }
    }

    .schema-special-frequency {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(#10b981, 0.08);
      border: 1px solid rgba(#10b981, 0.3);
      border-radius: $box-border-radius;
      margin-left: 2rem;
      height: 4.5rem;
      flex: 1;

      .special-frequency-text {
        font-family: $primary-font;
        font-size: 0.95rem;
        font-weight: $font-weight-semibold;
        color: #059669;
        font-style: italic;
      }
    }

    .schema-medication-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 0.5fr;
      background-color: $box-background;
      border: 1px solid $box-border-primary;
      border-radius: $box-border-radius;
      margin-left: 2rem;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      height: 4.5rem; // Match the new medication box height (60% of 7.5rem)
      flex: 1;
      
      .schema-cell {
        display: flex;
        flex-direction: row;
        border-right: 1px solid $box-border-primary;
        padding: 0;

        &:last-child {
          border-right: none;
        }

        &.night-cell {
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0.75rem;

          .night-input {
            font-family: $primary-font;
            color: $text-primary;
            font-weight: $font-weight-regular;
            font-size: 0.95rem;
            text-align: center;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            width: 4rem;
            background-color: transparent;
            transition: all 0.2s ease;

            &:hover {
              background-color: #f8f9fa;
              border-color: $box-border-primary;
            }

            &:focus {
              outline: none;
              background-color: white;
              border-color: $button-primary-background;
              box-shadow: 0 0 0 2px rgba($button-primary-background, 0.1);
            }

            &::placeholder {
              color: $text-secondary;
              opacity: 0.5;
            }
          }
        }

        .sub-box {
          flex: 1;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 0.25rem;
          padding: 0.75rem 0.5rem;
          border-right: 1px solid lighten($box-border-primary, 10%);

          &:last-child {
            border-right: none;
          }

          .value-label {
            font-size: 0.65rem;
            font-weight: $font-weight-thin;
            color: $text-secondary;
            text-align: center;
          }

          .value-input {
            font-family: $primary-font;
            color: $text-primary;
            font-weight: $font-weight-regular;
            font-size: 0.95rem;
            text-align: center;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            width: 4rem;
            background-color: transparent;
            transition: all 0.2s ease;

            &:hover {
              background-color: #f8f9fa;
              border-color: $box-border-primary;
            }

            &:focus {
              outline: none;
              background-color: white;
              border-color: $button-primary-background;
              box-shadow: 0 0 0 2px rgba($button-primary-background, 0.1);
            }

            &::placeholder {
              color: $text-secondary;
              opacity: 0.5;
            }
          }
        }
      }
    }

    .add-note-button {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      color: white;
      border: none;
      font-size: 1.5rem;
      font-weight: $font-weight-thin;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
      margin-right: 2rem;

      &:hover {
        background-color: darken($button-primary-background, 5%);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transform: scale(1.05);
      }

      &:active {
        transform: scale(0.95);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
    }
  }
}

```
--- END OF FILE: src\app\pages\analysis\analysis.page.scss ---

--- START OF FILE: src\app\pages\analysis\analysis.page.ts ---
```typescript
import { Component, OnInit, OnDestroy, ViewChild } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { TranslocoModule, TranslocoService } from '@jsverse/transloco';
import { Router } from '@angular/router';
import { Medication } from '../../components/medication-item/medication-item.component';
import { AnalysisMedicationItemComponent } from '../../components/analysis-medication-item/analysis-medication-item.component';
import { AnalysisToolbarComponent, ToolType } from '../../components/analysis-toolbar/analysis-toolbar.component';
import { MedicationSearchModalComponent } from '../../components/medication-search-modal/medication-search-modal.component';
import { MedicationNotesModalComponent } from '../../components/medication-notes-modal/medication-notes-modal.component';
import { InteractionNotesModalComponent } from '../../components/interaction-notes-modal/interaction-notes-modal.component';
import { NoteOverviewModalComponent } from '../../components/note-overview-modal/note-overview-modal.component';
import { TherapyAdherenceComponent } from '../../components/therapy-adherence/therapy-adherence.component';
import { InteractionsComponent } from '../../components/interactions/interactions.component';
import { ContraindicationsComponent } from '../../components/contraindications/contraindications.component';
import { PosologyComponent } from '../../components/posology/posology.component';
import { RenadaptorComponent } from '../../components/renadaptor/renadaptor.component';
import { GheopsComponent } from '../../components/gheops/gheops.component';
import { StartStopComponent } from '../../components/start-stop/start-stop.component';
import { QuestionnaireComponent } from '../../components/questionnaire/questionnaire.component';
import { MedicationSearchResult, Medication as ApiMedication } from '../../models/api.models';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { Subject } from 'rxjs';
import { debounceTime, takeUntil } from 'rxjs/operators';

@Component({
  selector: 'app-analysis',
  imports: [CommonModule, FormsModule, TranslocoModule, AnalysisMedicationItemComponent, AnalysisToolbarComponent, MedicationSearchModalComponent, MedicationNotesModalComponent, InteractionNotesModalComponent, NoteOverviewModalComponent, TherapyAdherenceComponent, InteractionsComponent, ContraindicationsComponent, PosologyComponent, RenadaptorComponent, GheopsComponent, StartStopComponent, QuestionnaireComponent],
  templateUrl: './analysis.page.html',
  styleUrls: ['./analysis.page.scss']
})
export class AnalysisPage implements OnInit, OnDestroy {
  medications: Medication[] = [];
  isLoading = false;
  activeTool: ToolType | null = 'medication-schema'; // Default to medication schema
  showSearchModal = false;
  editingMedication: Medication | null = null;
  showNotesModal = false;
  selectedMedicationForNotes: Medication | null = null;
  noteCategory: string = 'General'; // Track category based on tool/source
  showInteractionNotesModal = false;
  selectedInteraction: any = null;
  selectedInteractionType: 'drug-drug' | 'drug-food' = 'drug-drug';
  showNoteOverviewModal = false;

  @ViewChild(TherapyAdherenceComponent) therapyAdherenceComponent?: TherapyAdherenceComponent;
  @ViewChild(InteractionsComponent) interactionsComponent?: InteractionsComponent;
  @ViewChild(ContraindicationsComponent) contraindicationsComponent?: ContraindicationsComponent;
  @ViewChild(PosologyComponent) posologyComponent?: PosologyComponent;
  @ViewChild(RenadaptorComponent) renadaptorComponent?: RenadaptorComponent;

  private schemaChangeSubject = new Subject<Medication>();
  private destroy$ = new Subject<void>();

  private toolTitles: Record<ToolType, string> = {
    'medication-schema': 'medication.medication_schema',
    'therapy-adherence': 'tools.therapy_adherence',
    'interactions': 'tools.interactions',
    'contra-indications': 'tools.contraindications',
    'posology': 'tools.posology',
    'renadapter': 'tools.renadaptor',
  'gheops': 'tools.gheops',
    'start-stop-nl': 'tools.start_stop',
    'questionnaire': 'Questionnaire'
  };

  constructor(
    private apiService: ApiService,
    private stateService: StateService,
    private router: Router,
    private transloco: TranslocoService
  ) {}

  ngOnInit() {
    this.loadMedications();
    
    // Set up debounced auto-save for schema changes
    this.schemaChangeSubject
      .pipe(
        debounceTime(1000),
        takeUntil(this.destroy$)
      )
      .subscribe(medication => {
        this.saveSchemaChanges(medication);
      });

    // Listen for note overview modal requests
    this.stateService.noteOverviewModal$
      .pipe(takeUntil(this.destroy$))
      .subscribe(() => {
        this.openNoteOverview();
      });
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
  }

  onSchemaValueChange(medication: Medication) {
    console.log('[AnalysisPage] Schema value changed for medication:', medication.name);
    this.schemaChangeSubject.next(medication);
  }

  private saveSchemaChanges(medication: Medication) {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      console.error('[AnalysisPage] No medication review ID');
      return;
    }

    console.log('[AnalysisPage] Auto-saving schema changes for:', medication.name);

    // Helper function to convert empty strings and undefined to null, keep valid numbers
    const parseNumber = (value: any): number | null => {
      if (value === '' || value === null || value === undefined) {
        return null;
      }
      const parsed = Number(value);
      return isNaN(parsed) ? null : parsed;
    };

    // Extract dosage number from dosage string (e.g., "500mg" -> 500)
    const parseDosage = (dosage: string): number | null => {
      if (!dosage) return null;
      const match = dosage.match(/(\d+\.?\d*)/);
      return match ? parseFloat(match[1]) : null;
    };

    // Send complete medication data to prevent data loss
    const updateData = {
      name: medication.name || null,
      cnk: medication.cnk ?? null,
      vmp: medication.vmp ?? null,
      dosageMg: parseDosage(medication.dosage),
      routeOfAdministration: medication.route || null,
      indication: medication.indication ? medication.indication : null,
      asNeeded: medication.asNeeded ?? false,
      specialFrequency: parseNumber(medication.specialFrequency),
      specialDescription: medication.specialDescription || null,
      unitsBeforeBreakfast: parseNumber(medication.unitsBeforeBreakfast),
      unitsDuringBreakfast: parseNumber(medication.unitsDuringBreakfast),
      unitsBeforeLunch: parseNumber(medication.unitsBeforeLunch),
      unitsDuringLunch: parseNumber(medication.unitsDuringLunch),
      unitsBeforeDinner: parseNumber(medication.unitsBeforeDinner),
      unitsDuringDinner: parseNumber(medication.unitsDuringDinner),
      unitsAtBedtime: parseNumber(medication.unitsAtBedtime)
    };

    console.log('[AnalysisPage] Update request payload:', JSON.stringify(updateData, null, 2));

    this.apiService.updateMedication(
      medicationReviewId,
      medication.medicationId,
      updateData
    ).subscribe({
      next: (response) => {
        console.log('[AnalysisPage] Schema changes saved for:', medication.name);
      },
      error: (error) => {
        console.error('[AnalysisPage] Failed to save schema changes:', error);
      }
    });
  }

  openNotesModal(medication: Medication | ApiMedication | undefined) {
    // Handle general notes (no medication)
    if (!medication) {
      console.log('[AnalysisPage] Opening general notes modal for therapy adherence');
      this.noteCategory = 'TherapyAdherence';
      this.selectedMedicationForNotes = null as any;
      this.showNotesModal = true;
      return;
    }
    
    console.log('[AnalysisPage] Opening notes modal for:', medication.name);
    
    // Convert ApiMedication to Medication format if needed
    let displayMedication: Medication;
    if ('dosage' in medication && 'route' in medication) {
      // Already in Medication format
      displayMedication = medication as Medication;
    } else {
      // Convert from ApiMedication to Medication
      const apiMed = medication as ApiMedication;
      displayMedication = {
        medicationId: apiMed.medicationId,
        name: apiMed.name || '',
        dosage: apiMed.dosageMg ? `${apiMed.dosageMg}mg` : '',
        route: apiMed.routeOfAdministration || '',
        cnk: apiMed.cnk || null,
        asNeeded: apiMed.asNeeded ?? false,
        vmp: apiMed.vmp || null,
        indication: apiMed.indication || ''
      };
    }
    
    // Set category based on active tool
    this.noteCategory = this.getCategoryForTool(this.activeTool);
    this.selectedMedicationForNotes = displayMedication;
    this.showNotesModal = true;
  }

  onNotesModalClose() {
    this.showNotesModal = false;
    this.selectedMedicationForNotes = null;
  }

  openGeneralNotesModal(toolType: string) {
    console.log('[AnalysisPage] Opening general notes modal for tool:', toolType);
    this.noteCategory = this.getCategoryForTool(toolType as ToolType);
    this.selectedMedicationForNotes = null as any; // General note, no specific medication
    this.showNotesModal = true;
  }

  openInteractionNotesModal(data: { type: 'drug-drug' | 'drug-food' | 'general', interaction: any }) {
    console.log('[AnalysisPage] Opening interaction notes modal:', data);
    
    // Handle general notes separately
    if (data.type === 'general') {
      this.noteCategory = 'Interactions';
      this.selectedMedicationForNotes = null as any; // General note, no specific medication
      this.showNotesModal = true;
      return;
    }
    
    this.selectedInteractionType = data.type;
    this.selectedInteraction = data.interaction;
    this.showInteractionNotesModal = true;
  }

  onInteractionNotesModalClose() {
    this.showInteractionNotesModal = false;
    this.selectedInteraction = null;
  }

  openReferenceNotesModal(toolType: 'gheops' | 'start-stop-nl') {
    console.log('[AnalysisPage] Opening reference notes modal for:', toolType);
    
    // Create a pseudo-medication object with the tool name for context
    const toolNames = {
  'gheops': 'GheOPS Tool',
      'start-stop-nl': 'START-STOP Criteria (NL)'
    };
    
    // Set category based on reference tool type
    this.noteCategory = toolType === 'gheops' ? 'GheOPS' : 'START-STOP-NL';
    
    this.selectedMedicationForNotes = {
      medicationId: `ref-${toolType}`,
      name: toolNames[toolType],
      dosage: '',
      route: '',
      cnk: null,
      vmp: null,
      indication: 'Reference Document'
    };
    this.showNotesModal = true;
  }

  openQuestionnaireNotesModal() {
    console.log('[AnalysisPage] Opening questionnaire notes modal - general notes for Step 1');
    
    // Set category to map to Part 1 general questions in the actions page
    this.noteCategory = 'General';
    this.selectedMedicationForNotes = null as any; // General note, no specific medication
    this.showNotesModal = true;
  }

  openContraindicationNotesModal(data: { type: 'match' | 'product' | 'general', contraindication: any }) {
    console.log('[AnalysisPage] Opening contraindication notes modal:', data);
    
    // Handle general notes separately
    if (data.type === 'general' || !data.contraindication) {
      this.noteCategory = 'Contraindications';
      this.selectedMedicationForNotes = null as any; // General note, no specific medication
      this.showNotesModal = true;
      return;
    }
    
    // For specific contraindication notes, create a medication context
    const cnk = data.contraindication.medicationCnk || data.contraindication.cnk;
    const medName = data.contraindication.medication || data.contraindication.medicationName || 'Unknown Medication';
    
    this.noteCategory = 'Contraindications';
    this.selectedMedicationForNotes = {
      medicationId: `contraindication-${cnk}`,
      name: `${medName} - ${data.contraindication.condition}`,
      dosage: '',
      route: '',
      cnk: cnk ? parseInt(cnk) : null,
      vmp: null,
      indication: data.contraindication.condition
    };
    this.showNotesModal = true;
  }

  loadMedications() {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      this.medications = [];
      return;
    }

    this.isLoading = true;
    console.log('[AnalysisPage] Loading medications for review:', medicationReviewId);
    
    this.apiService.getMedications(medicationReviewId).subscribe({
      next: (medications) => {
        console.log('[AnalysisPage] Received medications:', medications);
        
        this.medications = medications.map(med => ({
          medicationId: med.medicationId,
          name: med.name || '',
          dosage: med.dosageMg ? `${med.dosageMg}mg` : '',
          route: med.routeOfAdministration || '',
          cnk: med.cnk ?? null,
          vmp: med.vmp ?? null,
          packageSize: med.packageSize ?? null,
          indication: med.indication ?? null,
          asNeeded: med.asNeeded ?? false,
          specialFrequency: med.specialFrequency ?? null,
          specialDescription: med.specialDescription ?? null,
          unitsBeforeBreakfast: med.unitsBeforeBreakfast ?? null,
          unitsDuringBreakfast: med.unitsDuringBreakfast ?? null,
          unitsBeforeLunch: med.unitsBeforeLunch ?? null,
          unitsDuringLunch: med.unitsDuringLunch ?? null,
          unitsBeforeDinner: med.unitsBeforeDinner ?? null,
          unitsDuringDinner: med.unitsDuringDinner ?? null,
          unitsAtBedtime: med.unitsAtBedtime ?? null
        }));
        
        this.isLoading = false;
      },
      error: (error) => {
        console.error('[AnalysisPage] Failed to load medications:', error);
        this.medications = [];
        this.isLoading = false;
      }
    });
  }

  onToolSelected(tool: ToolType) {
    this.activeTool = tool;
    console.log('[AnalysisPage] Selected tool:', tool);
    
    // Refresh therapy adherence data when that tool is selected
    if (tool === 'therapy-adherence') {
      console.log('[AnalysisPage] Refreshing therapy adherence data');
      setTimeout(() => {
        if (this.therapyAdherenceComponent) {
          this.therapyAdherenceComponent.refreshData();
        }
      }, 0);
    }
  }

  getToolTitle(): string {
    return this.activeTool ? this.transloco.translate(this.toolTitles[this.activeTool]) : '';
  }

  getLocalizedPeriod(specialDescription: string): string {
    if (!specialDescription) return '';
    const key = `medication.period_${specialDescription}`;
    return this.transloco.translate(key);
  }

  onMedicationBoxClick(medication: Medication) {
    // Handle clicks based on active tool
    if (this.activeTool === 'interactions' && this.interactionsComponent) {
      this.interactionsComponent.onMedicationClick(medication.medicationId);
    } else if (this.activeTool === 'contra-indications' && this.contraindicationsComponent) {
      this.contraindicationsComponent.onMedicationClick(medication.medicationId);
    } else if (this.activeTool === 'posology' && this.posologyComponent) {
      this.posologyComponent.onMedicationClick(medication.medicationId);
    } else if (this.activeTool === 'renadapter' && this.renadaptorComponent) {
      this.renadaptorComponent.onMedicationClick(medication.medicationId);
    }
  }

  isSelectedForInteractions(medicationId: string): boolean {
    return this.interactionsComponent?.isMedicationSelected(medicationId) ?? false;
  }

  isSelectedForContraindications(medicationId: string): boolean {
    return this.contraindicationsComponent?.isMedicationSelected(medicationId) ?? false;
  }

  isSelectedForPosology(medicationId: string): boolean {
    return this.posologyComponent?.isMedicationSelected(medicationId) ?? false;
  }

  isSelectedForRenadaptor(medicationId: string): boolean {
    return this.renadaptorComponent?.isMedicationSelected(medicationId) ?? false;
  }

  onMedicationDeleted(medicationId: string) {
    console.log('[AnalysisPage] Medication deleted:', medicationId);
    this.medications = this.medications.filter(med => med.medicationId !== medicationId);
    
    // Refresh child components
    this.refreshChildComponents();
  }

  onEditRequested(medication: Medication) {
    console.log('[AnalysisPage] Edit requested for medication:', medication.name);
    this.editingMedication = medication;
    this.showSearchModal = true;
  }

  addMedication() {
    console.log('[AnalysisPage] Add medication clicked');
    this.editingMedication = null;
    this.showSearchModal = true;
  }

  onModalClose() {
    this.showSearchModal = false;
    this.editingMedication = null;
  }

  onMedicationSelected(medication: MedicationSearchResult) {
    const medicationReviewId = this.stateService.medicationReviewId;
    if (!medicationReviewId) {
      console.error('[AnalysisPage] No medication review ID');
      return;
    }

    // Check if we're editing an existing medication
    if (this.editingMedication) {
      console.log('[AnalysisPage] Replacing medication:', this.editingMedication.name, 'with:', medication.benaming);

      // Update the existing medication while preserving intake and indication
      this.apiService.updateMedication(
        medicationReviewId,
        this.editingMedication.medicationId,
        {
          name: medication.benaming,
          cnk: parseInt(medication.cnk) || undefined,
          vmp: medication.vmp ? parseInt(medication.vmp) : undefined,
          // Preserve existing values
          indication: this.editingMedication.indication || undefined,
          unitsBeforeBreakfast: this.editingMedication.unitsBeforeBreakfast ?? undefined,
          unitsDuringBreakfast: this.editingMedication.unitsDuringBreakfast ?? undefined,
          unitsBeforeLunch: this.editingMedication.unitsBeforeLunch ?? undefined,
          unitsDuringLunch: this.editingMedication.unitsDuringLunch ?? undefined,
          unitsBeforeDinner: this.editingMedication.unitsBeforeDinner ?? undefined,
          unitsDuringDinner: this.editingMedication.unitsDuringDinner ?? undefined,
          unitsAtBedtime: this.editingMedication.unitsAtBedtime ?? undefined
        }
      ).subscribe({
        next: (response) => {
          console.log('[AnalysisPage] Medication updated:', response);
          this.showSearchModal = false;
          this.editingMedication = null;
          this.loadMedications();
          
          // Refresh child components after medication list updates
          setTimeout(() => this.refreshChildComponents(), 100);
        },
        error: (error) => {
          console.error('[AnalysisPage] Failed to update medication:', error);
          alert('Failed to update medication. Please try again.');
        }
      });
    } else {
      // Adding new medication
      console.log('[AnalysisPage] Adding medication:', medication);

      this.apiService.addMedication(
        medicationReviewId,
        {
          name: medication.benaming,
          cnk: parseInt(medication.cnk) || undefined,
          vmp: medication.vmp ? parseInt(medication.vmp) : undefined
        }
      ).subscribe({
        next: (response) => {
          console.log('[AnalysisPage] Medication added:', response);
          this.showSearchModal = false;
          this.loadMedications();
          
          // Refresh child components after medication list updates
          setTimeout(() => this.refreshChildComponents(), 100);
        },
        error: (error) => {
          console.error('[AnalysisPage] Failed to add medication:', error);
          alert('Failed to add medication. Please try again.');
        }
      });
    }
  }
  
  private refreshChildComponents() {
    console.log('[AnalysisPage] Refreshing child components');
    
    // Refresh therapy adherence component
    if (this.therapyAdherenceComponent) {
      this.therapyAdherenceComponent.refreshData();
    }
    
    // Refresh interactions component
    if (this.interactionsComponent) {
      this.interactionsComponent.refreshInteractions();
    }
    
    // Refresh contraindications component
    if (this.contraindicationsComponent) {
      this.contraindicationsComponent.refreshContraindications();
    }
  }

  openNoteOverview() {
    console.log('[AnalysisPage] Opening note overview modal');
    this.showNoteOverviewModal = true;
  }

  closeNoteOverview() {
    console.log('[AnalysisPage] Closing note overview modal');
    this.showNoteOverviewModal = false;
  }

  onCreatePatientConversation() {
    console.log('[AnalysisPage] Creating patient conversation - navigating to anamnesis');
    this.showNoteOverviewModal = false;
    this.router.navigate(['/anamnesis']);
  }

  private getCategoryForTool(tool: ToolType | null): string {
    const categoryMap: Record<ToolType, string> = {
      'medication-schema': 'MedicationSchema',
      'therapy-adherence': 'TherapyAdherence',
      'interactions': 'Interactions',
      'contra-indications': 'Contraindications',
      'posology': 'Posology',
      'renadapter': 'Renadapter',
      'gheops': 'GheOPS',
      'start-stop-nl': 'START-STOP-NL',
      'questionnaire': 'Questionnaire'
    };
    return tool ? categoryMap[tool] : 'General';
  }
}

```
--- END OF FILE: src\app\pages\analysis\analysis.page.ts ---

--- START OF FILE: src\app\pages\anamnesis\anamnesis.page.html ---
```typescript
<div class="anamnesis-page">
  <div class="page-header">
  <h1>Actions</h1>
  <div class="header-actions">
    <button class="btn-secondary btn-download" (click)="downloadPdf()" [title]="'pdf.download' | transloco">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-printer" viewBox="0 0 16 16">
        <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
        <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1"/>
      </svg>
      {{ 'pdf.download' | transloco }}
    </button>
    <button class="btn-primary" (click)="goToDocumentation()" [title]="'documentation.open' | transloco">{{ 'documentation.open' | transloco }}</button>
  </div>
  </div>

  <!-- Part Selector Tabs -->
  <div class="part-tabs">
    <button 
      class="part-tab" 
      [class.active]="currentPart === 'part1'"
      (click)="switchPart('part1')">
      <span class="tab-number">1</span>
      <span class="tab-label">{{ 'anamnesis.general_questions' | transloco }}</span>
      <span class="tab-percentage">{{ getPartProgress('part1') }}%</span>
    </button>
    <button 
      class="part-tab" 
      [class.active]="currentPart === 'part2'"
      (click)="switchPart('part2')">
      <span class="tab-number">2</span>
      <span class="tab-label">{{ 'anamnesis.therapy_adherence' | transloco }}</span>
      <span class="tab-percentage">{{ getPartProgress('part2') }}%</span>
    </button>
    <button 
      class="part-tab" 
      [class.active]="currentPart === 'part3'"
      (click)="switchPart('part3')">
      <span class="tab-number">3</span>
      <span class="tab-label">{{ 'anamnesis.effectiveness_side_effects' | transloco }}</span>
      <span class="tab-percentage">{{ getPartProgress('part3') }}%</span>
    </button>
  </div>

  <div class="content-container">
    <!-- Left Panel: Question Boxes (40%) -->
    <div class="question-boxes-panel">
      <div class="panel-header">
        <span>{{ 'anamnesis.question_categories' | transloco }}</span>
      </div>
      <div class="question-boxes-list">
        @for (box of questionBoxes; track box.id) {
          <div 
            class="question-box" 
            [class.selected]="selectedBox?.id === box.id"
            (click)="selectBox(box)">
            <div class="box-title">{{ box.title }}</div>
            <div class="box-count">{{ getAnsweredQuestionCount(box) }} out of {{ getVisibleQuestionCount(box) }} questions answered [{{ getQuestionProgress(box) }}%]</div>
            <div class="box-share-counters">
              <span class="share-counter patient-counter">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                {{ getShareWithPatientCount(box) }}
              </span>
              <span class="share-counter doctor-counter">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="1"></circle>
                  <path d="M12 1v6m0 6v6"></path>
                  <path d="M4.22 4.22l4.24 4.24m5.08 0l4.24-4.24M4.22 19.78l4.24-4.24m5.08 0l4.24 4.24"></path>
                </svg>
                {{ getShareWithDoctorCount(box) }}
              </span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getQuestionProgress(box)"></div>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Right Panel: Question Details (60%) -->
    <div class="question-details-panel">
      @if (selectedBox) {
        <div class="panel-header">{{ selectedBox.title }}</div>

        <div class="questions-container">
          <!-- Existing Notes (if any) -->
          @for (note of getNotesForSelectedBox(); track note.rowKey) {
            <div class="question-item">
              <div class="existing-note-header">
                <span class="note-category-badge">{{ note.category }}</span>
                <span class="note-timestamp">{{ note.timestamp | date:'short' }}</span>
              </div>
              <div class="existing-note-text">{{ note.text }}</div>
              <label class="question-label">{{ 'anamnesis_dynamic.pharmacist_action' | transloco }}</label>
              <textarea 
                class="question-textarea pharmacist-action"
                [value]="getNoteComment(note.rowKey)"
                (input)="onNoteCommentChange(note.rowKey, $event)"
                [placeholder]="'anamnesis_dynamic.pharmacist_action_placeholder' | transloco"
                rows="2"></textarea>
              <div class="pharmacist-note-sharing">
                <label class="share-checkbox">
                  <input 
                    type="checkbox"
                    [checked]="getNoteShareWithPatient(note.rowKey)"
                    (change)="onNoteShareChange(note.rowKey, 'patient', $event)">
                  <span>{{ 'anamnesis_dynamic.share_with_patient' | transloco }}</span>
                </label>
                <label class="share-checkbox">
                  <input 
                    type="checkbox"
                    [checked]="getNoteShareWithDoctor(note.rowKey)"
                    (change)="onNoteShareChange(note.rowKey, 'doctor', $event)">
                  <span>{{ 'anamnesis_dynamic.share_with_doctor' | transloco }}</span>
                </label>
              </div>
            </div>
          }

          <!-- Regular Questions -->
          @for (question of selectedBox.questions; track question.name) {
            @if (!question.hidden) {
              <div class="question-item">
                <label class="question-label">{{ question.text }}</label>
                
                @switch (question.type) {
                  @case ('text') {
                    <input 
                      type="text" 
                      class="question-input"
                      [(ngModel)]="question.value"
                      (ngModelChange)="onQuestionChange(question.name, $event)"
                      placeholder="Enter your answer">
                  }
                  @case ('textarea') {
                    <textarea 
                      [class]="(question.name.includes('_action') || question.name.includes('Action') || (question.name.includes('_notes') && currentPart === 'part2')) ? 'question-textarea pharmacist-action' : 'question-textarea'"
                      [(ngModel)]="question.value"
                      (ngModelChange)="onQuestionChange(question.name, $event)"
                      [placeholder]="(question.name.includes('_action') || question.name.includes('Action') || (question.name.includes('_notes') && currentPart === 'part2')) ? ('anamnesis_dynamic.pharmacist_action_placeholder' | transloco) : 'Enter your answer'"
                      rows="3"></textarea>
                    @if (question.name.includes('_action') || question.name.includes('Action') || (question.name.includes('_notes') && currentPart === 'part2')) {
                      <div class="pharmacist-note-sharing">
                        <label class="share-checkbox">
                          <input 
                            type="checkbox"
                            [(ngModel)]="question.shareWithPatient"
                            (ngModelChange)="onShareCheckboxChange(question.name)">
                          <span>{{ 'anamnesis_dynamic.share_with_patient' | transloco }}</span>
                        </label>
                        <label class="share-checkbox">
                          <input 
                            type="checkbox"
                            [(ngModel)]="question.shareWithDoctor"
                            (ngModelChange)="onShareCheckboxChange(question.name)">
                          <span>{{ 'anamnesis_dynamic.share_with_doctor' | transloco }}</span>
                        </label>
                      </div>
                    }
                  }
                  @case ('checkbox') {
                    <div class="question-checkbox">
                      <input 
                        type="checkbox" 
                        [id]="question.name"
                        [(ngModel)]="question.value"
                        (ngModelChange)="onQuestionChange(question.name, $event)">
                      <label [for]="question.name">Yes</label>
                    </div>
                  }
                  @case ('radio') {
                    <div class="question-radio-group">
                      @for (option of question.options; track option) {
                        <label class="question-radio">
                          <input 
                            type="radio" 
                            [name]="question.name"
                            [value]="option"
                            [(ngModel)]="question.value"
                            (ngModelChange)="onQuestionChange(question.name, $event)">
                          <span>{{ option === true ? ('common.yes' | transloco) : (option === false ? ('common.no' | transloco) : (option === 'Yes' ? ('anamnesis_dynamic.yes' | transloco) : (option === 'No' ? ('anamnesis_dynamic.no' | transloco) : option))) }}</span>
                        </label>
                      }
                    </div>
                  }
                  @case ('number') {
                    <input 
                      type="number" 
                      class="question-input"
                      [(ngModel)]="question.value"
                      (ngModelChange)="onQuestionChange(question.name, $event)"
                      min="0"
                      placeholder="0">
                  }
                  @case ('date') {
                    <input 
                      type="date" 
                      class="question-input"
                      [(ngModel)]="question.value"
                      (ngModelChange)="onQuestionChange(question.name, $event)">
                  }
                }
              </div>
            }
          }
        </div>
      } @else {
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="18" x2="12" y2="12"></line>
            <line x1="9" y1="15" x2="15" y2="15"></line>
          </svg>
          <p>Select a question category from the left to begin</p>
        </div>
      }
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\pages\anamnesis\anamnesis.page.html ---

--- START OF FILE: src\app\pages\anamnesis\anamnesis.page.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.anamnesis-page {
  height: 93vh;
  display: flex;
  flex-direction: column;
  background-color: $main-background;
  overflow: hidden;

  .page-header {
    background-color: transparent; // keep header transparent as requested
    padding: 1.25rem 1.5rem;
    border: none;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    flex-shrink: 0;
    flex-wrap: wrap;

    .back-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background-color: transparent;
      border: 1px solid $box-border;
      border-radius: 6px;
      color: $text-secondary;
      font-family: $primary-font;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;

      &:hover {
        background-color: $main-background;
        border-color: $button-primary-background;
        color: $button-primary-background;
      }

      svg {
        flex-shrink: 0;
      }
    }

    h1 {
      flex: 1;
      margin: 0;
      font-family: $primary-font;
      font-weight: $font-weight-semibold;
      font-size: 1.5rem;
      color: $text-primary;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .btn-download {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.65rem 1.25rem;
      font-size: 0.9375rem;

      svg {
        flex-shrink: 0;
      }
    }

    .btn-primary {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.65rem 1.25rem;
      background-color: $button-primary-background;
      color: $text-button-primary;
      border: none;
      border-radius: $box-border-radius-small;
      font-family: $primary-font;
      font-size: 0.9rem;
      font-weight: $font-weight-medium;
      cursor: pointer;
      transition: all 0.12s ease;

      &:hover {
        background-color: darken($button-primary-background, 5%);
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(69, 75, 96, 0.12);
      }

      &:active {
        transform: translateY(0);
      }
    }

    .notes-count {
      padding: 0.375rem 0.875rem;
      background-color: rgba($button-primary-background, 0.1);
      color: $button-primary-background;
      border-radius: 20px;
      font-family: $primary-font;
      font-size: 0.875rem;
      font-weight: $font-weight-medium;
    }

    .pdf-actions {
      display: flex;
      gap: 0.75rem;
      margin-left: auto;

      button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.55rem 1rem;
        border-radius: $box-border-radius-small;
        font-family: $primary-font;
        font-size: 0.9rem;
        font-weight: $font-weight-medium;
        cursor: pointer;
        transition: all 0.12s ease;

        svg {
          flex-shrink: 0;
        }
      }

      .btn-primary {
        background-color: $button-primary-background;
        color: $text-button-primary;
        border: none;

        &:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 18px rgba(69,75,96,0.12);
        }
      }

      .btn-secondary {
        background-color: $box-background;
        color: $text-primary;
        border: $box-border-width solid $box-border;

        &:hover {
          background-color: $main-background;
          border-color: $button-primary-background;
          color: $button-primary-background;
        }
      }
    }
  }

  .part-tabs {
    display: flex;
    gap: 0.5rem;
    padding: 0 1.5rem;
    background-color: transparent; // keep tabs background transparent as requested
    border-bottom: 1px solid $box-border;
    flex-shrink: 0;

    .part-tab {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.875rem 1.25rem;
      background-color: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      font-family: $primary-font;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;

      &:hover {
        background-color: rgba($button-primary-background, 0.05);
      }

      &.active {
        border-bottom-color: $button-primary-background;
        
        .tab-number {
          background-color: $button-primary-background;
          color: white;
        }

        .tab-label {
          color: $button-primary-background;
          font-weight: $font-weight-semibold;
        }
      }

      .tab-number {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 1.75rem;
        height: 1.75rem;
        border-radius: 50%;
        background-color: $main-background;
        color: $text-secondary;
        font-size: 0.875rem;
        font-weight: $font-weight-semibold;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .tab-label {
        font-size: 0.9375rem;
        color: $text-secondary;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .tab-percentage {
        margin-left: 0.5rem;
        padding: 0.25rem 0.5rem;
        background-color: rgba($button-primary-background, 0.1);
        color: $text-secondary;
        border-radius: 4px;
        font-size: 0.8125rem;
        font-weight: $font-weight-semibold;
        transition: all 0.2s ease;
        min-width: 3rem;
        text-align: center;
      }

      &.active .tab-percentage {
        background-color: rgba($button-primary-background, 0.15);
        color: $button-primary-background;
      }
    }
  }

  .content-container {
    flex: 1;
    display: flex;
    flex-direction: row;
    gap: 1.5rem;
    padding: 1.5rem;
    overflow: hidden;

    // Left Panel: Question Boxes (40%)
    .question-boxes-panel {
      flex: 0 0 40%;
      display: flex;
      flex-direction: column;
      background-color: $box-background;
      border: 1px solid $box-border;
      border-radius: 8px;
      overflow: hidden;

      .panel-header {
        background-color: $box-background;
        border-bottom: 1px solid $box-border;
        padding: 0.5rem 0.75rem;
        font-family: $primary-font;
        font-weight: $font-weight-semibold;
        font-size: 1rem;
        color: $text-primary;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;

        span {
          display: inline-block;
          font-size: 1rem;
          color: $text-primary;
        }

        .btn-icon {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 36px;
          height: 36px;
          padding: 6px;
          border-radius: 6px;
          border: 1px solid transparent;
          background: transparent;
          cursor: pointer;
          transition: background-color 0.12s ease, border-color 0.12s ease, transform 0.08s ease;

          svg {
            width: 18px;
            height: 18px;
            color: $text-secondary;
          }

          &:hover {
            background-color: rgba($button-primary-background, 0.06);
            border-color: rgba($button-primary-background, 0.12);
            svg { color: $button-primary-background; }
            transform: translateY(-1px);
          }

          &:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba($button-primary-background, 0.08);
            border-color: rgba($button-primary-background, 0.16);
          }
        }

        .btn-print {
          // slightly stronger contrast for the print icon
          svg { color: $text-secondary; }
        }
      }

      .question-boxes-list {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;

        .question-box {
          padding: 1rem;
          background-color: $main-background;
          border: 2px solid $box-border;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.2s ease;

          &:hover {
            border-color: $button-primary-background;
            background-color: rgba($button-primary-background, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(69, 75, 96, 0.08);
          }

          &.selected {
            border-color: $button-primary-background;
            background-color: rgba($button-primary-background, 0.1);
            box-shadow: 0 4px 12px rgba(69, 75, 96, 0.12);
          }

          .box-title {
            font-family: $primary-font;
            font-weight: $font-weight-semibold;
            font-size: 1rem;
            color: $text-primary;
            margin-bottom: 0.375rem;
          }

          .box-count {
            font-family: $primary-font;
            font-size: 0.75rem;
            color: $text-muted;
            font-style: italic;
            margin-bottom: 0.5rem;
          }

          .box-share-counters {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.75rem;

            .share-counter {
              display: flex;
              align-items: center;
              gap: 0.375rem;
              padding: 0.25rem 0.5rem;
              background-color: rgba($button-primary-background, 0.08);
              border-radius: 4px;
              font-family: $primary-font;
              font-size: 0.7rem;
              font-weight: $font-weight-medium;
              color: $button-primary-background;

              svg {
                flex-shrink: 0;
                opacity: 0.8;
              }

              &.patient-counter {
                background-color: rgba(52, 152, 219, 0.08);
                color: #3498db;

                svg {
                  color: #3498db;
                }
              }

              &.doctor-counter {
                background-color: rgba(155, 89, 182, 0.08);
                color: #9b59b6;

                svg {
                  color: #9b59b6;
                }
              }
            }
          }

          .progress-bar {
            width: 100%;
            height: 3px;
            background-color: rgba($box-border, 0.3);
            border-radius: 2px;
            margin-top: 0.75rem;
            overflow: hidden;

            .progress-fill {
              height: 100%;
              background: linear-gradient(90deg, $medication-indication 0%, darken($medication-indication, 15%) 100%);
              transition: width 0.3s ease;
              border-radius: 2px;
            }
          }
        }
      }
    }

    // Right Panel: Question Details (60%)
    .question-details-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: $box-background;
      border: 1px solid $box-border;
      border-radius: 8px;
      overflow: hidden;

      .panel-header {
        background-color: $box-background;
        border-bottom: 1px solid $box-border;
        padding: 1rem 1.25rem;
        font-family: $primary-font;
        font-weight: $font-weight-semibold;
        font-size: 1.125rem;
        color: $text-primary;
        flex-shrink: 0;
      }

      .questions-container {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;

        .question-item {
          display: flex;
          flex-direction: column;
          gap: 0.5rem;

          .existing-note-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.25rem;

            .note-category-badge {
              display: inline-block;
              padding: 0.2rem 0.5rem;
              background-color: rgba($button-primary-background, 0.1);
              color: $button-primary-background;
              border-radius: 3px;
              font-family: $primary-font;
              font-size: 0.65rem;
              font-weight: $font-weight-medium;
              text-transform: uppercase;
              letter-spacing: 0.02em;
            }

            .note-timestamp {
              font-family: $primary-font;
              font-size: 0.7rem;
              color: $text-muted;
            }
          }

          .existing-note-text {
            font-family: $primary-font;
            font-size: 0.9375rem;
            font-weight: $font-weight-medium;
            color: $text-primary;
            line-height: 1.5;
            padding: 0.75rem;
            background-color: rgba($button-primary-background, 0.05);
            border-left: 3px solid $button-primary-background;
            border-radius: 4px;
            white-space: pre-wrap;
            margin-bottom: 0.25rem;
          }

          .question-label {
            font-family: $primary-font;
            font-weight: $font-weight-medium;
            font-size: 0.9375rem;
            color: $text-primary;
            line-height: 1.5;
          }

          .question-input {
            padding: 0.625rem 0.875rem;
            background-color: white;
            border: 1px solid $box-border;
            border-radius: 6px;
            font-family: $primary-font;
            font-size: 0.875rem;
            color: $text-primary;
            transition: all 0.2s ease;

            &:focus {
              outline: none;
              border-color: $button-primary-background;
              box-shadow: 0 0 0 3px rgba($button-primary-background, 0.1);
            }

            &::placeholder {
              color: $text-muted;
            }
          }

          .question-textarea {
            padding: 0.625rem 0.875rem;
            background-color: white;
            border: 1px solid $box-border;
            border-radius: 6px;
            font-family: $primary-font;
            font-size: 0.875rem;
            color: $text-primary;
            resize: vertical;
            min-height: 80px;
            transition: all 0.2s ease;

            &:focus {
              outline: none;
              border-color: $button-primary-background;
              box-shadow: 0 0 0 3px rgba($button-primary-background, 0.1);
            }

            &::placeholder {
              color: $text-muted;
            }

            &.pharmacist-action {
              background-color: rgba($button-primary-background, 0.02);
              border-left: 3px solid $button-primary-background;
              border-radius: 6px;
              min-height: 100px;

              &:focus {
                background-color: white;
                border-color: $button-primary-background;
                box-shadow: 0 0 0 3px rgba($button-primary-background, 0.08);
              }
            }
          }

          .question-checkbox {
            display: flex;
            align-items: center;
            gap: 0.625rem;

            input[type="checkbox"] {
              width: 1.125rem;
              height: 1.125rem;
              cursor: pointer;
              accent-color: $button-primary-background;
            }

            label {
              font-family: $primary-font;
              font-size: 0.875rem;
              color: $text-secondary;
              cursor: pointer;
              user-select: none;
            }
          }

          .pharmacist-note-sharing {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.5rem;
            padding: 0.625rem 0.875rem;
            background-color: rgba($button-primary-background, 0.03);
            border-radius: 6px;
            border-left: 3px solid rgba($button-primary-background, 0.3);

            .share-checkbox {
              display: flex;
              align-items: center;
              gap: 0.5rem;
              cursor: pointer;
              user-select: none;

              input[type="checkbox"] {
                width: 1rem;
                height: 1rem;
                cursor: pointer;
                accent-color: $button-primary-background;
              }

              span {
                font-family: $primary-font;
                font-size: 0.8125rem;
                color: $text-secondary;
                font-weight: $font-weight-medium;
              }

              &:hover span {
                color: $text-primary;
              }
            }
          }

          .question-radio-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;

            .question-radio {
              display: flex;
              align-items: center;
              gap: 0.5rem;
              cursor: pointer;
              user-select: none;

              input[type="radio"] {
                width: 1.125rem;
                height: 1.125rem;
                cursor: pointer;
                accent-color: $button-primary-background;
              }

              span {
                font-family: $primary-font;
                font-size: 0.875rem;
                color: $text-secondary;
              }

              &:hover span {
                color: $text-primary;
              }
            }
          }
        }
      }

      .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem 2rem;
        gap: 1rem;

        svg {
          color: $text-muted;
          opacity: 0.5;
        }

        p {
          font-family: $primary-font;
          font-size: 0.9375rem;
          color: $text-muted;
          text-align: center;
          margin: 0;
        }
      }
    }

    .section {
      display: flex;
      flex-direction: column;
      background-color: $box-background;
      border: 1px solid $box-border;
      border-radius: 8px;

      .section-header {
        background-color: $box-background;
        border-bottom: 1px solid $box-border;
        padding: 1rem 1.25rem;
        font-family: $primary-font;
        font-weight: $font-weight-semibold;
        font-size: 1.125rem;
        color: $text-primary;
        flex-shrink: 0;
      }

      .accordion-list,
      .medication-list {
        padding: 0;
        background-color: $box-background;
        border: 1px solid $box-border;
        border-top: none;
        border-radius: 0 0 8px 8px;
        padding: 0.75rem;
      }

      .accordion-item {
        margin-bottom: 0.75rem;

        &:last-child {
          margin-bottom: 0;
        }

        .accordion-toggle {
          width: 100%;
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.875rem 1rem;
          background-color: $main-background;
          border: 1px solid $box-border;
          border-radius: 6px;
          font-family: $primary-font;
          font-size: 0.9375rem;
          color: $text-primary;
          text-align: left;
          cursor: pointer;
          transition: all 0.2s ease;

          &:hover {
            background-color: rgba($button-primary-background, 0.05);
            border-color: $button-primary-background;
          }

          .chev {
            font-size: 0.875rem;
            color: $text-muted;
            transition: transform 0.2s ease;

            &.open {
              transform: rotate(-180deg);
            }
          }
        }

        .accordion-body {
          padding: 1rem;
          background-color: white;
          border: 1px solid $box-border;
          border-top: none;
          border-radius: 0 0 6px 6px;
          margin-top: -1px;

          .question-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;

            .question-item {
              display: flex;
              flex-direction: column;
              gap: 0.25rem;
              padding: 0.75rem;
              background-color: $main-background;
              border-radius: 6px;
              border: $box-border-width solid $box-border;

              .question-text {
                font-family: $primary-font;
                font-size: 0.875rem;
                color: $text-primary;
                line-height: 1.4;
              }

              .question-type {
                font-family: $primary-font;
                font-size: 0.7rem;
                color: $text-muted;
                font-style: italic;
              }
            }
          }
        }
      }

      .medication-card {
        background-color: $box-background;
        border: $box-border-width solid $box-border;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        overflow: hidden;

        &:last-child {
          margin-bottom: 0;
        }

        .medication-toggle {
          width: 100%;
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.875rem 1rem;
          background-color: $main-background;
          border: none;
          font-family: $primary-font;
          text-align: left;
          cursor: pointer;
          transition: all 0.12s ease;

          &:hover {
            background-color: rgba($button-primary-background, 0.04);
          }

          .med-info {
            flex: 1;
            min-width: 0;

            .med-name {
              display: flex;
              align-items: center;
              gap: 0.5rem;
              font-weight: $font-weight-semibold;
              font-size: 0.95rem;
              color: $text-primary;
              margin-bottom: 0.25rem;

              .note-indicator {
                flex-shrink: 0;
                color: $button-primary-background;
                opacity: 0.7;
              }
            }

            .med-cnk {
              font-size: 0.75rem;
              color: $text-muted;
            }
          }

          .chev {
            flex-shrink: 0;
            font-size: 0.875rem;
            color: $text-muted;
            transition: transform 0.2s ease;
            margin-left: 0.5rem;

            &.open {
              transform: rotate(-180deg);
            }
          }
        }

        .med-body {
          padding: 1rem;
          background-color: $box-background;
          border-top: $box-border-width solid $box-border;

          .empty-med {
            font-family: $primary-font;
            font-size: 0.85rem;
            color: $text-muted;
            font-style: italic;
            text-align: center;
            padding: 1rem 0.5rem;
          }

          .med-note {
            padding: 0.875rem 1rem;
            background-color: $box-background;
            border: $box-border-width solid $box-border;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            transition: all 0.12s ease;

            &:hover {
              box-shadow: 0 4px 12px rgba(69,75,96,0.06);
              transform: translateY(-2px);
            }

            &:last-child {
              margin-bottom: 0;
            }

            .note-text {
              font-family: $primary-font;
              font-size: 0.9rem;
              color: $text-primary;
              line-height: 1.6;
              white-space: pre-wrap;
              margin-bottom: 0.65rem;
            }

            .note-meta {
              display: flex;
              align-items: center;
              gap: 0.65rem;
              flex-wrap: wrap;

              .note-category {
                display: inline-block;
                padding: 0.25rem 0.6rem;
                background-color: rgba($button-primary-background, 0.08);
                color: $button-primary-background;
                border-radius: 4px;
                font-family: $primary-font;
                font-size: 0.7rem;
                font-weight: $font-weight-medium;
                text-transform: uppercase;
                letter-spacing: 0.02em;
              }

              .note-ts {
                font-family: $primary-font;
                font-size: 0.75rem;
                color: $text-muted;
              }
            }
          }
        }
      }
    }
  }
}

// PDF Preview Modal
.pdf-preview-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.2s ease;

  .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .modal-content {
    position: relative;
    width: 95vw;
    max-width: 1400px;
    height: 95vh;
    background-color: $box-background;
    border-radius: $box-border-radius;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease;
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: $box-border-width solid $box-border;
    flex-shrink: 0;

    h2 {
      margin: 0;
      font-family: $secondary-font;
      font-size: 1.25rem;
      font-weight: $font-weight-semibold;
      color: $text-primary;
    }

    .close-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: $text-secondary;
      transition: color 0.12s ease;
      display: flex;
      align-items: center;
      justify-content: center;

      &:hover {
        color: $text-primary;
      }

      svg {
        display: block;
      }
    }
  }

  .modal-body {
    flex: 1;
    overflow: hidden;
    padding: 1.5rem;
    display: flex;
    min-height: 0;

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: $box-border-radius-small;
      background-color: #525659;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
  }

  .modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-top: $box-border-width solid $box-border;
    flex-shrink: 0;

    button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.65rem 1.25rem;
      border-radius: $box-border-radius-small;
      font-family: $primary-font;
      font-size: 0.9rem;
      font-weight: $font-weight-medium;
      cursor: pointer;
      transition: all 0.12s ease;

      svg {
        flex-shrink: 0;
      }
    }

    .btn-secondary {
      background-color: $box-background;
      color: $text-primary;
      border: $box-border-width solid $box-border;

      &:hover {
        background-color: $main-background;
        border-color: $button-primary-background;
        color: $button-primary-background;
      }
    }

    .btn-primary {
      background-color: $button-primary-background;
      color: $text-button-primary;
      border: none;

      &:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(69, 75, 96, 0.12);
      }
    }
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    transform: translateY(20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

```
--- END OF FILE: src\app\pages\anamnesis\anamnesis.page.scss ---

--- START OF FILE: src\app\pages\anamnesis\anamnesis.page.ts ---
```typescript
import { Component, OnInit, OnDestroy, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { Router } from '@angular/router';
import { Subject } from 'rxjs';
import { takeUntil, debounceTime, distinctUntilChanged, groupBy, mergeMap } from 'rxjs/operators';
import { TranslocoModule, TranslocoService } from '@jsverse/transloco';
import { ReviewNotesService, ReviewNote } from '../../services/review-notes.service';
import { StateService } from '../../services/state.service';
import { ApiService } from '../../services/api.service';
import { QuestionAnswer } from '../../models/api.models';
import { AnamnesisePdfService } from '../../services/anamnesis-pdf.service';

interface Question {
  name: string;
  text: string;
  type: 'text' | 'textarea' | 'checkbox' | 'number' | 'date' | 'radio';
  value: any;
  options?: (string | boolean)[]; // For radio button options - can be strings or booleans
  hidden?: boolean; // To conditionally show/hide questions
  originallyHidden?: boolean; // Original hidden state (never changes for PDF filtering)
  shareWithPatient?: boolean; // For pharmacist notes - share with patient
  shareWithDoctor?: boolean; // For pharmacist notes - share with doctor
}

interface QuestionBox {
  id: string;
  title: string;
  description?: string;
  questions: Question[];
}

@Component({
  selector: 'app-anamnesis',
  standalone: true,
  imports: [CommonModule, FormsModule, TranslocoModule],
  templateUrl: './anamnesis.page.html',
  styleUrls: ['./anamnesis.page.scss']
})
export class AnamnesisPage implements OnInit, OnDestroy {
  allQuestionBoxes: { part1: QuestionBox[], part2: QuestionBox[], part3: QuestionBox[] } = {
    part1: [],
    part2: [],
    part3: []
  };
  currentPart: 'part1' | 'part2' | 'part3' = 'part1';
  questionBoxes: QuestionBox[] = [];
  selectedBox: QuestionBox | null = null;
  questionAnswers: Map<string, QuestionAnswer> = new Map();
  medications: any[] = [];
  notes: ReviewNote[] = [];
  
  private destroy$ = new Subject<void>();
  private saveQueue$ = new Subject<{ questionName: string; value: any }>();

  private transloco = inject(TranslocoService);

  constructor(
    private reviewNotesService: ReviewNotesService,
    private stateService: StateService,
    private router: Router,
    private apiService: ApiService,
    private anamnesisePdfService: AnamnesisePdfService
  ) {}

  goToDocumentation() {
    this.router.navigate(['/report-generation']);
  }

  ngOnInit() {
    // Immediately verify session; if missing, redirect to home/login
    if (!this.stateService.medicationReviewId) {
      console.warn('[Anamnesis] No medicationReviewId in session - redirecting to home');
      this.router.navigate(['/']);
      return;
    }

    // Listen for window focus to handle session loss while user navigates away
    window.addEventListener('focus', this.handleWindowFocus);
    // Also listen for storage events so changes in other tabs can be detected
    window.addEventListener('storage', this.handleStorageEvent);

    this.initializeQuestionBoxes();
    this.loadMedications();
    this.loadNotes();
    this.loadQuestionAnswers();
    this.setupAutoSave();
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();

    // Cleanup listeners
    window.removeEventListener('focus', this.handleWindowFocus);
    window.removeEventListener('storage', this.handleStorageEvent);
  }

  // Use class properties with arrow functions so `this` is lexical when used as listener
  private handleWindowFocus = () => {
    // If session has been cleared, redirect to home/login
    if (!this.stateService.medicationReviewId) {
      console.warn('[Anamnesis] Session lost on window focus - redirecting to home');
      this.router.navigate(['/']);
    }
  };

  private handleStorageEvent = (event: StorageEvent) => {
    // If session storage was cleared in another tab, redirect
    if (event.key === null || event.key === 'medicationReviewId' || event.key === 'sessionData') {
      if (!this.stateService.medicationReviewId) {
        console.warn('[Anamnesis] Session change detected via storage event - redirecting to home');
        this.router.navigate(['/']);
      }
    }
  };

  private loadMedications() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.apiService.getMedications(reviewId)
      .pipe(takeUntil(this.destroy$))
      .subscribe({
        next: (meds) => {
          this.medications = meds || [];
          this.updatePart2And3QuestionBoxes();
          // Re-apply loaded answers to the newly created medication boxes
          this.applyLoadedAnswersToParts(['part2', 'part3']);
        },
        error: (err) => {
          console.error('[Anamnesis] Failed to load medications:', err);
        }
      });
  }

  private loadNotes() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.reviewNotesService.notes$
      .pipe(takeUntil(this.destroy$))
      .subscribe(notes => {
        this.notes = notes.filter(note => note.discussWithPatient === true);
        this.updatePart2And3QuestionBoxes();
        // Re-apply loaded answers when notes change
        this.applyLoadedAnswersToParts(['part2', 'part3']);
      });

    if (this.reviewNotesService.getNotesCount() === 0) {
      this.reviewNotesService.loadReviewNotes(reviewId);
    }
  }

  private updatePart2And3QuestionBoxes() {
    // Rebuild part 2 and 3 with medication-specific boxes
    this.initializePart2QuestionBoxes();
    this.initializePart3QuestionBoxes();
    
    // Refresh current view if on part 2 or 3
    if (this.currentPart === 'part2') {
      this.questionBoxes = this.allQuestionBoxes.part2;
    } else if (this.currentPart === 'part3') {
      this.questionBoxes = this.allQuestionBoxes.part3;
    }
  }

  private initializeQuestionBoxes() {
    // Part 1: General Questions
    this.allQuestionBoxes.part1 = [
      {
        id: 'concerns',
        title: this.transloco.translate('anamnesis.categories.concerns') || 'Bezorgdheden/Ervaringen',
        description: this.transloco.translate('anamnesis.general_questions') || 'Patient concerns and experiences with medication',
        questions: [
          { name: 'p1_concerns_tooMany', text: this.transloco.translate('pdf.patient_concern_tooMany') || 'Ervaart de patient de geneesmiddelen als te veel?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_concerns_tooManyAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true },
          { name: 'p1_concerns_financialBurden', text: this.transloco.translate('pdf.patient_concern_financialBurden') || 'Ervaart de patient financi√´le last?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_concerns_financialBurdenAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true },
          { name: 'p1_concerns_anxiety', text: this.transloco.translate('anamnesis.questions.anxiety') || 'Ervaart de patient angst?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_concerns_anxietyAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true },
          { name: 'p1_concerns_untreatedComplaints', text: this.transloco.translate('pdf.patient_concern_untreatedComplaints') || 'Ervaart de patient onvoldoende of niet behandelde klachten?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_concerns_untreatedComplaintsAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true },
          { name: 'p1_concerns_other', text: this.transloco.translate('pdf.patient_concern_other') || 'Zijn er andere bezorgdheden?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_concerns_otherAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true }
        ]
      },
      {
        id: 'medication_help',
        title: this.transloco.translate('anamnesis_dynamic.medication_help_title'),
        description: 'Assistance with medication intake',
        questions: [
          { name: 'p1_help_hasAssistance', text: this.transloco.translate('anamnesis_dynamic.what_problems') || 'Heeft de patient hulp bij inname, bijvoorbeeld een pillendoos of partner/familielid?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_help_additionalNeededQuestion', text: this.transloco.translate('pdf.medication_help_additionalNeeded') || 'Is extra hulp wenselijk voor de patient?', type: 'radio', options: [true, false], value: null, hidden: true, originallyHidden: true },
          { name: 'p1_help_additionalNeededAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true }
        ]
      },
      {
        id: 'practical_problems',
        title: this.transloco.translate('anamnesis.categories.practical_problems') || 'Praktische problemen',
        description: this.transloco.translate('pdf.practical_problems') || 'Practical issues affecting medication use',
        questions: [
          { name: 'p1_practical_swallowing', text: this.transloco.translate('pdf.practical_problem_swallowing') || 'Heeft de patient slikproblemen?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_practical_swallowingAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true },
          { name: 'p1_practical_movement', text: this.transloco.translate('pdf.practical_problem_movement') || 'Heeft de patient beweegstoornissen?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_practical_movementAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true },
          { name: 'p1_practical_vision', text: this.transloco.translate('pdf.practical_problem_vision') || 'Heeft de patient visusstoornissen?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_practical_visionAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true },
          { name: 'p1_practical_hearing', text: this.transloco.translate('pdf.practical_problem_hearing') || 'Heeft de patient gehoorstoornissen?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_practical_hearingAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true },
          { name: 'p1_practical_cognitive', text: this.transloco.translate('pdf.practical_problem_cognitive') || 'Heeft de patient cognitieve problemen?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_practical_cognitiveAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true },
          { name: 'p1_practical_dexterity', text: this.transloco.translate('pdf.practical_problem_dexterity') || 'Heeft de patient problemen met handvaardigheid?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_practical_dexterityAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true },
          { name: 'p1_practical_other', text: this.transloco.translate('pdf.practical_problem_other') || 'Zijn er andere praktische problemen?', type: 'radio', options: [true, false], value: null },
          { name: 'p1_practical_otherAction', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true }
        ]
      },
      {
        id: 'incidents',
        title: this.transloco.translate('anamnesis.categories.incidents') || 'Incidenten',
        description: this.transloco.translate('pdf.incidents') || 'Falls and hospitalizations',
        questions: [
          { name: 'p1_incidents_falls', text: this.transloco.translate('anamnesis.questions.falls') || 'Hoe vaak is de patient in de afgelopen 6 maanden gevallen?', type: 'number', value: 0 },
          { name: 'p1_incidents_hospitalizations', text: this.transloco.translate('anamnesis.questions.hospitalizations') || 'Hoe vaak is de patient gehospitaliseerd in het afgelopen jaar?', type: 'number', value: 0 },
          { name: 'p1_incidents_actionNeeded', text: this.transloco.translate('pdf.incidents_actionNeeded') || 'Is action needed?', type: 'radio', value: null, options: [true, false] },
          { name: 'p1_incidents_action', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true }
        ]
      },
      {
        id: 'followup',
        title: this.transloco.translate('anamnesis.categories.follow_up') || 'Opvolging/monitoring',
        description: this.transloco.translate('pdf.follow_up_monitoring') || 'Care providers and parameter monitoring',
        questions: [
          { name: 'p1_followup_careProviders', text: this.transloco.translate('anamnesis.questions.care_providers') || 'Door welke hulpverleners wordt de patient opgevolgd?', type: 'textarea', value: '' },
          { name: 'p1_followup_parameterMonitoring', text: this.transloco.translate('anamnesis.questions.parameter_monitoring') || 'Door welke hulpverleners worden de parameters opgevolgd?', type: 'textarea', value: '' },
          { name: 'p1_followup_actionNeeded', text: this.transloco.translate('pdf.followup_actionNeeded') || 'Is action needed?', type: 'radio', value: null, options: [true, false] },
          { name: 'p1_followup_action', text: this.transloco.translate('anamnesis_dynamic.pharmacist_action'), type: 'textarea', value: '', hidden: true, originallyHidden: true }
        ]
      }
    ];

    // Initialize part 2 and 3 (will be populated when medications load)
    this.initializePart2QuestionBoxes();
    this.initializePart3QuestionBoxes();

    // Set initial question boxes to part 1
    this.questionBoxes = this.allQuestionBoxes.part1;
  }

  private initializePart2QuestionBoxes() {
    const boxes: QuestionBox[] = [];

    // Add general notes section if there are any general adherence notes
    const generalAdherenceNotes = this.notes.filter(note => 
      !note.linkedCnk && (note.category === 'TherapyAdherence' || note.category === 'MedicationSchema')
    );

    if (generalAdherenceNotes.length > 0) {
      boxes.push({
        id: 'p2_general_notes',
        title: this.transloco.translate('tools.general_notes') || 'General Notes',
        description: `${generalAdherenceNotes.length} ${this.transloco.translate('tools.general_notes') || 'general adherence note(s)'}`,
        questions: [
          
        ]
      });
    }

    // Add a box for each medication
    this.medications.forEach(med => {
      const cnk = med.cnk != null ? String(med.cnk) : 'uncategorized';
      const medicationNotes = this.notes.filter(note => 
        String(note.linkedCnk) === cnk && (note.category === 'TherapyAdherence' || note.category === 'MedicationSchema')
      );

      boxes.push({
        id: `p2_med_${cnk}`,
        title: med.name || this.transloco.translate('pdf.no_medication') || 'Unnamed medication',
        description: `${this.transloco.translate('medication.cnk') || 'CNK'}: ${med.cnk || '‚Äî'} | ${medicationNotes.length} ${this.transloco.translate('notes.existing_notes') || 'note(s)'}`,
        questions: [
          { name: `p2_med_${cnk}_adherence`, text: this.transloco.translate('anamnesis_dynamic.takes_as_prescribed') || 'Takes as prescribed?', type: 'radio', value: null, options: [true, false] },
          { name: `p2_med_${cnk}_notes`, text: this.transloco.translate('anamnesis_dynamic.pharmacist_notes') || 'Pharmacist notes', type: 'textarea', value: '', hidden: true }
        ]
      });
    });

    this.allQuestionBoxes.part2 = boxes;
  }

  private initializePart3QuestionBoxes() {
    const boxes: QuestionBox[] = [];

    // Add general notes section if there are any general effectiveness notes
    const generalEffectivenessNotes = this.notes.filter(note => 
      !note.linkedCnk && note.category !== 'TherapyAdherence' && note.category !== 'MedicationSchema'
    );

    if (generalEffectivenessNotes.length > 0) {
      boxes.push({
        id: 'p3_general_notes',
        title: this.transloco.translate('tools.general_notes') || 'General Notes',
        description: `${generalEffectivenessNotes.length} ${this.transloco.translate('tools.general_notes') || 'general effectiveness note(s)'}`,
        questions: [
          
        ]
      });
    }

    // Add a box for each medication
    this.medications.forEach(med => {
      const cnk = med.cnk != null ? String(med.cnk) : 'uncategorized';
      const medicationNotes = this.notes.filter(note => 
        String(note.linkedCnk) === cnk && note.category !== 'TherapyAdherence' && note.category !== 'MedicationSchema'
      );

      boxes.push({
        id: `p3_med_${cnk}`,
        title: med.name || this.transloco.translate('pdf.no_medication') || 'Unnamed medication',
        description: `${this.transloco.translate('medication.cnk') || 'CNK'}: ${med.cnk || '‚Äî'} | ${medicationNotes.length} ${this.transloco.translate('notes.existing_notes') || 'note(s)'}`,
        questions: [
          { name: `p3_med_${cnk}_effective`, text: this.transloco.translate('anamnesis_dynamic.medication_effective_question') || 'Is this medication effective for the patient?', type: 'radio', value: null, options: [true, false] },
          { name: `p3_med_${cnk}_effectiveAction`, text: this.transloco.translate('anamnesis_dynamic.action_if_not_effective') || 'Action if not effective', type: 'textarea', value: '', hidden: true },
          { name: `p3_med_${cnk}_hasSideEffects`, text: this.transloco.translate('anamnesis_dynamic.side_effects_question') || 'Is the patient experiencing side effects?', type: 'radio', value: null, options: [true, false] },
          { name: `p3_med_${cnk}_sideEffectsAction`, text: this.transloco.translate('anamnesis_dynamic.action_for_side_effects') || 'Action for side effects', type: 'textarea', value: '', hidden: true }
        ]
      });
    });

    this.allQuestionBoxes.part3 = boxes;
  }

  private loadQuestionAnswers() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.apiService.getQuestionAnswers(reviewId)
      .pipe(takeUntil(this.destroy$))
      .subscribe({
        next: (answers) => {
          // Store answers in map (includes both regular questions and note comments)
          answers.forEach(answer => {
            this.questionAnswers.set(answer.questionName, answer);
          });

          // Apply answers to all parts
          this.applyLoadedAnswersToParts(['part1', 'part2', 'part3']);
        },
        error: (err) => {
          console.error('[Anamnesis] Failed to load question answers:', err);
        }
      });
  }

  private applyLoadedAnswersToParts(parts: ('part1' | 'part2' | 'part3')[]) {
    let loadedCount = 0;
    
    parts.forEach(part => {
      this.allQuestionBoxes[part].forEach(box => {
        box.questions.forEach(q => {
          const savedAnswer = this.questionAnswers.get(q.name);
          if (savedAnswer && savedAnswer.value !== null && savedAnswer.value !== undefined) {
            // Convert string values to appropriate types
            if (q.type === 'checkbox') {
              q.value = savedAnswer.value === 'true';
              console.log('[Anamnesis] Loaded checkbox:', q.name, 'from:', savedAnswer.value, 'to:', q.value);
              loadedCount++;
            } else if (q.type === 'number') {
              q.value = Number(savedAnswer.value) || 0;
              console.log('[Anamnesis] Loaded number:', q.name, '=', q.value);
              loadedCount++;
            } else if (q.type === 'radio') {
              // For boolean radio buttons, convert string to boolean
              if (q.options && q.options.length > 0 && typeof q.options[0] === 'boolean') {
                q.value = savedAnswer.value === 'true';
                console.log('[Anamnesis] Loaded boolean radio:', q.name, 'from:', savedAnswer.value, 'to:', q.value);
              } else {
                q.value = savedAnswer.value;
                console.log('[Anamnesis] Loaded string radio:', q.name, '=', q.value);
              }
              loadedCount++;
            } else {
              q.value = savedAnswer.value;
              if (savedAnswer.value) {
                console.log('[Anamnesis] Loaded', q.type, ':', q.name, '=', q.value?.substring(0, 50));
                loadedCount++;
              }
            }

            // Load share flags for pharmacist notes
            if (savedAnswer.shareWithPatient !== undefined) {
              q.shareWithPatient = savedAnswer.shareWithPatient;
            }
            if (savedAnswer.shareWithDoctor !== undefined) {
              q.shareWithDoctor = savedAnswer.shareWithDoctor;
            }
            
            // For Part 1 concern questions, update visibility of action fields
            if (part === 'part1') {
              if (q.name.startsWith('p1_concerns_')) {
                this.updatePart1ConcernsVisibility(q.name);
              } else if (q.name.startsWith('p1_help_')) {
                this.updatePart1MedicationHelpVisibility(q.name);
              } else if (q.name.startsWith('p1_practical_')) {
                this.updatePart1PracticalProblemsVisibility(q.name);
              } else if (q.name === 'p1_incidents_actionNeeded') {
                this.updatePart1IncidentsVisibility(q.value);
              } else if (q.name === 'p1_followup_actionNeeded') {
                this.updatePart1FollowupVisibility(q.value);
              }
            }
            
            // For Part 2 adherence questions, update visibility of follow-up questions
            if (q.name.includes('_adherence') && part === 'part2') {
              this.updatePart2QuestionVisibility(q.name, q.value);
            }
            
            // For Part 3 effectiveness and side effects questions, update visibility
            if (part === 'part3') {
              if (q.name.includes('_effective')) {
                this.updatePart3EffectivenessVisibility(q.name, q.value);
              } else if (q.name.includes('_hasSideEffects')) {
                this.updatePart3SideEffectsVisibility(q.name, q.value);
              }
            }
          }
        });
      });
    });

    if (loadedCount > 0) {
      console.log('[Anamnesis] ‚úì Applied', loadedCount, 'question answers to parts:', parts.join(', '));
    }
  }

  private setupAutoSave() {
    // Group by questionName so each question has its own debounce stream
    // This ensures rapid clicks on different checkboxes all get saved
    this.saveQueue$
      .pipe(
        takeUntil(this.destroy$),
        groupBy(item => item.questionName),
        mergeMap(group => 
          group.pipe(
            debounceTime(800),
            distinctUntilChanged((prev, curr) => prev.value === curr.value)
          )
        )
      )
      .subscribe(({ questionName, value }) => {
        this.saveQuestionAnswer(questionName, value);
      });
  }

  private saveQuestionAnswer(questionName: string, value: any, forceShareFlagsUpdate: boolean = false) {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) {
      console.warn('[Anamnesis] Cannot save - no medicationReviewId');
      return;
    }

    // Find the question object to get share flags
    let question: Question | undefined;
    for (const part of ['part1', 'part2', 'part3'] as ('part1' | 'part2' | 'part3')[]) {
      for (const box of this.allQuestionBoxes[part]) {
        const found = box.questions.find(q => q.name === questionName);
        if (found) {
          question = found;
          break;
        }
      }
      if (question) break;
    }

    // Convert value to string for storage
    const stringValue = String(value);

    console.log('[Anamnesis] Saving question:', questionName, 'value:', stringValue, 'type:', typeof value);

    // Check if answer already exists
    const existingAnswer = this.questionAnswers.get(questionName);

    if (existingAnswer) {
      // Check if share flags changed
      const shareFlagsChanged = forceShareFlagsUpdate || 
        existingAnswer.shareWithPatient !== question?.shareWithPatient ||
        existingAnswer.shareWithDoctor !== question?.shareWithDoctor;

      // Don't save if the value hasn't changed AND share flags haven't changed
      if (existingAnswer.value === stringValue && !shareFlagsChanged) {
        console.log('[Anamnesis] Skipping save - value and share flags unchanged:', questionName, stringValue);
        return;
      }

      console.log('[Anamnesis] Updating existing answer:', questionName, 'old:', existingAnswer.value, 'new:', stringValue, 'shareFlags changed:', shareFlagsChanged);
      
      // Update existing answer
      this.apiService.updateQuestionAnswer({
        medicationReviewId: reviewId,
        questionName,
        value: stringValue,
        shareWithPatient: question?.shareWithPatient,
        shareWithDoctor: question?.shareWithDoctor
      }).pipe(takeUntil(this.destroy$)).subscribe({
        next: (response) => {
          this.questionAnswers.set(questionName, response);
          console.log('[Anamnesis] ‚úì Updated question answer:', questionName, '=', stringValue);
        },
        error: (err) => {
          console.error('[Anamnesis] ‚úó Failed to update question answer:', questionName, err);
        }
      });
    } else {
      console.log('[Anamnesis] Creating new answer:', questionName, '=', stringValue);
      
      // Create new answer
      this.apiService.addQuestionAnswer({
        medicationReviewId: reviewId,
        questionName,
        value: stringValue,
        shareWithPatient: question?.shareWithPatient,
        shareWithDoctor: question?.shareWithDoctor
      }).pipe(takeUntil(this.destroy$)).subscribe({
        next: (response) => {
          this.questionAnswers.set(questionName, response);
          console.log('[Anamnesis] ‚úì Added question answer:', questionName, '=', stringValue);
        },
        error: (err) => {
          console.error('[Anamnesis] ‚úó Failed to add question answer:', questionName, err);
        }
      });
    }
  }

  selectBox(box: QuestionBox) {
    this.selectedBox = box;
  }

  onShareCheckboxChange(questionName: string) {
    // Immediately save when share checkbox changes
    // Find the question object across all parts
    let question: Question | undefined;
    for (const part of ['part1', 'part2', 'part3'] as ('part1' | 'part2' | 'part3')[]) {
      for (const box of this.allQuestionBoxes[part]) {
        const found = box.questions.find(q => q.name === questionName);
        if (found) {
          question = found;
          break;
        }
      }
      if (question) break;
    }
    
    if (question) {
      // Force update of share flags even if value hasn't changed
      this.saveQuestionAnswer(questionName, question.value, true);
    }
  }

  onQuestionChange(questionName: string, value: any) {
    this.saveQueue$.next({ questionName, value });
    
    // For Part 1 concern questions, show/hide action fields
    if (this.currentPart === 'part1') {
      if (questionName.startsWith('p1_concerns_')) {
        this.updatePart1ConcernsVisibility(questionName);
      } else if (questionName.startsWith('p1_help_')) {
        this.updatePart1MedicationHelpVisibility(questionName);
      } else if (questionName.startsWith('p1_practical_')) {
        this.updatePart1PracticalProblemsVisibility(questionName);
      } else if (questionName === 'p1_incidents_actionNeeded') {
        this.updatePart1IncidentsVisibility(value);
      } else if (questionName === 'p1_followup_actionNeeded') {
        this.updatePart1FollowupVisibility(value);
      }
    }
    
    // For Part 2 adherence questions, show/hide follow-up questions based on answer
    if (questionName.includes('_adherence') && this.currentPart === 'part2') {
      this.updatePart2QuestionVisibility(questionName, value);
    }
    
    // For Part 3 effectiveness and side effects questions, show/hide action fields
    if (this.currentPart === 'part3') {
      if (questionName.includes('_effective')) {
        this.updatePart3EffectivenessVisibility(questionName, value);
      } else if (questionName.includes('_hasSideEffects')) {
        this.updatePart3SideEffectsVisibility(questionName, value);
      }
    }
  }

  private updatePart2QuestionVisibility(adherenceQuestionName: string, value: any) {
    // Extract CNK from question name (e.g., "p2_med_12345_adherence" -> "12345")
    const cnkMatch = adherenceQuestionName.match(/p2_med_(.+)_adherence/);
    if (!cnkMatch) return;

    const cnk = cnkMatch[1];
    // Find the medication box
    const box = this.allQuestionBoxes.part2.find(b => b.id === `p2_med_${cnk}`);
    if (!box) return;

    // Derive the current adherence value from the adherence question in the box (more robust)
    const adherenceQ = box.questions.find(q => q.name.includes('_adherence'));
    const adherenceValue = adherenceQ ? adherenceQ.value : null;
    // Show follow-up questions when adherence is false (No)
    const showFollowUpQuestions = adherenceValue === false;

    console.log('[Anamnesis] updatePart2QuestionVisibility for', cnk, 'adherenceValue=', adherenceValue, '-> showFollowUp=', showFollowUpQuestions);

    box.questions.forEach(q => {
      if (q.name.includes('_notes')) {
        q.hidden = !showFollowUpQuestions;
      }
    });
  }

  private updatePart3EffectivenessVisibility(effectiveQuestionName: string, value: any) {
    // Extract CNK from question name (e.g., "p3_med_12345_effective" -> "12345")
    const cnkMatch = effectiveQuestionName.match(/p3_med_(.+)_effective/);
    if (!cnkMatch) return;

    const cnk = cnkMatch[1];
    const box = this.allQuestionBoxes.part3.find(b => b.id === `p3_med_${cnk}`);
    if (!box) return;

    // Derive current value from the corresponding radio question (robust against timing)
    const effectiveQ = box.questions.find(q => q.name.includes('_effective'));
    const effectiveValue = effectiveQ ? effectiveQ.value : null;
    const showActionField = effectiveValue === false;

    console.log('[Anamnesis] updatePart3EffectivenessVisibility for', cnk, 'effectiveValue=', effectiveValue, '-> showAction=', showActionField);

    const actionField = box.questions.find(q => q.name.includes('_effectiveAction'));
    if (actionField) {
      actionField.hidden = !showActionField;
    }
  }

  private updatePart3SideEffectsVisibility(sideEffectsQuestionName: string, value: any) {
    // Extract CNK from question name (e.g., "p3_med_12345_hasSideEffects" -> "12345")
    const cnkMatch = sideEffectsQuestionName.match(/p3_med_(.+)_hasSideEffects/);
    if (!cnkMatch) return;

    const cnk = cnkMatch[1];
    const box = this.allQuestionBoxes.part3.find(b => b.id === `p3_med_${cnk}`);
    if (!box) return;

    // Derive current value from the corresponding radio question
    const sideQ = box.questions.find(q => q.name.includes('_hasSideEffects'));
    const sideValue = sideQ ? sideQ.value : null;
    const showActionField = sideValue === true;

    console.log('[Anamnesis] updatePart3SideEffectsVisibility for', cnk, 'sideValue=', sideValue, '-> showAction=', showActionField);

    const actionField = box.questions.find(q => q.name.includes('_sideEffectsAction'));
    if (actionField) {
      actionField.hidden = !showActionField;
    }
  }

  private updatePart1ConcernsVisibility(questionName: string) {
    const box = this.allQuestionBoxes.part1.find(b => b.id === 'concerns');
    if (!box) return;

    // Extract field name from question name (e.g., "p1_concerns_tooMany" -> "tooMany")
    const fieldMatch = questionName.match(/p1_concerns_(\w+)/);
    if (!fieldMatch) return;
    
    const field = fieldMatch[1];
    const concernQ = box.questions.find(q => q.name === `p1_concerns_${field}`);
    const actionQ = box.questions.find(q => q.name === `p1_concerns_${field}Action`);
    
    if (concernQ && actionQ) {
      const showAction = concernQ.value === true;
      actionQ.hidden = !showAction;
      
      // If hiding, clear the field and its share flags, then save
      if (!showAction && (actionQ.value || actionQ.shareWithPatient || actionQ.shareWithDoctor)) {
        actionQ.value = '';
        actionQ.shareWithPatient = false;
        actionQ.shareWithDoctor = false;
        this.saveQuestionAnswer(`p1_concerns_${field}Action`, '', true);
      }
      
      console.log('[Anamnesis] updatePart1ConcernsVisibility:', field, 'value=', concernQ.value, '-> showAction=', showAction);
    }
  }

  private updatePart1MedicationHelpVisibility(questionName: string) {
    const box = this.allQuestionBoxes.part1.find(b => b.id === 'medication_help');
    if (!box) return;

    const hasAssistanceQ = box.questions.find(q => q.name === 'p1_help_hasAssistance');
    const additionalNeededQ = box.questions.find(q => q.name === 'p1_help_additionalNeededQuestion');
    const actionQ = box.questions.find(q => q.name === 'p1_help_additionalNeededAction');

    if (!hasAssistanceQ || !additionalNeededQ || !actionQ) return;

    // Show "Is extra hulp wenselijk" question when hasAssistance is false (No)
    const showNestedQuestion = hasAssistanceQ.value === false;
    additionalNeededQ.hidden = !showNestedQuestion;
    
    // If hiding the nested question, also clear it
    if (!showNestedQuestion && (additionalNeededQ.value !== null || actionQ.value)) {
      additionalNeededQ.value = null;
    }

    // Show action field when nested question is true (Yes) AND it's visible
    const showAction = additionalNeededQ.value === true && showNestedQuestion;
    actionQ.hidden = !showAction;
    
    // If hiding action field, clear it and its share flags, then save
    if (!showAction && (actionQ.value || actionQ.shareWithPatient || actionQ.shareWithDoctor)) {
      actionQ.value = '';
      actionQ.shareWithPatient = false;
      actionQ.shareWithDoctor = false;
      this.saveQuestionAnswer('p1_help_additionalNeededAction', '', true);
    }

    console.log('[Anamnesis] updatePart1MedicationHelpVisibility: hasAssistance=', hasAssistanceQ.value, 
                'additionalNeeded=', additionalNeededQ.value, '-> showNestedQ=', showNestedQuestion, 'showAction=', showAction);
  }

  private updatePart1PracticalProblemsVisibility(questionName: string) {
    const box = this.allQuestionBoxes.part1.find(b => b.id === 'practical_problems');
    if (!box) return;

    // Extract field name from question name (e.g., "p1_practical_swallowing" -> "swallowing")
    const fieldMatch = questionName.match(/p1_practical_(\w+)/);
    if (!fieldMatch) return;
    
    const field = fieldMatch[1];
    const problemQ = box.questions.find(q => q.name === `p1_practical_${field}`);
    const actionQ = box.questions.find(q => q.name === `p1_practical_${field}Action`);
    
    if (problemQ && actionQ) {
      const showAction = problemQ.value === true;
      actionQ.hidden = !showAction;
      
      // If hiding, clear the field and its share flags, then save
      if (!showAction && (actionQ.value || actionQ.shareWithPatient || actionQ.shareWithDoctor)) {
        actionQ.value = '';
        actionQ.shareWithPatient = false;
        actionQ.shareWithDoctor = false;
        this.saveQuestionAnswer(`p1_practical_${field}Action`, '', true);
      }
      
      console.log('[Anamnesis] updatePart1PracticalProblemsVisibility:', field, 'value=', problemQ.value, '-> showAction=', showAction);
    }
  }

  private updatePart1IncidentsVisibility(value: any) {
    const box = this.allQuestionBoxes.part1.find(b => b.id === 'incidents');
    if (!box) return;

    const actionQ = box.questions.find(q => q.name === 'p1_incidents_action');
    if (actionQ) {
      const shouldShow = value === true;
      actionQ.hidden = !shouldShow;
      
      // If hiding, clear the field and its share flags, then save
      if (!shouldShow && (actionQ.value || actionQ.shareWithPatient || actionQ.shareWithDoctor)) {
        actionQ.value = '';
        actionQ.shareWithPatient = false;
        actionQ.shareWithDoctor = false;
        this.saveQuestionAnswer('p1_incidents_action', '', true);
      }
      
      console.log('[Anamnesis] updatePart1IncidentsVisibility: actionNeeded=', value, '-> showAction=', shouldShow);
    }
  }

  private updatePart1FollowupVisibility(value: any) {
    const box = this.allQuestionBoxes.part1.find(b => b.id === 'followup');
    if (!box) return;

    const actionQ = box.questions.find(q => q.name === 'p1_followup_action');
    if (actionQ) {
      const shouldShow = value === true;
      actionQ.hidden = !shouldShow;
      
      // If hiding, clear the field and its share flags, then save
      if (!shouldShow && (actionQ.value || actionQ.shareWithPatient || actionQ.shareWithDoctor)) {
        actionQ.value = '';
        actionQ.shareWithPatient = false;
        actionQ.shareWithDoctor = false;
        this.saveQuestionAnswer('p1_followup_action', '', true);
      }
      
      console.log('[Anamnesis] updatePart1FollowupVisibility: actionNeeded=', value, '-> showAction=', shouldShow);
    }
  }

  switchPart(part: 'part1' | 'part2' | 'part3') {
    this.currentPart = part;
    this.questionBoxes = this.allQuestionBoxes[part];
    this.selectedBox = null; // Clear selection when switching parts
  }

  private getNotesForBox(box: QuestionBox): ReviewNote[] {
    // Part 2: Therapy Adherence notes
    if (this.currentPart === 'part2') {
      if (box.id === 'p2_general_notes') {
        return this.notes.filter(note => 
          !note.linkedCnk && (note.category === 'TherapyAdherence' || note.category === 'MedicationSchema')
        );
      } else if (box.id.startsWith('p2_med_')) {
        const cnk = box.id.replace('p2_med_', '');
        return this.notes.filter(note => 
          String(note.linkedCnk) === cnk && (note.category === 'TherapyAdherence' || note.category === 'MedicationSchema')
        );
      }
    }

    // Part 3: Effectiveness & Side Effects notes
    if (this.currentPart === 'part3') {
      if (box.id === 'p3_general_notes') {
        return this.notes.filter(note => 
          !note.linkedCnk && note.category !== 'TherapyAdherence' && note.category !== 'MedicationSchema'
        );
      } else if (box.id.startsWith('p3_med_')) {
        const cnk = box.id.replace('p3_med_', '');
        return this.notes.filter(note => 
          String(note.linkedCnk) === cnk && note.category !== 'TherapyAdherence' && note.category !== 'MedicationSchema'
        );
      }
    }

    return [];
  }

  getVisibleQuestionCount(box: QuestionBox): number {
    let count = box.questions.filter(q => !q.hidden).length;
    
    // Add notes count for general notes boxes
    const notes = this.getNotesForBox(box);
    count += notes.length;
    
    return count;
  }

  getAnsweredQuestionCount(box: QuestionBox): number {
    const visibleQuestions = box.questions.filter(q => !q.hidden);
    let answeredCount = visibleQuestions.filter(q => {
      if (q.type === 'checkbox') {
        return q.value === true;
      }
      if (q.type === 'radio') {
        if (q.options && q.options.length > 0 && typeof q.options[0] === 'boolean') {
          return q.value === true || q.value === false;
        }
        return q.value !== null && q.value !== undefined && q.value !== '';
      }
      if (q.type === 'number') {
        return q.value !== null && q.value !== undefined;
      }
      return q.value !== null && q.value !== undefined && q.value !== '';
    }).length;
    
    // Add answered notes count (notes with comments)
    const notes = this.getNotesForBox(box);
    notes.forEach(note => {
      const questionName = `note_comment_${note.rowKey}`;
      const savedAnswer = this.questionAnswers.get(questionName);
      if (savedAnswer?.value && savedAnswer.value.trim() !== '') {
        answeredCount++;
      }
    });
    
    return answeredCount;
  }

  getShareWithPatientCount(box: QuestionBox): number {
    let count = box.questions.filter(q => q.shareWithPatient === true).length;
    
    // Add notes marked for patient sharing
    const notes = this.getNotesForBox(box);
    notes.forEach(note => {
      const questionName = `note_share_patient_${note.rowKey}`;
      const savedAnswer = this.questionAnswers.get(questionName);
      if (savedAnswer?.value === 'true') {
        count++;
      }
    });
    
    return count;
  }

  getShareWithDoctorCount(box: QuestionBox): number {
    let count = box.questions.filter(q => q.shareWithDoctor === true).length;
    
    // Add notes marked for doctor sharing
    const notes = this.getNotesForBox(box);
    notes.forEach(note => {
      const questionName = `note_share_doctor_${note.rowKey}`;
      const savedAnswer = this.questionAnswers.get(questionName);
      if (savedAnswer?.value === 'true') {
        count++;
      }
    });
    
    return count;
  }

  getQuestionProgress(box: QuestionBox): number {
    const totalVisible = this.getVisibleQuestionCount(box);
    if (totalVisible === 0) return 0;
    
    const totalAnswered = this.getAnsweredQuestionCount(box);
    const progressPercent = Math.round((totalAnswered / totalVisible) * 100);
    
    console.log(`[Anamnesis] Progress for box "${box.id}": ${totalAnswered}/${totalVisible} = ${progressPercent}%`);
    
    return progressPercent;
  }

  getPartProgress(part: 'part1' | 'part2' | 'part3'): number {
    const boxes = this.allQuestionBoxes[part];
    if (!boxes || boxes.length === 0) return 0;

    let totalQuestions = 0;
    let totalAnswered = 0;

    boxes.forEach(box => {
      const visibleQuestions = box.questions.filter(q => !q.hidden);
      totalQuestions += visibleQuestions.length;

      const answeredQuestions = visibleQuestions.filter(q => {
        if (q.type === 'checkbox') {
          return q.value === true;
        }
        if (q.type === 'radio') {
          if (q.options && q.options.length > 0 && typeof q.options[0] === 'boolean') {
            return q.value === true || q.value === false;
          }
          return q.value !== null && q.value !== undefined && q.value !== '';
        }
        if (q.type === 'number') {
          return q.value !== null && q.value !== undefined;
        }
        return q.value !== null && q.value !== undefined && q.value !== '';
      });

      totalAnswered += answeredQuestions.length;
    });

    return totalQuestions === 0 ? 0 : Math.round((totalAnswered / totalQuestions) * 100);
  }

  getNotesForSelectedBox(): ReviewNote[] {
    if (!this.selectedBox) return [];

    // Part 2: Therapy Adherence notes
    if (this.currentPart === 'part2') {
      if (this.selectedBox.id === 'p2_general_notes') {
        // Return general adherence notes
        return this.notes.filter(note => 
          !note.linkedCnk && (note.category === 'TherapyAdherence' || note.category === 'MedicationSchema')
        );
      } else if (this.selectedBox.id.startsWith('p2_med_')) {
        // Extract CNK from box ID
        const cnk = this.selectedBox.id.replace('p2_med_', '');
        return this.notes.filter(note => 
          String(note.linkedCnk) === cnk && (note.category === 'TherapyAdherence' || note.category === 'MedicationSchema')
        );
      }
    }

    // Part 3: Effectiveness & Side Effects notes
    if (this.currentPart === 'part3') {
      if (this.selectedBox.id === 'p3_general_notes') {
        // Return general effectiveness notes
        return this.notes.filter(note => 
          !note.linkedCnk && note.category !== 'TherapyAdherence' && note.category !== 'MedicationSchema'
        );
      } else if (this.selectedBox.id.startsWith('p3_med_')) {
        // Extract CNK from box ID
        const cnk = this.selectedBox.id.replace('p3_med_', '');
        return this.notes.filter(note => 
          String(note.linkedCnk) === cnk && note.category !== 'TherapyAdherence' && note.category !== 'MedicationSchema'
        );
      }
    }

    return [];
  }

  getNoteComment(noteRowKey: string): string {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return '';

    // Use questionName format: note_comment_{noteRowKey}
    const questionName = `note_comment_${noteRowKey}`;
    const savedAnswer = this.questionAnswers.get(questionName);
    return savedAnswer?.value || '';
  }

  onNoteCommentChange(noteRowKey: string, event: Event) {
    const target = event.target as HTMLTextAreaElement;
    const value = target.value;
    const questionName = `note_comment_${noteRowKey}`;
    this.saveQuestionAnswer(questionName, value);
  }

  getNoteShareWithPatient(noteRowKey: string): boolean {
    const questionName = `note_share_patient_${noteRowKey}`;
    const savedAnswer = this.questionAnswers.get(questionName);
    return savedAnswer?.value === 'true';
  }

  getNoteShareWithDoctor(noteRowKey: string): boolean {
    const questionName = `note_share_doctor_${noteRowKey}`;
    const savedAnswer = this.questionAnswers.get(questionName);
    return savedAnswer?.value === 'true';
  }

  onNoteShareChange(noteRowKey: string, shareType: 'patient' | 'doctor', event: Event) {
    const target = event.target as HTMLInputElement;
    const value = target.checked;
    const questionName = `note_share_${shareType}_${noteRowKey}`;
    this.saveQuestionAnswer(questionName, value);
  }

  // Download PDF directly
  downloadPdf() {
    console.log('[AnamnesisPage] Generating and downloading PDF');
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) {
      console.error('[AnamnesisPage] No medication review ID');
      return;
    }

    // Get current notes from service
    const notes = this.reviewNotesService.getNotes();
    const generalSections = this.prepareGeneralSections(notes);
    const { adherenceNotes, effectivenessNotes } = this.prepareGroupedNotes(notes);

    // Get translated part titles
    const partTitles = {
      part1: this.transloco.translate('pdf.part_1_title'),
      part2: this.transloco.translate('pdf.part_2_title'),
      part3: this.transloco.translate('pdf.part_3_title'),
      part4: this.transloco.translate('pdf.part_4_title')
    };

    // Generate PDF and trigger download
    this.anamnesisePdfService.generatePDF(
      generalSections,
      this.medications,
      adherenceNotes as Record<string, ReviewNote[]>,
      effectivenessNotes as Record<string, ReviewNote[]>,
      false, // download mode
      partTitles
    ).catch(error => {
      console.error('Error generating PDF:', error);
    });
  }

  private prepareGeneralSections(notes: ReviewNote[]): any[] {
    // Build Part 1 sections from the question boxes and answers
    const sections: any[] = [];
    
    // Get Part 1 question boxes
    const part1Boxes = this.allQuestionBoxes.part1 || [];
    
    part1Boxes.forEach(box => {
      const section: any = {
        title: box.title,
        questions: []
      };
      
      box.questions.forEach(question => {
        // Skip all hidden questions - they should NEVER appear in the PDF
        // Use originallyHidden to check the initial state, not the current dynamic state
        if (question.originallyHidden) {
          console.log('[PDF] Skipping originally hidden question:', question.name);
          return; // Skip this question entirely
        }
        
        // Map question type to PDF type
        let pdfType = 'text';
        if (question.type === 'radio' && question.options && question.options.includes(true)) {
          pdfType = 'checkbox';
        } else if (question.type === 'number') {
          pdfType = 'number';
        } else if (question.type === 'textarea') {
          pdfType = 'text';
        }
        
        console.log('[PDF] Including question:', question.name, 'originallyHidden:', question.originallyHidden);
        section.questions.push({
          text: question.text,
          type: pdfType,
          value: this.questionAnswers.get(question.name)?.value
        });
      });
      
      if (section.questions.length > 0) {
        sections.push(section);
      }
    });
    
    console.log('[PDF] Final sections prepared:', sections);
    return sections;
  }

  private prepareGroupedNotes(notes: ReviewNote[]): { adherenceNotes: Record<string, ReviewNote[]>, effectivenessNotes: Record<string, ReviewNote[]> } {
    const adherenceNotes: Record<string, ReviewNote[]> = {};
    const effectivenessNotes: Record<string, ReviewNote[]> = {};

    // Filter for patient conversation notes only
    const patientNotes = notes.filter(note => note.discussWithPatient === true);

    // Separate general notes (no linkedCnk) and medication-specific notes
    const generalNotes = patientNotes.filter(note => !note.linkedCnk);
    const medicationNotes = patientNotes.filter(note => note.linkedCnk);

    // Build a quick lookup of medications by CNK
    const medsByCnk: Record<string, any> = {};
    this.medications.forEach(m => {
      if (m.cnk) {
        medsByCnk[m.cnk] = m;
      }
    });

    // Group medication-specific notes by their medication
    medicationNotes.forEach(note => {
      const cnk = String(note.linkedCnk);
      const med = medsByCnk[cnk];
      
      if (med) {
        const key = med.name || 'Unknown Medication';
        
        // Categorize based on note category
        if (note.category === 'TherapyAdherence' || note.category === 'MedicationSchema') {
          if (!adherenceNotes[key]) {
            adherenceNotes[key] = [];
          }
          adherenceNotes[key].push(note);
        } else {
          if (!effectivenessNotes[key]) {
            effectivenessNotes[key] = [];
          }
          effectivenessNotes[key].push(note);
        }
      }
    });

    // Add general notes under "General" heading
    if (generalNotes.length > 0) {
      const therapyGeneralNotes = generalNotes.filter(n => n.category === 'TherapyAdherence' || n.category === 'MedicationSchema');
      const effectivenessGeneralNotes = generalNotes.filter(n => n.category !== 'TherapyAdherence' && n.category !== 'MedicationSchema');
      
      if (therapyGeneralNotes.length > 0) {
        adherenceNotes['General'] = therapyGeneralNotes;
      }
      if (effectivenessGeneralNotes.length > 0) {
        effectivenessNotes['General'] = effectivenessGeneralNotes;
      }
    }

    return { adherenceNotes, effectivenessNotes };
  }
}


```
--- END OF FILE: src\app\pages\anamnesis\anamnesis.page.ts ---

--- START OF FILE: src\app\pages\anamnesis-preparation\anamnesis-preparation.page.html ---
```typescript
<div class="anamnesis-preparation-page">
  <div class="page-header">
    <button class="back-button" (click)="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back to Analysis
    </button>
    <h1>Note Overview</h1>
    <div class="notes-count">{{ notes.length }} note{{ notes.length !== 1 ? 's' : '' }}</div>
    <div class="generate-actions">
      <button class="btn-primary" (click)="generatePatientConversation()">Create patient conversation</button>
    </div>
  </div>

  <div class="notes-container">
    @if (notes.length === 0) {
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <h2>No notes yet</h2>
        <p>Add notes from the analysis page using the "Add Note" buttons on each tool.</p>
        <button class="btn-primary" (click)="goBack()">Go to Analysis</button>
      </div>
    } @else {
      <!-- Notes for Patient Conversation -->
      @if (notesForPatient.length > 0) {
        <div class="notes-section">
          <h2 class="section-title patient-section">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            For Patient Conversation ({{ notesForPatient.length }})
          </h2>
          <div class="notes-list">
            @for (note of notesForPatient; track note.rowKey) {
              <div class="note-card patient-note">
                <div class="note-content">
                  <p class="note-text">{{ note.text }}</p>
                  <div class="note-meta">
                    @if (note.category) {
                      <span class="note-category">{{ note.category }}</span>
                    }
                    @if (note.timestamp) {
                      <span class="note-timestamp">{{ note.timestamp | date: 'short' }}</span>
                    }
                  </div>
                </div>
                <div class="note-actions">
                  <div class="category-buttons">
                    <button 
                      class="category-btn"
                      [class.active]="note.discussWithPatient"
                      (click)="toggleDiscussWithPatient(note)"
                      [title]="note.discussWithPatient ? 'Remove from patient conversation' : 'Add to patient conversation'">
                      Patient
                    </button>
                    <button 
                      class="category-btn"
                      [class.active]="note.communicateToDoctor"
                      (click)="toggleCommunicateToDoctor(note)"
                      [title]="note.communicateToDoctor ? 'Remove from GP report' : 'Add to GP report'">
                      GP report
                    </button>
                  </div>
                  <button class="delete-button" (click)="deleteNote(note)" title="Delete note">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Notes for GP Report -->
      @if (notesForDoctor.length > 0) {
        <div class="notes-section">
          <h2 class="section-title doctor-section">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            For GP Report ({{ notesForDoctor.length }})
          </h2>
          <div class="notes-list">
            @for (note of notesForDoctor; track note.rowKey) {
              <div class="note-card doctor-note">
                <div class="note-content">
                  <p class="note-text">{{ note.text }}</p>
                  <div class="note-meta">
                    @if (note.category) {
                      <span class="note-category">{{ note.category }}</span>
                    }
                    @if (note.timestamp) {
                      <span class="note-timestamp">{{ note.timestamp | date: 'short' }}</span>
                    }
                  </div>
                </div>
                <div class="note-actions">
                  <div class="category-buttons">
                    <button 
                      class="category-btn"
                      [class.active]="note.discussWithPatient"
                      (click)="toggleDiscussWithPatient(note)"
                      [title]="note.discussWithPatient ? 'Remove from patient conversation' : 'Add to patient conversation'">
                      Patient
                    </button>
                    <button 
                      class="category-btn"
                      [class.active]="note.communicateToDoctor"
                      (click)="toggleCommunicateToDoctor(note)"
                      [title]="note.communicateToDoctor ? 'Remove from GP report' : 'Add to GP report'">
                      GP report
                    </button>
                  </div>
                  <button class="delete-button" (click)="deleteNote(note)" title="Delete note">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Internal Notes -->
      @if (internalNotes.length > 0) {
        <div class="notes-section">
          <h2 class="section-title internal-section">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg>
            Internal Notes ({{ internalNotes.length }})
          </h2>
          <div class="notes-list">
            @for (note of internalNotes; track note.rowKey) {
              <div class="note-card internal-note">
                <div class="note-content">
                  <p class="note-text">{{ note.text }}</p>
                  <div class="note-meta">
                    @if (note.category) {
                      <span class="note-category">{{ note.category }}</span>
                    }
                    @if (note.timestamp) {
                      <span class="note-timestamp">{{ note.timestamp | date: 'short' }}</span>
                    }
                  </div>
                </div>
                <div class="note-actions">
                  <div class="category-buttons">
                    <button 
                      class="category-btn"
                      [class.active]="note.discussWithPatient"
                      (click)="toggleDiscussWithPatient(note)"
                      [title]="note.discussWithPatient ? 'Remove from patient conversation' : 'Add to patient conversation'">
                      Patient
                    </button>
                    <button 
                      class="category-btn"
                      [class.active]="note.communicateToDoctor"
                      (click)="toggleCommunicateToDoctor(note)"
                      [title]="note.communicateToDoctor ? 'Remove from GP report' : 'Add to GP report'">
                      GP report
                    </button>
                  </div>
                  <button class="delete-button" (click)="deleteNote(note)" title="Delete note">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }
    }
  </div>

  <!-- Delete confirmation modal -->
  @if (showDeleteConfirmation) {
    <app-confirmation-modal
      [title]="'Delete Note'"
      [message]="'Are you sure you want to delete this note? This action cannot be undone.'"
      [confirmText]="'Delete'"
      [cancelText]="'Cancel'"
      (confirm)="onConfirmDelete()"
      (cancel)="onCancelDelete()"
    ></app-confirmation-modal>
  }
</div>

```
--- END OF FILE: src\app\pages\anamnesis-preparation\anamnesis-preparation.page.html ---

--- START OF FILE: src\app\pages\input\input.page.html ---
```typescript
<div class="input-page">
  <div class="left-panel">
    <app-patient-details></app-patient-details>
    <app-contra-indications></app-contra-indications>
  </div>

  <div class="right-panel">
    <div class="right-panel-content">
      <app-medication-list></app-medication-list>
    </div>
    <div class="action-button-container">
      <button class="start-preparation-button" (click)="startPreparation()">{{ 'input.start_preparation' | transloco }}</button>
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\pages\input\input.page.html ---

--- START OF FILE: src\app\pages\input\input.page.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.input-page {
  padding: 2rem;
  display: flex;
  gap: 2rem;
  height: 100%;
  overflow: hidden;

  .left-panel {
    width: 30%;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    padding-right: 0.5rem;

    &::-webkit-scrollbar {
      width: 6px;
    }

    &::-webkit-scrollbar-track {
      background: $main-background;
      border-radius: 3px;
    }

    &::-webkit-scrollbar-thumb {
      background: $box-border;
      border-radius: 3px;

      &:hover {
        background: $text-muted;
      }
    }
  }

  .right-panel {
    width: 70%;
    display: flex;
    gap: 1.5rem;
    overflow: hidden;

    .right-panel-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding-right: 0.5rem;

      &::-webkit-scrollbar {
        width: 6px;
      }

      &::-webkit-scrollbar-track {
        background: $main-background;
        border-radius: 3px;
      }

      &::-webkit-scrollbar-thumb {
        background: $box-border;
        border-radius: 3px;

        &:hover {
          background: $text-muted;
        }
      }
    }

    .action-button-container {
      display: flex;
      align-items: flex-start;
      padding-top: 0;

      .start-preparation-button {
        padding: 0.75rem 1.5rem;
        background-color: $button-primary;
        color: $text-button-primary;
        border: $box-border-width solid $box-border-primary;
        border-radius: $box-border-radius;
        font-family: $primary-font;
        font-size: 0.875rem;
        font-weight: $font-weight-medium;
        cursor: pointer;
        transition: background-color 0.2s ease;
        white-space: nowrap;

        &:hover {
          background-color: $button-primary-hover;
        }
      }
    }
  }
}

```
--- END OF FILE: src\app\pages\input\input.page.scss ---

--- START OF FILE: src\app\pages\input\input.page.ts ---
```typescript
import { Component } from '@angular/core';
import { Router } from '@angular/router';
import { PatientDetailsComponent } from '../../components/patient-details/patient-details.component';
import { ContraIndicationsComponent } from '../../components/contra-indications/contra-indications.component';
import { MedicationListComponent } from '../../components/medication-list/medication-list.component';
import { TranslocoModule } from '@jsverse/transloco';

@Component({
  selector: 'app-input',
  imports: [
    PatientDetailsComponent,
    ContraIndicationsComponent,
    MedicationListComponent,
    TranslocoModule
  ],
  templateUrl: './input.page.html',
  styleUrls: ['./input.page.scss']
})
export class InputPage {
  constructor(private router: Router) {}

  startPreparation() {
    this.router.navigate(['/analysis']);
  }
}

```
--- END OF FILE: src\app\pages\input\input.page.ts ---

--- START OF FILE: src\app\pages\login\login.page.html ---
```typescript
<div class="login-page">
  <div class="login-container">
    <div class="login-box">
      <h2 class="login-title">{{ 'login.title' | transloco }}</h2>
      
      <form (ngSubmit)="onSubmit()" class="login-form">
        <div class="field-group">
          <label for="apbNumber">{{ 'login.apb_number' | transloco }} <span class="required">*</span></label>
          <input 
            type="text" 
            id="apbNumber" 
            [(ngModel)]="apbNumber" 
            name="apbNumber"
            [placeholder]="'login.enter_apb' | transloco"
            [disabled]="isLoading">
        </div>

        <div class="field-group">
          <label for="medicationReviewId">{{ 'login.medication_review_id' | transloco }} <span class="optional">({{ 'login.optional' | transloco }})</span></label>
          <input 
            type="text" 
            id="medicationReviewId" 
            [(ngModel)]="medicationReviewId" 
            name="medicationReviewId"
            [placeholder]="'login.leave_empty' | transloco"
            [disabled]="isLoading">
        </div>

        @if (errorMessage) {
          <div class="error-message">
            {{ errorMessage }}
          </div>
        }

        <button 
          type="submit" 
          class="submit-button" 
          [disabled]="!isFormValid || isLoading"
          [class.disabled]="!isFormValid || isLoading">
          {{ isLoading ? ('common.loading' | transloco) : ('common.confirm' | transloco) }}
        </button>
      </form>
    </div>

    <div class="language-selector">
      <button 
        *ngFor="let lang of availableLanguages" 
        class="language-button"
        [class.active]="currentLanguage === lang.code"
        (click)="changeLanguage(lang.code)"
        [title]="lang.name">
        {{ lang.code.toUpperCase() }}
      </button>
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\pages\login\login.page.html ---

--- START OF FILE: src\app\pages\login\login.page.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.login-page {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  padding: 2rem;
  background-color: #132F52;
  position: relative;
  overflow: hidden;

  &::before {
    content: '';
    position: absolute;
    bottom: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background-image: url('/images/logo-transparent-stalk.svg');
    background-repeat: no-repeat;
    background-position: right bottom;
    background-size: contain;
    opacity: 0.15;
    pointer-events: none;
  }

  .login-container {
    width: 100%;
    max-width: 450px;
    position: relative;
    z-index: 1;

    .login-box {
      background-color: $box-background;
      border: $box-border-width solid $box-border-primary;
      border-radius: $box-border-radius;
      padding: 2.5rem;

      .login-title {
        font-size: 1.8rem;
        color: $text-primary;
        margin-bottom: 2rem;
        text-align: center;
      }

      .login-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;

        .field-group {
          display: flex;
          flex-direction: column;

          label {
            font-size: 0.875rem;
            color: $text-secondary;
            margin-bottom: 0.5rem;
            font-weight: $font-weight-regular;

            .required {
              color: #e74c3c;
            }

            .optional {
              color: $text-muted;
              font-size: 0.75rem;
            }
          }

          input {
            padding: 0.75rem;
            border: $box-border-width solid $box-border-primary;
            border-radius: $box-border-radius;
            font-family: $primary-font;
            font-size: 0.875rem;
            
            &:focus {
              outline: none;
              border-color: $button-primary;
            }

            &::placeholder {
              color: $text-muted;
            }

            &:disabled {
              opacity: 0.6;
              cursor: not-allowed;
            }
          }
        }

        .error-message {
          padding: 0.75rem;
          background-color: #fee;
          border: 1px solid #e74c3c;
          border-radius: $box-border-radius;
          color: #c0392b;
          font-size: 0.875rem;
          text-align: center;
        }

        .submit-button {
          margin-top: 1rem;
          padding: 0.75rem 1.5rem;
          background-color: $button-primary;
          color: $text-button-primary;
          border: $box-border-width solid $box-border-primary;
          border-radius: $box-border-radius;
          font-family: $primary-font;
          font-size: 1rem;
          font-weight: $font-weight-medium;
          cursor: pointer;
          transition: background-color 0.2s ease, opacity 0.2s ease;

          &:hover:not(.disabled) {
            background-color: $button-primary-hover;
          }

          &.disabled {
            opacity: 0.4;
            cursor: not-allowed;
          }
        }
      }
    }

    .language-selector {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      display: flex;
      gap: 0.5rem;
      z-index: 10;

      .language-button {
        width: 3rem;
        height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: $box-border-radius;
        color: rgba(255, 255, 255, 0.7);
        font-family: $primary-font;
        font-size: 0.75rem;
        font-weight: $font-weight-medium;
        cursor: pointer;
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);

        &:hover {
          background-color: rgba(255, 255, 255, 0.15);
          border-color: rgba(255, 255, 255, 0.5);
          color: rgba(255, 255, 255, 0.9);
        }

        &.active {
          background-color: $button-primary;
          border-color: $button-primary;
          color: $text-button-primary;
          box-shadow: 0 2px 8px rgba(69, 75, 96, 0.3);
        }
      }
    }
  }
}

```
--- END OF FILE: src\app\pages\login\login.page.scss ---

--- START OF FILE: src\app\pages\login\login.page.ts ---
```typescript
import { Component, inject } from '@angular/core';
import { Router } from '@angular/router';
import { FormsModule } from '@angular/forms';
import { CommonModule } from '@angular/common';
import { TranslocoModule, TranslocoService } from '@jsverse/transloco';
import { ApiService } from '../../services/api.service';
import { StateService } from '../../services/state.service';
import { LoginRequest } from '../../models/api.models';

@Component({
  selector: 'app-login',
  standalone: true,
  imports: [FormsModule, CommonModule, TranslocoModule],
  templateUrl: './login.page.html',
  styleUrls: ['./login.page.scss']
})
export class LoginPage {
  apbNumber: string = '';
  medicationReviewId: string = '';
  isLoading: boolean = false;
  errorMessage: string = '';

  availableLanguages = [
    { code: 'en', name: 'English' },
    { code: 'nl', name: 'Nederlands' },
    { code: 'fr', name: 'Fran√ßais' }
  ];

  get currentLanguage(): string {
    return this.transloco.getActiveLang();
  }

  private transloco = inject(TranslocoService);
  constructor(
    private router: Router,
    private apiService: ApiService,
    private stateService: StateService
  ) {}

  changeLanguage(lang: string) {
    this.transloco.setActiveLang(lang);
  }

  get isFormValid(): boolean {
    return this.apbNumber.trim() !== '';
  }

  onSubmit() {
    if (!this.isFormValid || this.isLoading) {
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    const request: LoginRequest = {
      apbNumber: this.apbNumber.trim()
    };

    // Add optional medication review ID if provided
    if (this.medicationReviewId.trim()) {
      request.medicationReviewId = this.medicationReviewId.trim();
    }

    this.apiService.login(request).subscribe({
      next: (response) => {
        console.log('Login successful:', response);
        // Get existing session data to preserve values like renalFunction if backend didn't return them
        const existingSession = this.stateService.getSessionData();
        const newSession = {
          ...response,
          apbNumber: request.apbNumber
        };
        
        // Preserve renalFunction from existing session if backend returned null
        if (existingSession?.patient?.renalFunction && !newSession.patient.renalFunction) {
          console.log('[LoginPage] Preserving renalFunction from existing session:', existingSession.patient.renalFunction);
          newSession.patient.renalFunction = existingSession.patient.renalFunction;
        }
        
        console.log('[LoginPage] Final session data to store:', newSession);
        this.stateService.setSessionData(newSession);
        this.router.navigate(['/input']);
      },
      error: (error) => {
        console.error('Login failed:', error);
        this.isLoading = false;
        const serverMsg = error.error?.message;
        this.errorMessage = serverMsg ? serverMsg : this.transloco.translate('login.login_failed');
      },
      complete: () => {
        this.isLoading = false;
      }
    });
  }
}

```
--- END OF FILE: src\app\pages\login\login.page.ts ---

--- START OF FILE: src\app\pages\note-overview\note-overview.page.html ---
```typescript
<div class="note-overview-page">
  <div class="page-header">
    <button class="back-button" (click)="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back to Analysis
    </button>
    <h1>Note Overview</h1>
    <div class="notes-count">{{ notes.length }} note{{ notes.length !== 1 ? 's' : '' }}</div>
    <div class="generate-actions">
      <button class="btn-primary" (click)="generatePatientConversation()">Create patient conversation</button>
    </div>
  </div>

  <div class="notes-container">
    @if (notes.length === 0) {
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <h2>No notes yet</h2>
        <p>Add notes from the analysis page using the "Add Note" buttons on each tool.</p>
        <button class="btn-primary" (click)="goBack()">Go to Analysis</button>
      </div>
    } @else {
      <!-- Notes for Patient Conversation -->
      @if (notesForPatient.length > 0) {
        <div class="notes-section">
          <h2 class="section-title patient-section">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            For Patient Conversation ({{ notesForPatient.length }})
          </h2>
          <div class="notes-list">
            @for (note of notesForPatient; track note.rowKey) {
              <div class="note-card patient-note">
                <div class="note-content">
                  <p class="note-text">{{ note.text }}</p>
                  <div class="note-meta">
                    @if (note.category) {
                      <span class="note-category">{{ note.category }}</span>
                    }
                    @if (note.timestamp) {
                      <span class="note-timestamp">{{ note.timestamp | date: 'short' }}</span>
                    }
                  </div>
                </div>
                <div class="note-actions">
                  <div class="category-buttons">
                    <button 
                      class="category-btn"
                      [class.active]="note.discussWithPatient"
                      (click)="toggleDiscussWithPatient(note)"
                      [title]="note.discussWithPatient ? 'Remove from patient conversation' : 'Add to patient conversation'">
                      Patient
                    </button>
                    <button 
                      class="category-btn"
                      [class.active]="note.communicateToDoctor"
                      (click)="toggleCommunicateToDoctor(note)"
                      [title]="note.communicateToDoctor ? 'Remove from GP report' : 'Add to GP report'">
                      GP report
                    </button>
                  </div>
                  <button class="delete-button" (click)="deleteNote(note)" title="Delete note">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Notes for GP Report -->
      @if (notesForDoctor.length > 0) {
        <div class="notes-section">
          <h2 class="section-title doctor-section">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            For GP Report ({{ notesForDoctor.length }})
          </h2>
          <div class="notes-list">
            @for (note of notesForDoctor; track note.rowKey) {
              <div class="note-card doctor-note">
                <div class="note-content">
                  <p class="note-text">{{ note.text }}</p>
                  <div class="note-meta">
                    @if (note.category) {
                      <span class="note-category">{{ note.category }}</span>
                    }
                    @if (note.timestamp) {
                      <span class="note-timestamp">{{ note.timestamp | date: 'short' }}</span>
                    }
                  </div>
                </div>
                <div class="note-actions">
                  <div class="category-buttons">
                    <button 
                      class="category-btn"
                      [class.active]="note.discussWithPatient"
                      (click)="toggleDiscussWithPatient(note)"
                      [title]="note.discussWithPatient ? 'Remove from patient conversation' : 'Add to patient conversation'">
                      Patient
                    </button>
                    <button 
                      class="category-btn"
                      [class.active]="note.communicateToDoctor"
                      (click)="toggleCommunicateToDoctor(note)"
                      [title]="note.communicateToDoctor ? 'Remove from GP report' : 'Add to GP report'">
                      GP report
                    </button>
                  </div>
                  <button class="delete-button" (click)="deleteNote(note)" title="Delete note">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Internal Notes -->
      @if (internalNotes.length > 0) {
        <div class="notes-section">
          <h2 class="section-title internal-section">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg>
            Internal Notes ({{ internalNotes.length }})
          </h2>
          <div class="notes-list">
            @for (note of internalNotes; track note.rowKey) {
              <div class="note-card internal-note">
                <div class="note-content">
                  <p class="note-text">{{ note.text }}</p>
                  <div class="note-meta">
                    @if (note.category) {
                      <span class="note-category">{{ note.category }}</span>
                    }
                    @if (note.timestamp) {
                      <span class="note-timestamp">{{ note.timestamp | date: 'short' }}</span>
                    }
                  </div>
                </div>
                <div class="note-actions">
                  <div class="category-buttons">
                    <button 
                      class="category-btn"
                      [class.active]="note.discussWithPatient"
                      (click)="toggleDiscussWithPatient(note)"
                      [title]="note.discussWithPatient ? 'Remove from patient conversation' : 'Add to patient conversation'">
                      Patient
                    </button>
                    <button 
                      class="category-btn"
                      [class.active]="note.communicateToDoctor"
                      (click)="toggleCommunicateToDoctor(note)"
                      [title]="note.communicateToDoctor ? 'Remove from GP report' : 'Add to GP report'">
                      GP report
                    </button>
                  </div>
                  <button class="delete-button" (click)="deleteNote(note)" title="Delete note">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }
    }
  </div>

  <!-- Delete confirmation modal -->
  @if (showDeleteConfirmation) {
    <app-confirmation-modal
      [title]="'messages.delete_note_title' | transloco"
      [message]="'messages.confirm_delete_note' | transloco"
      [confirmText]="'common.delete' | transloco"
      [cancelText]="'common.cancel' | transloco"
      (confirm)="onConfirmDelete()"
      (cancel)="onCancelDelete()"
    ></app-confirmation-modal>
  }
</div>

```
--- END OF FILE: src\app\pages\note-overview\note-overview.page.html ---

--- START OF FILE: src\app\pages\note-overview\note-overview.page.scss ---
```typescript
@import '../../../styles/_colors';
@import '../../../styles/_fonts';

.note-overview-page {
  height: 93vh;
  display: flex;
  flex-direction: column;
  background-color: $main-background;
  overflow: hidden;

  .page-header {
    background-color: $box-background;
    padding: 1.25rem 1.5rem;
    border: $box-border-width solid $box-border;
    display: flex;
    align-items: center;
    gap: 1.25rem;
    flex-shrink: 0;
    box-shadow: 0 1px 0 rgba(0,0,0,0.02);

    .back-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.9rem;
      background-color: transparent;
      border: $box-border-width solid $box-border;
      border-radius: $box-border-radius-small;
      color: $text-secondary;
      font-family: $primary-font;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.12s ease;

      &:hover {
        background-color: $input-background;
        border-color: $button-primary-background;
        color: $button-primary-background;
      }

      svg { flex-shrink: 0; }
    }

    h1 {
      flex: 1;
      margin: 0;
      font-family: $primary-font;
      font-weight: $font-weight-semibold;
      font-size: 1.375rem;
      color: $text-primary;
    }

    .notes-count {
      padding: 0.35rem 0.75rem;
      background-color: rgba($button-primary-background, 0.08);
      color: $button-primary-background;
      border-radius: 16px;
      font-family: $primary-font;
      font-size: 0.85rem;
      font-weight: $font-weight-medium;
    }

    .generate-actions { 
      margin-left: 0.5rem;

      .btn-primary {
        padding: 0.55rem 1rem;
        background-color: $button-primary-background;
        color: $text-button-primary;
        border: none;
        border-radius: $box-border-radius-small;
        font-family: $primary-font;
        font-size: 0.9rem;
        font-weight: $font-weight-medium;
        cursor: pointer;
        transition: all 0.12s ease;

        &:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(69,75,96,0.08); }
      }
    }
  }

  // -------------------- Empty State --------------------
  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    text-align: center;

    svg { color: $text-muted; margin-bottom: 1.25rem; }

    h2 { font-family: $primary-font; font-weight: $font-weight-semibold; font-size: 1.25rem; color: $text-primary; margin: 0 0 0.5rem 0; }
    p  { font-family: $primary-font; color: $text-secondary; margin: 0 0 1.5rem 0; }

    .btn-primary {
      padding: 0.6rem 1.25rem;
      background-color: $button-primary-background;
      color: $text-button-primary;
      border-radius: $box-border-radius;
      border: none;
      font-family: $primary-font;
      cursor: pointer;
      transition: all 0.12s ease;

      &:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(69,75,96,0.08); }
    }
  }

  // -------------------- Notes Container --------------------
  .notes-container { flex: 1; overflow-y: auto; padding: 1.25rem; }

  .notes-section {
    background-color: $box-background;
    border: $box-border-width solid $box-border;
    border-radius: 8px;
    margin-bottom: 1.25rem;
    overflow: hidden;

    .section-title {
      display: flex; align-items: center; gap: 0.75rem; padding: 0.95rem 1rem; margin: 0;
      font-family: $primary-font; font-weight: $font-weight-semibold; font-size: 1.05rem; border-bottom: $box-border-width solid $box-border;

      &.patient-section { background-color: rgba(69,75,96,0.05); color: $button-primary-background; }
      &.doctor-section  { background-color: rgba(244,114,128,0.05); color: #f4576c; }
      &.internal-section{ background-color: rgba(79,172,254,0.05); color: #4facfe; }
    }

    .notes-list { padding: 1rem; display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
  }

  // -------------------- Note Cards --------------------
  .note-card {
    display: flex; gap: 1rem; padding: 1rem; border-radius: 8px; border: $box-border-width solid $box-border; background-color: $box-background;
    transition: all 0.12s ease;

    &:hover { box-shadow: 0 6px 18px rgba(69,75,96,0.06); transform: translateY(-3px); }

    &.patient-note { border-left: 4px solid $button-primary-background; }
    &.doctor-note  { border-left: 4px solid #f4576c; }
    &.internal-note{ border-left: 4px solid #4facfe; }

    .note-content { flex: 1; min-width: 0;
      .note-text { margin: 0 0 0.5rem 0; font-family: $primary-font; font-size: 0.95rem; color: $text-primary; line-height: 1.5; white-space: pre-wrap; }

      .note-meta { display: flex; gap: 0.65rem; align-items: center; flex-wrap: wrap;
        .note-category { padding: 0.2rem 0.55rem; background-color: rgba($button-primary-background,0.06); color: $button-primary-background; border-radius: 4px; font-size: 0.75rem; }
        .note-timestamp { font-size: 0.8rem; color: $text-muted; }
      }
    }

    .note-actions { display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;
      .category-buttons { display: flex; gap: 0.5rem;
        .category-btn { padding: 0.35rem 0.7rem; border: $box-border-width solid $box-border; background: $box-background; border-radius: 6px; font-size: 0.82rem; color: $text-secondary; transition: all 0.12s ease; }
        .category-btn.active { background: $button-primary-background; color: $text-button-primary; border-color: $button-primary-background; }
      }

      .delete-button { padding: 0.45rem; border-radius: 6px; border: 1px solid #ffd7d9; background: $box-background; svg { color: #c62828; } &:hover { background: #fff1f1; transform: scale(1.03); } }
    }
  }
}

```
--- END OF FILE: src\app\pages\note-overview\note-overview.page.scss ---

--- START OF FILE: src\app\pages\note-overview\note-overview.page.ts ---
```typescript
import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { TranslocoModule } from '@jsverse/transloco';
import { ReviewNotesService, ReviewNote } from '../../services/review-notes.service';
import { StateService } from '../../services/state.service';
import { ConfirmationModalComponent } from '../../components/confirmation-modal/confirmation-modal.component';

@Component({
  selector: 'app-note-overview',
  imports: [CommonModule, ConfirmationModalComponent, TranslocoModule],
  templateUrl: './note-overview.page.html',
  styleUrls: ['./note-overview.page.scss']
})
export class NoteOverviewPage implements OnInit, OnDestroy {
  notes: ReviewNote[] = [];
  notesForPatient: ReviewNote[] = [];
  notesForDoctor: ReviewNote[] = [];
  internalNotes: ReviewNote[] = [];
  
  private destroy$ = new Subject<void>();
  showDeleteConfirmation = false;
  selectedNoteToDelete: ReviewNote | null = null;

  constructor(
    private reviewNotesService: ReviewNotesService,
    private stateService: StateService,
    private router: Router
  ) {}

  ngOnInit() {
    // Subscribe to notes changes
    this.reviewNotesService.notes$
      .pipe(takeUntil(this.destroy$))
      .subscribe(notes => {
        this.notes = notes;
        this.categorizeNotes();
      });

    // Load notes if not already loaded
    const reviewId = this.stateService.medicationReviewId;
    if (reviewId && this.reviewNotesService.getNotesCount() === 0) {
      this.reviewNotesService.loadReviewNotes(reviewId);
    }
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
  }

  generatePatientConversation() {
    // Navigate to the Anamnesis page (the three-column preparation view)
    this.router.navigate(['/anamnesis']);
  }

  private categorizeNotes() {
    this.notesForPatient = this.notes.filter(n => n.discussWithPatient);
    this.notesForDoctor = this.notes.filter(n => n.communicateToDoctor);
    this.internalNotes = this.notes.filter(n => !n.discussWithPatient && !n.communicateToDoctor);
  }

  deleteNote(note: ReviewNote) {
    // Show confirmation modal instead of browser confirm
    this.selectedNoteToDelete = note;
    this.showDeleteConfirmation = true;
  }

  onConfirmDelete() {
    if (!this.selectedNoteToDelete) return;
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) {
      console.error('[NoteOverview] No review ID found');
      this.showDeleteConfirmation = false;
      this.selectedNoteToDelete = null;
      return;
    }

    const rowKey = this.selectedNoteToDelete.rowKey;
    this.reviewNotesService.deleteNote(reviewId, rowKey).subscribe({
      next: () => {
        console.log('[NoteOverview] Note deleted successfully');
        this.showDeleteConfirmation = false;
        this.selectedNoteToDelete = null;
      },
      error: (error) => {
        console.error('[NoteOverview] Error deleting note:', error);
        alert('Failed to delete note. Please try again.');
        this.showDeleteConfirmation = false;
        this.selectedNoteToDelete = null;
      }
    });
  }

  onCancelDelete() {
    this.showDeleteConfirmation = false;
    this.selectedNoteToDelete = null;
  }

  toggleDiscussWithPatient(note: ReviewNote) {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.reviewNotesService.updateNote(reviewId, note.rowKey, {
      discussWithPatient: !note.discussWithPatient
    }).subscribe({
      error: (error) => {
        console.error('[NoteOverview] Error updating note:', error);
        alert('Failed to update note. Please try again.');
      }
    });
  }

  toggleCommunicateToDoctor(note: ReviewNote) {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.reviewNotesService.updateNote(reviewId, note.rowKey, {
      communicateToDoctor: !note.communicateToDoctor
    }).subscribe({
      error: (error) => {
        console.error('[NoteOverview] Error updating note:', error);
        alert('Failed to update note. Please try again.');
      }
    });
  }

  goBack() {
    this.router.navigate(['/analysis']);
  }
}

```
--- END OF FILE: src\app\pages\note-overview\note-overview.page.ts ---

--- START OF FILE: src\app\pages\pdf-preview\pdf-preview.page.html ---
```typescript
<div class="pdf-preview-page">
  <div class="page-header">
    <h1>PDF Preview</h1>
    <div class="header-actions">
      <button class="btn-secondary" (click)="downloadPdf()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Download PDF
      </button>
      <button class="btn-primary" (click)="navigateToAnamnesis()">
        Continue to Actions
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="5" y1="12" x2="19" y2="12"></line>
          <polyline points="12 5 19 12 12 19"></polyline>
        </svg>
      </button>
    </div>
  </div>

  <div class="preview-container">
    @if (isLoading) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Generating PDF preview...</p>
      </div>
    } @else if (pdfPreviewUrl) {
      <embed 
        [src]="pdfPreviewUrl" 
        type="application/pdf"
        class="pdf-iframe"
        title="PDF Preview"
      />
    } @else {
      <div class="error-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <h2>{{ 'pdf_errors.failed_to_generate' | transloco }}</h2>
        <p>Please try again or contact support if the problem persists.</p>
      </div>
    }
  </div>
</div>

```
--- END OF FILE: src\app\pages\pdf-preview\pdf-preview.page.html ---

--- START OF FILE: src\app\pages\pdf-preview\pdf-preview.page.scss ---
```typescript
@use '../../../styles/_colors' as *;
@use '../../../styles/_fonts' as *;

.pdf-preview-page {
  height: 93vh;
  display: flex;
  flex-direction: column;
  background-color: $main-background;
  overflow: hidden;

  .page-header {
    background-color: $box-background;
    padding: 1.5rem 2rem;
    border-bottom: $box-border-width solid $box-border;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;

    h1 {
      margin: 0;
      font-family: $primary-font;
      font-weight: $font-weight-semibold;
      font-size: 1.5rem;
      color: $text-primary;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;

      .btn-secondary,
      .btn-primary {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.65rem 1.25rem;
        border-radius: $box-border-radius-small;
        font-family: $primary-font;
        font-size: 0.95rem;
        font-weight: $font-weight-medium;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;

        svg {
          flex-shrink: 0;
        }
      }

      .btn-secondary {
        background-color: $box-background;
        color: $text-primary;
        border: $box-border-width solid $box-border;

        &:hover {
          background-color: $input-background;
          border-color: $button-primary-background;
          color: $button-primary-background;
        }
      }

      .btn-primary {
        background-color: $button-primary-background;
        color: $text-button-primary;

        &:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 18px rgba(69, 75, 96, 0.15);
        }
      }
    }
  }

  .preview-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    overflow: hidden;

    .pdf-iframe {
      width: 100%;
      height: 100%;
      border: $box-border-width solid $box-border;
      border-radius: $box-border-radius;
      background-color: #525659;
    }

    .loading-state,
    .error-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 3rem;

      svg {
        color: $text-muted;
        margin-bottom: 1.5rem;
      }

      h2 {
        font-family: $primary-font;
        font-weight: $font-weight-semibold;
        font-size: 1.25rem;
        color: $text-primary;
        margin: 0 0 0.5rem 0;
      }

      p {
        font-family: $primary-font;
        color: $text-secondary;
        margin: 0;
        font-size: 0.95rem;
      }
    }

    .loading-state {
      .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid rgba($button-primary-background, 0.1);
        border-top-color: $button-primary-background;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-bottom: 1.5rem;
      }
    }
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

```
--- END OF FILE: src\app\pages\pdf-preview\pdf-preview.page.scss ---

--- START OF FILE: src\app\pages\pdf-preview\pdf-preview.page.ts ---
```typescript
import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { TranslocoModule, TranslocoService } from '@jsverse/transloco';
import { Router } from '@angular/router';
import { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { AnamnesisePdfService } from '../../services/anamnesis-pdf.service';
import { ReviewNotesService, ReviewNote } from '../../services/review-notes.service';
import { StateService } from '../../services/state.service';
import { ApiService } from '../../services/api.service';

@Component({
  selector: 'app-pdf-preview',
  standalone: true,
  imports: [CommonModule, TranslocoModule],
  templateUrl: './pdf-preview.page.html',
  styleUrls: ['./pdf-preview.page.scss']
})
export class PdfPreviewPage implements OnInit, OnDestroy {
  pdfPreviewUrl: SafeResourceUrl | null = null;
  isLoading = false;
  medications: any[] = [];

  private destroy$ = new Subject<void>();

  constructor(
    private anamnesisePdfService: AnamnesisePdfService,
    private reviewNotesService: ReviewNotesService,
    private stateService: StateService,
    private apiService: ApiService,
    private transloco: TranslocoService,
    private sanitizer: DomSanitizer,
    private router: Router
  ) {}

  ngOnInit() {
    this.loadMedications();
    this.generatePdfPreview();
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
    
    // Clean up blob URL
    if (this.pdfPreviewUrl) {
      const url = (this.pdfPreviewUrl as any).changingThisBreaksApplicationSecurity;
      if (url && url.startsWith('blob:')) {
        URL.revokeObjectURL(url);
      }
    }
  }

  loadMedications() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) return;

    this.apiService.getMedications(reviewId).subscribe({
      next: (meds) => {
        this.medications = meds;
      },
      error: (error) => {
        console.error('[PdfPreviewPage] Failed to load medications:', error);
      }
    });
  }

  generatePdfPreview() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) {
      console.error('[PdfPreviewPage] No medication review ID');
      return;
    }

    this.isLoading = true;

    // Load notes and generate PDF
    this.reviewNotesService.loadReviewNotes(reviewId);
    
    this.reviewNotesService.notes$
      .pipe(takeUntil(this.destroy$))
      .subscribe(notes => {
        if (notes.length === 0 && this.reviewNotesService.getNotesCount() === 0) {
          return; // Still loading
        }

        if (this.medications.length === 0) {
          return; // Medications not loaded yet
        }

        // Prepare data for PDF generation
        const generalSections = this.prepareGeneralSections(notes);
        const { adherenceNotes, effectivenessNotes } = this.prepareGroupedNotes(notes);

        // Get translated part titles
        const partTitles = {
          part1: this.transloco.translate('pdf.part_1_title'),
          part2: this.transloco.translate('pdf.part_2_title'),
          part3: this.transloco.translate('pdf.part_3_title'),
          part4: this.transloco.translate('pdf.part_4_title')
        };

        // Generate PDF blob
        this.anamnesisePdfService.generatePDF(
          generalSections,
          this.medications,
          adherenceNotes as Record<string, ReviewNote[]>,
          effectivenessNotes as Record<string, ReviewNote[]>,
          true, // preview mode
          partTitles
        ).then(blob => {
          if (blob) {
            console.log('[PdfPreviewPage] PDF blob generated, size:', blob.size);
            const url = URL.createObjectURL(blob);
            console.log('[PdfPreviewPage] Blob URL created:', url);
            // Bypass security without adding fragments that might break iframe rendering
            this.pdfPreviewUrl = this.sanitizer.bypassSecurityTrustResourceUrl(url);
            this.isLoading = false;
          } else {
            console.error('[PdfPreviewPage] No blob returned from PDF service');
            this.isLoading = false;
          }
        }).catch(error => {
          console.error('[PdfPreviewPage] Error generating PDF:', error);
          this.isLoading = false;
        });
      });
  }

  downloadPdf() {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) {
      console.error('[PdfPreviewPage] No medication review ID');
      return;
    }

    // Get current notes from service
    const notes = this.reviewNotesService.getNotes();
    const generalSections = this.prepareGeneralSections(notes);
    const { adherenceNotes, effectivenessNotes } = this.prepareGroupedNotes(notes);

    // Get translated part titles
    const partTitles = {
      part1: this.transloco.translate('pdf.part_1_title'),
      part2: this.transloco.translate('pdf.part_2_title'),
      part3: this.transloco.translate('pdf.part_3_title'),
      part4: this.transloco.translate('pdf.part_4_title')
    };

    // Generate PDF and trigger download
    this.anamnesisePdfService.generatePDF(
      generalSections,
      this.medications,
      adherenceNotes as Record<string, ReviewNote[]>,
      effectivenessNotes as Record<string, ReviewNote[]>,
      false, // download mode
      partTitles
    ).catch(error => {
      console.error('Error generating PDF:', error);
    });
  }

  navigateToAnamnesis() {
    this.router.navigate(['/anamnesis']);
  }

  private prepareGeneralSections(notes: ReviewNote[]): any[] {
    // Return the standard general sections structure with predefined questions
    return [
      {
        title: 'Bezorgdheden/Ervaringen',
        questions: [
          { text: 'Ervaart de patient de geneesmiddelen als te veel?', type: 'checkbox' },
          { text: 'Ervaart de patient financiele last?', type: 'checkbox' },
          { text: 'Ervaart de patient angst?', type: 'checkbox' },
          { text: 'Ervaart de patient onvoldoende of niet behandelde klachten?', type: 'checkbox-text' },
          { text: 'Zijn er andere bezorgdheden?', type: 'text' }
        ]
      },
      {
        title: 'Medication Intake Assistance',
        questions: [
          { text: 'Heeft de patient hulp bij inname, bijvoorbeeld een pillendoos of partner/familielid?', type: 'checkbox' },
          { text: 'Is extra hulp wenselijk voor de patient?', type: 'checkbox-text' }
        ]
      },
      {
        title: 'Praktische problemen',
        questions: [
          { text: 'Heeft de patient slikproblemen?', type: 'checkbox' },
          { text: 'Heeft de patient beweegstoornissen?', type: 'checkbox' },
          { text: 'Heeft de patient visusstoornissen?', type: 'checkbox' },
          { text: 'Heeft de patient gehoorstoornissen?', type: 'checkbox' },
          { text: 'Heeft de patient cognitieve problemen?', type: 'checkbox' },
          { text: 'Heeft de patient problemen met handvaardigheid?', type: 'checkbox' },
          { text: 'Zijn er andere praktische problemen?', type: 'text' }
        ]
      },
      {
        title: 'Incidenten',
        questions: [
          { text: 'Hoe vaak is de patient in de afgelopen 6 maanden gevallen?', type: 'number' },
          { text: 'Hoe vaak is de patient gehospitaliseerd in het afgelopen jaar?', type: 'number' }
        ]
      },
      {
        title: 'Opvolging/monitoring',
        questions: [
          { text: 'Door welke hulpverleners wordt de patient opgevolgd?', type: 'text-small' },
          { text: 'Door welke hulpverleners worden de parameters opgevolgd?', type: 'text-small' }
        ]
      }
    ];
  }

  private prepareGroupedNotes(notes: ReviewNote[]): { adherenceNotes: Record<string, ReviewNote[]>, effectivenessNotes: Record<string, ReviewNote[]> } {
    const adherenceNotes: Record<string, ReviewNote[]> = {};
    const effectivenessNotes: Record<string, ReviewNote[]> = {};

    // Filter for patient conversation notes only
    const patientNotes = notes.filter(note => note.discussWithPatient === true);

    // Separate general notes (no linkedCnk) and medication-specific notes
    const generalNotes = patientNotes.filter(note => !note.linkedCnk);
    const medicationNotes = patientNotes.filter(note => note.linkedCnk);

    // Build a quick lookup of medications by CNK
    const medsByCnk: Record<string, any> = {};
    this.medications.forEach(m => {
      if (m.cnk != null) medsByCnk[String(m.cnk)] = m;
    });

    // Add general notes to appropriate sections
    generalNotes.forEach(note => {
      // Therapy adherence / medication schema general notes
      if (note.category === 'TherapyAdherence' || note.category === 'MedicationSchema') {
        if (!adherenceNotes['general']) adherenceNotes['general'] = [];
        adherenceNotes['general'].push(note);
      } else {
        // Other general notes go to effectiveness section
        if (!effectivenessNotes['general']) effectivenessNotes['general'] = [];
        effectivenessNotes['general'].push(note);
      }
    });

    // Group medication-specific notes by CNK
    medicationNotes.forEach(note => {
      const cnk = String(note.linkedCnk);

      // Therapy adherence / medication schema categories
      if (note.category === 'TherapyAdherence' || note.category === 'MedicationSchema') {
        if (!adherenceNotes[cnk]) adherenceNotes[cnk] = [];
        adherenceNotes[cnk].push(note);
      } else {
        // Effectiveness & Side-Effects related categories
        if (!effectivenessNotes[cnk]) effectivenessNotes[cnk] = [];
        effectivenessNotes[cnk].push(note);
      }
    });

    // Ensure every medication has an entry (even if empty)
    this.medications.forEach(m => {
      const key = m.cnk != null ? String(m.cnk) : 'uncategorized';
      if (!adherenceNotes[key]) adherenceNotes[key] = [];
      if (!effectivenessNotes[key]) effectivenessNotes[key] = [];
    });

    return { adherenceNotes, effectivenessNotes };
  }
}

```
--- END OF FILE: src\app\pages\pdf-preview\pdf-preview.page.ts ---

--- START OF FILE: src\app\pages\report-generation\report-generation.page.html ---
```typescript
<div class="report-generation-page">
  <div class="page-header">
    <button class="back-button" (click)="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      {{ 'documentation.back_to_actions' | transloco }}
    </button>
    <h1>{{ 'pdf.preview' | transloco }}</h1>
  </div>

  <div class="content-container">
    <!-- Left Sidebar: Tools -->
    <div class="tools-sidebar">
      <div class="tool-button" 
           [class.active]="activeTool === 'patient-summary'"
           (click)="selectTool('patient-summary')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span>{{ 'reports.patient_summary' | transloco }}</span>
      </div>

      <div class="tool-button" 
           [class.active]="activeTool === 'doctor-summary'"
           (click)="selectTool('doctor-summary')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="12" y1="18" x2="12" y2="12"></line>
          <line x1="9" y1="15" x2="15" y2="15"></line>
        </svg>
        <span>{{ 'reports.doctor_summary' | transloco }}</span>
      </div>

      <div class="tool-button" 
           [class.active]="activeTool === 'pharmacy-summary'"
           (click)="selectTool('pharmacy-summary')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
          <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
        </svg>
        <span>{{ 'reports.pharmacy_summary' | transloco }}</span>
      </div>
    </div>

    <!-- Main Content Area: PDF Preview -->
    <div class="pdf-preview-area">
      @if (activeTool === null) {
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="18" x2="12" y2="12"></line>
            <line x1="9" y1="15" x2="15" y2="15"></line>
          </svg>
          <p>{{ 'reports.select_tool' | transloco }}</p>
        </div>
      } @else {
        <div class="pdf-container">
          <div class="pdf-toolbar">
            <h3>
              @if (activeTool === 'patient-summary') {
                {{ 'reports.patient_summary' | transloco }}
              } @else if (activeTool === 'doctor-summary') {
                {{ 'reports.doctor_summary' | transloco }}
              } @else if (activeTool === 'pharmacy-summary') {
                {{ 'reports.pharmacy_summary' | transloco }}
              } @else {
                {{ 'reports.select_tool' | transloco }}
              }
            </h3>
            <button class="btn-primary" (click)="downloadPDF()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              {{ 'pdf.download' | transloco }}
            </button>
          </div>
          <div class="pdf-viewer">
            @if (isGenerating) {
              <div class="loading-state">
                <div class="spinner"></div>
                <p>{{ 'pdf.generating' | transloco }}</p>
              </div>
            } @else if (pdfUrl) {
              <iframe [src]="pdfUrl" frameborder="0"></iframe>
            } @else {
              <div class="error-state">
                <p>{{ 'pdf_errors.failed_to_generate' | transloco }}</p>
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
</div>

```
--- END OF FILE: src\app\pages\report-generation\report-generation.page.html ---

--- START OF FILE: src\app\pages\report-generation\report-generation.page.scss ---
```typescript
@import '../../../styles/colors';
@import '../../../styles/fonts';

.report-generation-page {
  height: 93vh;
  display: flex;
  flex-direction: column;
  background-color: $main-background;
  overflow: hidden;

  .page-header {
    background-color: transparent;
    padding: 1.25rem 1.5rem;
    border: none;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    flex-shrink: 0;

    .back-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background-color: transparent;
      border: 1px solid $box-border;
      border-radius: 6px;
      color: $text-secondary;
      font-family: $primary-font;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;

      &:hover {
        background-color: $main-background;
        border-color: $button-primary-background;
        color: $button-primary-background;
      }

      svg {
        flex-shrink: 0;
      }
    }

    h1 {
      flex: 1;
      margin: 0;
      font-family: $primary-font;
      font-weight: $font-weight-semibold;
      font-size: 1.5rem;
      color: $text-primary;
    }
  }

  .content-container {
    flex: 1;
    display: flex;
    gap: 1.5rem;
    padding: 0 1.5rem 1.5rem;
    overflow: hidden;

    .tools-sidebar {
      flex: 0 0 280px;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem;
      background-color: $box-background;
      border: 1px solid $box-border;
      border-radius: 8px;
      overflow-y: auto;

      .tool-button {
        display: flex;
        align-items: center;
        gap: 0.875rem;
        padding: 1rem 1.25rem;
        background-color: $main-background;
        border: 2px solid $box-border;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: $primary-font;
        font-size: 0.9375rem;
        color: $text-primary;
        font-weight: $font-weight-medium;

        svg {
          flex-shrink: 0;
          color: $text-secondary;
          transition: color 0.2s ease;
        }

        span {
          flex: 1;
        }

        &:hover {
          border-color: $button-primary-background;
          background-color: rgba($button-primary-background, 0.05);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(69, 75, 96, 0.08);

          svg {
            color: $button-primary-background;
          }
        }

        &.active {
          border-color: $button-primary-background;
          background-color: rgba($button-primary-background, 0.1);
          box-shadow: 0 4px 12px rgba(69, 75, 96, 0.12);

          svg {
            color: $button-primary-background;
          }

          span {
            color: $button-primary-background;
            font-weight: $font-weight-semibold;
          }
        }
      }
    }

    .pdf-preview-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: $box-background;
      border: 1px solid $box-border;
      border-radius: 8px;
      overflow: hidden;

      .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem 2rem;
        gap: 1rem;

        svg {
          color: $text-muted;
          opacity: 0.5;
        }

        p {
          font-family: $primary-font;
          font-size: 0.9375rem;
          color: $text-muted;
          text-align: center;
          margin: 0;
        }
      }

      .pdf-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;

        .pdf-toolbar {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 1rem 1.5rem;
          background-color: $box-background;
          border-bottom: 1px solid $box-border;
          flex-shrink: 0;

          h3 {
            margin: 0;
            font-family: $primary-font;
            font-weight: $font-weight-semibold;
            font-size: 1.125rem;
            color: $text-primary;
          }

          .btn-primary {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.65rem 1.25rem;
            background-color: $button-primary-background;
            color: $text-button-primary;
            border: none;
            border-radius: $box-border-radius-small;
            font-family: $primary-font;
            font-size: 0.9rem;
            font-weight: $font-weight-medium;
            cursor: pointer;
            transition: all 0.12s ease;

            svg {
              flex-shrink: 0;
            }

            &:hover {
              background-color: darken($button-primary-background, 5%);
              transform: translateY(-2px);
              box-shadow: 0 6px 18px rgba(69, 75, 96, 0.12);
            }

            &:active {
              transform: translateY(0);
            }
          }
        }

        .pdf-viewer {
          flex: 1;
          display: flex;
          padding: 1.5rem;
          overflow: hidden;
          background-color: #525659;

          iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: $box-border-radius-small;
            background-color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
          }

          .loading-state,
          .error-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;

            .spinner {
              width: 40px;
              height: 40px;
              border: 4px solid rgba(255, 255, 255, 0.3);
              border-top-color: white;
              border-radius: 50%;
              animation: spin 1s linear infinite;
            }

            p {
              font-family: $primary-font;
              font-size: 0.9375rem;
              color: white;
              margin: 0;
            }
          }

          .error-state p {
            color: #ff6b6b;
          }
        }
      }
    }
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

```
--- END OF FILE: src\app\pages\report-generation\report-generation.page.scss ---

--- START OF FILE: src\app\pages\report-generation\report-generation.page.ts ---
```typescript
import { Component, inject, OnInit } from '@angular/core';
import { Router } from '@angular/router';
import { CommonModule } from '@angular/common';
import { TranslocoModule, TranslocoService } from '@jsverse/transloco';
import { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser';
import { StateService } from '../../services/state.service';
import { ApiService } from '../../services/api.service';
import { PdfGenerationService } from '../../services/pdf-generation.service';

type ReportTool = 'patient-summary' | 'doctor-summary' | 'pharmacy-summary' | null;

@Component({
  selector: 'app-report-generation',
  imports: [CommonModule, TranslocoModule],
  templateUrl: './report-generation.page.html',
  styleUrls: ['./report-generation.page.scss']
})
export class ReportGenerationPage implements OnInit {
  private router = inject(Router);
  private sanitizer = inject(DomSanitizer);
  private stateService = inject(StateService);
  private apiService = inject(ApiService);
  private transloco = inject(TranslocoService);
  private pdfService = inject(PdfGenerationService);

  activeTool: ReportTool = null;
  isGenerating = false;
  pdfUrl: SafeResourceUrl | null = null;

  ngOnInit() {
    // Auto-select first tool on load
    this.selectTool('patient-summary');
  }

  goBack() {
    this.router.navigate(['/anamnesis']);
  }

  selectTool(tool: ReportTool) {
    if (this.activeTool === tool) return;
    
    this.activeTool = tool;
    this.pdfUrl = null;
    
    if (tool) {
      this.generatePDF(tool);
    }
  }

  getToolTitle(): string {
    switch (this.activeTool) {
      case 'patient-summary':
        return this.transloco.translate('reports.patient_summary');
      case 'doctor-summary':
        return this.transloco.translate('reports.doctor_summary');
      case 'pharmacy-summary':
        return this.transloco.translate('reports.pharmacy_summary');
      default:
        return '';
    }
  }

  private generatePDF(tool: ReportTool) {
    if (!tool) return;

    console.log('[ReportGeneration] Starting PDF generation for:', tool);
    this.isGenerating = true;
    this.pdfUrl = null;

    // Generate PDF using the PDF service
    let pdfObservable;
    switch (tool) {
      case 'patient-summary':
        pdfObservable = this.pdfService.generatePatientSummary();
        break;
      case 'doctor-summary':
        pdfObservable = this.pdfService.generateDoctorSummary();
        break;
      case 'pharmacy-summary':
        pdfObservable = this.pdfService.generatePharmacySummary();
        break;
      default:
        return;
    }

    pdfObservable.subscribe({
      next: (pdfBlob) => {
        console.log('[ReportGeneration] PDF blob created, size:', pdfBlob.size, 'bytes');
        
        const url = URL.createObjectURL(pdfBlob);
        console.log('[ReportGeneration] PDF URL created:', url);
        
        this.pdfUrl = this.sanitizer.bypassSecurityTrustResourceUrl(url);
        this.isGenerating = false;
        console.log('[ReportGeneration] PDF ready for display');
      },
      error: (error) => {
        console.error('[ReportGeneration] Failed to generate PDF:', error);
        this.isGenerating = false;
      }
    });
  }

  downloadPDF() {
    if (!this.pdfUrl || !this.activeTool) return;

    const filename = `${this.activeTool}-${Date.now()}.pdf`;
    
    // Create a temporary link and trigger download
    const link = document.createElement('a');
    link.href = (this.pdfUrl as any).changingThisBreaksApplicationSecurity;
    link.download = filename;
    link.click();
  }
}

```
--- END OF FILE: src\app\pages\report-generation\report-generation.page.ts ---

--- START OF FILE: src\app\services\anamnesis-pdf.service.ts ---
```typescript
import { Injectable } from '@angular/core';
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import { ReviewNote } from './review-notes.service';

@Injectable({
  providedIn: 'root'
})
export class AnamnesisePdfService {

  private sanitizeForPdf(input: string | undefined | null): string {
    if (input == null) return '';
    let s = String(input);
    const original = s;

    console.log('[Sanitize] Original string:', s);

    s = s.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

    // Collapse standard whitespace
    s = s.replace(/\s+/g, ' ');

    // Replace curly quotes ‚Üí straight
    s = s.replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g, "'")
         .replace(/[\u201C\u201D\u201E\u201F\u00AB\u00BB]/g, '"');

    // Replace dash variants
    s = s.replace(/[\u2010\u2011\u2012\u2013\u2014\u2015\u2212\u058A]/g, '-');

    // Replace bullets
    s = s.replace(/[\u2022\u2023\u2043\u00B7]/g, '-');

    // Ellipsis
    s = s.replace(/\u2026/g, '...');

    // Remove zero-width and invisible chars
    s = s.replace(/[\u200B\u200C\u200D\u2060\uFEFF]/g, '');

    // Normalize tricky spaces ‚Üí plain space
    s = s.replace(/[\u00A0\u202F\u2000-\u200A]/g, ' ');

    // Remove control characters (keeps \n)
    s = s.replace(/[\u0000-\u0008\u000B-\u000C\u000E-\u001F\u007F-\u009F]/g, '');

    s = s.replace("‚Üî", "<>");

    s = s.trim();
    
    // Log if characters were changed (for debugging)
    if (original !== s) {
      console.log('Sanitized text:', { original: JSON.stringify(original), sanitized: JSON.stringify(s) });
    }

    return s;
  }

  private formatSpecialFrequency(specialFrequency: number): string {
    const frequencyMap: Record<number, string> = {
      1: 'daily',
      2: 'twice weekly',
      3: 'three times weekly',
      4: 'weekly',
      5: 'every 2 weeks',
      6: 'every 3 weeks',
      7: 'every 4 weeks',
      8: 'monthly',
      9: 'every 2 months',
      10: 'quarterly',
      11: 'annually'
    };
    return frequencyMap[specialFrequency] || `frequency code ${specialFrequency}`;
  }

  private async loadLogoAsBase64(): Promise<string | null> {
    try {
      const response = await fetch('/images/Top_bar_logo.png');
      const blob = await response.blob();
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          resolve(reader.result as string);
        };
        reader.readAsDataURL(blob);
      });
    } catch (error) {
      console.warn('Failed to load logo:', error);
      return null;
    }
  }

  private async getLogoImageWithAspectRatio(): Promise<{ data: string; width: number; height: number } | null> {
    const logoBase64 = await this.loadLogoAsBase64();
    if (!logoBase64) return null;

    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        resolve({
          data: logoBase64,
          width: img.naturalWidth,
          height: img.naturalHeight
        });
      };
      img.onerror = () => {
        resolve(null);
      };
      img.src = logoBase64;
    });
  }

  async generatePDF(
    generalSections: { title: string; questions: { text: string; type: string }[] }[],
    medications: any[],
    adherenceNotesByMedication: Record<string, ReviewNote[]>,
    effectivenessNotesByMedication: Record<string, ReviewNote[]>,
    previewMode: boolean = false,
    partTitles?: { part1: string; part2: string; part3: string; part4: string }
  ): Promise<Blob | void> {
    // Console log all notes for debugging
    console.log('=== PDF Generation Debug ===');
    console.log('Adherence Notes:', adherenceNotesByMedication);
    console.log('Effectiveness Notes:', effectivenessNotesByMedication);
    
    const doc = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });

    let yPosition = 20;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15;
    const contentWidth = pageWidth - (margin * 2);

    // Add logo to top right with proper aspect ratio
    const logoInfo = await this.getLogoImageWithAspectRatio();
    if (logoInfo) {
      try {
        const maxLogoHeight = 15; // Maximum height in mm
        const aspectRatio = logoInfo.width / logoInfo.height;
        const logoHeight = maxLogoHeight;
        const logoWidth = logoHeight * aspectRatio; // Calculate width to maintain aspect ratio
        const logoX = pageWidth - margin - logoWidth; // Right aligned
        const logoY = margin; // Top aligned
        doc.addImage(logoInfo.data, 'PNG', logoX, logoY, logoWidth, logoHeight);
      } catch (error) {
        console.warn('Failed to add logo to PDF:', error);
      }
    }

    // Set default part titles if not provided
    const titles = partTitles || {
      part1: 'Part 1: General Questions',
      part2: 'Medication Scheme',
      part3: 'Part 2: Therapy Adherence',
      part4: 'Part 3: Effectiveness & Side-Effects'
    };

    // Title
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
  doc.text(this.sanitizeForPdf('Anamnesis Preparation'), margin, yPosition);
    yPosition += 12;

    // Add horizontal line
    doc.setLineWidth(0.5);
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 8;

    // Medication Schema (not numbered as a part)
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
  doc.text(this.sanitizeForPdf(titles.part2), margin, yPosition);
    yPosition += 8;

    // Add medication scheme table
    if (medications.length > 0) {
      const tableData = medications.map(med => {
        // Check for special frequency first
        if (med.specialFrequency && med.specialDescription) {
          const freqText = this.formatSpecialFrequency(med.specialFrequency);
          return [
            this.sanitizeForPdf(med.name || 'Unnamed'),
            '',
            '',
            '',
            '',
            '',
            '',
            this.sanitizeForPdf(`${med.specialDescription} (${freqText})`)
          ];
        } else if (med.asNeeded) {
          // As needed medication
          return [
            this.sanitizeForPdf(med.name || 'Unnamed'),
            '',
            '',
            '',
            '',
            '',
            '',
            this.sanitizeForPdf('As needed')
          ];
        } else {
          // Standard daily schedule with intake moments
          return [
            this.sanitizeForPdf(med.name || 'Unnamed'),
            this.sanitizeForPdf(med.unitsBeforeBreakfast || ''),
            this.sanitizeForPdf(med.unitsDuringBreakfast || ''),
            this.sanitizeForPdf(med.unitsBeforeLunch || ''),
            this.sanitizeForPdf(med.unitsDuringLunch || ''),
            this.sanitizeForPdf(med.unitsBeforeDinner || ''),
            this.sanitizeForPdf(med.unitsDuringDinner || ''),
            this.sanitizeForPdf(med.unitsAtBedtime || '')
          ];
        }
      });

      autoTable(doc, {
        head: [['Medication', 'Before\nBreakfast', 'During\nBreakfast', 'Before\nLunch', 'During\nLunch', 'Before\nDinner', 'During\nDinner', 'Bedtime']],
        body: tableData,
        startY: yPosition,
        margin: margin,
        theme: 'grid',
        columnStyles: {
          0: { cellWidth: 50, halign: 'left' },
          1: { cellWidth: 15 },
          2: { cellWidth: 15 },
          3: { cellWidth: 15 },
          4: { cellWidth: 15 },
          5: { cellWidth: 15 },
          6: { cellWidth: 15 },
          7: { cellWidth: 30 }
        },
        headStyles: {
          fillColor: [69, 75, 96],
          textColor: 255,
          fontSize: 8,
          fontStyle: 'bold',
          halign: 'center',
          valign: 'middle',
          cellPadding: 3,
          lineWidth: 0.5,
          lineColor: [0, 0, 0]
        },
        bodyStyles: {
          fontSize: 9,
          textColor: 0,
          halign: 'center',
          valign: 'middle',
          cellPadding: 4,
          lineWidth: 0.3,
          lineColor: [100, 100, 100]
        },
        alternateRowStyles: {
          fillColor: [245, 245, 245]
        }
      });

      yPosition = (doc as any).lastAutoTable.finalY + 10;
    }

    // Start a new page for the parts
    doc.addPage();
    yPosition = 20;

    // Part 1: General Questions
    generalSections.forEach(section => {
      // Check if we need a new page
      if (yPosition > pageHeight - 40) {
        doc.addPage();
        yPosition = 20;
      }

      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text(this.sanitizeForPdf(section.title), margin, yPosition);
      yPosition += 6;

      section.questions.forEach(q => {
        if (yPosition > pageHeight - 30) {
          doc.addPage();
          yPosition = 20;
        }

        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setDrawColor(100, 100, 100);
        doc.setLineWidth(0.3);

        // Draw checkbox or text field based on type
        if (q.type === 'checkbox' || q.type === 'checkbox-text') {
          // Draw checkbox with consistent border
          const checkboxSize = 4;
          doc.rect(margin, yPosition - 3, checkboxSize, checkboxSize); // Empty checkbox with border
          const lines = doc.splitTextToSize(this.sanitizeForPdf(q.text), contentWidth - 10);
          doc.text(lines, margin + 7, yPosition);
          yPosition += Math.max(6, lines.length * 5);

          // Add text field if checkbox-text
          if (q.type === 'checkbox-text') {
            doc.setDrawColor(200, 200, 200);
            doc.line(margin + 7, yPosition, pageWidth - margin, yPosition);
            yPosition += 8;
          }
        } else if (q.type === 'number') {
          const lines = doc.splitTextToSize(this.sanitizeForPdf(q.text), contentWidth - 25);
          doc.text(lines, margin, yPosition);
          const textHeight = lines.length * 5;
          // Draw number field box
          doc.setDrawColor(150, 150, 150);
          doc.rect(pageWidth - margin - 20, yPosition - 4, 20, 6);
          yPosition += Math.max(8, textHeight + 2);
        } else if (q.type === 'text' || q.type === 'text-small') {
          const lines = doc.splitTextToSize(this.sanitizeForPdf(q.text), contentWidth);
          doc.text(lines, margin, yPosition);
          yPosition += lines.length * 5 + 2;
          
          // Draw text field lines
          const lineCount = q.type === 'text' ? 2 : 1;
          doc.setDrawColor(200, 200, 200);
          for (let i = 0; i < lineCount; i++) {
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 6;
          }
        }

        yPosition += 2;
      });

      yPosition += 4;
    });

    // Combined Parts 2 & 3: Therapy Adherence and Effectiveness
    // Use landscape orientation for better space
    doc.addPage('a4', 'landscape');
    
    // Get landscape dimensions
    const landscapeWidth = doc.internal.pageSize.getWidth();
    const landscapeHeight = doc.internal.pageSize.getHeight();
    const landscapeMargin = 10; // Reduced from 15 to 10
    
    yPosition = landscapeMargin;

    // Prepare table data combining both parts with separate note fields
    const combinedTableData: any[] = [];
    
    // Add general notes row if they exist
    const generalAdherenceNotes = adherenceNotesByMedication['General'] || adherenceNotesByMedication['general'] || [];
    const generalEffectivenessNotes = effectivenessNotesByMedication['General'] || effectivenessNotesByMedication['general'] || [];
    
    if (generalAdherenceNotes.length > 0 || generalEffectivenessNotes.length > 0) {
      combinedTableData.push([
        this.sanitizeForPdf('General Notes'),
        { 
          adherenceNotes: generalAdherenceNotes, 
          effectivenessNotes: [], 
          isGeneral: true,
          maxNoteCount: Math.max(generalAdherenceNotes.length, generalEffectivenessNotes.length)
        },
        { 
          adherenceNotes: [], 
          effectivenessNotes: generalEffectivenessNotes, 
          isGeneral: true,
          maxNoteCount: Math.max(generalAdherenceNotes.length, generalEffectivenessNotes.length)
        }
      ]);
    }

    // Add rows for each medication
    medications.forEach(med => {
      const medName = med.name || 'Unnamed medication';
      const adherenceNotes = adherenceNotesByMedication[medName] || [];
      const effectivenessNotes = effectivenessNotesByMedication[medName] || [];
      const maxNoteCount = Math.max(adherenceNotes.length, effectivenessNotes.length);
      
      combinedTableData.push([
        this.sanitizeForPdf(medName),
        { adherenceNotes, effectivenessNotes: [], isGeneral: false, maxNoteCount },
        { adherenceNotes: [], effectivenessNotes, isGeneral: false, maxNoteCount }
      ]);
    });

    // Create the combined table with custom cell rendering
    autoTable(doc, {
      head: [[
        this.sanitizeForPdf('Medication'),
        this.sanitizeForPdf(titles.part3),
        this.sanitizeForPdf(titles.part4)
      ]],
      body: combinedTableData,
      startY: yPosition,
      margin: landscapeMargin,
      theme: 'grid',
      columnStyles: {
        0: { cellWidth: 65, halign: 'left', valign: 'middle' },
        1: { cellWidth: 100, halign: 'left', valign: 'top' },
        2: { cellWidth: 100, halign: 'left', valign: 'top' }
      },
      headStyles: {
        fillColor: [69, 75, 96],
        textColor: 255,
        fontSize: 10,
        fontStyle: 'bold',
        halign: 'center',
        valign: 'middle',
        cellPadding: 5,
        lineWidth: 0.5,
        lineColor: [0, 0, 0]
      },
      bodyStyles: {
        fontSize: 8,
        textColor: 0,
        halign: 'left',
        valign: 'top',
        cellPadding: 5,
        minCellHeight: 55, // Default to ~1/3 of landscape page height
        lineWidth: 0.3,
        lineColor: [80, 80, 80]
      },
      rowPageBreak: 'avoid',
      alternateRowStyles: {
        fillColor: [250, 250, 250]
      },
      didParseCell: (data: any) => {
        // Set row height early in the process based on max note count
        if (data.section === 'body') {
          const cellData = data.row.raw[1]; // Check column 1 for maxNoteCount
          if (typeof cellData === 'object' && cellData !== null && cellData.maxNoteCount) {
            const maxNoteCount = cellData.maxNoteCount;
            
            // Calculate height dynamically based on note count
            // Each note needs space for text + at least 2 writing lines
            // Use a more conservative formula to avoid huge rows
            let dynamicHeight = 55; // Minimum height for 1-3 notes
            
            if (maxNoteCount > 3) {
              // For each note beyond 3, add 20mm (not 26mm)
              dynamicHeight = 55 + ((maxNoteCount - 3) * 20);
            }
            
            // Set the row's minCellHeight
            data.row.height = dynamicHeight;
            data.cell.styles.minCellHeight = dynamicHeight;
          }
        }
      },
      willDrawCell: (data: any) => {
        // Prevent default text rendering for columns 1 and 2 (notes columns)
        if (data.section === 'body' && (data.column.index === 1 || data.column.index === 2)) {
          data.cell.text = ''; // Clear the text so it doesn't render [object Object]
        }
      },
      didDrawCell: (data: any) => {
        // Custom rendering for notes columns with separate text fields
        if (data.section === 'body' && (data.column.index === 1 || data.column.index === 2)) {
          const cell = data.cell;
          const cellData = data.row.raw[data.column.index];
          
          if (typeof cellData === 'object' && cellData !== null) {
            const notes = data.column.index === 1 ? cellData.adherenceNotes : cellData.effectivenessNotes;
            const cellPadding = 3;
            let currentY = cell.y + cellPadding;
            
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            
            // Calculate available space - distribute equally among all notes
            const availableWidth = cell.width - (cellPadding * 2);
            const availableHeight = cell.height - (cellPadding * 2);
            const displayNotes = notes; // Use all notes, don't limit them
            const noteCount = displayNotes.length > 0 ? displayNotes.length : 3; // Default to 3 empty sections
            const noteHeight = availableHeight / noteCount;
            
            // If no notes, create equal sections with lines for writing
            if (displayNotes.length === 0) {
              for (let section = 0; section < 3; section++) {
                const sectionY = currentY + (section * noteHeight);
                
                // Draw separator line between sections
                if (section > 0) {
                  doc.setDrawColor(150, 150, 150);
                  doc.setLineWidth(0.3);
                  doc.line(
                    cell.x + cellPadding,
                    sectionY,
                    cell.x + cell.width - cellPadding,
                    sectionY
                  );
                }
                
                // Draw horizontal lines for writing
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.15);
                const lineSpacing = 6;
                const startY = sectionY + 3;
                const sectionHeight = noteHeight - 3;
                const lineCount = Math.floor(sectionHeight / lineSpacing);
                
                for (let i = 0; i < lineCount; i++) {
                  const lineY = startY + (i * lineSpacing);
                  if (lineY < sectionY + noteHeight - 1) {
                    doc.line(
                      cell.x + cellPadding + 2,
                      lineY,
                      cell.x + cell.width - cellPadding - 2,
                      lineY
                    );
                  }
                }
              }
            } else {
              // Draw each note in its own section - all notes get equal space
              displayNotes.forEach((note: ReviewNote, index: number) => {
                const fieldY = currentY + (index * noteHeight);
                
                // Draw separator line between notes
                if (index > 0) {
                  doc.setDrawColor(150, 150, 150);
                  doc.setLineWidth(0.3);
                  doc.line(
                    cell.x + cellPadding,
                    fieldY,
                    cell.x + cell.width - cellPadding,
                    fieldY
                  );
                }
                
                // Draw the note text at the top of the section
                const noteText = this.sanitizeForPdf(note.text);
                doc.setFontSize(7.5);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(40, 40, 40);
                
                // Use a simple bullet character that works in PDF
                const bulletText = '- ' + noteText;
                const textLines = doc.splitTextToSize(bulletText, availableWidth - 6);
                const maxLines = 2; // Limit to 2 lines for the note itself
                const displayLines = textLines.slice(0, maxLines);
                
                doc.text(displayLines, cell.x + cellPadding + 3, fieldY + 4);
                
                // Add horizontal lines for writing below the note - use ALL remaining space
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.15);
                const textHeight = displayLines.length * 3;
                const startLineY = fieldY + 4 + textHeight + 2;
                const remainingHeight = noteHeight - (4 + textHeight + 2);
                const lineSpacing = 6;
                const lineCount = Math.floor(remainingHeight / lineSpacing);
                
                for (let j = 0; j < lineCount; j++) {
                  const lineY = startLineY + (j * lineSpacing);
                  if (lineY < fieldY + noteHeight - 1) {
                    doc.line(
                      cell.x + cellPadding + 2,
                      lineY,
                      cell.x + cell.width - cellPadding - 2,
                      lineY
                    );
                  }
                }
              });
            }
          }
        }
      }
    });

    if (previewMode) {
      return doc.output('blob');
    } else {
      doc.save('anamnesis-preparation.pdf');
    }
  }
}

```
--- END OF FILE: src\app\services\anamnesis-pdf.service.ts ---

--- START OF FILE: src\app\services\api.service.ts ---
```typescript
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders, HttpParams } from '@angular/common/http';
import { Observable } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { of } from 'rxjs';
import { 
  LoginRequest, 
  LoginResponse, 
  UpdatePatientRequest, 
  UpdatePatientResponse, 
  UpdateMedicationReviewRequest, 
  UpdateMedicationReviewResponse,
  APBContraindicationsRequest,
  APBContraindicationsResponse,
  APBContraindicationsResponseBackend,
  Contraindication,
  AddContraindicationRequest,
  UpdateContraindicationRequest,
  ContraindicationResponse,
  MedicationSearchRequest,
  MedicationSearchResponse,
  Medication,
  AddMedicationRequest,
  MedicationResponse,
  UpdateMedicationRequest,
  LabValue,
  AddLabValueRequest,
  UpdateLabValueRequest,
  LabValueResponse,
  DispensingHistoryResponse,
  AddManualDispensingMomentRequest,
  AddManualDispensingMomentResponse,
  QuestionAnswer,
  AddQuestionAnswerRequest,
  UpdateQuestionAnswerRequest,
  QuestionAnswerResponse
} from '../models/api.models';
import { environment } from '../../environments/environment';

@Injectable({
  providedIn: 'root'
})
export class ApiService {
  // API base URL is now configured via environment files
  // Development: Uses '/api' with proxy to http://localhost:7071/api
  // Production: Update environment.prod.ts with the production API URL
  private readonly API_BASE_URL = environment.apiBaseUrl;

  constructor(private http: HttpClient) {}

  private getHeaders(): HttpHeaders {
    return new HttpHeaders({
      'Content-Type': 'application/json',
      'Cache-Control': 'no-cache, no-store, must-revalidate',
      'Pragma': 'no-cache',
      'Expires': '0'
    });
  }

  login(request: LoginRequest): Observable<LoginResponse> {
    const headers = this.getHeaders();

    return this.http.post<any>(`${this.API_BASE_URL}/login`, request, { headers })
      .pipe(
        tap(rawResponse => console.log('[ApiService] RAW Login response:', rawResponse)),
        map(response => ({
          patientCreated: response.patientCreated ?? response.PatientCreated ?? false,
          reviewCreated: response.reviewCreated ?? response.ReviewCreated ?? false,
          patientId: response.patientId ?? response.PatientId ?? '',
          medicationReviewId: response.medicationReviewId ?? response.MedicationReviewId ?? '',
          patient: {
            dateOfBirth: response.patient?.dateOfBirth ?? response.patient?.DateOfBirth ?? response.Patient?.dateOfBirth ?? response.Patient?.DateOfBirth ?? null,
            sex: response.patient?.sex ?? response.patient?.Sex ?? response.Patient?.sex ?? response.Patient?.Sex ?? null,
            renalFunction: response.patient?.renalFunction ?? response.patient?.RenalFunction ?? response.Patient?.renalFunction ?? response.Patient?.RenalFunction ?? null
          },
          review: {
            reviewDate: response.review?.reviewDate ?? response.review?.ReviewDate ?? response.Review?.reviewDate ?? response.Review?.ReviewDate ?? null,
            firstNameAtTimeOfReview: response.review?.firstNameAtTimeOfReview ?? response.review?.FirstNameAtTimeOfReview ?? response.Review?.firstNameAtTimeOfReview ?? response.Review?.FirstNameAtTimeOfReview ?? null,
            lastNameAtTimeOfReview: response.review?.lastNameAtTimeOfReview ?? response.review?.LastNameAtTimeOfReview ?? response.Review?.lastNameAtTimeOfReview ?? response.Review?.LastNameAtTimeOfReview ?? null
          }
        })),
        tap(mappedResponse => console.log('[ApiService] Mapped Login response:', mappedResponse))
      );
  }

  updatePatient(request: UpdatePatientRequest): Observable<UpdatePatientResponse> {
    const headers = this.getHeaders();

    return this.http.put<UpdatePatientResponse>(`${this.API_BASE_URL}/update_patient`, request, { headers })
      .pipe(tap(response => console.log('[ApiService] Update patient response:', response)));
  }

  updateMedicationReview(request: UpdateMedicationReviewRequest): Observable<UpdateMedicationReviewResponse> {
    const headers = this.getHeaders();

    return this.http.put<UpdateMedicationReviewResponse>(`${this.API_BASE_URL}/update_medication_review`, request, { headers })
      .pipe(tap(response => console.log('[ApiService] Update review response:', response)));
  }

  // APB Contraindications
  getAPBContraindications(request: APBContraindicationsRequest): Observable<APBContraindicationsResponse> {
    const headers = this.getHeaders();

    return this.http.post<APBContraindicationsResponseBackend>(`${this.API_BASE_URL}/get_apb_contraindications`, request, { headers })
      .pipe(
        map(backendResponse => {
          // Convert PascalCase to camelCase, including nested items
          const response: APBContraindicationsResponse = {
            language: backendResponse.Language,
            result: {
              hypersensitivities: {
                list: backendResponse.Result.Hypersensitivities.List.map(item => ({
                  code: (item as any).Code || item.code,
                  description: (item as any).Description || item.description
                }))
              },
              pathologies: {
                list: backendResponse.Result.Pathologies.List.map(item => ({
                  code: (item as any).Code || item.code,
                  description: (item as any).Description || item.description
                }))
              },
              physiologicalConditions: {
                list: backendResponse.Result.PhysiologicalConditions.List.map(item => ({
                  code: (item as any).Code || item.code,
                  description: (item as any).Description || item.description
                }))
              }
            }
          };
          return response;
        })
      );
  }

  // Contraindication CRUD
  getContraindications(medicationReviewId: string): Observable<Contraindication[]> {
    return this.http.get<any[]>(`${this.API_BASE_URL}/manage_contraindications?medicationReviewId=${medicationReviewId}`, {
      headers: this.getHeaders()
    })
      .pipe(
        map(items => items.map(item => ({
          contraindicationId: item.rowKey || item.ContraindicationId || item.contraindicationId,
          name: item.name || item.Name,
          contraindicationCode: item.contraindicationCode || item.ContraindicationCode
        })))
      );
  }

  addContraindication(reviewId: string, contraindication: any): Observable<ContraindicationResponse> {
    const headers = this.getHeaders();

    const request = { medicationReviewId: reviewId, ...contraindication };

    return this.http.post<any>(`${this.API_BASE_URL}/manage_contraindications`, request, { headers })
      .pipe(
        map(item => ({
          contraindicationId: item.rowKey || item.ContraindicationId || item.contraindicationId,
          name: item.name || item.Name,
          contraindicationCode: item.contraindicationCode || item.ContraindicationCode
        }))
      );
  }

  updateContraindication(reviewId: string, contraindicationId: string, contraindication: any): Observable<ContraindicationResponse> {
    const headers = this.getHeaders();

    const request = { 
      medicationReviewId: reviewId, 
      contraindicationId, 
      ...contraindication 
    };

    return this.http.put<any>(`${this.API_BASE_URL}/manage_contraindications`, request, { headers })
      .pipe(
        map(item => ({
          contraindicationId: item.rowKey || item.ContraindicationId || item.contraindicationId,
          name: item.name || item.Name,
          contraindicationCode: item.contraindicationCode || item.ContraindicationCode
        }))
      );
  }

  deleteContraindication(medicationReviewId: string, contraindicationId: string): Observable<void> {
    return this.http.delete<void>(`${this.API_BASE_URL}/manage_contraindications?medicationReviewId=${medicationReviewId}&contraindicationId=${contraindicationId}`);
  }

  // Medication Search
  searchMedications(request: MedicationSearchRequest): Observable<MedicationSearchResponse> {
    const headers = this.getHeaders();

    return this.http.post<any>(`${this.API_BASE_URL}/search_medications`, request, { headers })
      .pipe(
        tap(rawResponse => console.log('[ApiService] RAW search_medications response:', JSON.stringify(rawResponse, null, 2))),
        map(backendResponse => ({
          searchTerm: backendResponse.searchTerm || backendResponse.SearchTerm,
          count: backendResponse.count || backendResponse.Count,
          results: (backendResponse.results || backendResponse.Results || []).map((item: any) => ({
            benaming: item.benaming || item.Benaming,
            cnk: item.cnk || item.CNK || item.Cnk,
            verpakking: item.verpakking || item.Verpakking,
            vmp: item.vmp || item.VMP || item.Vmp || null
          }))
        }))
      );
  }

  // Medication CRUD
  getMedications(medicationReviewId: string): Observable<Medication[]> {
    console.log('[ApiService] === GET MEDICATIONS ===');
    console.log('[ApiService] URL: GET', `${this.API_BASE_URL}/manage_medications?medicationReviewId=${medicationReviewId}`);
    
    return this.http.get<any[]>(`${this.API_BASE_URL}/manage_medications?medicationReviewId=${medicationReviewId}`, { 
      headers: this.getHeaders() 
    })
      .pipe(
        tap(rawResponse => {
          console.log('[ApiService] RAW backend response:', JSON.stringify(rawResponse, null, 2));
        }),
        map(items => {
          const mapped = items.map(item => ({
            medicationId: item.rowKey ?? item.MedicationId ?? item.medicationId,
            name: item.name ?? item.Name ?? null,
            cnk: item.cnk ?? item.CNK ?? item.Cnk ?? null,
            asNeeded: (item.asNeeded === true || item.asNeeded === 'true' || item.AsNeeded === true || item.AsNeeded === 'true') ? true : false,
            vmp: item.vmp ?? item.VMP ?? item.Vmp ?? null,
            packageSize: item.packageSize ?? item.PackageSize ?? null,
            dosageMg: item.dosageMg ?? item.DosageMg ?? null,
            routeOfAdministration: item.routeOfAdministration ?? item.RouteOfAdministration ?? null,
            indication: item.indication ?? item.Indication ?? null,
            specialFrequency: item.specialFrequency ?? item.SpecialFrequency ?? null,
            specialDescription: item.specialDescription ?? item.SpecialDescription ?? null,
            unitsBeforeBreakfast: item.unitsBeforeBreakfast ?? item.UnitsBeforeBreakfast ?? null,
            unitsDuringBreakfast: item.unitsDuringBreakfast ?? item.UnitsDuringBreakfast ?? null,
            unitsBeforeLunch: item.unitsBeforeLunch ?? item.UnitsBeforeLunch ?? null,
            unitsDuringLunch: item.unitsDuringLunch ?? item.UnitsDuringLunch ?? null,
            unitsBeforeDinner: item.unitsBeforeDinner ?? item.UnitsBeforeDinner ?? null,
            unitsDuringDinner: item.unitsDuringDinner ?? item.UnitsDuringDinner ?? null,
            unitsAtBedtime: item.unitsAtBedtime ?? item.UnitsAtBedtime ?? null,
            timestamp: item.timestamp ?? item.Timestamp ?? null
          }));
          
          // Sort by timestamp (oldest first)
          mapped.sort((a, b) => {
            if (!a.timestamp && !b.timestamp) return 0;
            if (!a.timestamp) return 1;
            if (!b.timestamp) return -1;
            return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
          });
          
          console.log('[ApiService] Medications sorted by timestamp:', mapped.length);
          return mapped;
        })
      );
  }

  addMedication(reviewId: string, medication: any): Observable<MedicationResponse> {
    const headers = this.getHeaders();

    const request = { medicationReviewId: reviewId, ...medication };

    console.log('[ApiService] === ADD MEDICATION ===');
    console.log('[ApiService] Request:', JSON.stringify(request, null, 2));

    return this.http.post<any>(`${this.API_BASE_URL}/manage_medications`, request, { headers })
      .pipe(
        tap(rawResponse => {
          console.log('[ApiService] RAW add medication response:', JSON.stringify(rawResponse, null, 2));
        }),
        map(item => ({
          medicationId: item.rowKey ?? item.MedicationId ?? item.medicationId,
          name: item.name ?? item.Name ?? null,
          asNeeded: (item.asNeeded === true || item.asNeeded === 'true' || item.AsNeeded === true || item.AsNeeded === 'true') ? true : false,
          cnk: item.cnk ?? item.CNK ?? item.Cnk ?? null,
          vmp: item.vmp ?? item.VMP ?? item.Vmp ?? null,
          packageSize: item.packageSize ?? item.PackageSize ?? null,
          dosageMg: item.dosageMg ?? item.DosageMg ?? null,
          routeOfAdministration: item.routeOfAdministration ?? item.RouteOfAdministration ?? null,
          indication: item.indication ?? item.Indication ?? null,
          specialFrequency: item.specialFrequency ?? item.SpecialFrequency ?? null,
          specialDescription: item.specialDescription ?? item.SpecialDescription ?? null,
          unitsBeforeBreakfast: item.unitsBeforeBreakfast ?? item.UnitsBeforeBreakfast ?? null,
          unitsDuringBreakfast: item.unitsDuringBreakfast ?? item.UnitsDuringBreakfast ?? null,
          unitsBeforeLunch: item.unitsBeforeLunch ?? item.UnitsBeforeLunch ?? null,
          unitsDuringLunch: item.unitsDuringLunch ?? item.UnitsDuringLunch ?? null,
          unitsBeforeDinner: item.unitsBeforeDinner ?? item.UnitsBeforeDinner ?? null,
          unitsDuringDinner: item.unitsDuringDinner ?? item.UnitsDuringDinner ?? null,
          unitsAtBedtime: item.unitsAtBedtime ?? item.UnitsAtBedtime ?? null
        }))
      );
  }

  updateMedication(reviewId: string, medicationId: string, medication: any): Observable<MedicationResponse> {
    const headers = this.getHeaders();

    const request = { 
      medicationReviewId: reviewId, 
      medicationId, 
      ...medication 
    };

    console.log('[ApiService] === UPDATE MEDICATION REQUEST ===');
    console.log('[ApiService] URL: PUT', `${this.API_BASE_URL}/manage_medications`);
    console.log('[ApiService] Request body:', JSON.stringify(request, null, 2));

    return this.http.put<any>(`${this.API_BASE_URL}/manage_medications`, request, { headers })
      .pipe(
        tap(rawResponse => {
          console.log('[ApiService] RAW backend response:', JSON.stringify(rawResponse, null, 2));
        }),
        map(item => ({
          medicationId: item.rowKey ?? item.MedicationId ?? item.medicationId,
          name: item.name ?? item.Name ?? null,
          asNeeded: (item.asNeeded === true || item.asNeeded === 'true' || item.AsNeeded === true || item.AsNeeded === 'true') ? true : false,
          cnk: item.cnk ?? item.CNK ?? item.Cnk ?? null,
          vmp: item.vmp ?? item.VMP ?? item.Vmp ?? null,
          packageSize: item.packageSize ?? item.PackageSize ?? null,
          dosageMg: item.dosageMg ?? item.DosageMg ?? null,
          routeOfAdministration: item.routeOfAdministration ?? item.RouteOfAdministration ?? null,
          indication: item.indication ?? item.Indication ?? null,
          specialFrequency: item.specialFrequency ?? item.SpecialFrequency ?? null,
          specialDescription: item.specialDescription ?? item.SpecialDescription ?? null,
          unitsBeforeBreakfast: item.unitsBeforeBreakfast ?? item.UnitsBeforeBreakfast ?? null,
          unitsDuringBreakfast: item.unitsDuringBreakfast ?? item.UnitsDuringBreakfast ?? null,
          unitsBeforeLunch: item.unitsBeforeLunch ?? item.UnitsBeforeLunch ?? null,
          unitsDuringLunch: item.unitsDuringLunch ?? item.UnitsDuringLunch ?? null,
          unitsBeforeDinner: item.unitsBeforeDinner ?? item.UnitsBeforeDinner ?? null,
          unitsDuringDinner: item.unitsDuringDinner ?? item.UnitsDuringDinner ?? null,
          unitsAtBedtime: item.unitsAtBedtime ?? item.UnitsAtBedtime ?? null
        }))
      );
  }

  deleteMedication(medicationReviewId: string, medicationId: string): Observable<void> {
    return this.http.delete<void>(`${this.API_BASE_URL}/manage_medications?medicationReviewId=${medicationReviewId}&medicationId=${medicationId}`);
  }

  // Lab Value CRUD
  getLabValues(medicationReviewId: string): Observable<LabValue[]> {
    return this.http.get<any[]>(`${this.API_BASE_URL}/manage_lab_values?medicationReviewId=${medicationReviewId}`, {
      headers: this.getHeaders()
    })
      .pipe(
        map(items => items.map(item => ({
          labValueId: item.rowKey ?? item.LabValueId ?? item.labValueId,
          name: item.name ?? item.Name ?? null,
          value: item.value ?? item.Value ?? 0,
          unit: item.unit ?? item.Unit ?? null
        })))
      );
  }

  addLabValue(reviewId: string, labValue: any): Observable<LabValueResponse> {
    const headers = this.getHeaders();

    const request = { medicationReviewId: reviewId, ...labValue };

    return this.http.post<any>(`${this.API_BASE_URL}/manage_lab_values`, request, { headers })
      .pipe(
        map(item => ({
          labValueId: item.rowKey ?? item.LabValueId ?? item.labValueId,
          name: item.name ?? item.Name ?? null,
          value: item.value ?? item.Value ?? 0,
          unit: item.unit ?? item.Unit ?? null
        }))
      );
  }

  updateLabValue(reviewId: string, labValueId: string, labValue: any): Observable<LabValueResponse> {
    const headers = this.getHeaders();

    const request = { 
      medicationReviewId: reviewId, 
      labValueId, 
      ...labValue 
    };

    return this.http.put<any>(`${this.API_BASE_URL}/manage_lab_values`, request, { headers })
      .pipe(
        map(item => ({
          labValueId: item.rowKey ?? item.LabValueId ?? item.labValueId,
          name: item.name ?? item.Name ?? null,
          value: item.value ?? item.Value ?? 0,
          unit: item.unit ?? item.Unit ?? null
        }))
      );
  }

  deleteLabValue(medicationReviewId: string, labValueId: string): Observable<void> {
    return this.http.delete<void>(`${this.API_BASE_URL}/manage_lab_values?medicationReviewId=${medicationReviewId}&labValueId=${labValueId}`);
  }

  // Dispensing History
  uploadDispensingHistory(apbNumber: string, reviewId: string, file: File): Observable<any> {
    const formData = new FormData();
    formData.append('file', file);
    
    return this.http.post(
      `${this.API_BASE_URL}/upload_dispensing_history?apbNumber=${apbNumber}&medicationReviewId=${reviewId}`,
      formData
    ).pipe(tap(response => console.log('[ApiService] Upload dispensing history response:', response)));
  }

  queryDispensingHistory(apbNumber: string, reviewId: string): Observable<DispensingHistoryResponse> {
    return this.http.get<any>(
      `${this.API_BASE_URL}/query_dispensing_history?apbNumber=${apbNumber}&medicationReviewId=${reviewId}`
    ).pipe(
      tap(response => {
        console.log('[ApiService] Query dispensing history raw response:', JSON.stringify(response, null, 2));
        if (response.dispensingData?.[0]?.dispensingMoments?.[0]) {
          console.log('[ApiService] First raw moment:', response.dispensingData[0].dispensingMoments[0]);
        }
      }),
      map(response => ({
        medicationReviewId: response.medicationReviewId ?? response.MedicationReviewId,
        blobUri: response.blobUri ?? response.BlobUri,
        totalCnkCodes: response.totalCnkCodes ?? response.TotalCnkCodes,
        totalDispensingMoments: response.totalDispensingMoments ?? response.TotalDispensingMoments,
        csvMoments: response.csvMoments ?? response.CsvMoments,
        manualMoments: response.manualMoments ?? response.ManualMoments,
        dispensingData: (response.dispensingData ?? response.DispensingData ?? []).map((cnkGroup: any) => ({
          cnk: cnkGroup.cnk ?? cnkGroup.Cnk ?? cnkGroup.CNK,
          description: cnkGroup.description ?? cnkGroup.Description,
          dispensingMoments: (cnkGroup.dispensingMoments ?? cnkGroup.DispensingMoments ?? []).map((moment: any) => {
            const extractedId = moment.id ?? moment.Id ?? moment.rowKey ?? moment.RowKey;
            console.log('[ApiService] Extracting ID from moment:', { rawId: moment.id, rawId_PascalCase: moment.Id, rawRowKey: moment.rowKey, rawRowKey_PascalCase: moment.RowKey, extractedId });
            return {
              date: moment.date ?? moment.Date,
              amount: moment.amount ?? moment.Amount,
              source: moment.source ?? moment.Source,
              id: extractedId
            };
          })
        }))
      })),
      tap(response => {
        console.log('[ApiService] Query dispensing history mapped response:', JSON.stringify(response, null, 2));
        if (response.dispensingData?.[0]?.dispensingMoments?.[0]) {
          console.log('[ApiService] First mapped moment:', response.dispensingData[0].dispensingMoments[0]);
        }
      })
    );
  }

  addManualDispensingMoment(
    apbNumber: string, 
    reviewId: string, 
    moment: AddManualDispensingMomentRequest
  ): Observable<AddManualDispensingMomentResponse> {
    const headers = this.getHeaders();

    return this.http.post<AddManualDispensingMomentResponse>(
      `${this.API_BASE_URL}/add_manual_dispensing_moment?apbNumber=${apbNumber}&medicationReviewId=${reviewId}`,
      moment,
      { headers }
    ).pipe(tap(response => console.log('[ApiService] Add manual dispensing moment response:', response)));
  }

  deleteManualDispensingMoment(
    apbNumber: string,
    reviewId: string,
    id: string
  ): Observable<any> {
    return this.http.delete<any>(
      `${this.API_BASE_URL}/delete_manual_dispensing_moment?apbNumber=${apbNumber}&medicationReviewId=${reviewId}&id=${id}`
    ).pipe(tap(response => console.log('[ApiService] Delete manual dispensing moment response:', response)));
  }

  checkInteractions(request: any): Observable<any> {
    const headers = new HttpHeaders({
      'Content-Type': 'application/json'
    });

    return this.http.post<any>(
      `${this.API_BASE_URL}/get_interactions`,
      request,
      { headers }
    ).pipe(tap(response => console.log('[ApiService] Interactions response:', response)));
  }

  getInteractionDetails(request: any): Observable<any> {
    const headers = new HttpHeaders({
      'Content-Type': 'application/json'
    });

    return this.http.post<any>(
      `${this.API_BASE_URL}/get_interaction_details`,
      request,
      { headers }
    ).pipe(tap(response => console.log('[ApiService] Interaction details response:', response)));
  }

  // Contraindication Matching
  getContraindicationMatches(request: any): Observable<any> {
    const headers = new HttpHeaders({
      'Content-Type': 'application/json'
    });

    return this.http.post<any>(
      `${this.API_BASE_URL}/get_contraindication_matches`,
      request,
      { headers }
    ).pipe(tap(response => console.log('[ApiService] Contraindication matches response:', response)));
  }

  getProductContraindications(cnk: string, language?: string): Observable<any> {
    const headers = new HttpHeaders({
      'Content-Type': 'application/json'
    });

    return this.http.post<any>(
      `${this.API_BASE_URL}/get_product_contraindications`,
      { cnk, language: language || 'NL' },
      { headers }
    ).pipe(tap(response => console.log('[ApiService] Product contraindications response:', response)));
  }

  // Product Dosage (Posology)
  getProductDosage(cnk: string, language?: string): Observable<any> {
    const headers = new HttpHeaders({
      'Content-Type': 'application/json'
    });

    return this.http.post<any>(
      `${this.API_BASE_URL}/get_product_dosage`,
      { cnk, language: language || 'NL' },
      { headers }
    ).pipe(tap(response => console.log('[ApiService] Product dosage response:', response)));
  }

  // Product Renadaptor (Renal Dosing)
  getProductRenadaptor(cnk: string, language?: string): Observable<any> {
    const headers = new HttpHeaders({
      'Content-Type': 'application/json'
    });

    return this.http.post<any>(
      `${this.API_BASE_URL}/get_product_renadaptor`,
      { cnk, language: language || 'NL' },
      { headers }
    ).pipe(tap(response => console.log('[ApiService] Product renadaptor response:', response)));
  }

  // Reference Documents
  getReferenceDocumentUrl(type: 'gheops' | 'start-stop'): string {
    return `${this.API_BASE_URL}/get_reference_document?type=${type}`;
  }

  getReferenceDocument(type: 'gheops' | 'start-stop'): Observable<Blob> {
    return this.http.get(`${this.API_BASE_URL}/get_reference_document?type=${type}`, {
      responseType: 'blob'
    }).pipe(
      tap(() => console.log(`[ApiService] Retrieved reference document: ${type}`))
    );
  }

  // Review Notes CRUD
  getReviewNotes(medicationReviewId: string): Observable<any[]> {
    return this.http.get<any[]>(`${this.API_BASE_URL}/manage_review_notes?medicationReviewId=${medicationReviewId}`, {
      headers: this.getHeaders()
    }).pipe(
      tap(response => console.log('[ApiService] Get review notes response:', response))
    );
  }

  addReviewNote(reviewId: string, note: any): Observable<any> {
    const headers = this.getHeaders();
    const request = { medicationReviewId: reviewId, ...note };

    return this.http.post<any>(`${this.API_BASE_URL}/manage_review_notes`, request, { headers })
      .pipe(tap(response => console.log('[ApiService] Add review note response:', response)));
  }

  updateReviewNote(reviewId: string, reviewNoteId: string, updates: any): Observable<any> {
    const headers = this.getHeaders();
    const request = { 
      medicationReviewId: reviewId, 
      reviewNoteId, 
      ...updates 
    };

    return this.http.put<any>(`${this.API_BASE_URL}/manage_review_notes`, request, { headers })
      .pipe(tap(response => console.log('[ApiService] Update review note response:', response)));
  }

  deleteReviewNote(medicationReviewId: string, reviewNoteId: string): Observable<any> {
    return this.http.delete<any>(
      `${this.API_BASE_URL}/manage_review_notes?medicationReviewId=${medicationReviewId}&reviewNoteId=${reviewNoteId}`,
      { headers: this.getHeaders() }
    ).pipe(tap(response => console.log('[ApiService] Delete review note response:', response)));
  }

  // Question Answer CRUD
  getQuestionAnswers(medicationReviewId: string): Observable<QuestionAnswer[]> {
    return this.http.get<QuestionAnswer[]>(
      `${this.API_BASE_URL}/manage_question_answers?medicationReviewId=${medicationReviewId}`,
      { headers: this.getHeaders() }
    ).pipe(tap(response => console.log('[ApiService] Get question answers response:', response)));
  }

  getQuestionAnswer(medicationReviewId: string, questionName: string): Observable<QuestionAnswerResponse> {
    return this.http.get<QuestionAnswerResponse>(
      `${this.API_BASE_URL}/manage_question_answers?medicationReviewId=${medicationReviewId}&questionName=${questionName}`,
      { headers: this.getHeaders() }
    ).pipe(tap(response => console.log('[ApiService] Get question answer response:', response)));
  }

  addQuestionAnswer(request: AddQuestionAnswerRequest): Observable<QuestionAnswerResponse> {
    const headers = this.getHeaders();

    return this.http.post<QuestionAnswerResponse>(
      `${this.API_BASE_URL}/manage_question_answers`,
      request,
      { headers }
    ).pipe(tap(response => console.log('[ApiService] Add question answer response:', response)));
  }

  updateQuestionAnswer(request: UpdateQuestionAnswerRequest): Observable<QuestionAnswerResponse> {
    const headers = this.getHeaders();

    return this.http.put<QuestionAnswerResponse>(
      `${this.API_BASE_URL}/manage_question_answers`,
      request,
      { headers }
    ).pipe(tap(response => console.log('[ApiService] Update question answer response:', response)));
  }

  deleteQuestionAnswer(medicationReviewId: string, questionName: string): Observable<any> {
    return this.http.delete<any>(
      `${this.API_BASE_URL}/manage_question_answers?medicationReviewId=${medicationReviewId}&questionName=${questionName}`,
      { headers: this.getHeaders() }
    ).pipe(tap(response => console.log('[ApiService] Delete question answer response:', response)));
  }
}


```
--- END OF FILE: src\app\services\api.service.ts ---

--- START OF FILE: src\app\services\pdf-generation.service.ts ---
```typescript
import { Injectable, inject } from '@angular/core';
import { TranslocoService } from '@jsverse/transloco';
import pdfMake from 'pdfmake/build/pdfmake';
import { vfs } from 'pdfmake/build/vfs_fonts';
import { TDocumentDefinitions, Content } from 'pdfmake/interfaces';
import { ApiService } from './api.service';
import { StateService } from './state.service';
import { forkJoin, Observable, of } from 'rxjs';
import { map, catchError, mergeMap } from 'rxjs/operators';
import { 
  QuestionAnswer, 
  Medication, 
  Contraindication, 
  LabValue,
  Patient,
  MedicationReview 
} from '../models/api.models';

// Initialize pdfMake with fonts
(pdfMake as any).vfs = vfs;

interface ReportData {
  patient: Patient | null;
  review: MedicationReview | null;
  medications: Medication[];
  questionAnswers: QuestionAnswer[];
  contraindications: Contraindication[];
  labValues: LabValue[];
}

@Injectable({
  providedIn: 'root'
})
export class PdfGenerationService {
  private apiService = inject(ApiService);
  private stateService = inject(StateService);
  private transloco = inject(TranslocoService);

  // Brand colors from _colors.scss
  private readonly brandPrimary = '#454B60';
  private readonly brandSecondary = '#5F6476';
  private readonly brandAccent = '#9DC9A2';
  private readonly textPrimary = '#454B60';
  private readonly textSecondary = '#666666';
  private readonly borderColor = '#e0e0e0';

  private loadReportData(): Observable<ReportData> {
    const reviewId = this.stateService.medicationReviewId;
    if (!reviewId) {
      return of({
        patient: null,
        review: null,
        medications: [],
        questionAnswers: [],
        contraindications: [],
        labValues: []
      });
    }

    const sessionData = this.stateService.getSessionData();

    return forkJoin({
      medications: this.apiService.getMedications(reviewId).pipe(catchError(() => of([]))),
      questionAnswers: this.apiService.getQuestionAnswers(reviewId).pipe(catchError(() => of([]))),
      contraindications: this.apiService.getContraindications(reviewId).pipe(catchError(() => of([]))),
      labValues: this.apiService.getLabValues(reviewId).pipe(catchError(() => of([])))
    }).pipe(
      map(data => ({
        patient: sessionData?.patient || null,
        review: sessionData?.review || null,
        medications: data.medications,
        questionAnswers: data.questionAnswers,
        contraindications: data.contraindications,
        labValues: data.labValues
      }))
    );
  }

  generatePatientSummary(): Observable<Blob> {
    return this.loadReportData().pipe(
      mergeMap((data: ReportData) => {
        const docDefinition = this.createPatientSummaryDocument(data);
        return this.createPdfBlob(docDefinition);
      })
    );
  }

  generateDoctorSummary(): Observable<Blob> {
    return this.loadReportData().pipe(
      mergeMap((data: ReportData) => {
        const docDefinition = this.createDoctorSummaryDocument(data);
        return this.createPdfBlob(docDefinition);
      })
    );
  }

  generatePharmacySummary(): Observable<Blob> {
    return this.loadReportData().pipe(
      mergeMap((data: ReportData) => {
        const docDefinition = this.createPharmacySummaryDocument(data);
        return this.createPdfBlob(docDefinition);
      })
    );
  }

  private createPdfBlob(docDefinition: TDocumentDefinitions): Observable<Blob> {
    return new Observable<Blob>(observer => {
      try {
        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
        
        pdfDocGenerator.getBlob((blob) => {
          observer.next(blob);
          observer.complete();
        });
      } catch (error) {
        observer.error(error);
      }
    });
  }

  private createPatientSummaryDocument(data: ReportData): TDocumentDefinitions {
    const content: Content[] = [];

    // Header
    content.push(this.createHeader(this.transloco.translate('pdf.patient_summary')));
    content.push(this.createSpacer(20));

    // Patient Info
    content.push(this.createPatientInfoSection(data));
    content.push(this.createSpacer(15));

    // Notes to Discuss with Patient
    const patientNotes = data.questionAnswers.filter(qa => qa.shareWithPatient && qa.value);
    if (patientNotes.length > 0) {
      content.push(this.createSectionTitle(this.transloco.translate('pdf.pharmacist_notes')));
      content.push(this.createSpacer(10));
      
      patientNotes.forEach(note => {
        const noteContent = this.createNoteCard(note, data.medications);
        content.push(noteContent);
        content.push(this.createSpacer(8));
      });
    } else {
      content.push({
        text: this.transloco.translate('pdf.no_notes') || 'No notes',
        style: 'emptyState'
      });
    }

    return {
      content,
      styles: this.getStyles(),
      pageMargins: [40, 60, 40, 60]
    };
  }

  private createDoctorSummaryDocument(data: ReportData): TDocumentDefinitions {
    const content: Content[] = [];

    // Header
    content.push(this.createHeader(this.transloco.translate('pdf.doctor_summary')));
    content.push(this.createSpacer(20));

    // Patient Info
    content.push(this.createPatientInfoSection(data));
    content.push(this.createSpacer(15));

    // Medication List
    if (data.medications.length > 0) {
      content.push(this.createSectionTitle(this.transloco.translate('pdf.current_medications')));
      content.push(this.createSpacer(10));
      content.push(this.createMedicationScheduleTable(data.medications));
      content.push(this.createSpacer(15));
    }

    // Clinical Notes for Doctor
    const doctorNotes = data.questionAnswers.filter(qa => qa.shareWithDoctor && qa.value);
    if (doctorNotes.length > 0) {
      content.push(this.createSectionTitle('Pharmacist Observations'));
      content.push(this.createSpacer(10));
      
      doctorNotes.forEach(note => {
        const noteContent = this.createNoteCard(note, data.medications);
        content.push(noteContent);
        content.push(this.createSpacer(8));
      });
    } else {
      content.push({
        text: 'No clinical observations marked for review.',
        style: 'emptyState'
      });
    }

    return {
      content,
      styles: this.getStyles(),
      pageMargins: [40, 60, 40, 60]
    };
  }

  private createPharmacySummaryDocument(data: ReportData): TDocumentDefinitions {
    const content: Content[] = [];

    // Header
    content.push(this.createHeader(this.transloco.translate('pdf.pharmacy_summary')));
    content.push(this.createSpacer(20));

    // Patient Info
    content.push(this.createPatientInfoSection(data));
    content.push(this.createSpacer(15));

    // Medications with Schema
    if (data.medications.length > 0) {
      content.push(this.createSectionTitle(this.transloco.translate('pdf.current_medications')));
      content.push(this.createSpacer(10));
      content.push(this.createMedicationScheduleTable(data.medications));
      content.push(this.createSpacer(15));
    }

    // Contraindications
    if (data.contraindications.length > 0) {
      content.push(this.createSectionTitle(this.transloco.translate('tools.contraindications')));
      content.push(this.createSpacer(10));
      data.contraindications.forEach(ci => {
        content.push({
          text: `‚Ä¢ ${ci.name || ci.contraindicationCode}`,
          style: 'listItem'
        });
      });
      content.push(this.createSpacer(15));
    }

    // Lab Values
    if (data.labValues.length > 0) {
      content.push(this.createSectionTitle('Lab Values'));
      content.push(this.createSpacer(10));
      content.push(this.createLabValuesTable(data.labValues));
      content.push(this.createSpacer(15));
    }

    // Comprehensive Anamnesis - Part 1
    this.addPart1QuestionsToPharmacySummary(content, data);

    // Part 2: Medication Adherence
    this.addPart2QuestionsToPharmacySummary(content, data);

    // Part 3: Medication Effectiveness and Side Effects
    this.addPart3QuestionsToPharmacySummary(content, data);

    return {
      content,
      styles: this.getStyles(),
      pageMargins: [40, 60, 40, 60]
    };
  }

  private addPart1QuestionsToPharmacySummary(content: Content[], data: ReportData) {
    content.push(this.createSectionTitle(this.transloco.translate('pdf.part_1')));
    content.push(this.createSpacer(10));

    // Patient Concerns
    const concernsAnswers = this.getAnswersForSection(data.questionAnswers, 'p1_concerns_');
    if (concernsAnswers.length > 0) {
      content.push({ text: this.transloco.translate('pdf.patient_concerns') || 'Patient Concerns', style: 'subsectionTitle' });
      content.push(this.createSpacer(5));
      this.addQuestionAnswerPairs(content, concernsAnswers, [
        { key: 'tooMany', label: this.transloco.translate('pdf.patient_concern_tooMany') },
        { key: 'financialBurden', label: this.transloco.translate('pdf.patient_concern_financialBurden') },
        { key: 'anxiety', label: this.transloco.translate('pdf.patient_concern_anxiety') },
        { key: 'untreatedComplaints', label: this.transloco.translate('pdf.patient_concern_untreatedComplaints') },
        { key: 'other', label: this.transloco.translate('pdf.patient_concern_other') }
      ]);
      content.push(this.createSpacer(10));
    }

    // Medication Assistance
    const helpAnswers = this.getAnswersForSection(data.questionAnswers, 'p1_help_');
    if (helpAnswers.length > 0) {
      content.push({ text: this.transloco.translate('pdf.medication_assistance') || 'Medication Assistance', style: 'subsectionTitle' });
      content.push(this.createSpacer(5));
      this.addQuestionAnswerPairs(content, helpAnswers, [
        { key: 'hasAssistance', label: this.transloco.translate('pdf.medication_help_hasAssistance') },
        { key: 'additionalNeededQuestion', label: this.transloco.translate('pdf.medication_help_additionalNeeded') }
      ]);
      content.push(this.createSpacer(10));
    }

    // Practical Problems
    const practicalAnswers = this.getAnswersForSection(data.questionAnswers, 'p1_practical_');
    if (practicalAnswers.length > 0) {
      content.push({ text: this.transloco.translate('pdf.practical_problems') || 'Practical Problems', style: 'subsectionTitle' });
      content.push(this.createSpacer(5));
      this.addQuestionAnswerPairs(content, practicalAnswers, [
        { key: 'swallowing', label: this.transloco.translate('pdf.practical_problem_swallowing') },
        { key: 'movement', label: this.transloco.translate('pdf.practical_problem_movement') },
        { key: 'vision', label: this.transloco.translate('pdf.practical_problem_vision') },
        { key: 'hearing', label: this.transloco.translate('pdf.practical_problem_hearing') },
        { key: 'cognitive', label: this.transloco.translate('pdf.practical_problem_cognitive') },
        { key: 'dexterity', label: this.transloco.translate('pdf.practical_problem_dexterity') },
        { key: 'other', label: this.transloco.translate('pdf.practical_problem_other') }
      ]);
      content.push(this.createSpacer(10));
    }

    // Incidents
    const incidentAnswers = this.getAnswersForSection(data.questionAnswers, 'p1_incidents_');
    if (incidentAnswers.length > 0) {
      content.push({ text: this.transloco.translate('pdf.incidents') || 'Incidents', style: 'subsectionTitle' });
      content.push(this.createSpacer(5));
      this.addQuestionAnswerPairs(content, incidentAnswers, [
        { key: 'falls', label: this.transloco.translate('pdf.incidents_falls') },
        { key: 'hospitalizations', label: this.transloco.translate('pdf.incidents_hospitalizations') },
        { key: 'actionNeeded', label: this.transloco.translate('pdf.incidents_actionNeeded') }
      ]);
      content.push(this.createSpacer(10));
    }

    // Follow-up/Monitoring
    const followupAnswers = this.getAnswersForSection(data.questionAnswers, 'p1_followup_');
    if (followupAnswers.length > 0) {
      content.push({ text: this.transloco.translate('pdf.follow_up_monitoring') || 'Follow-up and Monitoring', style: 'subsectionTitle' });
      content.push(this.createSpacer(5));
      this.addQuestionAnswerPairs(content, followupAnswers, [
        { key: 'careProviders', label: this.transloco.translate('pdf.followup_careProviders') },
        { key: 'parameterMonitoring', label: this.transloco.translate('pdf.followup_parameterMonitoring') },
        { key: 'actionNeeded', label: this.transloco.translate('pdf.followup_actionNeeded') }
      ]);
      content.push(this.createSpacer(10));
    }
  }

  private addPart2QuestionsToPharmacySummary(content: Content[], data: ReportData) {
    const part2Answers = data.questionAnswers.filter(qa => qa.questionName.startsWith('p2_med_'));
    if (part2Answers.length === 0) return;

    content.push(this.createSectionTitle(this.transloco.translate('pdf.part_2')));
    content.push(this.createSpacer(10));

    // Group by medication
    const medicationGroups = this.groupAnswersByMedication(part2Answers, data.medications);
    
    medicationGroups.forEach(group => {
      content.push({ text: group.medicationName, style: 'subsectionTitle' });
      content.push(this.createSpacer(5));
      
      this.addQuestionAnswerPairs(content, group.answers, [
        { key: 'adherence', label: this.transloco.translate('pdf.adherence_takes_as_prescribed') },
        { key: 'frequency', label: this.transloco.translate('pdf.adherence_frequency_forgotten') },
        { key: 'barriers', label: this.transloco.translate('pdf.adherence_problems') },
        { key: 'notes', label: this.transloco.translate('pdf.pharmacist_notes') }
      ]);
      
      content.push(this.createSpacer(10));
    });
  }

  private addPart3QuestionsToPharmacySummary(content: Content[], data: ReportData) {
    const part3Answers = data.questionAnswers.filter(qa => qa.questionName.startsWith('p3_med_'));
    if (part3Answers.length === 0) return;

    content.push(this.createSectionTitle(this.transloco.translate('pdf.part_3')));
    content.push(this.createSpacer(10));

    // Group by medication
    const medicationGroups = this.groupAnswersByMedication(part3Answers, data.medications);
    
    medicationGroups.forEach(group => {
      content.push({ text: group.medicationName, style: 'subsectionTitle' });
      content.push(this.createSpacer(5));
      
      this.addQuestionAnswerPairs(content, group.answers, [
        { key: 'effective', label: this.transloco.translate('pdf.effectiveness_is_effective') },
        { key: 'effectiveAction', label: this.transloco.translate('pdf.pharmacist_notes') },
        { key: 'hasSideEffects', label: this.transloco.translate('pdf.effectiveness_has_side_effects') },
        { key: 'sideEffectsAction', label: this.transloco.translate('pdf.pharmacist_notes') }
      ]);
      
      content.push(this.createSpacer(10));
    });
  }

  private getAnswersForSection(answers: QuestionAnswer[], prefix: string): QuestionAnswer[] {
    return answers.filter(qa => qa.questionName.startsWith(prefix));
  }

  private addQuestionAnswerPairs(content: Content[], answers: QuestionAnswer[], questionMap: { key: string; label: string }[]) {
    questionMap.forEach(q => {
      const answer = answers.find(a => a.questionName.includes(`_${q.key}`));
      if (answer && answer.value) {
        content.push({
          columns: [
            { text: q.label, style: 'questionLabel', width: '*' },
            { text: answer.value, style: 'answerValue', width: '60%' }
          ],
          margin: [0, 2, 0, 2]
        });
      }
    });
  }

  private groupAnswersByMedication(answers: QuestionAnswer[], medications: Medication[]): { medicationName: string; answers: QuestionAnswer[] }[] {
    const groups: Map<string, QuestionAnswer[]> = new Map();
    
    answers.forEach(answer => {
      const cnkMatch = answer.questionName.match(/med_(\d+)/);
      if (cnkMatch) {
        const cnk = cnkMatch[1];
        if (!groups.has(cnk)) {
          groups.set(cnk, []);
        }
        groups.get(cnk)!.push(answer);
      }
    });

    return Array.from(groups.entries()).map(([cnk, answers]) => {
      const med = medications.find(m => String(m.cnk) === cnk);
      return {
        medicationName: med?.name || `Medication CNK: ${cnk}`,
        answers
      };
    });
  }

  private createHeader(title: string): Content {
    return {
      columns: [
        {
          text: title,
          style: 'header',
          width: '*'
        },
        {
          text: new Date().toLocaleDateString(),
          style: 'headerDate',
          width: 'auto'
        }
      ]
    };
  }

  private createPatientInfoSection(data: ReportData): Content {
    const items: any[] = [];

    if (data.review?.firstNameAtTimeOfReview || data.review?.lastNameAtTimeOfReview) {
      const name = [data.review.firstNameAtTimeOfReview, data.review.lastNameAtTimeOfReview]
        .filter(Boolean)
        .join(' ');
      items.push({ text: this.transloco.translate('patient.name') + ':', style: 'infoLabel', width: 80 });
      items.push({ text: name, style: 'infoValue', width: '*' });
    }

    if (data.patient?.dateOfBirth) {
      if (items.length > 0) {
        items.push({ text: '', width: 20 }); // Spacer
      }
      items.push({ text: this.transloco.translate('patient.birth_date') + ':', style: 'infoLabel', width: 60 });
      // Format date: extract date part only (YYYY-MM-DD)
      const formattedDate = data.patient.dateOfBirth.split('T')[0];
      items.push({ text: formattedDate, style: 'infoValue', width: 'auto' });
    }

    if (data.patient?.sex) {
      if (items.length > 0) {
        items.push({ text: '', width: 20 }); // Spacer
      }
      items.push({ text: this.transloco.translate('patient.sex') + ':', style: 'infoLabel', width: 60 });
      items.push({ text: data.patient.sex, style: 'infoValue', width: 'auto' });
    }

    if (items.length === 0) {
      return { text: '' };
    }

    return {
      columns: items,
      style: 'patientInfo'
    };
  }

  private createSectionTitle(title: string): Content {
    return {
      text: title,
      style: 'sectionTitle'
    };
  }

  private createNoteCard(note: QuestionAnswer, medications: Medication[]): Content {
    const context = this.getNoteContext(note.questionName, medications);
    
    const stack: any[] = [];
    
    // Add context header if available
    if (context.category) {
      stack.push({
        text: context.category,
        style: 'noteCategory',
        margin: [0, 0, 0, 2]
      });
    }
    
    // Add medication name if applicable
    if (context.medicationName) {
      stack.push({
        text: context.medicationName,
        style: 'noteMedication',
        margin: [0, 0, 0, 4]
      });
    }
    
    // Add question context
    if (context.question) {
      stack.push({
        text: context.question,
        style: 'noteQuestion',
        margin: [0, 0, 0, 4]
      });
    }
    
    // Add the actual note content
    stack.push({
      text: note.value || '',
      style: 'noteContent',
      margin: [0, 0, 0, 0]
    });
    
    return {
      stack,
      margin: [10, 5, 10, 10],
      fillColor: '#f9f9f9'
    };
  }

  private getNoteContext(questionName: string, medications: Medication[]): { 
    category?: string; 
    medicationName?: string; 
    question?: string;
  } {
    const context: { category?: string; medicationName?: string; question?: string } = {};
    
    // Extract CNK if present
    const cnkMatch = questionName.match(/med_(\d+)/);
    if (cnkMatch) {
      const cnk = parseInt(cnkMatch[1]);
      const med = medications.find(m => m.cnk === cnk);
      if (med?.name) {
        context.medicationName = `Medication: ${med.name} (CNK: ${med.cnk})`;
        if (med.indication) {
          context.medicationName += ` - ${med.indication}`;
        }
      }
    }
    
    // Determine category and question context
    if (questionName.startsWith('p1_concerns_')) {
      context.category = 'Part 1: Patient Concerns';
      if (questionName.includes('tooManyAction')) context.question = 'Action for: Patient feels they take too many medications';
      else if (questionName.includes('financialBurdenAction')) context.question = 'Action for: Financial burden concern';
      else if (questionName.includes('anxietyAction')) context.question = 'Action for: Anxiety about medications';
      else if (questionName.includes('untreatedComplaintsAction')) context.question = 'Action for: Untreated complaints';
      else if (questionName.includes('otherAction')) context.question = 'Action for: Other concerns';
    } else if (questionName.startsWith('p1_help_')) {
      context.category = 'Part 1: Medication Assistance';
      if (questionName.includes('additionalNeededAction')) context.question = 'Action for: Additional assistance needed';
    } else if (questionName.startsWith('p1_practical_')) {
      context.category = 'Part 1: Practical Problems';
      if (questionName.includes('swallowingAction')) context.question = 'Action for: Swallowing difficulties';
      else if (questionName.includes('movementAction')) context.question = 'Action for: Movement limitations';
      else if (questionName.includes('visionAction')) context.question = 'Action for: Vision problems';
      else if (questionName.includes('hearingAction')) context.question = 'Action for: Hearing problems';
      else if (questionName.includes('cognitiveAction')) context.question = 'Action for: Cognitive problems';
      else if (questionName.includes('dexterityAction')) context.question = 'Action for: Dexterity issues';
      else if (questionName.includes('otherAction')) context.question = 'Action for: Other practical problems';
    } else if (questionName.includes('p1_incidents_action')) {
      context.category = 'Part 1: Incidents';
      context.question = 'Pharmacist action regarding falls or hospitalizations';
    } else if (questionName.includes('p1_followup_action')) {
      context.category = 'Part 1: Follow-up/Monitoring';
      context.question = 'Pharmacist action for care coordination and monitoring';
    } else if (questionName.includes('p2_med_') && questionName.includes('_notes')) {
      context.category = 'Part 2: Therapy Adherence';
      context.question = 'Pharmacist notes on medication adherence';
    } else if (questionName.includes('p2_med_') && questionName.includes('_barriers')) {
      context.category = 'Part 2: Therapy Adherence';
      context.question = 'Barriers to taking medication as prescribed';
    } else if (questionName.includes('p3_med_') && questionName.includes('effectiveAction')) {
      context.category = 'Part 3: Medication Effectiveness';
      context.question = 'Action for: Medication not working as expected';
    } else if (questionName.includes('p3_med_') && questionName.includes('sideEffectsAction')) {
      context.category = 'Part 3: Side Effects';
      context.question = 'Action for: Patient experiencing side effects';
    }
    
    return context;
  }

  private createMedicationTable(medications: Medication[]): Content {
    const tableBody: any[] = [
      [
        { text: this.transloco.translate('pdf.medication'), style: 'tableHeader' },
        { text: this.transloco.translate('pdf.frequency_per_day'), style: 'tableHeader' },
        { text: this.transloco.translate('pdf.indication'), style: 'tableHeader' }
      ]
    ];

    medications.forEach(med => {
      tableBody.push([
        { text: med.name || this.transloco.translate('pdf.no_medication'), style: 'tableCell' },
        { text: this.formatFrequency(med), style: 'tableCell' },
        { text: med.indication || '-', style: 'tableCell' }
      ]);
    });

    return {
      table: {
        headerRows: 1,
        widths: ['*', 'auto', '*'],
        body: tableBody
      },
      layout: {
        hLineWidth: () => 0.5,
        vLineWidth: () => 0.5,
        hLineColor: () => this.borderColor,
        vLineColor: () => this.borderColor,
        paddingLeft: () => 8,
        paddingRight: () => 8,
        paddingTop: () => 6,
        paddingBottom: () => 6
      }
    };
  }

  private createMedicationScheduleTable(medications: Medication[]): Content {
    const tableBody: any[] = [
      [
        { text: this.transloco.translate('pdf.medication'), style: 'tableHeader' },
        { text: this.transloco.translate('medication.breakfast'), style: 'tableHeader' },
        { text: this.transloco.translate('medication.lunch'), style: 'tableHeader' },
        { text: this.transloco.translate('medication.dinner'), style: 'tableHeader' },
        { text: this.transloco.translate('medication.bedtime'), style: 'tableHeader' }
      ]
    ];

    medications.forEach(med => {
      // Check for special frequency (non-daily)
      if (med.specialFrequency && med.specialDescription) {
        const frequencyMap: Record<number, string> = {
          1: 'daily',
          2: 'twice weekly',
          3: 'three times weekly',
          4: 'weekly',
          5: 'every 2 weeks',
          6: 'every 3 weeks',
          7: 'every 4 weeks',
          8: 'monthly',
          9: 'every 2 months',
          10: 'quarterly',
          11: 'annually'
        };
        const freqText = frequencyMap[med.specialFrequency] || `code ${med.specialFrequency}`;
        tableBody.push([
          { text: med.name || 'Unknown', style: 'tableCell' },
          { text: `${med.specialDescription}`, style: 'tableCell', alignment: 'center' },
          { text: `(${freqText})`, style: 'tableCell', alignment: 'center', colSpan: 3 }
        ]);
      } else if (med.asNeeded) {
        // As needed medication
        tableBody.push([
          { text: med.name || 'Unknown', style: 'tableCell' },
          { text: 'As needed', style: 'tableCell', alignment: 'center', colSpan: 4 }
        ]);
      } else {
        // Standard daily schedule
        const morning = [med.unitsBeforeBreakfast, med.unitsDuringBreakfast]
          .filter(u => u && u > 0)
          .map(u => String(u))
          .join('+') || '-';
        
        const noon = [med.unitsBeforeLunch, med.unitsDuringLunch]
          .filter(u => u && u > 0)
          .map(u => String(u))
          .join('+') || '-';
        
        const evening = [med.unitsBeforeDinner, med.unitsDuringDinner]
          .filter(u => u && u > 0)
          .map(u => String(u))
          .join('+') || '-';
        
        const bedtime = med.unitsAtBedtime && med.unitsAtBedtime > 0 
          ? String(med.unitsAtBedtime) 
          : '-';

        tableBody.push([
          { text: med.name || 'Unknown', style: 'tableCell' },
          { text: morning, style: 'tableCell', alignment: 'center' },
          { text: noon, style: 'tableCell', alignment: 'center' },
          { text: evening, style: 'tableCell', alignment: 'center' },
          { text: bedtime, style: 'tableCell', alignment: 'center' }
        ]);
      }
    });

    return {
      table: {
        headerRows: 1,
        widths: ['*', 'auto', 'auto', 'auto', 'auto'],
        body: tableBody
      },
      layout: {
        hLineWidth: () => 0.5,
        vLineWidth: () => 0.5,
        hLineColor: () => this.borderColor,
        vLineColor: () => this.borderColor,
        paddingLeft: () => 8,
        paddingRight: () => 8,
        paddingTop: () => 6,
        paddingBottom: () => 6
      }
    };
  }

  private createLabValuesTable(labValues: LabValue[]): Content {
    const tableBody: any[] = [
      [
        { text: 'Parameter', style: 'tableHeader' },
        { text: 'Value', style: 'tableHeader' },
        { text: 'Unit', style: 'tableHeader' }
      ]
    ];

    labValues.forEach(lab => {
      tableBody.push([
        { text: lab.name || 'Unknown', style: 'tableCell' },
        { text: String(lab.value), style: 'tableCell', alignment: 'right' },
        { text: lab.unit || '', style: 'tableCell' }
      ]);
    });

    return {
      table: {
        headerRows: 1,
        widths: ['*', 'auto', 'auto'],
        body: tableBody
      },
      layout: {
        hLineWidth: () => 0.5,
        vLineWidth: () => 0.5,
        hLineColor: () => this.borderColor,
        vLineColor: () => this.borderColor,
        paddingLeft: () => 8,
        paddingRight: () => 8,
        paddingTop: () => 6,
        paddingBottom: () => 6
      }
    };
  }

  private formatDosage(med: Medication): string {
    if (med.dosageMg) {
      return `${med.dosageMg}mg`;
    }
    return '-';
  }

  private formatFrequency(med: Medication): string {
    const doses = [
      med.unitsBeforeBreakfast || 0,
      med.unitsDuringBreakfast || 0,
      med.unitsBeforeLunch || 0,
      med.unitsDuringLunch || 0,
      med.unitsBeforeDinner || 0,
      med.unitsDuringDinner || 0,
      med.unitsAtBedtime || 0
    ];
    
    const totalPerDay = doses.reduce((sum, dose) => sum + dose, 0);
    const timesPerDay = doses.filter(d => d > 0).length;
    
    if (totalPerDay === 0) {
      return med.asNeeded ? (this.transloco.translate('pdf.as_needed') || 'As needed') : '-';
    }
    
    if (timesPerDay === 1) {
      return this.transloco.translate('pdf.x_daily', { count: totalPerDay }) || `${totalPerDay}x daily`;
    }
    
    return this.transloco.translate('pdf.units_x_daily', { units: totalPerDay, count: timesPerDay }) || `${totalPerDay} units, ${timesPerDay}x daily`;
  }

  private createSpacer(height: number): Content {
    return { text: '', margin: [0, height, 0, 0] };
  }

  private getStyles(): any {
    return {
      header: {
        fontSize: 24,
        bold: true,
        color: this.brandPrimary,
        margin: [0, 0, 0, 0]
      },
      headerDate: {
        fontSize: 12,
        color: this.textSecondary,
        alignment: 'right',
        margin: [0, 8, 0, 0]
      },
      sectionTitle: {
        fontSize: 16,
        bold: true,
        color: this.brandPrimary,
        margin: [0, 0, 0, 0]
      },
      subsectionTitle: {
        fontSize: 13,
        bold: true,
        color: this.brandSecondary,
        margin: [0, 5, 0, 0]
      },
      questionLabel: {
        fontSize: 10,
        color: this.textSecondary,
        bold: false
      },
      answerValue: {
        fontSize: 10,
        color: this.textPrimary,
        bold: true
      },
      patientInfo: {
        fillColor: '#f5f5f5',
        margin: [0, 0, 0, 0]
      },
      infoLabel: {
        fontSize: 10,
        bold: true,
        color: this.textSecondary
      },
      infoValue: {
        fontSize: 10,
        color: this.textPrimary
      },
      noteCategory: {
        fontSize: 9,
        bold: true,
        color: this.brandAccent,
        italics: true
      },
      noteMedication: {
        fontSize: 11,
        bold: true,
        color: this.brandPrimary
      },
      noteQuestion: {
        fontSize: 10,
        color: this.textSecondary,
        italics: true
      },
      noteLabel: {
        fontSize: 11,
        bold: true,
        color: this.brandPrimary,
        margin: [0, 0, 0, 4]
      },
      noteContent: {
        fontSize: 10,
        color: this.textPrimary,
        lineHeight: 1.4
      },
      tableHeader: {
        fontSize: 11,
        bold: true,
        color: this.brandPrimary,
        fillColor: '#f5f5f5'
      },
      tableCell: {
        fontSize: 10,
        color: this.textPrimary
      },
      listItem: {
        fontSize: 10,
        color: this.textPrimary,
        margin: [0, 2, 0, 2]
      },
      emptyState: {
        fontSize: 10,
        color: this.textSecondary,
        italics: true
      }
    };
  }
}

```
--- END OF FILE: src\app\services\pdf-generation.service.ts ---

--- START OF FILE: src\app\services\review-notes.service.ts ---
```typescript
import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';
import { ApiService } from './api.service';

export interface ReviewNote {
  partitionKey: string;       // Medication Review ID
  rowKey: string;             // Review Note ID
  text?: string;
  discussWithPatient: boolean;
  communicateToDoctor: boolean;
  category?: string;          // Category for organizing notes (e.g., "Posology", "Interactions", "GheOPS")
  linkedCnk?: string;         // CNK code to link note to specific medication
  medicationName?: string;    // Medication name stored separately from CNK
  timestamp?: string;
  eTag?: string;
}

@Injectable({
  providedIn: 'root'
})
export class ReviewNotesService {
  private notesSubject = new BehaviorSubject<ReviewNote[]>([]);
  private currentReviewId: string | null = null;

  public notes$ = this.notesSubject.asObservable();
  public notesCount$ = new BehaviorSubject<number>(0);

  constructor(private apiService: ApiService) {}

  /**
   * Load all review notes for a specific review
   */
  loadReviewNotes(reviewId: string): void {
    this.currentReviewId = reviewId;
    
    this.apiService.getReviewNotes(reviewId).subscribe({
      next: (notes) => {
        this.notesSubject.next(notes);
        this.notesCount$.next(notes.length);
        console.log('[ReviewNotesService] Loaded notes:', notes);
      },
      error: (error) => {
        console.error('[ReviewNotesService] Error loading notes:', error);
      }
    });
  }

  /**
   * Add a new review note
   */
  addNote(reviewId: string, note: { text?: string; discussWithPatient?: boolean; communicateToDoctor?: boolean; category?: string; linkedCnk?: string; medicationName?: string }): Observable<ReviewNote> {
    return new Observable(observer => {
      this.apiService.addReviewNote(reviewId, note).subscribe({
        next: (newNote) => {
          // Ensure timestamp is set (either from backend or set to current time)
          if (!newNote.timestamp) {
            newNote.timestamp = new Date().toISOString();
          }
          
          const currentNotes = this.notesSubject.value;
          const updatedNotes = [...currentNotes, newNote];
          this.notesSubject.next(updatedNotes);
          this.notesCount$.next(updatedNotes.length);
          console.log('[ReviewNotesService] Added note:', newNote);
          observer.next(newNote);
          observer.complete();
        },
        error: (error) => {
          console.error('[ReviewNotesService] Error adding note:', error);
          observer.error(error);
        }
      });
    });
  }

  /**
   * Update an existing review note
   */
  updateNote(reviewId: string, noteId: string, updates: Partial<ReviewNote>): Observable<ReviewNote> {
    return new Observable(observer => {
      this.apiService.updateReviewNote(reviewId, noteId, updates).subscribe({
        next: (updatedNote) => {
          const currentNotes = this.notesSubject.value;
          const index = currentNotes.findIndex(n => n.rowKey === noteId);
          if (index !== -1) {
            currentNotes[index] = updatedNote;
            this.notesSubject.next([...currentNotes]);
          }
          console.log('[ReviewNotesService] Updated note:', updatedNote);
          observer.next(updatedNote);
          observer.complete();
        },
        error: (error) => {
          console.error('[ReviewNotesService] Error updating note:', error);
          observer.error(error);
        }
      });
    });
  }

  /**
   * Delete a review note
   */
  deleteNote(reviewId: string, noteId: string): Observable<void> {
    return new Observable(observer => {
      this.apiService.deleteReviewNote(reviewId, noteId).subscribe({
        next: () => {
          const currentNotes = this.notesSubject.value;
          const updatedNotes = currentNotes.filter(n => n.rowKey !== noteId);
          this.notesSubject.next(updatedNotes);
          this.notesCount$.next(updatedNotes.length);
          console.log('[ReviewNotesService] Deleted note:', noteId);
          observer.next();
          observer.complete();
        },
        error: (error) => {
          console.error('[ReviewNotesService] Error deleting note:', error);
          observer.error(error);
        }
      });
    });
  }

  /**
   * Get current notes count
   */
  getNotesCount(): number {
    return this.notesSubject.value.length;
  }

  /**
   * Get all notes
   */
  getNotes(): ReviewNote[] {
    return this.notesSubject.value;
  }

  /**
   * Clear notes (useful when switching reviews)
   */
  clearNotes(): void {
    this.notesSubject.next([]);
    this.notesCount$.next(0);
    this.currentReviewId = null;
  }
}

```
--- END OF FILE: src\app\services\review-notes.service.ts ---

--- START OF FILE: src\app\services\state.service.ts ---
```typescript
import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable, Subject } from 'rxjs';
import { SessionData } from '../models/api.models';

@Injectable({
  providedIn: 'root'
})
export class StateService {
  private sessionDataSubject = new BehaviorSubject<SessionData | null>(null);
  public sessionData$: Observable<SessionData | null> = this.sessionDataSubject.asObservable();

  private contraindicationsChangedSubject = new Subject<void>();
  public contraindicationsChanged$: Observable<void> = this.contraindicationsChangedSubject.asObservable();

  private noteOverviewModalSubject = new Subject<void>();
  public noteOverviewModal$: Observable<void> = this.noteOverviewModalSubject.asObservable();

  setSessionData(data: SessionData): void {
    this.sessionDataSubject.next(data);
  }

  openNoteOverviewModal(): void {
    this.noteOverviewModalSubject.next();
  }

  getSessionData(): SessionData | null {
    return this.sessionDataSubject.value;
  }

  clearSessionData(): void {
    this.sessionDataSubject.next(null);
  }

  notifyContraindicationsChanged(): void {
    this.contraindicationsChangedSubject.next();
  }

  get apbNumber(): string {
    return this.sessionDataSubject.value?.apbNumber || '';
  }

  get patientId(): string {
    return this.sessionDataSubject.value?.patientId || '';
  }

  get medicationReviewId(): string {
    return this.sessionDataSubject.value?.medicationReviewId || '';
  }
}

```
--- END OF FILE: src\app\services\state.service.ts ---

--- START OF FILE: src\environments\environment.prod.ts ---
```typescript
// This file contains production environment configuration
// Update the apiBaseUrl when deploying to production
// You can use a relative path like '/api' if your backend is on the same domain,
// or a full URL like 'https://your-backend-domain.com/api'
export const environment = {
  production: true,
  apiBaseUrl: 'https://medication-review-dev-ckg0gbg2bufhgwcp.westeurope-01.azurewebsites.net/api'
}

```
--- END OF FILE: src\environments\environment.prod.ts ---

--- START OF FILE: src\environments\environment.ts ---
```typescript
// This file contains development environment configuration
// In development, the proxy.conf.json file will redirect /api requests to http://localhost:7071/api
export const environment = {
  production: false,
  apiBaseUrl: '/api'
};

```
--- END OF FILE: src\environments\environment.ts ---

--- START OF FILE: src\styles\_add-note-buttons.scss ---
```typescript
// Shared styles for Add Note buttons across all tools
// This file is imported into styles.scss and is available globally

.add-note-button {
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  background-color: $button-primary-background;
  color: white;
  border: none;
  font-size: 1.5rem;
  font-weight: bold;
  line-height: 1;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

  &:hover {
    background-color: darken($button-primary-background, 8%);
    transform: scale(1.08);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  &:active {
    transform: scale(0.95);
  }

  // General note variant (different color to distinguish from medication-specific notes)
  &.general-note {
    background-color: #6c757d; // Muted gray color
    
    &:hover {
      background-color: darken(#6c757d, 8%);
    }
  }
}

// Positioning helper for buttons that float/absolute position
.add-note-button-container {
  position: relative;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
  
  .add-note-button {
    margin: 0;
  }
  
  .button-label {
    font-family: $primary-font;
    font-size: 0.85rem;
    color: $text-secondary;
    font-weight: $font-weight-medium;
  }
}

```
--- END OF FILE: src\styles\_add-note-buttons.scss ---

--- START OF FILE: src\styles\_colors.scss ---
```typescript
// Color Variables
// This file contains all color definitions used throughout the application

// Header colors
$header-background: #ffffff;
$header-text: #333333;

// Main content colors
$main-background: #f5f5f5;

// Icon colors
$icon-color: #333333;
$icon-hover: #666666;

// Medication colors
$medication-indication: #9DC9A2;

// Box/Card colors
$box-background: #ffffff;
$box-border: #e0e0e0;
$box-border-primary: #5F6476;
$box-border-width: 1px;
$box-border-radius: 5px;
$box-border-radius-small: 5px;
$box-border-radius-none: 0px;

// Button colors
$button-primary: #454B60;
$button-primary-background: #454B60;
$button-primary-hover: #363b4d;
$button-secondary: #ffffff;
$button-secondary-hover: #f5f5f5;

// Input colors
$input-background: #ffffff;

// Text colors
$text-primary: #454B60;
$text-secondary: #454B60;
$text-tertiary: #999999;
$text-muted: #999999;
$text-button-primary: #ffffff;
$text-button-secondary: #454B60;
```
--- END OF FILE: src\styles\_colors.scss ---

--- START OF FILE: src\styles\_fonts.scss ---
```typescript
// Centralized font settings
// Define font-family variables here so they can be changed in one place

@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;600;700&display=swap');

$primary-font: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;

// Font weight variables
$font-weight-thin: 200; // thin (light) version for headers
$font-weight-regular: 400;
$font-weight-medium: 600;
$font-weight-bold: 700;
// Semi-bold alias
$font-weight-semibold: 600;
// Secondary font - used for accents and headings where a different family is desired
$secondary-font: $primary-font;
```
--- END OF FILE: src\styles\_fonts.scss ---
